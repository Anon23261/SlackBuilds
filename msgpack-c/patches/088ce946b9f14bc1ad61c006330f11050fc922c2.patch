From 088ce946b9f14bc1ad61c006330f11050fc922c2 Mon Sep 17 00:00:00 2001
From: Takatoshi Kondo <redboltz@gmail.com>
Date: Fri, 3 Feb 2017 17:11:51 +0900
Subject: [PATCH] Fixed #561

Fixed unpacker's buffer expansion logic.
---
 include/msgpack/v2/parse.hpp | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/include/msgpack/v2/parse.hpp b/include/msgpack/v2/parse.hpp
index ba250a3..ddbfb69 100644
--- a/include/msgpack/v2/parse.hpp
+++ b/include/msgpack/v2/parse.hpp
@@ -839,7 +839,7 @@ template <typename VisitorHolder, typename ReferencedBufferHook>
 inline void parser<VisitorHolder, ReferencedBufferHook>::expand_buffer(std::size_t size)
 {
     if(m_used == m_off && detail::get_count(m_buffer) == 1
-       && static_cast<VisitorHolder&>(*this).visitor().referenced()) {
+       && !static_cast<VisitorHolder&>(*this).visitor().referenced()) {
         // rewind buffer
         m_free += m_used - COUNTER_SIZE;
         m_used = COUNTER_SIZE;
