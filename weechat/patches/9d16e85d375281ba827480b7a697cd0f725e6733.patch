From 9d16e85d375281ba827480b7a697cd0f725e6733 Mon Sep 17 00:00:00 2001
From: orbea <orbea@riseup.net>
Date: Tue, 21 Jan 2020 06:54:23 -0800
Subject: [PATCH] Fix the build with guile-3.0.0.

v2: Update configure.ac too.

Signed-off-by: orbea <orbea@riseup.net>
---
 cmake/FindGuile.cmake                 | 2 +-
 configure.ac                          | 2 +-
 src/plugins/guile/weechat-guile-api.c | 2 ++
 src/plugins/guile/weechat-guile.c     | 2 ++
 4 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/cmake/FindGuile.cmake b/cmake/FindGuile.cmake
index b6928e66c..501e86e26 100644
--- a/cmake/FindGuile.cmake
+++ b/cmake/FindGuile.cmake
@@ -33,7 +33,7 @@ endif()
 
 find_package(PkgConfig)
 if(PKG_CONFIG_FOUND)
-  pkg_search_module(GUILE guile-2.2 guile-2.0)
+  pkg_search_module(GUILE guile-3.0 guile-2.2 guile-2.0)
   if(GUILE_FOUND)
     # check if variable "scm_install_gmp_memory_functions" exists
     set(CMAKE_REQUIRED_INCLUDES ${GUILE_INCLUDE_DIRS})
diff --git a/configure.ac b/configure.ac
index e73730304..e710e3900 100644
--- a/configure.ac
+++ b/configure.ac
@@ -730,7 +730,7 @@ if test "x$enable_guile" = "xyes" ; then
     guile_found="no"
     AC_MSG_CHECKING(for Guile headers and libraries)
     echo
-    for v in "2.2" "2.0" ; do
+    for v in "3.0" "2.2" "2.0" ; do
         pkgconfig_guile_found=`$PKGCONFIG --exists guile-$v 2>/dev/null`
         if test "x$?" = "x0" ; then
             GUILE_VERSION=`$PKGCONFIG --modversion guile-$v`
diff --git a/src/plugins/guile/weechat-guile-api.c b/src/plugins/guile/weechat-guile-api.c
index 5c3ff356c..ec4c20e97 100644
--- a/src/plugins/guile/weechat-guile-api.c
+++ b/src/plugins/guile/weechat-guile-api.c
@@ -24,6 +24,8 @@
 
 #include <libguile.h>
 #include <time.h>
+#include <stdio.h>
+#include <string.h>
 
 #include "../weechat-plugin.h"
 #include "../plugin-script.h"
diff --git a/src/plugins/guile/weechat-guile.c b/src/plugins/guile/weechat-guile.c
index 63c34e0c1..24bedb541 100644
--- a/src/plugins/guile/weechat-guile.c
+++ b/src/plugins/guile/weechat-guile.c
@@ -30,6 +30,8 @@
 #include <sys/stat.h>
 #include <unistd.h>
 #include <libgen.h>
+#include <stdio.h>
+#include <string.h>
 
 #include "../weechat-plugin.h"
 #include "../plugin-script.h"
