diff -Naurp fwbuilder-5.1.0.3599-orig/doc/ChangeLog fwbuilder-5.1.0.3599/doc/ChangeLog
--- fwbuilder-5.1.0.3599-orig/doc/ChangeLog	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/doc/ChangeLog	2014-07-08 16:51:14.332957896 +0200
@@ -8092,9 +8092,9 @@
 	ESTABLISED". Policy importer for iptables should properly
 	handle rules that use combination of a "-p protocol" and
 	match state "RELATED,ESTABLISHED". Example:
-	-A INBOUND -p tcp -m state --state RELATED,ESTABLISHED -j ACCEPT
+	-A INBOUND -p tcp -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
 	This rule should translate into fwbuilder rule using CustomService
-	object with code "-m state --state RELATED,ESTABLISHED"
+	object with code "-m conntrack --ctstate RELATED,ESTABLISHED"
 	and protocol spec "tcp".
 
 2009-06-03  vadim  <vadim@vk.crocodile.org>
@@ -11897,7 +11897,7 @@
 	to match on state if the action is drop" and #1671910: "2.1.8 In
 	'Branch' acton compiler doesn't insert NEW stanza". Rely only on
 	rule option 'stateless' to decide whether the rule should have 
-	"-m state --state NEW".
+	"-m conntrack --ctstate NEW".
 
 2007-05-06  vadim  <vadim@vk.crocodile.org>
 
@@ -13202,7 +13202,7 @@
  
  	* PolicyCompiler_PrintRule.cpp (PolicyRuleToString): fixed bug
  	#1375432: "fwb_ipt with twice -m state". Compiler used to generate
- 	options "-m state --state XYZ" twice in a situation when
+ 	options "-m conntrack --ctstate XYZ" twice in a situation when
  	administrator uses custom service that already includes this code
  	and rule is not stateless.
  
@@ -13253,7 +13253,7 @@
 	not have negation and we do not add any virtual addresses for NAT.
 	After removal the rule collapses to a simple command like this:
 
-	iptables -A INPUT -p tcp --dport 22 -m state --state NEW -j ACCEPT
+	iptables -A INPUT -p tcp --dport 22 -m conntrack --ctstate NEW -j ACCEPT
 
 	this works fine except if we have added virtual addresses for
 	NAT. It is assumed that firewall object in rules represents
diff -Naurp fwbuilder-5.1.0.3599-orig/doc/cisco_doc_15244_example.fwb fwbuilder-5.1.0.3599/doc/cisco_doc_15244_example.fwb
--- fwbuilder-5.1.0.3599-orig/doc/cisco_doc_15244_example.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/doc/cisco_doc_15244_example.fwb	2014-07-08 16:51:14.349957684 +0200
@@ -104,7 +104,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -112,7 +112,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/doc/cluster_examples.fwb fwbuilder-5.1.0.3599/doc/cluster_examples.fwb
--- fwbuilder-5.1.0.3599-orig/doc/cluster_examples.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/doc/cluster_examples.fwb	2014-07-08 16:51:14.340957796 +0200
@@ -104,14 +104,14 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
         <CustomServiceCommand platform="Undefined"></CustomServiceCommand>
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
         <ServiceGroup id="sg-DHCP" name="DHCP" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/import/IPTImporter.cpp fwbuilder-5.1.0.3599/src/import/IPTImporter.cpp
--- fwbuilder-5.1.0.3599-orig/src/import/IPTImporter.cpp	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/import/IPTImporter.cpp	2014-07-08 16:51:14.157960084 +0200
@@ -549,7 +549,7 @@ void IPTImporter::addStateMatch(libfwbui
         ObjectSignature sig(error_tracker);
         sig.type_name = CustomService::TYPENAME;
         sig.platform = "iptables";
-        sig.code = QString("-m state --state %1").arg(state.c_str());
+        sig.code = QString("-m conntrack --ctstate %1").arg(state.c_str());
         sig.protocol_name = "";
         srv->addRef(commitObject(service_maker->createObject(sig)));
         recent_match = "";
@@ -928,7 +928,7 @@ void IPTImporter::pushPolicyRule()
             ObjectSignature sig(error_tracker);
             sig.type_name = CustomService::TYPENAME;
             sig.platform = "iptables";
-            sig.code = QString("-m state --state RELATED,ESTABLISHED");
+            sig.code = QString("-m conntrack --ctstate RELATED,ESTABLISHED");
             sig.protocol_name = "";
             estab = service_maker->createObject(sig);
         }
@@ -990,7 +990,7 @@ void IPTImporter::pushPolicyRule()
         ObjectSignature sig(error_tracker);
         sig.type_name = CustomService::TYPENAME;
         sig.platform = "iptables";
-        sig.code = QString("-m state --state %1").arg(current_state.c_str());
+        sig.code = QString("-m conntrack --ctstate %1").arg(current_state.c_str());
         sig.protocol_name = "";
         FWObject *state_match_srv = commitObject(service_maker->createObject(sig));
 
diff -Naurp fwbuilder-5.1.0.3599-orig/src/iptlib/PolicyCompiler_PrintRule.cpp fwbuilder-5.1.0.3599/src/iptlib/PolicyCompiler_PrintRule.cpp
--- fwbuilder-5.1.0.3599-orig/src/iptlib/PolicyCompiler_PrintRule.cpp	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/iptlib/PolicyCompiler_PrintRule.cpp	2014-07-08 16:51:12.744977749 +0200
@@ -1635,8 +1635,8 @@ string PolicyCompiler_ipt::PrintRule::Po
         /*
          * But not, when the line already contains a state matching
          */
-        if (command_line.str().find("-m state --state", 0) == string::npos)
-            command_line << " -m state --state NEW ";
+        if (command_line.str().find("-m conntrack --ctstate", 0) == string::npos)
+            command_line << " -m conntrack --ctstate NEW ";
     }
 
     command_line << _printTimeInterval(rule);
diff -Naurp fwbuilder-5.1.0.3599-orig/src/iptlib/PolicyCompiler_ipt.cpp fwbuilder-5.1.0.3599/src/iptlib/PolicyCompiler_ipt.cpp
--- fwbuilder-5.1.0.3599-orig/src/iptlib/PolicyCompiler_ipt.cpp	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/iptlib/PolicyCompiler_ipt.cpp	2014-07-08 16:51:12.702978274 +0200
@@ -3537,7 +3537,7 @@ bool PolicyCompiler_ipt::decideOnTarget:
  *  we do not add any virtual addresses for NAT.
  *
  * After removal the rule collapses to a simple command like this:
- *   iptables -A INPUT -p tcp --dport 22 -m state --state NEW -j ACCEPT
+ *   iptables -A INPUT -p tcp --dport 22 -m conntrack --ctstate NEW -j ACCEPT
  *
  * this works fine except if we have added virtual addresses for
  * NAT. It is assumed that firewall object in rules represents
diff -Naurp fwbuilder-5.1.0.3599-orig/src/libfwbuilder/migration/FWObjectDatabase_0.10.0.xslt fwbuilder-5.1.0.3599/src/libfwbuilder/migration/FWObjectDatabase_0.10.0.xslt
--- fwbuilder-5.1.0.3599-orig/src/libfwbuilder/migration/FWObjectDatabase_0.10.0.xslt	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/libfwbuilder/migration/FWObjectDatabase_0.10.0.xslt	2014-07-08 16:51:12.793977136 +0200
@@ -140,7 +140,7 @@
 <CustomService comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually statefule firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." id="stdid14" library="Standard"  name="ESTABLISHED">
 <CustomServiceCommand platform="Undefined"></CustomServiceCommand>
 <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
-<CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+<CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
 </CustomService>
 <xsl:text>
 </xsl:text>
diff -Naurp fwbuilder-5.1.0.3599-orig/src/res/configlets/ipcop/automatic_rules fwbuilder-5.1.0.3599/src/res/configlets/ipcop/automatic_rules
--- fwbuilder-5.1.0.3599-orig/src/res/configlets/ipcop/automatic_rules	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/res/configlets/ipcop/automatic_rules	2014-07-08 16:51:12.386982224 +0200
@@ -21,16 +21,16 @@
 
 {{if mgmt_access}}
 # backup ssh access
-{{$begin_rule}} INPUT  -p tcp -m tcp  -s {{$ssh_management_address}}  --dport 222  -m state --state NEW,ESTABLISHED -j  ACCEPT {{$end_rule}}
-{{$begin_rule}} OUTPUT  -p tcp -m tcp  -d {{$ssh_management_address}}  --sport 222  -m state --state ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
+{{$begin_rule}} INPUT  -p tcp -m tcp  -s {{$ssh_management_address}}  --dport 222  -m conntrack --ctstate NEW,ESTABLISHED -j  ACCEPT {{$end_rule}}
+{{$begin_rule}} OUTPUT  -p tcp -m tcp  -d {{$ssh_management_address}}  --sport 222  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
 {{endif}}
 
 {{if drop_new_tcp_with_no_syn}}
 # drop TCP sessions opened prior firewall restart
-{{$begin_rule}} INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP {{$end_rule}}
-{{$begin_rule}} OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP {{$end_rule}}
+{{$begin_rule}} INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP {{$end_rule}}
+{{$begin_rule}} OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP {{$end_rule}}
 {{if ipforw}}
-{{$begin_rule}} FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP {{$end_rule}}
+{{$begin_rule}} FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP {{$end_rule}}
 {{endif}}
 {{endif}}
 
@@ -48,20 +48,20 @@
 
 {{if drop_invalid}}
 # drop packets that do not match any valid state 
-{{$begin_rule}} OUTPUT   -m state --state INVALID  -j DROP {{$end_rule}}
-{{$begin_rule}} INPUT    -m state --state INVALID  -j DROP {{$end_rule}}
+{{$begin_rule}} OUTPUT   -m conntrack --ctstate INVALID  -j DROP {{$end_rule}}
+{{$begin_rule}} INPUT    -m conntrack --ctstate INVALID  -j DROP {{$end_rule}}
 {{if ipforw}}
-{{$begin_rule}} FORWARD  -m state --state INVALID  -j DROP {{$end_rule}}
+{{$begin_rule}} FORWARD  -m conntrack --ctstate INVALID  -j DROP {{$end_rule}}
 {{endif}}
 {{endif}}
 
 {{if drop_invalid_and_log}}
 # drop packets that do not match any valid state and log them
 {{$create_drop_invalid_chain}}
-{{$begin_rule}} OUTPUT   -m state --state INVALID  -j drop_invalid {{$end_rule}}
-{{$begin_rule}} INPUT    -m state --state INVALID  -j drop_invalid {{$end_rule}}
+{{$begin_rule}} OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid {{$end_rule}}
+{{$begin_rule}} INPUT    -m conntrack --ctstate INVALID  -j drop_invalid {{$end_rule}}
 {{if ipforw}}
-{{$begin_rule}} FORWARD  -m state --state INVALID  -j drop_invalid {{$end_rule}}
+{{$begin_rule}} FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid {{$end_rule}}
 {{endif}}
 
 {{if use_ulog}}
diff -Naurp fwbuilder-5.1.0.3599-orig/src/res/configlets/linux24/automatic_rules fwbuilder-5.1.0.3599/src/res/configlets/linux24/automatic_rules
--- fwbuilder-5.1.0.3599-orig/src/res/configlets/linux24/automatic_rules	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/res/configlets/linux24/automatic_rules	2014-07-08 16:51:12.353982637 +0200
@@ -50,9 +50,9 @@
 
 {{if accept_established}}
 # accept established sessions
-{{$begin_rule}} INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
-{{$begin_rule}} OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
-{{$begin_rule}} FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
+{{$begin_rule}} INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
+{{$begin_rule}} OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
+{{$begin_rule}} FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
 {{endif}}
 
 
@@ -67,16 +67,16 @@
 
 {{if mgmt_access}}
 # backup ssh access
-{{$begin_rule}} INPUT  -p tcp -m tcp  -s {{$ssh_management_address}}  --dport 22  -m state --state NEW,ESTABLISHED -j  ACCEPT {{$end_rule}}
-{{$begin_rule}} OUTPUT  -p tcp -m tcp  -d {{$ssh_management_address}}  --sport 22  -m state --state ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
+{{$begin_rule}} INPUT  -p tcp -m tcp  -s {{$ssh_management_address}}  --dport 22  -m conntrack --ctstate NEW,ESTABLISHED -j  ACCEPT {{$end_rule}}
+{{$begin_rule}} OUTPUT  -p tcp -m tcp  -d {{$ssh_management_address}}  --sport 22  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
 {{endif}}
 
 {{if drop_new_tcp_with_no_syn}}
 # drop TCP sessions opened prior firewall restart
-{{$begin_rule}} INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP {{$end_rule}}
-{{$begin_rule}} OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP {{$end_rule}}
+{{$begin_rule}} INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP {{$end_rule}}
+{{$begin_rule}} OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP {{$end_rule}}
 {{if ipforw}}
-{{$begin_rule}} FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP {{$end_rule}}
+{{$begin_rule}} FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP {{$end_rule}}
 {{endif}}
 {{endif}}
 
@@ -100,20 +100,20 @@
 
 {{if drop_invalid}}
 # drop packets that do not match any valid state 
-{{$begin_rule}} OUTPUT   -m state --state INVALID  -j DROP {{$end_rule}}
-{{$begin_rule}} INPUT    -m state --state INVALID  -j DROP {{$end_rule}}
+{{$begin_rule}} OUTPUT   -m conntrack --ctstate INVALID  -j DROP {{$end_rule}}
+{{$begin_rule}} INPUT    -m conntrack --ctstate INVALID  -j DROP {{$end_rule}}
 {{if ipforw}}
-{{$begin_rule}} FORWARD  -m state --state INVALID  -j DROP {{$end_rule}}
+{{$begin_rule}} FORWARD  -m conntrack --ctstate INVALID  -j DROP {{$end_rule}}
 {{endif}}
 {{endif}}
 
 {{if drop_invalid_and_log}}
 # drop packets that do not match any valid state and log them
 {{$create_drop_invalid_chain}}
-{{$begin_rule}} OUTPUT   -m state --state INVALID  -j drop_invalid {{$end_rule}}
-{{$begin_rule}} INPUT    -m state --state INVALID  -j drop_invalid {{$end_rule}}
+{{$begin_rule}} OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid {{$end_rule}}
+{{$begin_rule}} INPUT    -m conntrack --ctstate INVALID  -j drop_invalid {{$end_rule}}
 {{if ipforw}}
-{{$begin_rule}} FORWARD  -m state --state INVALID  -j drop_invalid {{$end_rule}}
+{{$begin_rule}} FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid {{$end_rule}}
 {{endif}}
 
 {{if use_ulog}}
diff -Naurp fwbuilder-5.1.0.3599-orig/src/res/configlets/linux24/block_action fwbuilder-5.1.0.3599/src/res/configlets/linux24/block_action
--- fwbuilder-5.1.0.3599-orig/src/res/configlets/linux24/block_action	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/res/configlets/linux24/block_action	2014-07-08 16:51:12.361982537 +0200
@@ -30,8 +30,8 @@ block_action() {
 
 {{if mgmt_access}}
     # backup ssh access
-    $IPTABLES -A INPUT  -p tcp -m tcp  -s {{$ssh_management_address}}  --dport 22  -m state --state NEW,ESTABLISHED -j  ACCEPT
-    $IPTABLES -A OUTPUT  -p tcp -m tcp  -d {{$ssh_management_address}}  --sport 22  -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT  -p tcp -m tcp  -s {{$ssh_management_address}}  --dport 22  -m conntrack --ctstate NEW,ESTABLISHED -j  ACCEPT
+    $IPTABLES -A OUTPUT  -p tcp -m tcp  -d {{$ssh_management_address}}  --sport 22  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 {{endif}}
 }
 
diff -Naurp fwbuilder-5.1.0.3599-orig/src/res/configlets/secuwall/management_rules fwbuilder-5.1.0.3599/src/res/configlets/secuwall/management_rules
--- fwbuilder-5.1.0.3599-orig/src/res/configlets/secuwall/management_rules	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/res/configlets/secuwall/management_rules	2014-07-08 16:51:12.383982262 +0200
@@ -4,51 +4,51 @@
 {{if has_secuwall_mgmt_mgmtaddr}}
 # SSH access from management stations/networks
 for mgmt in {{$secuwall_mgmt_mgmtaddr}} ; do
-  {{$begin_rule}} INPUT -p tcp -m tcp -s ${mgmt} --dport 22 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
-  {{$begin_rule}} OUTPUT -p tcp -m tcp -d ${mgmt} --sport 22 -m state --state ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
+  {{$begin_rule}} INPUT -p tcp -m tcp -s ${mgmt} --dport 22 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
+  {{$begin_rule}} OUTPUT -p tcp -m tcp -d ${mgmt} --sport 22 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
 done
 {{endif}}
 
 {{if has_secuwall_mgmt_loggingaddr}}
 # logging via SYSLOG to loghosts
 for loghost in {{$secuwall_mgmt_loggingaddr}} ; do
-  {{$begin_rule}} OUTPUT -p udp -m udp -d ${loghost} --dport 514 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
-  {{$begin_rule}} OUTPUT -p tcp -m tcp -d ${loghost} --dport 514 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
-  {{$begin_rule}} INPUT -p tcp -m tcp -s ${loghost} --sport 514 -m state --state ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
+  {{$begin_rule}} OUTPUT -p udp -m udp -d ${loghost} --dport 514 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
+  {{$begin_rule}} OUTPUT -p tcp -m tcp -d ${loghost} --dport 514 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
+  {{$begin_rule}} INPUT -p tcp -m tcp -s ${loghost} --sport 514 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
 done
 {{endif}}
 
 {{if has_secuwall_mgmt_ntpaddr}}
 # get current time via NTP
 for ntphost in {{$secuwall_mgmt_ntpaddr}} ; do
-  {{$begin_rule}} OUTPUT -p udp -m udp -d ${ntphost} --dport 123 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
-  {{$begin_rule}} INPUT -p udp -m udp -s ${ntphost} --sport 123 -m state --state ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
+  {{$begin_rule}} OUTPUT -p udp -m udp -d ${ntphost} --dport 123 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
+  {{$begin_rule}} INPUT -p udp -m udp -s ${ntphost} --sport 123 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
 done
 {{endif}}
 
 {{if has_secuwall_mgmt_snmpaddr}}
 # let us peek via SNMP
 for snmp in {{$secuwall_mgmt_snmpaddr}} ; do
-  {{$begin_rule}} INPUT -p udp -m udp -s ${snmp} --dport 161 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
-  {{$begin_rule}} OUTPUT -p udp -m udp -d ${snmp} --sport 161 -m state --state ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
-  {{$begin_rule}} OUTPUT -p udp -m udp -d ${snmp} --dport 162 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
+  {{$begin_rule}} INPUT -p udp -m udp -s ${snmp} --dport 161 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
+  {{$begin_rule}} OUTPUT -p udp -m udp -d ${snmp} --sport 161 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
+  {{$begin_rule}} OUTPUT -p udp -m udp -d ${snmp} --dport 162 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
 done
 {{endif}}
 
 {{if has_secuwall_mgmt_nagiosaddr}}
 # access to the NRPE client on the firewall
 for nagios in {{$secuwall_mgmt_nagiosaddr}} ; do
-  {{$begin_rule}} INPUT -p tcp -m tcp -s ${nagios} --dport 5666 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
-  {{$begin_rule}} OUTPUT -p tcp -m tcp -d ${nagios} --sport 5666 -m state --state ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
+  {{$begin_rule}} INPUT -p tcp -m tcp -s ${nagios} --dport 5666 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
+  {{$begin_rule}} OUTPUT -p tcp -m tcp -d ${nagios} --sport 5666 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
 done
 {{endif}}
 
 # client DNS for the firewall
 {{if has_secuwall_dns_srv1}}
 for dns in {{$secuwall_dns_srv1}} {{$secuwall_dns_srv2}} {{$secuwall_dns_srv3}} ; do
-  {{$begin_rule}} OUTPUT -p udp -m udp -d ${dns} --dport 53 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
-  {{$begin_rule}} INPUT -p udp -m udp -s ${dns} --sport 53 -m state --state ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
-  {{$begin_rule}} OUTPUT -p tcp -m tcp -d ${dns} --dport 53 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
-  {{$begin_rule}} INPUT -p tcp -m tcp -s ${dns} --sport 53 -m state --state ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
+  {{$begin_rule}} OUTPUT -p udp -m udp -d ${dns} --dport 53 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
+  {{$begin_rule}} INPUT -p udp -m udp -s ${dns} --sport 53 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
+  {{$begin_rule}} OUTPUT -p tcp -m tcp -d ${dns} --dport 53 -m conntrack --ctstate NEW,ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
+  {{$begin_rule}} INPUT -p tcp -m tcp -s ${dns} --sport 53 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT {{$end_rule}}
 done
 {{endif}}
diff -Naurp fwbuilder-5.1.0.3599-orig/src/res/help/en_US/iptables_rule_options.html fwbuilder-5.1.0.3599/src/res/help/en_US/iptables_rule_options.html
--- fwbuilder-5.1.0.3599-orig/src/res/help/en_US/iptables_rule_options.html	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/res/help/en_US/iptables_rule_options.html	2014-07-08 16:51:12.253983887 +0200
@@ -31,16 +31,16 @@ name in the firewall object "advanced" s
   Firewall Builder always uses stateful packet inspection if it is
   available in the target firewall. In case of iptables, this means it
   always uses module "state" by adding the following parameters to the
-  generated rules: "-m state --state NEW". It also adds a rule to
+  generated rules: "-m conntrack --ctstate NEW". It also adds a rule to
   match states "ESTABLISHED,RELATED" on top of the policy. However,
   sometimes it might be desirable to create a rule without state
   matching. Checking this checkbox on makes the rule stateless, which
-  means parameters "-m state --state NEW" will not be added.
+  means parameters "-m conntrack --ctstate NEW" will not be added.
 </p>
 
 <p>
   Rules with action Deny are always stateless by default and do not get
-  the "-m state --state NEW" parameters, although you can make them
+  the "-m conntrack --ctstate NEW" parameters, although you can make them
   stateful by checking this checkbox.
 </p>
 
diff -Naurp fwbuilder-5.1.0.3599-orig/src/res/objects_init.xml fwbuilder-5.1.0.3599/src/res/objects_init.xml
--- fwbuilder-5.1.0.3599-orig/src/res/objects_init.xml	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/res/objects_init.xml	2014-07-08 16:51:12.391982162 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/res/objects_init.xml.in fwbuilder-5.1.0.3599/src/res/objects_init.xml.in
--- fwbuilder-5.1.0.3599-orig/src/res/objects_init.xml.in	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/res/objects_init.xml.in	2014-07-08 16:51:12.395982112 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/res/templates.xml fwbuilder-5.1.0.3599/src/res/templates.xml
--- fwbuilder-5.1.0.3599-orig/src/res/templates.xml	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/res/templates.xml	2014-07-08 16:51:12.329982937 +0200
@@ -104,7 +104,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"/>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -112,7 +112,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"/>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/res/templates.xml.in fwbuilder-5.1.0.3599/src/res/templates.xml.in
--- fwbuilder-5.1.0.3599-orig/src/res/templates.xml.in	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/res/templates.xml.in	2014-07-08 16:51:12.309983187 +0200
@@ -104,7 +104,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"/>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -112,7 +112,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"/>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/ImporterTest/test_data/ios.fwb fwbuilder-5.1.0.3599/src/unit_tests/ImporterTest/test_data/ios.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/ImporterTest/test_data/ios.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/ImporterTest/test_data/ios.fwb	2014-07-08 16:51:11.782989775 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/ImporterTest/test_data/ipt-no-nat.fwb fwbuilder-5.1.0.3599/src/unit_tests/ImporterTest/test_data/ipt-no-nat.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/ImporterTest/test_data/ipt-no-nat.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/ImporterTest/test_data/ipt-no-nat.fwb	2014-07-08 16:51:11.755990113 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/ImporterTest/test_data/ipt-no-nat.test fwbuilder-5.1.0.3599/src/unit_tests/ImporterTest/test_data/ipt-no-nat.test
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/ImporterTest/test_data/ipt-no-nat.test	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/ImporterTest/test_data/ipt-no-nat.test	2014-07-08 16:51:11.787989713 +0200
@@ -13,8 +13,8 @@
 -A RH-Firewall-1-INPUT -d 224.0.0.251 -p udp -m udp --dport 5353 -j ACCEPT 
 -A RH-Firewall-1-INPUT -p udp -m udp --dport 631 -j ACCEPT 
 -A RH-Firewall-1-INPUT -p tcp -m tcp --dport 631 -j ACCEPT 
--A RH-Firewall-1-INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT 
--A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT 
+-A RH-Firewall-1-INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT 
+-A RH-Firewall-1-INPUT -p tcp -m conntrack --ctstate NEW -m tcp --dport 22 -j ACCEPT 
 -A RH-Firewall-1-INPUT -j REJECT --reject-with icmp-host-prohibited 
 COMMIT
 # Completed on Mon Apr 11 15:46:04 2011
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/ImporterTest/test_data/ipt.fwb fwbuilder-5.1.0.3599/src/unit_tests/ImporterTest/test_data/ipt.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/ImporterTest/test_data/ipt.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/ImporterTest/test_data/ipt.fwb	2014-07-08 16:51:11.777989838 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
@@ -640,10 +640,10 @@
       <ServiceGroup id="id180" name="Users" comment="" ro="False"/>
       <ServiceGroup id="id181" name="Custom" comment="" ro="False">
         <CustomService id="id182" name="cust-0" comment="Created during import of  line 18" ro="False" protocol="any" address_family="ipv4">
-          <CustomServiceCommand platform="iptables">-m state --state NEW,ESTABLISHED</CustomServiceCommand>
+          <CustomServiceCommand platform="iptables">-m conntrack --ctstate NEW,ESTABLISHED</CustomServiceCommand>
         </CustomService>
         <CustomService id="id183" name="cust-0" comment="Created during import of  line 31" ro="False" protocol="any" address_family="ipv4">
-          <CustomServiceCommand platform="iptables">-m state --state NEW,RELATED,ESTABLISHED</CustomServiceCommand>
+          <CustomServiceCommand platform="iptables">-m conntrack --ctstate NEW,RELATED,ESTABLISHED</CustomServiceCommand>
         </CustomService>
         <CustomService id="id184" name="cust-0" comment="Created during import of  line 214" ro="False" protocol="any" address_family="ipv4">
           <CustomServiceCommand platform="iptables">-m length --length 400:65535</CustomServiceCommand>
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/ImporterTest/test_data/ipt.test fwbuilder-5.1.0.3599/src/unit_tests/ImporterTest/test_data/ipt.test
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/ImporterTest/test_data/ipt.test	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/ImporterTest/test_data/ipt.test	2014-07-08 16:51:11.787989713 +0200
@@ -6,35 +6,35 @@
 :user_chain - [0:0]
 
 # this should produce rule in the same chain
--A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT 
+-A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT 
 
 # and these, too
--A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
--A OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT 
--A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT 
+-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+-A OUTPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT 
+-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT 
 
 # unusual combination of states, creates custom service object. Also, since the same rule
 # matches tcp service and custom service, branch will be created
--A INPUT -s 192.168.2.0/24 -p tcp -m tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT 
+-A INPUT -s 192.168.2.0/24 -p tcp -m tcp --dport 22 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT 
 
 # this creates a branch, matching service in the main policy and
 # ESTABLISHED,RELATE states in the branch
 #
--A OUTPUT -d 21.21.21.21 -p tcp -m tcp --sport 22 -m state --state RELATED,ESTABLISHED -j ACCEPT 
+-A OUTPUT -d 21.21.21.21 -p tcp -m tcp --sport 22 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT 
 
 # variant with a different action. New branch rule set should be created, different
 # from the one created for the rule above.
 #
--A OUTPUT -d 21.21.21.21 -p tcp -m tcp --dport 23 -m state --state RELATED,ESTABLISHED -j DROP
+-A OUTPUT -d 21.21.21.21 -p tcp -m tcp --dport 23 -m conntrack --ctstate RELATED,ESTABLISHED -j DROP
 
 # more complex combination of states
--A FORWARD -s 1.1.1.0/24 -d 2.2.2.0/24 -p tcp -m state --state NEW,RELATED,ESTABLISHED -m tcp ! --dport 80 -j ACCEPT
+-A FORWARD -s 1.1.1.0/24 -d 2.2.2.0/24 -p tcp -m conntrack --ctstate NEW,RELATED,ESTABLISHED -m tcp ! --dport 80 -j ACCEPT
 
 # this should be recognized as built-in rule
--A FORWARD -m state --state INVALID -j drop_invalid 
+-A FORWARD -m conntrack --ctstate INVALID -j drop_invalid 
 
 # this should be recognized as built-in rule
--A OUTPUT -m state --state INVALID -j drop_invalid 
+-A OUTPUT -m conntrack --ctstate INVALID -j drop_invalid 
 
 # these go into INPUT chain, should end up with firewall object in DST
 -A INPUT -i lo -j ACCEPT
@@ -85,7 +85,7 @@
 -A FORWARD -m iprange --src-range 10.212.66.2-10.212.66.3 -d 192.11.1.11 -j ACCEPT
 
 #
--A FORWARD -s 192.168.0.0/16 -m state --state NEW -j ACCEPT
+-A FORWARD -s 192.168.0.0/16 -m conntrack --ctstate NEW -j ACCEPT
 
 # this should end up with action "Continue" and logging on
 -A FORWARD -j LOG --log-prefix "FORWARD catch-all"
@@ -103,32 +103,32 @@
 # this should be reproduced using custom service object even though it
 #  is in user-defined chain
 #
--A user_chain -m state --state RELATED,ESTABLISHED -j ACCEPT
+-A user_chain -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
 
--A user_chain -s 192.168.19.0/24  -p tcp -m tcp --dport 5432 -m state --state NEW -j ACCEPT
--A user_chain -s 192.168.16.125  -p tcp -m tcp --dport 5432 -m state --state NEW -j ACCEPT
--A user_chain -s 192.168.0.0/16 -p tcp -m tcp --dport 873 -m state --state NEW -j ACCEPT
--A user_chain -s 192.168.0.0/16 -p tcp -m tcp --dport 22 -m state --state NEW -j ACCEPT
--A user_chain -s 192.0.34.166 -p tcp -m tcp --dport 22 -m state --state NEW -j ACCEPT
--A user_chain -s 192.168.19.0/24 -p tcp -m tcp --dport 137:139 -m state --state NEW -j ACCEPT
+-A user_chain -s 192.168.19.0/24  -p tcp -m tcp --dport 5432 -m conntrack --ctstate NEW -j ACCEPT
+-A user_chain -s 192.168.16.125  -p tcp -m tcp --dport 5432 -m conntrack --ctstate NEW -j ACCEPT
+-A user_chain -s 192.168.0.0/16 -p tcp -m tcp --dport 873 -m conntrack --ctstate NEW -j ACCEPT
+-A user_chain -s 192.168.0.0/16 -p tcp -m tcp --dport 22 -m conntrack --ctstate NEW -j ACCEPT
+-A user_chain -s 192.0.34.166 -p tcp -m tcp --dport 22 -m conntrack --ctstate NEW -j ACCEPT
+-A user_chain -s 192.168.19.0/24 -p tcp -m tcp --dport 137:139 -m conntrack --ctstate NEW -j ACCEPT
 
 
--A user_chain -s 192.168.19.0/24 -p tcp -m tcp --dport :1023 -m state --state NEW -j ACCEPT
--A user_chain -s 192.168.19.0/24 -p tcp -m tcp --dport 6000: -m state --state NEW -j ACCEPT
+-A user_chain -s 192.168.19.0/24 -p tcp -m tcp --dport :1023 -m conntrack --ctstate NEW -j ACCEPT
+-A user_chain -s 192.168.19.0/24 -p tcp -m tcp --dport 6000: -m conntrack --ctstate NEW -j ACCEPT
 
--A user_chain -s 192.168.0.0/16 -p udp --dport 137 -m state --state NEW -j ACCEPT
--A user_chain -s 192.168.0.0/16 -p udp --dport 138 -m state --state NEW -j ACCEPT
--A user_chain -s 192.168.0.0/16 -p tcp -m tcp --dport 139 -m state --state NEW -j ACCEPT
--A user_chain -s 192.168.0.0/16 -p tcp -m tcp --dport 445 -m state --state NEW -j ACCEPT
--A user_chain -p tcp -m tcp --dport 80 -m state --state NEW -j ACCEPT
+-A user_chain -s 192.168.0.0/16 -p udp --dport 137 -m conntrack --ctstate NEW -j ACCEPT
+-A user_chain -s 192.168.0.0/16 -p udp --dport 138 -m conntrack --ctstate NEW -j ACCEPT
+-A user_chain -s 192.168.0.0/16 -p tcp -m tcp --dport 139 -m conntrack --ctstate NEW -j ACCEPT
+-A user_chain -s 192.168.0.0/16 -p tcp -m tcp --dport 445 -m conntrack --ctstate NEW -j ACCEPT
+-A user_chain -p tcp -m tcp --dport 80 -m conntrack --ctstate NEW -j ACCEPT
 
--A user_chain -s 192.168.0.0/16 -p tcp -m tcp --dport 8080 -m state --state NEW -j ACCEPT
--A user_chain -s 192.0.34.166 -p tcp -m tcp --dport 8080 -m state --state NEW -j ACCEPT
+-A user_chain -s 192.168.0.0/16 -p tcp -m tcp --dport 8080 -m conntrack --ctstate NEW -j ACCEPT
+-A user_chain -s 192.0.34.166 -p tcp -m tcp --dport 8080 -m conntrack --ctstate NEW -j ACCEPT
 
--A user_chain -p tcp -m tcp --dport 443 -m state --state NEW -j ACCEPT
+-A user_chain -p tcp -m tcp --dport 443 -m conntrack --ctstate NEW -j ACCEPT
 
--A user_chain -s 127.0.0.1 -p tcp -m tcp --dport 631 -m state --state NEW -j ACCEPT
--A user_chain -s 127.0.0.1 -p tcp -m tcp --dport 515 -m state --state NEW -j ACCEPT
+-A user_chain -s 127.0.0.1 -p tcp -m tcp --dport 631 -m conntrack --ctstate NEW -j ACCEPT
+-A user_chain -s 127.0.0.1 -p tcp -m tcp --dport 515 -m conntrack --ctstate NEW -j ACCEPT
 
 # different combinations of tcp flags in combination with some other
 # options. Taken from a real policy.
@@ -152,7 +152,7 @@
 
 
 # was: bad port spec
--A user_chain -s 192.168.0.0/16 -p tcp -m tcp --dport 8088 -m state --state NEW -j ACCEPT
+-A user_chain -s 192.168.0.0/16 -p tcp -m tcp --dport 8088 -m conntrack --ctstate NEW -j ACCEPT
 
 # Log prefix and log limit test
 # Also need action Continue (or NOP)
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/ObjectManipulatorTest/test.fwb fwbuilder-5.1.0.3599/src/unit_tests/ObjectManipulatorTest/test.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/ObjectManipulatorTest/test.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/ObjectManipulatorTest/test.fwb	2014-07-08 16:51:11.845988988 +0200
@@ -104,14 +104,14 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
         <CustomServiceCommand platform="Undefined"></CustomServiceCommand>
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
         <ServiceGroup id="sg-DHCP" name="DHCP" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-block-return-actions.fwb fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-block-return-actions.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-block-return-actions.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-block-return-actions.fwb	2014-07-08 16:51:11.944987750 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-hosts-matches.fwb fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-hosts-matches.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-hosts-matches.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-hosts-matches.fwb	2014-07-08 16:51:11.959987562 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-icmp-matches.fwb fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-icmp-matches.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-icmp-matches.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-icmp-matches.fwb	2014-07-08 16:51:11.952987650 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-interface-matches.fwb fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-interface-matches.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-interface-matches.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-interface-matches.fwb	2014-07-08 16:51:11.948987700 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-macros.fwb fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-macros.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-macros.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-macros.fwb	2014-07-08 16:51:11.933987888 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-nat-rules.fwb fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-nat-rules.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-nat-rules.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-nat-rules.fwb	2014-07-08 16:51:11.903988263 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-port-matches.fwb fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-port-matches.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-port-matches.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-port-matches.fwb	2014-07-08 16:51:11.922988025 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-rdr-rules.fwb fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-rdr-rules.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-rdr-rules.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-rdr-rules.fwb	2014-07-08 16:51:11.894988375 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-route-to-4.7.fwb fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-route-to-4.7.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-route-to-4.7.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-route-to-4.7.fwb	2014-07-08 16:51:11.928987950 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-route-to.fwb fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-route-to.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-route-to.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-route-to.fwb	2014-07-08 16:51:11.913988138 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-state-matches.fwb fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-state-matches.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-state-matches.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-state-matches.fwb	2014-07-08 16:51:11.962987525 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-tables.fwb fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-tables.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-tables.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-tables.fwb	2014-07-08 16:51:11.898988325 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-tcp-flags-matches.fwb fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-tcp-flags-matches.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-tcp-flags-matches.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-tcp-flags-matches.fwb	2014-07-08 16:51:11.909988188 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-user-group-matches.fwb fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-user-group-matches.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PFImporterTest/test_data/pf-user-group-matches.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PFImporterTest/test_data/pf-user-group-matches.fwb	2014-07-08 16:51:11.937987838 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PIXImporterTest/test_data/asa8.0-names.fwb fwbuilder-5.1.0.3599/src/unit_tests/PIXImporterTest/test_data/asa8.0-names.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PIXImporterTest/test_data/asa8.0-names.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PIXImporterTest/test_data/asa8.0-names.fwb	2014-07-08 16:51:12.072986150 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PIXImporterTest/test_data/asa8.0.fwb fwbuilder-5.1.0.3599/src/unit_tests/PIXImporterTest/test_data/asa8.0.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PIXImporterTest/test_data/asa8.0.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PIXImporterTest/test_data/asa8.0.fwb	2014-07-08 16:51:12.139985312 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PIXImporterTest/test_data/asa8.3-acl-object-groups.fwb fwbuilder-5.1.0.3599/src/unit_tests/PIXImporterTest/test_data/asa8.3-acl-object-groups.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PIXImporterTest/test_data/asa8.3-acl-object-groups.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PIXImporterTest/test_data/asa8.3-acl-object-groups.fwb	2014-07-08 16:51:12.100985800 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PIXImporterTest/test_data/asa8.3-acl.fwb fwbuilder-5.1.0.3599/src/unit_tests/PIXImporterTest/test_data/asa8.3-acl.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PIXImporterTest/test_data/asa8.3-acl.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PIXImporterTest/test_data/asa8.3-acl.fwb	2014-07-08 16:51:12.112985650 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PIXImporterTest/test_data/asa8.3-objects-and-groups.fwb fwbuilder-5.1.0.3599/src/unit_tests/PIXImporterTest/test_data/asa8.3-objects-and-groups.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PIXImporterTest/test_data/asa8.3-objects-and-groups.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PIXImporterTest/test_data/asa8.3-objects-and-groups.fwb	2014-07-08 16:51:12.145985237 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PIXImporterTest/test_data/asa8.3.fwb fwbuilder-5.1.0.3599/src/unit_tests/PIXImporterTest/test_data/asa8.3.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PIXImporterTest/test_data/asa8.3.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PIXImporterTest/test_data/asa8.3.fwb	2014-07-08 16:51:12.134985375 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PIXImporterTest/test_data/fwsm1.fwb fwbuilder-5.1.0.3599/src/unit_tests/PIXImporterTest/test_data/fwsm1.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PIXImporterTest/test_data/fwsm1.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PIXImporterTest/test_data/fwsm1.fwb	2014-07-08 16:51:12.077986087 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PIXImporterTest/test_data/pix6.fwb fwbuilder-5.1.0.3599/src/unit_tests/PIXImporterTest/test_data/pix6.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PIXImporterTest/test_data/pix6.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PIXImporterTest/test_data/pix6.fwb	2014-07-08 16:51:12.086985975 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PIXImporterTest/test_data/pix7-nat.fwb fwbuilder-5.1.0.3599/src/unit_tests/PIXImporterTest/test_data/pix7-nat.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PIXImporterTest/test_data/pix7-nat.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PIXImporterTest/test_data/pix7-nat.fwb	2014-07-08 16:51:12.128985450 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/PIXImporterTest/test_data/pix7.fwb fwbuilder-5.1.0.3599/src/unit_tests/PIXImporterTest/test_data/pix7.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/PIXImporterTest/test_data/pix7.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/PIXImporterTest/test_data/pix7.fwb	2014-07-08 16:51:12.091985912 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/commandLinePrintingTest/test.fwb fwbuilder-5.1.0.3599/src/unit_tests/commandLinePrintingTest/test.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/commandLinePrintingTest/test.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/commandLinePrintingTest/test.fwb	2014-07-08 16:51:12.061986287 +0200
@@ -104,7 +104,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -112,7 +112,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/compilerLibTest/test.fwb fwbuilder-5.1.0.3599/src/unit_tests/compilerLibTest/test.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/compilerLibTest/test.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/compilerLibTest/test.fwb	2014-07-08 16:51:11.798989575 +0200
@@ -104,7 +104,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -112,7 +112,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/generatedScriptTestsIpfilter/test1.fwb fwbuilder-5.1.0.3599/src/unit_tests/generatedScriptTestsIpfilter/test1.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/generatedScriptTestsIpfilter/test1.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/generatedScriptTestsIpfilter/test1.fwb	2014-07-08 16:51:12.036986600 +0200
@@ -104,7 +104,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -112,7 +112,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/generatedScriptTestsIpfw/test1.fwb fwbuilder-5.1.0.3599/src/unit_tests/generatedScriptTestsIpfw/test1.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/generatedScriptTestsIpfw/test1.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/generatedScriptTestsIpfw/test1.fwb	2014-07-08 16:51:11.877988588 +0200
@@ -104,7 +104,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -112,7 +112,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/generatedScriptTestsLinux/test1.fwb fwbuilder-5.1.0.3599/src/unit_tests/generatedScriptTestsLinux/test1.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/generatedScriptTestsLinux/test1.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/generatedScriptTestsLinux/test1.fwb	2014-07-08 16:51:11.987987212 +0200
@@ -104,7 +104,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -112,7 +112,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/generatedScriptTestsPF/test1.fwb fwbuilder-5.1.0.3599/src/unit_tests/generatedScriptTestsPF/test1.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/generatedScriptTestsPF/test1.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/generatedScriptTestsPF/test1.fwb	2014-07-08 16:51:11.810989425 +0200
@@ -104,7 +104,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -112,7 +112,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/generatedScriptTestsSecuwall/test1.fwb fwbuilder-5.1.0.3599/src/unit_tests/generatedScriptTestsSecuwall/test1.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/generatedScriptTestsSecuwall/test1.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/generatedScriptTestsSecuwall/test1.fwb	2014-07-08 16:51:11.969987437 +0200
@@ -104,14 +104,14 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
         <CustomServiceCommand platform="Undefined"></CustomServiceCommand>
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
         <ServiceGroup id="sg-DHCP" name="DHCP" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/instDialogClusterTest/test.fwb fwbuilder-5.1.0.3599/src/unit_tests/instDialogClusterTest/test.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/instDialogClusterTest/test.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/instDialogClusterTest/test.fwb	2014-07-08 16:51:12.049986437 +0200
@@ -104,14 +104,14 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
         <CustomServiceCommand platform="Undefined"></CustomServiceCommand>
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
         <ServiceGroup id="sg-DHCP" name="DHCP" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/instDialogCompileTest/test.fwb fwbuilder-5.1.0.3599/src/unit_tests/instDialogCompileTest/test.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/instDialogCompileTest/test.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/instDialogCompileTest/test.fwb	2014-07-08 16:51:11.863988763 +0200
@@ -104,7 +104,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -112,7 +112,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/instDialogInspectTest/test.fwb fwbuilder-5.1.0.3599/src/unit_tests/instDialogInspectTest/test.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/instDialogInspectTest/test.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/instDialogInspectTest/test.fwb	2014-07-08 16:51:12.014986875 +0200
@@ -104,7 +104,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -112,7 +112,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/instDialogInstallTest/test.fwb fwbuilder-5.1.0.3599/src/unit_tests/instDialogInstallTest/test.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/instDialogInstallTest/test.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/instDialogInstallTest/test.fwb	2014-07-08 16:51:11.995987112 +0200
@@ -104,14 +104,14 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
         <CustomServiceCommand platform="Undefined"></CustomServiceCommand>
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
         <ServiceGroup id="sg-DHCP" name="DHCP" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/src/unit_tests/instDialogObjectListTest/test.fwb fwbuilder-5.1.0.3599/src/unit_tests/instDialogObjectListTest/test.fwb
--- fwbuilder-5.1.0.3599-orig/src/unit_tests/instDialogObjectListTest/test.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/src/unit_tests/instDialogObjectListTest/test.fwb	2014-07-08 16:51:11.837989088 +0200
@@ -104,14 +104,14 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
         <CustomServiceCommand platform="Undefined"></CustomServiceCommand>
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
         <ServiceGroup id="sg-DHCP" name="DHCP" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/test/iosacl/cluster-tests.fwb fwbuilder-5.1.0.3599/test/iosacl/cluster-tests.fwb
--- fwbuilder-5.1.0.3599-orig/test/iosacl/cluster-tests.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/iosacl/cluster-tests.fwb	2014-07-08 16:51:11.420994301 +0200
@@ -104,14 +104,14 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
         <CustomServiceCommand platform="Undefined"></CustomServiceCommand>
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
         <ServiceGroup id="sg-DHCP" name="DHCP" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/test/iosacl/objects-for-regression-tests.fwb fwbuilder-5.1.0.3599/test/iosacl/objects-for-regression-tests.fwb
--- fwbuilder-5.1.0.3599-orig/test/iosacl/objects-for-regression-tests.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/iosacl/objects-for-regression-tests.fwb	2014-07-08 16:51:11.396994601 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipf/objects-for-regression-tests.fwb fwbuilder-5.1.0.3599/test/ipf/objects-for-regression-tests.fwb
--- fwbuilder-5.1.0.3599-orig/test/ipf/objects-for-regression-tests.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipf/objects-for-regression-tests.fwb	2014-07-08 16:51:11.338995326 +0200
@@ -104,7 +104,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -112,7 +112,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipfw/objects-for-regression-tests.fwb fwbuilder-5.1.0.3599/test/ipfw/objects-for-regression-tests.fwb
--- fwbuilder-5.1.0.3599-orig/test/ipfw/objects-for-regression-tests.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipfw/objects-for-regression-tests.fwb	2014-07-08 16:51:11.494993376 +0200
@@ -6323,7 +6323,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
       </CustomService>
     </ServiceGroup>
     <AnyNetwork id="sysid0" name="Any" comment="Any Network" ro="False" address="0.0.0.0" netmask="0.0.0.0"/>
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/cluster-tests.fwb fwbuilder-5.1.0.3599/test/ipt/cluster-tests.fwb
--- fwbuilder-5.1.0.3599-orig/test/ipt/cluster-tests.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/cluster-tests.fwb	2014-07-08 16:51:11.025999239 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall-base-rulesets.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall-base-rulesets.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall-base-rulesets.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall-base-rulesets.fw.orig	2014-07-08 16:51:10.356007615 +0200
@@ -320,9 +320,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -336,14 +336,14 @@ script_body() {
     echo "Rule web_server_inbound 0 (global)"
     # 
     $IPTABLES -N web_server_inbound
-    $IPTABLES -A web_server_inbound -i +  -p tcp -m tcp  --dport 80  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A web_server_inbound -i +  -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule web_server_inbound 1 (global)
     # 
     echo "Rule web_server_inbound 1 (global)"
     # 
-    $IPTABLES -A web_server_inbound -i +  -p icmp  -m icmp  --icmp-type 3  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A web_server_inbound -i +  -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A web_server_inbound -i +  -p icmp  -m icmp  --icmp-type 3  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A web_server_inbound -i +  -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule web_server_inbound 2 (global)
     # 
@@ -360,14 +360,14 @@ script_body() {
     echo "Rule mail_server_inbound 0 (global)"
     # 
     $IPTABLES -N mail_server_inbound
-    $IPTABLES -A mail_server_inbound -i +  -p tcp -m tcp  --dport 25  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A mail_server_inbound -i +  -p tcp -m tcp  --dport 25  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule mail_server_inbound 1 (global)
     # 
     echo "Rule mail_server_inbound 1 (global)"
     # 
-    $IPTABLES -A mail_server_inbound -i +  -p icmp  -m icmp  --icmp-type 3  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A mail_server_inbound -i +  -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A mail_server_inbound -i +  -p icmp  -m icmp  --icmp-type 3  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A mail_server_inbound -i +  -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
     # ================ Table 'filter', rule set mail_server_outbound
     # 
     # Rule mail_server_outbound 0 (global)
@@ -375,15 +375,15 @@ script_body() {
     echo "Rule mail_server_outbound 0 (global)"
     # 
     $IPTABLES -N mail_server_outbound
-    $IPTABLES -A mail_server_outbound -o +  -p tcp -m tcp  -m multiport  --dports 53,25  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A mail_server_outbound -o +  -p udp -m udp  --dport 53  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A mail_server_outbound -o +  -p tcp -m tcp  -m multiport  --dports 53,25  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A mail_server_outbound -o +  -p udp -m udp  --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule mail_server_outbound 1 (global)
     # 
     echo "Rule mail_server_outbound 1 (global)"
     # 
-    $IPTABLES -A mail_server_outbound -o +  -p icmp  -m icmp  --icmp-type 3  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A mail_server_outbound -o +  -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A mail_server_outbound -o +  -p icmp  -m icmp  --icmp-type 3  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A mail_server_outbound -o +  -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
     # ================ Table 'filter', rule set web_server_outbound
     # 
     # Rule web_server_outbound 0 (global)
@@ -391,15 +391,15 @@ script_body() {
     echo "Rule web_server_outbound 0 (global)"
     # 
     $IPTABLES -N web_server_outbound
-    $IPTABLES -A web_server_outbound -o +  -p icmp  -m icmp  --icmp-type 3  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A web_server_outbound -o +  -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A web_server_outbound -o +  -p icmp  -m icmp  --icmp-type 3  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A web_server_outbound -o +  -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule web_server_outbound 1 (global)
     # 
     echo "Rule web_server_outbound 1 (global)"
     # 
-    $IPTABLES -A web_server_outbound -o +  -p tcp -m tcp  --dport 53  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A web_server_outbound -o +  -p udp -m udp  --dport 53  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A web_server_outbound -o +  -p tcp -m tcp  --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A web_server_outbound -o +  -p udp -m udp  --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
     # ================ Table 'filter', rule set base-ruleset
     # 
     # Rule base-ruleset 0 (global)
@@ -408,7 +408,7 @@ script_body() {
     # 
     $IPTABLES -N base-ruleset
     $IPTABLES -N Cid41961X1271.0
-    $IPTABLES -A base-ruleset -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid41961X1271.0
+    $IPTABLES -A base-ruleset -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid41961X1271.0
     $IPTABLES -A Cid41961X1271.0  -d 33.33.33.33   -j ACCEPT
     $IPTABLES -A Cid41961X1271.0  -d 172.16.1.1   -j ACCEPT
     $IPTABLES -A Cid41961X1271.0  -d 192.168.100.1   -j ACCEPT
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-1.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-1.fw.orig	2014-07-08 16:51:10.417006852 +0200
@@ -353,17 +353,17 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # backup ssh access
-    $IPTABLES -A INPUT  -p tcp -m tcp  -s 1.1.1.2/255.255.255.255  --dport 22  -m state --state NEW,ESTABLISHED -j  ACCEPT 
-    $IPTABLES -A OUTPUT  -p tcp -m tcp  -d 1.1.1.2/255.255.255.255  --sport 22  -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A INPUT  -p tcp -m tcp  -s 1.1.1.2/255.255.255.255  --dport 22  -m conntrack --ctstate NEW,ESTABLISHED -j  ACCEPT 
+    $IPTABLES -A OUTPUT  -p tcp -m tcp  -d 1.1.1.2/255.255.255.255  --sport 22  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop packets that do not match any valid state and log them
     $IPTABLES -N drop_invalid
-    $IPTABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IPTABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IPTABLES -A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix "INVALID state -- DENY "
     $IPTABLES -A drop_invalid -j DROP
 
@@ -381,7 +381,7 @@ script_body() {
     # firewall-ipv6-1:Policy:4: error: Rule '4 (global)' shadows rule '6 (global)'  below it
 
     $IPTABLES -N Cid4834D3108571.0
-    $IPTABLES -A INPUT -p tcp -m tcp  -d 1.1.1.1   --dport 22  -m state --state NEW  -j Cid4834D3108571.0
+    $IPTABLES -A INPUT -p tcp -m tcp  -d 1.1.1.1   --dport 22  -m conntrack --ctstate NEW  -j Cid4834D3108571.0
     $IPTABLES -N RULE_4
     $IPTABLES -A Cid4834D3108571.0  -s 61.150.47.112   -j RULE_4
     $IPTABLES -A Cid4834D3108571.0  -s 192.168.1.0   -j RULE_4
@@ -393,7 +393,7 @@ script_body() {
     echo "Rule 6 (global)"
     # 
     $IPTABLES -N Cid4835041F8571.0
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid4835041F8571.0
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid4835041F8571.0
     $IPTABLES -N RULE_6
     $IPTABLES -A Cid4835041F8571.0  -s 61.150.47.112   -j RULE_6
     $IPTABLES -A Cid4835041F8571.0  -s 192.168.1.0   -j RULE_6
@@ -405,7 +405,7 @@ script_body() {
     echo "Rule 7 (global)"
     # 
     $IPTABLES -N In_RULE_7
-    $IPTABLES -A INPUT  -m state --state NEW  -j In_RULE_7
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j In_RULE_7
     $IPTABLES -A In_RULE_7  -j ULOG  --ulog-nlgroup 1 --ulog-prefix "RULE 7 -- ACCEPT " --ulog-qthreshold 1
     $IPTABLES -A In_RULE_7  -j ACCEPT
     # 
@@ -414,10 +414,10 @@ script_body() {
     echo "Rule 10 (global)"
     # 
     $IPTABLES -N RULE_10
-    $IPTABLES -A INPUT  -s 61.150.47.112   -m state --state NEW  -j RULE_10
-    $IPTABLES -A INPUT  -s 192.168.1.0   -m state --state NEW  -j RULE_10
-    $IPTABLES -A FORWARD  -s 61.150.47.112   -m state --state NEW  -j RULE_10
-    $IPTABLES -A FORWARD  -s 192.168.1.0   -m state --state NEW  -j RULE_10
+    $IPTABLES -A INPUT  -s 61.150.47.112   -m conntrack --ctstate NEW  -j RULE_10
+    $IPTABLES -A INPUT  -s 192.168.1.0   -m conntrack --ctstate NEW  -j RULE_10
+    $IPTABLES -A FORWARD  -s 61.150.47.112   -m conntrack --ctstate NEW  -j RULE_10
+    $IPTABLES -A FORWARD  -s 192.168.1.0   -m conntrack --ctstate NEW  -j RULE_10
     $IPTABLES -A RULE_10  -j ULOG  --ulog-nlgroup 1 --ulog-prefix "RULE 10 -- ACCEPT " --ulog-qthreshold 1
     $IPTABLES -A RULE_10  -j ACCEPT
     # 
@@ -425,8 +425,8 @@ script_body() {
     # 
     echo "Rule 11 (global)"
     # 
-    $IPTABLES -A INPUT -p icmp  -m icmp  -s 1.1.1.1   --icmp-type 8/0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p icmp  -m icmp  -s 1.1.1.1   --icmp-type 8/0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p icmp  -m icmp  -s 1.1.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p icmp  -m icmp  -s 1.1.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 13 (global)
     # 
@@ -435,52 +435,52 @@ script_body() {
     # firewall-ipv6-1:Policy:13: error: Rule '13 (global)' shadows rule '15 (global)'  below it
     # firewall-ipv6-1:Policy:13: error: Rule '13 (global)' shadows rule '17 (global)'  below it
 
-    $IPTABLES -A OUTPUT -p icmp  -m icmp  --icmp-type any  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type any  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p icmp  -m icmp  --icmp-type any  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p icmp  -m icmp  --icmp-type any  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type any  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p icmp  -m icmp  --icmp-type any  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 15 (global)
     # 
     echo "Rule 15 (global)"
     # 
-    $IPTABLES -A OUTPUT -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 17 (global)
     # 
     echo "Rule 17 (global)"
     # 
-    $IPTABLES -A OUTPUT -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 18 (global)
     # 
     echo "Rule 18 (global)"
     # 
     # INPUT, OUTPUT, FORWARD
-    $IPTABLES -A INPUT  -s 1.1.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 1.1.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 1.1.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 19 (global)
     # 
     echo "Rule 19 (global)"
     # 
     # INPUT, OUTPUT, FORWARD
-    $IPTABLES -A OUTPUT  -d 1.1.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 1.1.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 1.1.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 20 (global)
     # 
     echo "Rule 20 (global)"
     # 
-    $IPTABLES -A OUTPUT  -d 6bone.net  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -d ny6ix.net  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 6bone.net  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d ny6ix.net  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 6bone.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d ny6ix.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 6bone.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d ny6ix.net  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 21 (global)
     # 
@@ -500,9 +500,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IP6TABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # rules to permit IPv6 Neighbor discovery
     $IP6TABLES -A INPUT  -p ipv6-icmp -m icmp6 --icmpv6-type router-solicitation -m hl --hl-eq 255 -j ACCEPT 
     $IP6TABLES -A OUTPUT -p ipv6-icmp -m icmp6 --icmpv6-type router-solicitation -m hl --hl-eq 255 -j ACCEPT 
@@ -514,9 +514,9 @@ script_body() {
     $IP6TABLES -A OUTPUT -p ipv6-icmp -m icmp6 --icmpv6-type neighbour-advertisement -m hl --hl-eq 255 -j ACCEPT 
     # drop packets that do not match any valid state and log them
     $IP6TABLES -N drop_invalid
-    $IP6TABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IP6TABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IP6TABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IP6TABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IP6TABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IP6TABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IP6TABLES -A drop_invalid -j LOG --log-level debug --log-prefix "INVALID state -- DENY "
     $IP6TABLES -A drop_invalid -j DROP
 
@@ -534,34 +534,34 @@ script_body() {
     # for bug 2047082
     # firewall-ipv6-1:Policy_ipv6:0: error: Rule 'Policy_ipv6 0 (global)' shadows rule 'Policy_ipv6 14 (global)'  below it
 
-    $IP6TABLES -A OUTPUT  -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A OUTPUT  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule Policy_ipv6 1 (global)
     # 
     echo "Rule Policy_ipv6 1 (global)"
     # 
-    $IP6TABLES -A OUTPUT  -d 6bone.net  -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A OUTPUT  -d ny6ix.net  -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A FORWARD  -d 6bone.net  -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A FORWARD  -d ny6ix.net  -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A OUTPUT  -d 6bone.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A OUTPUT  -d ny6ix.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A FORWARD  -d 6bone.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A FORWARD  -d ny6ix.net  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule Policy_ipv6 3 (global)
     # 
     echo "Rule Policy_ipv6 3 (global)"
     # 
     # INPUT, OUTPUT, FORWARD
-    $IP6TABLES -A INPUT  -s fe80::/64   -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A OUTPUT  -s fe80::/64   -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A FORWARD  -s fe80::/64   -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A INPUT  -s fe80::/64   -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A OUTPUT  -s fe80::/64   -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A FORWARD  -s fe80::/64   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule Policy_ipv6 4 (global)
     # 
     echo "Rule Policy_ipv6 4 (global)"
     # 
     # INPUT, OUTPUT, FORWARD
-    $IP6TABLES -A OUTPUT  -d fe80::/64   -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A INPUT  -d fe80::/64   -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A FORWARD  -d fe80::/64   -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A OUTPUT  -d fe80::/64   -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A INPUT  -d fe80::/64   -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A FORWARD  -d fe80::/64   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule Policy_ipv6 5 (global)
     # 
@@ -612,7 +612,7 @@ script_body() {
     # 
     # firewall-ipv6-1:Policy_ipv6:9: warning: Making rule stateless because it matches ICMPv6
 
-    $IP6TABLES -A INPUT -p tcp -m tcp  --dport 993  -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A INPUT -p tcp -m tcp  --dport 993  -m conntrack --ctstate NEW  -j ACCEPT
     $IP6TABLES -A INPUT -p ipv6-icmp  -j ACCEPT
     # 
     # Rule Policy_ipv6 10 (global)
@@ -621,8 +621,8 @@ script_body() {
     # 
     # firewall-ipv6-1:Policy_ipv6:10: warning: Making rule stateless because it matches ICMPv6
 
-    $IP6TABLES -A INPUT -p tcp -m tcp  -m multiport  --dports 3268,3269,445,42,53,88,389,636,135,139  -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A INPUT -p udp -m udp  -m multiport  --dports 53,88,138,137  -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A INPUT -p tcp -m tcp  -m multiport  --dports 3268,3269,445,42,53,88,389,636,135,139  -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A INPUT -p udp -m udp  -m multiport  --dports 53,88,138,137  -m conntrack --ctstate NEW  -j ACCEPT
     $IP6TABLES -A INPUT -p ipv6-icmp  -j ACCEPT
     # 
     # Rule Policy_ipv6 11 (global)
@@ -650,7 +650,7 @@ script_body() {
     # 
     echo "Rule Policy_ipv6 14 (global)"
     # 
-    $IP6TABLES -A OUTPUT  -s fe80::21d:9ff:fe8b:8e94   -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A OUTPUT  -s fe80::21d:9ff:fe8b:8e94   -m conntrack --ctstate NEW  -j ACCEPT
 }
 
 ip_forward() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-2.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-2.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-2.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-2.fw.orig	2014-07-08 16:51:10.586004740 +0200
@@ -381,17 +381,17 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # backup ssh access
-    $IPTABLES -A INPUT  -p tcp -m tcp  -s 1.1.1.2/255.255.255.255  --dport 22  -m state --state NEW,ESTABLISHED -j  ACCEPT 
-    $IPTABLES -A OUTPUT  -p tcp -m tcp  -d 1.1.1.2/255.255.255.255  --sport 22  -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A INPUT  -p tcp -m tcp  -s 1.1.1.2/255.255.255.255  --dport 22  -m conntrack --ctstate NEW,ESTABLISHED -j  ACCEPT 
+    $IPTABLES -A OUTPUT  -p tcp -m tcp  -d 1.1.1.2/255.255.255.255  --sport 22  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop packets that do not match any valid state and log them
     $IPTABLES -N drop_invalid
-    $IPTABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IPTABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IPTABLES -A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix "INVALID state -- DENY "
     $IPTABLES -A drop_invalid -j DROP
 
@@ -409,7 +409,7 @@ script_body() {
     # firewall-ipv6-2:Policy:4: error: Rule '4 (global)' shadows rule '6 (global)'  below it
 
     $IPTABLES -N Cid56136X87590.0
-    $IPTABLES -A INPUT -p tcp -m tcp  -d 1.1.1.1   --dport 22  -m state --state NEW  -j Cid56136X87590.0
+    $IPTABLES -A INPUT -p tcp -m tcp  -d 1.1.1.1   --dport 22  -m conntrack --ctstate NEW  -j Cid56136X87590.0
     $IPTABLES -N RULE_4
     $IPTABLES -A Cid56136X87590.0  -s 61.150.47.112   -j RULE_4
     $IPTABLES -A Cid56136X87590.0  -s 192.168.1.0   -j RULE_4
@@ -421,7 +421,7 @@ script_body() {
     echo "Rule 6 (global)"
     # 
     $IPTABLES -N Cid56160X87590.0
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid56160X87590.0
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid56160X87590.0
     $IPTABLES -N RULE_6
     $IPTABLES -A Cid56160X87590.0  -s 61.150.47.112   -j RULE_6
     $IPTABLES -A Cid56160X87590.0  -s 192.168.1.0   -j RULE_6
@@ -436,7 +436,7 @@ script_body() {
     # firewall-ipv6-2:Policy:7: error: Rule '7 (global)' shadows rule '28 (global)'  below it
 
     $IPTABLES -N In_RULE_7
-    $IPTABLES -A INPUT  -m state --state NEW  -j In_RULE_7
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j In_RULE_7
     $IPTABLES -A In_RULE_7  -j ULOG  --ulog-nlgroup 1 --ulog-prefix "RULE 7 -- ACCEPT " --ulog-qthreshold 1
     $IPTABLES -A In_RULE_7  -j ACCEPT
     # 
@@ -446,25 +446,25 @@ script_body() {
     # 
     # firewall-ipv6-2:Policy:8: error: Rule '8 (global)' shadows rule '9 (global)'  below it
 
-    $IPTABLES -A OUTPUT  -d 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 192.168.1.1   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 9 (global)
     # 
     echo "Rule 9 (global)"
     # 
-    $IPTABLES -A OUTPUT  -d 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 192.168.1.1   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 12 (global)
     # 
     echo "Rule 12 (global)"
     # 
     $IPTABLES -N RULE_12
-    $IPTABLES -A INPUT  -s 61.150.47.112   -m state --state NEW  -j RULE_12
-    $IPTABLES -A INPUT  -s 192.168.1.0   -m state --state NEW  -j RULE_12
-    $IPTABLES -A FORWARD  -s 61.150.47.112   -m state --state NEW  -j RULE_12
-    $IPTABLES -A FORWARD  -s 192.168.1.0   -m state --state NEW  -j RULE_12
+    $IPTABLES -A INPUT  -s 61.150.47.112   -m conntrack --ctstate NEW  -j RULE_12
+    $IPTABLES -A INPUT  -s 192.168.1.0   -m conntrack --ctstate NEW  -j RULE_12
+    $IPTABLES -A FORWARD  -s 61.150.47.112   -m conntrack --ctstate NEW  -j RULE_12
+    $IPTABLES -A FORWARD  -s 192.168.1.0   -m conntrack --ctstate NEW  -j RULE_12
     $IPTABLES -A RULE_12  -j ULOG  --ulog-nlgroup 1 --ulog-prefix "RULE 12 -- ACCEPT " --ulog-qthreshold 1
     $IPTABLES -A RULE_12  -j ACCEPT
     # 
@@ -472,8 +472,8 @@ script_body() {
     # 
     echo "Rule 13 (global)"
     # 
-    $IPTABLES -A INPUT -p icmp  -m icmp  -s 1.1.1.1   --icmp-type 8/0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p icmp  -m icmp  -s 1.1.1.1   --icmp-type 8/0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p icmp  -m icmp  -s 1.1.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p icmp  -m icmp  -s 1.1.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 15 (global)
     # 
@@ -482,25 +482,25 @@ script_body() {
     # firewall-ipv6-2:Policy:15: error: Rule '15 (global)' shadows rule '17 (global)'  below it
     # firewall-ipv6-2:Policy:15: error: Rule '15 (global)' shadows rule '19 (global)'  below it
 
-    $IPTABLES -A OUTPUT -p icmp  -m icmp  --icmp-type any  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type any  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p icmp  -m icmp  --icmp-type any  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p icmp  -m icmp  --icmp-type any  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type any  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p icmp  -m icmp  --icmp-type any  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 17 (global)
     # 
     echo "Rule 17 (global)"
     # 
-    $IPTABLES -A OUTPUT -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 19 (global)
     # 
     echo "Rule 19 (global)"
     # 
-    $IPTABLES -A OUTPUT -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 20 (global)
     # 
@@ -510,34 +510,34 @@ script_body() {
     # firewall-ipv6-2:Policy:20: error: Rule '20 (global)' shadows rule '22 (global)'  below it
     # firewall-ipv6-2:Policy:20: error: Rule '20 (global)' shadows rule '30 (global)'  below it
 
-    $IPTABLES -A INPUT  -s 1.1.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 1.1.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 1.1.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 21 (global)
     # 
     echo "Rule 21 (global)"
     # 
     # INPUT, OUTPUT, FORWARD
-    $IPTABLES -A OUTPUT  -d 1.1.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 1.1.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 1.1.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 22 (global)
     # 
     echo "Rule 22 (global)"
     # 
     # for bug 2047082
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 23 (global)
     # 
     echo "Rule 23 (global)"
     # 
-    $IPTABLES -A OUTPUT  -d 6bone.net  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -d ny6ix.net  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 6bone.net  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d ny6ix.net  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 6bone.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d ny6ix.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 6bone.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d ny6ix.net  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 24 (global)
     # 
@@ -555,7 +555,7 @@ script_body() {
     # 
     echo "Rule 30 (global)"
     # 
-    $IPTABLES -A OUTPUT  -s 1.1.1.1   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 1.1.1.1   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 32 (global)
     # 
@@ -612,14 +612,14 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IP6TABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop packets that do not match any valid state and log them
     $IP6TABLES -N drop_invalid
-    $IP6TABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IP6TABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IP6TABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IP6TABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IP6TABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IP6TABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IP6TABLES -A drop_invalid -j LOG --log-level debug --log-prefix "INVALID state -- DENY "
     $IP6TABLES -A drop_invalid -j DROP
 
@@ -637,7 +637,7 @@ script_body() {
     # this rule shadows the next.
     # Note that we add command line
     # flag -xt to the compiler
-    $IP6TABLES -A INPUT -p tcp -m tcp  -s fe80::/64   -d fe80::21d:9ff:fe8b:8e94   --dport 22  -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A INPUT -p tcp -m tcp  -s fe80::/64   -d fe80::21d:9ff:fe8b:8e94   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (global)
     # 
@@ -648,7 +648,7 @@ script_body() {
     # firewall-ipv6-2:Policy:1: error: Rule '1 (global)' shadows rule '5 (global)'  below it
     # firewall-ipv6-2:Policy:1: error: Rule '1 (global)' shadows rule '6 (global)'  below it
 
-    $IP6TABLES -A INPUT -p tcp -m tcp  -s 2001:5c0:0:2::24   -d fe80::21d:9ff:fe8b:8e94   --dport 22  -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A INPUT -p tcp -m tcp  -s 2001:5c0:0:2::24   -d fe80::21d:9ff:fe8b:8e94   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (global)
     # 
@@ -660,7 +660,7 @@ script_body() {
     # firewall-ipv6-2:Policy:2: error: Rule '2 (global)' shadows rule '6 (global)'  below it
 
     $IP6TABLES -N RULE_2
-    $IP6TABLES -A INPUT -p tcp -m tcp  -s 3ffe:1200:2001:1:8000::1   --dport 22  -m state --state NEW  -j RULE_2
+    $IP6TABLES -A INPUT -p tcp -m tcp  -s 3ffe:1200:2001:1:8000::1   --dport 22  -m conntrack --ctstate NEW  -j RULE_2
     $IP6TABLES -A RULE_2  -j LOG  --log-level info --log-prefix "RULE 2 -- ACCEPT "
     $IP6TABLES -A RULE_2  -j ACCEPT
     # 
@@ -671,7 +671,7 @@ script_body() {
     # firewall-ipv6-2:Policy:3: error: Rule '3 (global)' shadows rule '5 (global)'  below it
 
     $IP6TABLES -N Cid56124X87590.0
-    $IP6TABLES -A INPUT -p tcp -m tcp  -d fe80::21d:9ff:fe8b:8e94   --dport 22  -m state --state NEW  -j Cid56124X87590.0
+    $IP6TABLES -A INPUT -p tcp -m tcp  -d fe80::21d:9ff:fe8b:8e94   --dport 22  -m conntrack --ctstate NEW  -j Cid56124X87590.0
     $IP6TABLES -N RULE_3
     $IP6TABLES -A Cid56124X87590.0  -s 2001:5c0:0:2::24   -j RULE_3
     $IP6TABLES -A Cid56124X87590.0  -s 3ffe:1200:2000::/36   -j RULE_3
@@ -684,7 +684,7 @@ script_body() {
     echo "Rule 4 (global)"
     # 
     $IP6TABLES -N Cid56136X87590.0
-    $IP6TABLES -A INPUT -p tcp -m tcp  -d fe80::21d:9ff:fe8b:8e94   --dport 22  -m state --state NEW  -j Cid56136X87590.0
+    $IP6TABLES -A INPUT -p tcp -m tcp  -d fe80::21d:9ff:fe8b:8e94   --dport 22  -m conntrack --ctstate NEW  -j Cid56136X87590.0
     $IP6TABLES -N RULE_4
     $IP6TABLES -A Cid56136X87590.0  -s 2001:5c0:0:2::24   -j RULE_4
     $IP6TABLES -A Cid56136X87590.0  -s 3ffe:1200:2001:1:8000::1   -j RULE_4
@@ -696,7 +696,7 @@ script_body() {
     echo "Rule 5 (global)"
     # 
     $IP6TABLES -N Cid56148X87590.0
-    $IP6TABLES -A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid56148X87590.0
+    $IP6TABLES -A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid56148X87590.0
     $IP6TABLES -N RULE_5
     $IP6TABLES -A Cid56148X87590.0  -s 2001:5c0:0:2::24   -j RULE_5
     $IP6TABLES -A Cid56148X87590.0  -s 3ffe:1200:2000::/36   -j RULE_5
@@ -709,7 +709,7 @@ script_body() {
     echo "Rule 6 (global)"
     # 
     $IP6TABLES -N Cid56160X87590.0
-    $IP6TABLES -A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid56160X87590.0
+    $IP6TABLES -A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid56160X87590.0
     $IP6TABLES -N RULE_6
     $IP6TABLES -A Cid56160X87590.0  -s 2001:5c0:0:2::24   -j RULE_6
     $IP6TABLES -A Cid56160X87590.0  -s 3ffe:1200:2001:1:8000::1   -j RULE_6
@@ -724,7 +724,7 @@ script_body() {
     # firewall-ipv6-2:Policy:7: error: Rule '7 (global)' shadows rule '28 (global)'  below it
 
     $IP6TABLES -N In_RULE_7
-    $IP6TABLES -A INPUT  -m state --state NEW  -j In_RULE_7
+    $IP6TABLES -A INPUT  -m conntrack --ctstate NEW  -j In_RULE_7
     $IP6TABLES -A In_RULE_7  -j LOG  --log-level info --log-prefix "RULE 7 -- ACCEPT "
     $IP6TABLES -A In_RULE_7  -j ACCEPT
     # 
@@ -734,15 +734,15 @@ script_body() {
     # 
     # firewall-ipv6-2:Policy:8: error: Rule '8 (global)' shadows rule '9 (global)'  below it
 
-    $IP6TABLES -A OUTPUT  -d e80::21d:9ff:fe8b:8e94   -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A FORWARD  -d e80::21d:9ff:fe8b:8e94   -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A OUTPUT  -d e80::21d:9ff:fe8b:8e94   -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A FORWARD  -d e80::21d:9ff:fe8b:8e94   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 9 (global)
     # 
     echo "Rule 9 (global)"
     # 
-    $IP6TABLES -A OUTPUT  -d e80::21d:9ff:fe8b:8e94   -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A FORWARD  -d e80::21d:9ff:fe8b:8e94   -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A OUTPUT  -d e80::21d:9ff:fe8b:8e94   -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A FORWARD  -d e80::21d:9ff:fe8b:8e94   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 10 (global)
     # 
@@ -751,9 +751,9 @@ script_body() {
     # firewall-ipv6-2:Policy:10: error: Rule '10 (global)' shadows rule '25 (global)'  below it
 
     $IP6TABLES -N RULE_10
-    $IP6TABLES -A INPUT  -s fe80::/64   -m state --state NEW  -j RULE_10
-    $IP6TABLES -A OUTPUT  -s fe80::/64   -m state --state NEW  -j RULE_10
-    $IP6TABLES -A FORWARD  -s fe80::/64   -m state --state NEW  -j RULE_10
+    $IP6TABLES -A INPUT  -s fe80::/64   -m conntrack --ctstate NEW  -j RULE_10
+    $IP6TABLES -A OUTPUT  -s fe80::/64   -m conntrack --ctstate NEW  -j RULE_10
+    $IP6TABLES -A FORWARD  -s fe80::/64   -m conntrack --ctstate NEW  -j RULE_10
     $IP6TABLES -A RULE_10  -j LOG  --log-level info --log-prefix "RULE 10 -- ACCEPT "
     $IP6TABLES -A RULE_10  -j ACCEPT
     # 
@@ -764,12 +764,12 @@ script_body() {
     # firewall-ipv6-2:Policy:11: error: Rule '11 (global)' shadows rule '12 (global)'  below it
 
     $IP6TABLES -N RULE_11
-    $IP6TABLES -A INPUT  -s 2001:5c0:0:2::24   -m state --state NEW  -j RULE_11
-    $IP6TABLES -A INPUT  -s 3ffe:1200:2000::/36   -m state --state NEW  -j RULE_11
-    $IP6TABLES -A INPUT  -s 3ffe:1200:2001:1:8000::1   -m state --state NEW  -j RULE_11
-    $IP6TABLES -A FORWARD  -s 2001:5c0:0:2::24   -m state --state NEW  -j RULE_11
-    $IP6TABLES -A FORWARD  -s 3ffe:1200:2000::/36   -m state --state NEW  -j RULE_11
-    $IP6TABLES -A FORWARD  -s 3ffe:1200:2001:1:8000::1   -m state --state NEW  -j RULE_11
+    $IP6TABLES -A INPUT  -s 2001:5c0:0:2::24   -m conntrack --ctstate NEW  -j RULE_11
+    $IP6TABLES -A INPUT  -s 3ffe:1200:2000::/36   -m conntrack --ctstate NEW  -j RULE_11
+    $IP6TABLES -A INPUT  -s 3ffe:1200:2001:1:8000::1   -m conntrack --ctstate NEW  -j RULE_11
+    $IP6TABLES -A FORWARD  -s 2001:5c0:0:2::24   -m conntrack --ctstate NEW  -j RULE_11
+    $IP6TABLES -A FORWARD  -s 3ffe:1200:2000::/36   -m conntrack --ctstate NEW  -j RULE_11
+    $IP6TABLES -A FORWARD  -s 3ffe:1200:2001:1:8000::1   -m conntrack --ctstate NEW  -j RULE_11
     $IP6TABLES -A RULE_11  -j LOG  --log-level info --log-prefix "RULE 11 -- ACCEPT "
     $IP6TABLES -A RULE_11  -j ACCEPT
     # 
@@ -778,10 +778,10 @@ script_body() {
     echo "Rule 12 (global)"
     # 
     $IP6TABLES -N RULE_12
-    $IP6TABLES -A INPUT  -s 2001:5c0:0:2::24   -m state --state NEW  -j RULE_12
-    $IP6TABLES -A INPUT  -s 3ffe:1200:2001:1:8000::1   -m state --state NEW  -j RULE_12
-    $IP6TABLES -A FORWARD  -s 2001:5c0:0:2::24   -m state --state NEW  -j RULE_12
-    $IP6TABLES -A FORWARD  -s 3ffe:1200:2001:1:8000::1   -m state --state NEW  -j RULE_12
+    $IP6TABLES -A INPUT  -s 2001:5c0:0:2::24   -m conntrack --ctstate NEW  -j RULE_12
+    $IP6TABLES -A INPUT  -s 3ffe:1200:2001:1:8000::1   -m conntrack --ctstate NEW  -j RULE_12
+    $IP6TABLES -A FORWARD  -s 2001:5c0:0:2::24   -m conntrack --ctstate NEW  -j RULE_12
+    $IP6TABLES -A FORWARD  -s 3ffe:1200:2001:1:8000::1   -m conntrack --ctstate NEW  -j RULE_12
     $IP6TABLES -A RULE_12  -j LOG  --log-level info --log-prefix "RULE 12 -- ACCEPT "
     $IP6TABLES -A RULE_12  -j ACCEPT
     # 
@@ -825,34 +825,34 @@ script_body() {
     # for bug 2047082
     # firewall-ipv6-2:Policy:22: error: Rule '22 (global)' shadows rule '30 (global)'  below it
 
-    $IP6TABLES -A OUTPUT  -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A OUTPUT  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 23 (global)
     # 
     echo "Rule 23 (global)"
     # 
-    $IP6TABLES -A OUTPUT  -d 6bone.net  -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A OUTPUT  -d ny6ix.net  -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A FORWARD  -d 6bone.net  -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A FORWARD  -d ny6ix.net  -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A OUTPUT  -d 6bone.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A OUTPUT  -d ny6ix.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A FORWARD  -d 6bone.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A FORWARD  -d ny6ix.net  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 25 (global)
     # 
     echo "Rule 25 (global)"
     # 
     # INPUT, OUTPUT, FORWARD
-    $IP6TABLES -A INPUT  -s fe80::/64   -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A OUTPUT  -s fe80::/64   -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A FORWARD  -s fe80::/64   -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A INPUT  -s fe80::/64   -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A OUTPUT  -s fe80::/64   -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A FORWARD  -s fe80::/64   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 26 (global)
     # 
     echo "Rule 26 (global)"
     # 
     # INPUT, OUTPUT, FORWARD
-    $IP6TABLES -A OUTPUT  -d fe80::/64   -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A INPUT  -d fe80::/64   -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A FORWARD  -d fe80::/64   -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A OUTPUT  -d fe80::/64   -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A INPUT  -d fe80::/64   -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A FORWARD  -d fe80::/64   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 27 (global)
     # 
@@ -885,7 +885,7 @@ script_body() {
     # 
     echo "Rule 30 (global)"
     # 
-    $IP6TABLES -A OUTPUT  -s fe80::21d:9ff:fe8b:8e94   -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A OUTPUT  -s fe80::21d:9ff:fe8b:8e94   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 31 (global)
     # 
@@ -929,8 +929,8 @@ reset_all() {
 block_action() {
     reset_all
     # backup ssh access
-    $IPTABLES -A INPUT  -p tcp -m tcp  -s 1.1.1.2/255.255.255.255  --dport 22  -m state --state NEW,ESTABLISHED -j  ACCEPT
-    $IPTABLES -A OUTPUT  -p tcp -m tcp  -d 1.1.1.2/255.255.255.255  --sport 22  -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT  -p tcp -m tcp  -s 1.1.1.2/255.255.255.255  --dport 22  -m conntrack --ctstate NEW,ESTABLISHED -j  ACCEPT
+    $IPTABLES -A OUTPUT  -p tcp -m tcp  -d 1.1.1.2/255.255.255.255  --sport 22  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 }
 
 stop_action() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-3.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-3.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-3.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-3.fw.orig	2014-07-08 16:51:10.626004240 +0200
@@ -331,14 +331,14 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop packets that do not match any valid state and log them
     $IPTABLES -N drop_invalid
-    $IPTABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IPTABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IPTABLES -A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix "INVALID state -- DENY "
     $IPTABLES -A drop_invalid -j DROP
 
@@ -360,7 +360,7 @@ script_body() {
     echo "Rule fw-ipv6-3 0 (global)"
     # 
     $IPTABLES -N In_fw-ipv6-3_0
-    $IPTABLES -A INPUT  -m state --state NEW  -j In_fw-ipv6-3_0
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j In_fw-ipv6-3_0
     $IPTABLES -A In_fw-ipv6-3_0  -j ULOG  --ulog-nlgroup 1 --ulog-prefix "RULE 0 -- ACCEPT " --ulog-qthreshold 1
     $IPTABLES -A In_fw-ipv6-3_0  -j ACCEPT
     # 
@@ -368,8 +368,8 @@ script_body() {
     # 
     echo "Rule fw-ipv6-3 1 (global)"
     # 
-    $IPTABLES -A INPUT -p icmp  -m icmp  -s 1.1.1.1   --icmp-type 8/0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p icmp  -m icmp  -s 1.1.1.1   --icmp-type 8/0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p icmp  -m icmp  -s 1.1.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p icmp  -m icmp  -s 1.1.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule fw-ipv6-3 2 (global)
     # 
@@ -377,17 +377,17 @@ script_body() {
     # 
     # firewall-ipv6-3:fw-ipv6-3:2: error: Rule 'fw-ipv6-3 2 (global)' shadows rule 'fw-ipv6-3 3 (global)'  below it
 
-    $IPTABLES -A OUTPUT -p icmp  -m icmp  --icmp-type any  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type any  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p icmp  -m icmp  --icmp-type any  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p icmp  -m icmp  --icmp-type any  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type any  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p icmp  -m icmp  --icmp-type any  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule fw-ipv6-3 3 (global)
     # 
     echo "Rule fw-ipv6-3 3 (global)"
     # 
-    $IPTABLES -A OUTPUT -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule fw-ipv6-3 4 (global)
     # 
@@ -396,34 +396,34 @@ script_body() {
     # INPUT, OUTPUT, FORWARD
     # firewall-ipv6-3:fw-ipv6-3:4: error: Rule 'fw-ipv6-3 4 (global)' shadows rule 'fw-ipv6-3 6 (global)'  below it
 
-    $IPTABLES -A INPUT  -s 1.1.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 1.1.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 1.1.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule fw-ipv6-3 5 (global)
     # 
     echo "Rule fw-ipv6-3 5 (global)"
     # 
     # INPUT, OUTPUT, FORWARD
-    $IPTABLES -A OUTPUT  -d 1.1.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 1.1.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 1.1.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule fw-ipv6-3 6 (global)
     # 
     echo "Rule fw-ipv6-3 6 (global)"
     # 
     # for bug 2047082
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule fw-ipv6-3 7 (global)
     # 
     echo "Rule fw-ipv6-3 7 (global)"
     # 
-    $IPTABLES -A OUTPUT  -d 6bone.net  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -d ny6ix.net  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 6bone.net  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d ny6ix.net  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 6bone.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d ny6ix.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 6bone.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d ny6ix.net  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule fw-ipv6-3 8 (global)
     # 
@@ -492,14 +492,14 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IP6TABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop packets that do not match any valid state and log them
     $IP6TABLES -N drop_invalid
-    $IP6TABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IP6TABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IP6TABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IP6TABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IP6TABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IP6TABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IP6TABLES -A drop_invalid -j LOG --log-level debug --log-prefix "INVALID state -- DENY "
     $IP6TABLES -A drop_invalid -j DROP
 
@@ -515,7 +515,7 @@ script_body() {
     echo "Rule fw-ipv6-3 0 (global)"
     # 
     $IP6TABLES -N In_fw-ipv6-3_0
-    $IP6TABLES -A INPUT  -m state --state NEW  -j In_fw-ipv6-3_0
+    $IP6TABLES -A INPUT  -m conntrack --ctstate NEW  -j In_fw-ipv6-3_0
     $IP6TABLES -A In_fw-ipv6-3_0  -j LOG  --log-level info --log-prefix "RULE 0 -- ACCEPT "
     $IP6TABLES -A In_fw-ipv6-3_0  -j ACCEPT
     # 
@@ -524,16 +524,16 @@ script_body() {
     echo "Rule fw-ipv6-3 6 (global)"
     # 
     # for bug 2047082
-    $IP6TABLES -A OUTPUT  -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A OUTPUT  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule fw-ipv6-3 7 (global)
     # 
     echo "Rule fw-ipv6-3 7 (global)"
     # 
-    $IP6TABLES -A OUTPUT  -d 6bone.net  -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A OUTPUT  -d ny6ix.net  -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A FORWARD  -d 6bone.net  -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A FORWARD  -d ny6ix.net  -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A OUTPUT  -d 6bone.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A OUTPUT  -d ny6ix.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A FORWARD  -d 6bone.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A FORWARD  -d ny6ix.net  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule fw-ipv6-3 11 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-4-1.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-4-1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-4-1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-4-1.fw.orig	2014-07-08 16:51:10.396007115 +0200
@@ -343,53 +343,53 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # drop packets that do not match any valid state and log them
     echo ":drop_invalid - [0:0]"
-    echo "-A OUTPUT   -m state --state INVALID  -j drop_invalid "
-    echo "-A INPUT    -m state --state INVALID  -j drop_invalid "
-    echo "-A FORWARD  -m state --state INVALID  -j drop_invalid "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid "
     echo "-A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix \"INVALID state -- DENY \""
     echo "-A drop_invalid -j DROP "
     # ================ Table 'filter', rule set Policy
     # 
     # Rule  0 (global)
     echo ":In_RULE_0 - [0:0]"
-    echo "-A INPUT  -m state --state NEW  -j In_RULE_0 "
+    echo "-A INPUT  -m conntrack --ctstate NEW  -j In_RULE_0 "
     echo "-A In_RULE_0  -j ULOG  --ulog-nlgroup 1 --ulog-prefix \"RULE 0 -- ACCEPT \" --ulog-qthreshold 1 "
     echo "-A In_RULE_0  -j ACCEPT "
     # 
     # Rule  1 (global)
-    echo "-A OUTPUT -p icmp  -m icmp  -s 1.1.1.1   --icmp-type 8/0   -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT -p icmp  -m icmp  -s 1.1.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  2 (global)
     # firewall-ipv6-4-1:Policy:2: error: Rule '2 (global)' shadows rule '3 (global)'  below it
 
-    echo "-A FORWARD -p icmp  -m icmp  --icmp-type any  -m state --state NEW  -j ACCEPT "
+    echo "-A FORWARD -p icmp  -m icmp  --icmp-type any  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  3 (global)
-    echo "-A FORWARD -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT "
+    echo "-A FORWARD -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  4 (global)
     # INPUT, OUTPUT, FORWARD
     # firewall-ipv6-4-1:Policy:4: error: Rule '4 (global)' shadows rule '6 (global)'  below it
 
-    echo "-A FORWARD  -s 1.1.1.0/24   -m state --state NEW  -j ACCEPT "
+    echo "-A FORWARD  -s 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  5 (global)
     # INPUT, OUTPUT, FORWARD
-    echo "-A FORWARD  -d 1.1.1.0/24   -m state --state NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  6 (global)
     # for bug 2047082
     # 
-    echo "-A OUTPUT  -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  7 (global)
-    echo "-A FORWARD  -d 6bone.net  -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d ny6ix.net  -m state --state NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 6bone.net  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d ny6ix.net  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  8 (global)
     echo ":RULE_8 - [0:0]"
@@ -400,11 +400,11 @@ script_body() {
     # 
     # Rule  9 (global)
     # ipv4 address range for bug 2820152
-    echo "-A FORWARD -m iprange --dst-range 192.168.1.1-192.168.1.100  -m state --state NEW  -j ACCEPT "
+    echo "-A FORWARD -m iprange --dst-range 192.168.1.1-192.168.1.100  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  10 (global)
     # ipv4 address range for bug 2820152
-    echo "-A INPUT  -d 255.255.255.255   -m state --state NEW  -j ACCEPT "
+    echo "-A INPUT  -d 255.255.255.255   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  11 (global)
     echo ":RULE_11 - [0:0]"
@@ -446,32 +446,32 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # drop packets that do not match any valid state and log them
     echo ":drop_invalid - [0:0]"
-    echo "-A OUTPUT   -m state --state INVALID  -j drop_invalid "
-    echo "-A INPUT    -m state --state INVALID  -j drop_invalid "
-    echo "-A FORWARD  -m state --state INVALID  -j drop_invalid "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid "
     echo "-A drop_invalid -j LOG --log-level debug --log-prefix \"INVALID state -- DENY \""
     echo "-A drop_invalid -j DROP "
     # ================ Table 'filter', rule set Policy
     # 
     # Rule  0 (global)
     echo ":In_RULE_0 - [0:0]"
-    echo "-A INPUT  -m state --state NEW  -j In_RULE_0 "
+    echo "-A INPUT  -m conntrack --ctstate NEW  -j In_RULE_0 "
     echo "-A In_RULE_0  -j LOG  --log-level info --log-prefix \"RULE 0 -- ACCEPT \""
     echo "-A In_RULE_0  -j ACCEPT "
     # 
     # Rule  6 (global)
     # for bug 2047082
     # 
-    echo "-A OUTPUT  -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  7 (global)
-    echo "-A FORWARD  -d 6bone.net  -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d ny6ix.net  -m state --state NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 6bone.net  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d ny6ix.net  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  11 (global)
     echo ":RULE_11 - [0:0]"
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-4.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-4.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-4.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-4.fw.orig	2014-07-08 16:51:10.380007315 +0200
@@ -343,64 +343,64 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # drop packets that do not match any valid state and log them
     echo ":drop_invalid - [0:0]"
-    echo "-A OUTPUT   -m state --state INVALID  -j drop_invalid "
-    echo "-A INPUT    -m state --state INVALID  -j drop_invalid "
-    echo "-A FORWARD  -m state --state INVALID  -j drop_invalid "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid "
     echo "-A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix \"INVALID state -- DENY \""
     echo "-A drop_invalid -j DROP "
     # ================ Table 'filter', rule set Policy
     # 
     # Rule  0 (global)
     echo ":In_RULE_0 - [0:0]"
-    echo "-A INPUT  -m state --state NEW  -j In_RULE_0 "
+    echo "-A INPUT  -m conntrack --ctstate NEW  -j In_RULE_0 "
     echo "-A In_RULE_0  -j ULOG  --ulog-nlgroup 1 --ulog-prefix \"RULE 0 -- ACCEPT \" --ulog-qthreshold 1 "
     echo "-A In_RULE_0  -j ACCEPT "
     # 
     # Rule  1 (global)
-    echo "-A INPUT -p icmp  -m icmp  -s 1.1.1.1   --icmp-type 8/0   -m state --state NEW  -j ACCEPT "
-    echo "-A OUTPUT -p icmp  -m icmp  -s 1.1.1.1   --icmp-type 8/0   -m state --state NEW  -j ACCEPT "
+    echo "-A INPUT -p icmp  -m icmp  -s 1.1.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A OUTPUT -p icmp  -m icmp  -s 1.1.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  2 (global)
     # firewall-ipv6-4:Policy:2: error: Rule '2 (global)' shadows rule '3 (global)'  below it
 
-    echo "-A OUTPUT -p icmp  -m icmp  --icmp-type any  -m state --state NEW  -j ACCEPT "
-    echo "-A INPUT -p icmp  -m icmp  --icmp-type any  -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD -p icmp  -m icmp  --icmp-type any  -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT -p icmp  -m icmp  --icmp-type any  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A INPUT -p icmp  -m icmp  --icmp-type any  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD -p icmp  -m icmp  --icmp-type any  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  3 (global)
-    echo "-A OUTPUT -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT "
-    echo "-A INPUT -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A INPUT -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  4 (global)
     # INPUT, OUTPUT, FORWARD
     # firewall-ipv6-4:Policy:4: error: Rule '4 (global)' shadows rule '6 (global)'  below it
 
-    echo "-A INPUT  -s 1.1.1.0/24   -m state --state NEW  -j ACCEPT "
-    echo "-A OUTPUT  -s 1.1.1.0/24   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -s 1.1.1.0/24   -m state --state NEW  -j ACCEPT "
+    echo "-A INPUT  -s 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A OUTPUT  -s 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -s 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  5 (global)
     # INPUT, OUTPUT, FORWARD
-    echo "-A OUTPUT  -d 1.1.1.0/24   -m state --state NEW  -j ACCEPT "
-    echo "-A INPUT  -d 1.1.1.0/24   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d 1.1.1.0/24   -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A INPUT  -d 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 1.1.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  6 (global)
     # for bug 2047082
     # 
-    echo "-A OUTPUT  -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  7 (global)
-    echo "-A OUTPUT  -d 6bone.net  -m state --state NEW  -j ACCEPT "
-    echo "-A OUTPUT  -d ny6ix.net  -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d 6bone.net  -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d ny6ix.net  -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 6bone.net  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d ny6ix.net  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 6bone.net  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d ny6ix.net  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  8 (global)
     echo ":RULE_8 - [0:0]"
@@ -413,29 +413,29 @@ script_body() {
     # 
     # Rule  9 (global)
     # ipv4 address range for bug 2820152
-    echo "-A OUTPUT  -d 192.168.1.1   -m state --state NEW  -j ACCEPT "
-    echo "-A OUTPUT  -d 192.168.1.2/31   -m state --state NEW  -j ACCEPT "
-    echo "-A OUTPUT  -d 192.168.1.4/30   -m state --state NEW  -j ACCEPT "
-    echo "-A OUTPUT  -d 192.168.1.8/29   -m state --state NEW  -j ACCEPT "
-    echo "-A OUTPUT  -d 192.168.1.16/28   -m state --state NEW  -j ACCEPT "
-    echo "-A OUTPUT  -d 192.168.1.32/27   -m state --state NEW  -j ACCEPT "
-    echo "-A OUTPUT  -d 192.168.1.64/27   -m state --state NEW  -j ACCEPT "
-    echo "-A OUTPUT  -d 192.168.1.96/30   -m state --state NEW  -j ACCEPT "
-    echo "-A OUTPUT  -d 192.168.1.100   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d 192.168.1.1   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d 192.168.1.2/31   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d 192.168.1.4/30   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d 192.168.1.8/29   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d 192.168.1.16/28   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d 192.168.1.32/27   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d 192.168.1.64/27   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d 192.168.1.96/30   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d 192.168.1.100   -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 192.168.1.2/31   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 192.168.1.4/30   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 192.168.1.8/29   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 192.168.1.16/28   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 192.168.1.32/27   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 192.168.1.64/27   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 192.168.1.96/30   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 192.168.1.100   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 192.168.1.2/31   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 192.168.1.4/30   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 192.168.1.8/29   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 192.168.1.16/28   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 192.168.1.32/27   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 192.168.1.64/27   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 192.168.1.96/30   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 192.168.1.100   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  10 (global)
     # ipv4 address range for bug 2820152
-    echo "-A OUTPUT  -d 255.255.255.255   -m state --state NEW  -j ACCEPT "
-    echo "-A INPUT  -d 255.255.255.255   -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 255.255.255.255   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A INPUT  -d 255.255.255.255   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  11 (global)
     echo ":RULE_11 - [0:0]"
@@ -479,34 +479,34 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # drop packets that do not match any valid state and log them
     echo ":drop_invalid - [0:0]"
-    echo "-A OUTPUT   -m state --state INVALID  -j drop_invalid "
-    echo "-A INPUT    -m state --state INVALID  -j drop_invalid "
-    echo "-A FORWARD  -m state --state INVALID  -j drop_invalid "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid "
     echo "-A drop_invalid -j LOG --log-level debug --log-prefix \"INVALID state -- DENY \""
     echo "-A drop_invalid -j DROP "
     # ================ Table 'filter', rule set Policy
     # 
     # Rule  0 (global)
     echo ":In_RULE_0 - [0:0]"
-    echo "-A INPUT  -m state --state NEW  -j In_RULE_0 "
+    echo "-A INPUT  -m conntrack --ctstate NEW  -j In_RULE_0 "
     echo "-A In_RULE_0  -j LOG  --log-level info --log-prefix \"RULE 0 -- ACCEPT \""
     echo "-A In_RULE_0  -j ACCEPT "
     # 
     # Rule  6 (global)
     # for bug 2047082
     # 
-    echo "-A OUTPUT  -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  7 (global)
-    echo "-A OUTPUT  -d 6bone.net  -m state --state NEW  -j ACCEPT "
-    echo "-A OUTPUT  -d ny6ix.net  -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d 6bone.net  -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d ny6ix.net  -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 6bone.net  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d ny6ix.net  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 6bone.net  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d ny6ix.net  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  11 (global)
     echo ":RULE_11 - [0:0]"
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-5.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-5.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-5.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-5.fw.orig	2014-07-08 16:51:10.471006177 +0200
@@ -323,9 +323,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -352,9 +352,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IP6TABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IP6TABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-6.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-6.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-6.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-6.fw.orig	2014-07-08 16:51:10.974999877 +0200
@@ -331,9 +331,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -354,9 +354,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IP6TABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IP6TABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-7.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-7.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-7.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-7.fw.orig	2014-07-08 16:51:10.468006215 +0200
@@ -340,14 +340,14 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # drop packets that do not match any valid state and log them
     echo ":drop_invalid - [0:0]"
-    echo "-A OUTPUT   -m state --state INVALID  -j drop_invalid "
-    echo "-A INPUT    -m state --state INVALID  -j drop_invalid "
-    echo "-A FORWARD  -m state --state INVALID  -j drop_invalid "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid "
     echo "-A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix \"INVALID state -- DENY \""
     echo "-A drop_invalid -j DROP "
 
@@ -380,9 +380,9 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # rules to permit IPv6 Neighbor discovery
     echo "-A INPUT  -p ipv6-icmp -m icmp6 --icmpv6-type router-solicitation -m hl --hl-eq 255 -j ACCEPT "
     echo "-A OUTPUT -p ipv6-icmp -m icmp6 --icmpv6-type router-solicitation -m hl --hl-eq 255 -j ACCEPT "
@@ -394,9 +394,9 @@ script_body() {
     echo "-A OUTPUT -p ipv6-icmp -m icmp6 --icmpv6-type neighbour-advertisement -m hl --hl-eq 255 -j ACCEPT "
     # drop packets that do not match any valid state and log them
     echo ":drop_invalid - [0:0]"
-    echo "-A OUTPUT   -m state --state INVALID  -j drop_invalid "
-    echo "-A INPUT    -m state --state INVALID  -j drop_invalid "
-    echo "-A FORWARD  -m state --state INVALID  -j drop_invalid "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid "
     echo "-A drop_invalid -j LOG --log-level debug --log-prefix \"INVALID state -- DENY \""
     echo "-A drop_invalid -j DROP "
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-8.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-8.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-8.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-8.fw.orig	2014-07-08 16:51:10.558005090 +0200
@@ -365,9 +365,9 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # rules to permit IPv6 Neighbor discovery
     echo "-A INPUT  -p ipv6-icmp -m icmp6 --icmpv6-type router-solicitation -m hl --hl-eq 255 -j ACCEPT "
     echo "-A OUTPUT -p ipv6-icmp -m icmp6 --icmpv6-type router-solicitation -m hl --hl-eq 255 -j ACCEPT "
@@ -379,9 +379,9 @@ script_body() {
     echo "-A OUTPUT -p ipv6-icmp -m icmp6 --icmpv6-type neighbour-advertisement -m hl --hl-eq 255 -j ACCEPT "
     # drop packets that do not match any valid state and log them
     echo ":drop_invalid - [0:0]"
-    echo "-A OUTPUT   -m state --state INVALID  -j drop_invalid "
-    echo "-A INPUT    -m state --state INVALID  -j drop_invalid "
-    echo "-A FORWARD  -m state --state INVALID  -j drop_invalid "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid "
     echo "-A drop_invalid -j LOG --log-level debug --log-prefix \"INVALID state -- DENY \""
     echo "-A drop_invalid -j DROP "
     # ================ Table 'filter', rule set Policy_OSPF
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-ipt-reset-prolog-after-flush.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-ipt-reset-prolog-after-flush.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-ipt-reset-prolog-after-flush.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-ipt-reset-prolog-after-flush.fw.orig	2014-07-08 16:51:10.597004602 +0200
@@ -337,21 +337,21 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # drop packets that do not match any valid state and log them
     echo ":drop_invalid - [0:0]"
-    echo "-A OUTPUT   -m state --state INVALID  -j drop_invalid "
-    echo "-A INPUT    -m state --state INVALID  -j drop_invalid "
-    echo "-A FORWARD  -m state --state INVALID  -j drop_invalid "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid "
     echo "-A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix \"INVALID state -- DENY \""
     echo "-A drop_invalid -j DROP "
     # ================ Table 'filter', rule set Policy
     # 
     # Rule  0 (global)
-    echo "-A INPUT  -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD -i +   -m state --state NEW  -j ACCEPT "
+    echo "-A INPUT  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD -i +   -m conntrack --ctstate NEW  -j ACCEPT "
     #
     echo COMMIT
 
@@ -387,21 +387,21 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # drop packets that do not match any valid state and log them
     echo ":drop_invalid - [0:0]"
-    echo "-A OUTPUT   -m state --state INVALID  -j drop_invalid "
-    echo "-A INPUT    -m state --state INVALID  -j drop_invalid "
-    echo "-A FORWARD  -m state --state INVALID  -j drop_invalid "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid "
     echo "-A drop_invalid -j LOG --log-level debug --log-prefix \"INVALID state -- DENY \""
     echo "-A drop_invalid -j DROP "
     # ================ Table 'filter', rule set Policy
     # 
     # Rule  0 (global)
-    echo "-A INPUT  -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD -i +   -m state --state NEW  -j ACCEPT "
+    echo "-A INPUT  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD -i +   -m conntrack --ctstate NEW  -j ACCEPT "
     #
     echo COMMIT
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-ipt-reset-prolog-after-interfaces.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-ipt-reset-prolog-after-interfaces.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-ipt-reset-prolog-after-interfaces.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-ipt-reset-prolog-after-interfaces.fw.orig	2014-07-08 16:51:10.957000102 +0200
@@ -337,21 +337,21 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # drop packets that do not match any valid state and log them
     echo ":drop_invalid - [0:0]"
-    echo "-A OUTPUT   -m state --state INVALID  -j drop_invalid "
-    echo "-A INPUT    -m state --state INVALID  -j drop_invalid "
-    echo "-A FORWARD  -m state --state INVALID  -j drop_invalid "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid "
     echo "-A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix \"INVALID state -- DENY \""
     echo "-A drop_invalid -j DROP "
     # ================ Table 'filter', rule set Policy
     # 
     # Rule  0 (global)
-    echo "-A INPUT  -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD -i +   -m state --state NEW  -j ACCEPT "
+    echo "-A INPUT  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD -i +   -m conntrack --ctstate NEW  -j ACCEPT "
     #
     echo COMMIT
 
@@ -387,21 +387,21 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # drop packets that do not match any valid state and log them
     echo ":drop_invalid - [0:0]"
-    echo "-A OUTPUT   -m state --state INVALID  -j drop_invalid "
-    echo "-A INPUT    -m state --state INVALID  -j drop_invalid "
-    echo "-A FORWARD  -m state --state INVALID  -j drop_invalid "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid "
     echo "-A drop_invalid -j LOG --log-level debug --log-prefix \"INVALID state -- DENY \""
     echo "-A drop_invalid -j DROP "
     # ================ Table 'filter', rule set Policy
     # 
     # Rule  0 (global)
-    echo "-A INPUT  -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD -i +   -m state --state NEW  -j ACCEPT "
+    echo "-A INPUT  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD -i +   -m conntrack --ctstate NEW  -j ACCEPT "
     #
     echo COMMIT
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-ipt-reset-prolog-top.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-ipt-reset-prolog-top.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-ipt-reset-prolog-top.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-ipt-reset-prolog-top.fw.orig	2014-07-08 16:51:11.039999064 +0200
@@ -337,21 +337,21 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # drop packets that do not match any valid state and log them
     echo ":drop_invalid - [0:0]"
-    echo "-A OUTPUT   -m state --state INVALID  -j drop_invalid "
-    echo "-A INPUT    -m state --state INVALID  -j drop_invalid "
-    echo "-A FORWARD  -m state --state INVALID  -j drop_invalid "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid "
     echo "-A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix \"INVALID state -- DENY \""
     echo "-A drop_invalid -j DROP "
     # ================ Table 'filter', rule set Policy
     # 
     # Rule  0 (global)
-    echo "-A INPUT  -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD -i +   -m state --state NEW  -j ACCEPT "
+    echo "-A INPUT  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD -i +   -m conntrack --ctstate NEW  -j ACCEPT "
     #
     echo COMMIT
 
@@ -387,21 +387,21 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # drop packets that do not match any valid state and log them
     echo ":drop_invalid - [0:0]"
-    echo "-A OUTPUT   -m state --state INVALID  -j drop_invalid "
-    echo "-A INPUT    -m state --state INVALID  -j drop_invalid "
-    echo "-A FORWARD  -m state --state INVALID  -j drop_invalid "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid "
     echo "-A drop_invalid -j LOG --log-level debug --log-prefix \"INVALID state -- DENY \""
     echo "-A drop_invalid -j DROP "
     # ================ Table 'filter', rule set Policy
     # 
     # Rule  0 (global)
-    echo "-A INPUT  -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD -i +   -m state --state NEW  -j ACCEPT "
+    echo "-A INPUT  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD -i +   -m conntrack --ctstate NEW  -j ACCEPT "
     #
     echo COMMIT
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-nd-ns-1.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-nd-ns-1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-nd-ns-1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-nd-ns-1.fw.orig	2014-07-08 16:51:11.032999151 +0200
@@ -337,14 +337,14 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # drop packets that do not match any valid state and log them
     echo ":drop_invalid - [0:0]"
-    echo "-A OUTPUT   -m state --state INVALID  -j drop_invalid "
-    echo "-A INPUT    -m state --state INVALID  -j drop_invalid "
-    echo "-A FORWARD  -m state --state INVALID  -j drop_invalid "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid "
     echo "-A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix \"INVALID state -- DENY \""
     echo "-A drop_invalid -j DROP "
 
@@ -377,9 +377,9 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # rules to permit IPv6 Neighbor discovery
     echo "-A INPUT  -p ipv6-icmp -m icmp6 --icmpv6-type router-solicitation -m hl --hl-eq 255 -j ACCEPT "
     echo "-A OUTPUT -p ipv6-icmp -m icmp6 --icmpv6-type router-solicitation -m hl --hl-eq 255 -j ACCEPT "
@@ -391,9 +391,9 @@ script_body() {
     echo "-A OUTPUT -p ipv6-icmp -m icmp6 --icmpv6-type neighbour-advertisement -m hl --hl-eq 255 -j ACCEPT "
     # drop packets that do not match any valid state and log them
     echo ":drop_invalid - [0:0]"
-    echo "-A OUTPUT   -m state --state INVALID  -j drop_invalid "
-    echo "-A INPUT    -m state --state INVALID  -j drop_invalid "
-    echo "-A FORWARD  -m state --state INVALID  -j drop_invalid "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid "
     echo "-A drop_invalid -j LOG --log-level debug --log-prefix \"INVALID state -- DENY \""
     echo "-A drop_invalid -j DROP "
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-nd-ns-2.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-nd-ns-2.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-nd-ns-2.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-nd-ns-2.fw.orig	2014-07-08 16:51:10.436006615 +0200
@@ -337,14 +337,14 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # drop packets that do not match any valid state and log them
     echo ":drop_invalid - [0:0]"
-    echo "-A OUTPUT   -m state --state INVALID  -j drop_invalid "
-    echo "-A INPUT    -m state --state INVALID  -j drop_invalid "
-    echo "-A FORWARD  -m state --state INVALID  -j drop_invalid "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid "
     echo "-A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix \"INVALID state -- DENY \""
     echo "-A drop_invalid -j DROP "
 
@@ -377,9 +377,9 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # rules to permit IPv6 Neighbor discovery
     echo "-A INPUT  -p ipv6-icmp -m icmp6 --icmpv6-type router-solicitation -m hl --hl-eq 255 -j ACCEPT "
     echo "-A OUTPUT -p ipv6-icmp -m icmp6 --icmpv6-type router-solicitation -m hl --hl-eq 255 -j ACCEPT "
@@ -395,9 +395,9 @@ script_body() {
     echo "-A FORWARD  -p ipv6-icmp -m icmp6 --icmpv6-type neighbour-advertisement -m hl --hl-eq 255 -j ACCEPT "
     # drop packets that do not match any valid state and log them
     echo ":drop_invalid - [0:0]"
-    echo "-A OUTPUT   -m state --state INVALID  -j drop_invalid "
-    echo "-A INPUT    -m state --state INVALID  -j drop_invalid "
-    echo "-A FORWARD  -m state --state INVALID  -j drop_invalid "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid "
     echo "-A drop_invalid -j LOG --log-level debug --log-prefix \"INVALID state -- DENY \""
     echo "-A drop_invalid -j DROP "
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-prolog-after-flush.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-prolog-after-flush.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-prolog-after-flush.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-prolog-after-flush.fw.orig	2014-07-08 16:51:10.560005065 +0200
@@ -328,14 +328,14 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop packets that do not match any valid state and log them
     $IPTABLES -N drop_invalid
-    $IPTABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IPTABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IPTABLES -A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix "INVALID state -- DENY "
     $IPTABLES -A drop_invalid -j DROP
 
@@ -356,8 +356,8 @@ script_body() {
     # 
     echo "Rule 0 (global)"
     # 
-    $IPTABLES -A INPUT  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i +   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i +   -m conntrack --ctstate NEW  -j ACCEPT
 
 
     # ================ IPv6
@@ -365,14 +365,14 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IP6TABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop packets that do not match any valid state and log them
     $IP6TABLES -N drop_invalid
-    $IP6TABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IP6TABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IP6TABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IP6TABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IP6TABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IP6TABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IP6TABLES -A drop_invalid -j LOG --log-level debug --log-prefix "INVALID state -- DENY "
     $IP6TABLES -A drop_invalid -j DROP
 
@@ -387,8 +387,8 @@ script_body() {
     # 
     echo "Rule 0 (global)"
     # 
-    $IP6TABLES -A INPUT  -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A FORWARD -i +   -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A INPUT  -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A FORWARD -i +   -m conntrack --ctstate NEW  -j ACCEPT
 }
 
 ip_forward() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-prolog-after-interfaces.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-prolog-after-interfaces.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-prolog-after-interfaces.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-prolog-after-interfaces.fw.orig	2014-07-08 16:51:10.972999902 +0200
@@ -328,14 +328,14 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop packets that do not match any valid state and log them
     $IPTABLES -N drop_invalid
-    $IPTABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IPTABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IPTABLES -A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix "INVALID state -- DENY "
     $IPTABLES -A drop_invalid -j DROP
 
@@ -356,8 +356,8 @@ script_body() {
     # 
     echo "Rule 0 (global)"
     # 
-    $IPTABLES -A INPUT  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i +   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i +   -m conntrack --ctstate NEW  -j ACCEPT
 
 
     # ================ IPv6
@@ -365,14 +365,14 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IP6TABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop packets that do not match any valid state and log them
     $IP6TABLES -N drop_invalid
-    $IP6TABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IP6TABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IP6TABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IP6TABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IP6TABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IP6TABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IP6TABLES -A drop_invalid -j LOG --log-level debug --log-prefix "INVALID state -- DENY "
     $IP6TABLES -A drop_invalid -j DROP
 
@@ -387,8 +387,8 @@ script_body() {
     # 
     echo "Rule 0 (global)"
     # 
-    $IP6TABLES -A INPUT  -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A FORWARD -i +   -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A INPUT  -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A FORWARD -i +   -m conntrack --ctstate NEW  -j ACCEPT
 }
 
 ip_forward() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-prolog-top.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-prolog-top.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall-ipv6-prolog-top.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall-ipv6-prolog-top.fw.orig	2014-07-08 16:51:10.953000152 +0200
@@ -328,14 +328,14 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop packets that do not match any valid state and log them
     $IPTABLES -N drop_invalid
-    $IPTABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IPTABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IPTABLES -A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix "INVALID state -- DENY "
     $IPTABLES -A drop_invalid -j DROP
 
@@ -356,8 +356,8 @@ script_body() {
     # 
     echo "Rule 0 (global)"
     # 
-    $IPTABLES -A INPUT  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i +   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i +   -m conntrack --ctstate NEW  -j ACCEPT
 
 
     # ================ IPv6
@@ -365,14 +365,14 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IP6TABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop packets that do not match any valid state and log them
     $IP6TABLES -N drop_invalid
-    $IP6TABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IP6TABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IP6TABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IP6TABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IP6TABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IP6TABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IP6TABLES -A drop_invalid -j LOG --log-level debug --log-prefix "INVALID state -- DENY "
     $IP6TABLES -A drop_invalid -j DROP
 
@@ -387,8 +387,8 @@ script_body() {
     # 
     echo "Rule 0 (global)"
     # 
-    $IP6TABLES -A INPUT  -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A FORWARD -i +   -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A INPUT  -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A FORWARD -i +   -m conntrack --ctstate NEW  -j ACCEPT
 }
 
 ip_forward() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall-server-1-s.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall-server-1-s.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall-server-1-s.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall-server-1-s.fw.orig	2014-07-08 16:51:10.368007465 +0200
@@ -324,9 +324,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall.fw.orig	2014-07-08 16:51:10.453006402 +0200
@@ -362,21 +362,21 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # backup ssh access
-    $IPTABLES -A INPUT  -p tcp -m tcp  -s 192.168.1.100/255.255.255.255  --dport 22  -m state --state NEW,ESTABLISHED -j  ACCEPT 
-    $IPTABLES -A OUTPUT  -p tcp -m tcp  -d 192.168.1.100/255.255.255.255  --sport 22  -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A INPUT  -p tcp -m tcp  -s 192.168.1.100/255.255.255.255  --dport 22  -m conntrack --ctstate NEW,ESTABLISHED -j  ACCEPT 
+    $IPTABLES -A OUTPUT  -p tcp -m tcp  -d 192.168.1.100/255.255.255.255  --sport 22  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop TCP sessions opened prior firewall restart
-    $IPTABLES -A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
-    $IPTABLES -A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
-    $IPTABLES -A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
+    $IPTABLES -A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
+    $IPTABLES -A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
+    $IPTABLES -A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
     # drop packets that do not match any valid state and log them
     $IPTABLES -N drop_invalid
-    $IPTABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IPTABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IPTABLES -A drop_invalid -j LOG --log-level debug --log-prefix "INVALID state -- DENY "
     $IPTABLES -A drop_invalid -j DROP
 
@@ -632,11 +632,11 @@ script_body() {
     echo "Rule 3 (eth1)"
     # 
     $IPTABLES -N Cid47421X33852.0
-    $IPTABLES -A INPUT -i eth1  -p udp -m udp  --dport 53  -m state --state NEW  -j Cid47421X33852.0
+    $IPTABLES -A INPUT -i eth1  -p udp -m udp  --dport 53  -m conntrack --ctstate NEW  -j Cid47421X33852.0
     $IPTABLES -A Cid47421X33852.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid47421X33852.0  -d 222.222.222.222   -j ACCEPT
     $IPTABLES -N Cid47421X33852.1
-    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  --dport 53  -m state --state NEW  -j Cid47421X33852.1
+    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  --dport 53  -m conntrack --ctstate NEW  -j Cid47421X33852.1
     $IPTABLES -A Cid47421X33852.1  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid47421X33852.1  -d 222.222.222.222   -j ACCEPT
     # 
@@ -647,43 +647,43 @@ script_body() {
     # rule in FORWARD chain with
     # -o eth1 and dest address of the firewall
     # is pretty much impossible
-    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -d 222.222.222.222   --dport 53  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -d 222.222.222.222   --dport 53  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -d 222.222.222.222   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -d 222.222.222.222   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (eth1)
     # 
     echo "Rule 5 (eth1)"
     # 
-    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -d 222.222.222.222   --dport 53  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth1  -p udp -m udp  -d 192.168.1.10   --dport 53  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -d 222.222.222.222   --dport 53  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -d 192.168.1.10   --dport 53  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth1  -p udp -m udp  -d 192.168.1.10   --dport 53  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -d 222.222.222.222   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth1  -p udp -m udp  -d 192.168.1.10   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -d 222.222.222.222   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -d 192.168.1.10   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth1  -p udp -m udp  -d 192.168.1.10   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 6 (eth1)
     # 
     echo "Rule 6 (eth1)"
     # 
-    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -d 222.222.222.222   --dport 53  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth1  -p udp -m udp  -d 192.168.1.10   --dport 53  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -d 222.222.222.222   --dport 53  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -d 192.168.1.10   --dport 53  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth1  -p udp -m udp  -d 192.168.1.10   --dport 53  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -d 222.222.222.222   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth1  -p udp -m udp  -d 192.168.1.10   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -d 222.222.222.222   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -d 192.168.1.10   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth1  -p udp -m udp  -d 192.168.1.10   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 7 (eth1)
     # 
     echo "Rule 7 (eth1)"
     # 
     $IPTABLES -N Cid112281X33852.0
-    $IPTABLES -A INPUT -i eth1  -p udp -m udp  --dport 53  -m state --state NEW  -j Cid112281X33852.0
+    $IPTABLES -A INPUT -i eth1  -p udp -m udp  --dport 53  -m conntrack --ctstate NEW  -j Cid112281X33852.0
     $IPTABLES -A Cid112281X33852.0  -s 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid112281X33852.0  -s 222.222.222.222   -j ACCEPT
     $IPTABLES -N Cid112281X33852.1
-    $IPTABLES -A FORWARD -i eth1  -p udp -m udp  --dport 53  -m state --state NEW  -j Cid112281X33852.1
+    $IPTABLES -A FORWARD -i eth1  -p udp -m udp  --dport 53  -m conntrack --ctstate NEW  -j Cid112281X33852.1
     $IPTABLES -A Cid112281X33852.1  -s 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid112281X33852.1  -s 222.222.222.222   -j ACCEPT
     $IPTABLES -N Cid112281X33852.2
-    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  --dport 53  -m state --state NEW  -j Cid112281X33852.2
+    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  --dport 53  -m conntrack --ctstate NEW  -j Cid112281X33852.2
     $IPTABLES -A Cid112281X33852.2  -s 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid112281X33852.2  -s 222.222.222.222   -j ACCEPT
     # 
@@ -693,31 +693,31 @@ script_body() {
     # 
     # keep FORWARD chain
     # because it is needed for anti-spoofing rules
-    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -s 222.222.222.222   --dport 53  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth1  -p udp -m udp  -s 222.222.222.222   --dport 53  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -s 222.222.222.222   --dport 53  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -s 222.222.222.222   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth1  -p udp -m udp  -s 222.222.222.222   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -s 222.222.222.222   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 9 (eth1)
     # 
     echo "Rule 9 (eth1)"
     # 
-    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -s 222.222.222.222   --dport 53  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -s 192.168.1.10   --dport 53  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth1  -p udp -m udp  -s 222.222.222.222   --dport 53  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth1  -p udp -m udp  -s 192.168.1.10   --dport 53  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -s 222.222.222.222   --dport 53  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth1  -p udp -m udp  -s 192.168.1.10   --dport 53  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -s 222.222.222.222   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -s 192.168.1.10   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth1  -p udp -m udp  -s 222.222.222.222   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth1  -p udp -m udp  -s 192.168.1.10   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -s 222.222.222.222   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth1  -p udp -m udp  -s 192.168.1.10   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 10 (eth0)
     # 
     echo "Rule 10 (eth0)"
     # 
     $IPTABLES -N Cid3B92DFC5.0
-    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -s 192.168.1.0/24   --dport 53  -m state --state NEW  -j Cid3B92DFC5.0
+    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -s 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j Cid3B92DFC5.0
     $IPTABLES -A Cid3B92DFC5.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid3B92DFC5.0  -d 222.222.222.222   -j ACCEPT
     $IPTABLES -N Cid3B92DFC5.1
-    $IPTABLES -A OUTPUT -o eth0  -p udp -m udp  -s 192.168.1.0/24   --dport 53  -m state --state NEW  -j Cid3B92DFC5.1
+    $IPTABLES -A OUTPUT -o eth0  -p udp -m udp  -s 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j Cid3B92DFC5.1
     $IPTABLES -A Cid3B92DFC5.1  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid3B92DFC5.1  -d 222.222.222.222   -j ACCEPT
     # 
@@ -736,8 +736,8 @@ script_body() {
     # 
     echo "Rule 12 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p tcp -m tcp  --dport 80  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth0  -p tcp -m tcp  --dport 80  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth0  -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 13 (eth0,eth1)
     # 
@@ -763,10 +763,10 @@ script_body() {
     # 
     echo "Rule 15 (eth0,eth1)"
     # 
-    $IPTABLES -A INPUT -i eth0   -d 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth0   -d 222.222.222.222   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth1   -d 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth1   -d 222.222.222.222   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0   -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0   -d 222.222.222.222   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1   -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1   -d 222.222.222.222   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 16 (global)
     # 
@@ -877,12 +877,12 @@ script_body() {
     echo "Rule 26 (global)"
     # 
     $IPTABLES -N RULE_26
-    $IPTABLES -A OUTPUT  -p tcp -m state --state ESTABLISHED --tcp-flags SYN,ACK,RST,URG ACK  -j RULE_26
-    $IPTABLES -A OUTPUT  -p tcp -m state --state ESTABLISHED --tcp-flags SYN,FIN,RST,URG,PSH RST  -j RULE_26
-    $IPTABLES -A INPUT  -p tcp -m state --state ESTABLISHED --tcp-flags SYN,ACK,RST,URG ACK  -j RULE_26
-    $IPTABLES -A INPUT  -p tcp -m state --state ESTABLISHED --tcp-flags SYN,FIN,RST,URG,PSH RST  -j RULE_26
-    $IPTABLES -A FORWARD  -p tcp -m state --state ESTABLISHED --tcp-flags SYN,ACK,RST,URG ACK  -j RULE_26
-    $IPTABLES -A FORWARD  -p tcp -m state --state ESTABLISHED --tcp-flags SYN,FIN,RST,URG,PSH RST  -j RULE_26
+    $IPTABLES -A OUTPUT  -p tcp -m conntrack --ctstate ESTABLISHED --tcp-flags SYN,ACK,RST,URG ACK  -j RULE_26
+    $IPTABLES -A OUTPUT  -p tcp -m conntrack --ctstate ESTABLISHED --tcp-flags SYN,FIN,RST,URG,PSH RST  -j RULE_26
+    $IPTABLES -A INPUT  -p tcp -m conntrack --ctstate ESTABLISHED --tcp-flags SYN,ACK,RST,URG ACK  -j RULE_26
+    $IPTABLES -A INPUT  -p tcp -m conntrack --ctstate ESTABLISHED --tcp-flags SYN,FIN,RST,URG,PSH RST  -j RULE_26
+    $IPTABLES -A FORWARD  -p tcp -m conntrack --ctstate ESTABLISHED --tcp-flags SYN,ACK,RST,URG ACK  -j RULE_26
+    $IPTABLES -A FORWARD  -p tcp -m conntrack --ctstate ESTABLISHED --tcp-flags SYN,FIN,RST,URG,PSH RST  -j RULE_26
     $IPTABLES -A RULE_26  -m limit --limit 5/second -j LOG  --log-level 7 --log-prefix "CUSTOM LOGGING"
     $IPTABLES -A RULE_26  -j DROP
     # 
@@ -892,31 +892,31 @@ script_body() {
     # 
     # both src and dst have multiple interfaces
     $IPTABLES -N Cid3EE24E9C.0
-    $IPTABLES -A INPUT  -s 192.168.1.1   -m state --state NEW  -j Cid3EE24E9C.0
-    $IPTABLES -A INPUT  -s 222.222.222.222   -m state --state NEW  -j Cid3EE24E9C.0
+    $IPTABLES -A INPUT  -s 192.168.1.1   -m conntrack --ctstate NEW  -j Cid3EE24E9C.0
+    $IPTABLES -A INPUT  -s 222.222.222.222   -m conntrack --ctstate NEW  -j Cid3EE24E9C.0
     $IPTABLES -A Cid3EE24E9C.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid3EE24E9C.0  -d 222.222.222.222   -j ACCEPT
     $IPTABLES -N Cid3EE24E9C.1
-    $IPTABLES -A OUTPUT  -s 192.168.1.1   -m state --state NEW  -j Cid3EE24E9C.1
-    $IPTABLES -A OUTPUT  -s 222.222.222.222   -m state --state NEW  -j Cid3EE24E9C.1
+    $IPTABLES -A OUTPUT  -s 192.168.1.1   -m conntrack --ctstate NEW  -j Cid3EE24E9C.1
+    $IPTABLES -A OUTPUT  -s 222.222.222.222   -m conntrack --ctstate NEW  -j Cid3EE24E9C.1
     $IPTABLES -A Cid3EE24E9C.1  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid3EE24E9C.1  -d 222.222.222.222   -j ACCEPT
     $IPTABLES -N Cid3EE24E9C.2
-    $IPTABLES -A OUTPUT  -s 192.168.1.1   -m state --state NEW  -j Cid3EE24E9C.2
-    $IPTABLES -A OUTPUT  -s 222.222.222.222   -m state --state NEW  -j Cid3EE24E9C.2
+    $IPTABLES -A OUTPUT  -s 192.168.1.1   -m conntrack --ctstate NEW  -j Cid3EE24E9C.2
+    $IPTABLES -A OUTPUT  -s 222.222.222.222   -m conntrack --ctstate NEW  -j Cid3EE24E9C.2
     $IPTABLES -A Cid3EE24E9C.2  -d 33.33.33.33   -j ACCEPT
     $IPTABLES -A Cid3EE24E9C.2  -d 172.16.1.1   -j ACCEPT
     $IPTABLES -A Cid3EE24E9C.2  -d 192.168.100.1   -j ACCEPT
     $IPTABLES -N Cid3EE24E9C.3
-    $IPTABLES -A INPUT  -d 192.168.1.1   -m state --state NEW  -j Cid3EE24E9C.3
-    $IPTABLES -A INPUT  -d 222.222.222.222   -m state --state NEW  -j Cid3EE24E9C.3
+    $IPTABLES -A INPUT  -d 192.168.1.1   -m conntrack --ctstate NEW  -j Cid3EE24E9C.3
+    $IPTABLES -A INPUT  -d 222.222.222.222   -m conntrack --ctstate NEW  -j Cid3EE24E9C.3
     $IPTABLES -A Cid3EE24E9C.3  -s 33.33.33.33   -j ACCEPT
     $IPTABLES -A Cid3EE24E9C.3  -s 172.16.1.1   -j ACCEPT
     $IPTABLES -A Cid3EE24E9C.3  -s 192.168.100.1   -j ACCEPT
     $IPTABLES -N Cid3EE24E9C.4
-    $IPTABLES -A FORWARD  -s 33.33.33.33   -m state --state NEW  -j Cid3EE24E9C.4
-    $IPTABLES -A FORWARD  -s 172.16.1.1   -m state --state NEW  -j Cid3EE24E9C.4
-    $IPTABLES -A FORWARD  -s 192.168.100.1   -m state --state NEW  -j Cid3EE24E9C.4
+    $IPTABLES -A FORWARD  -s 33.33.33.33   -m conntrack --ctstate NEW  -j Cid3EE24E9C.4
+    $IPTABLES -A FORWARD  -s 172.16.1.1   -m conntrack --ctstate NEW  -j Cid3EE24E9C.4
+    $IPTABLES -A FORWARD  -s 192.168.100.1   -m conntrack --ctstate NEW  -j Cid3EE24E9C.4
     $IPTABLES -A Cid3EE24E9C.4  -d 33.33.33.33   -j ACCEPT
     $IPTABLES -A Cid3EE24E9C.4  -d 172.16.1.1   -j ACCEPT
     $IPTABLES -A Cid3EE24E9C.4  -d 192.168.100.1   -j ACCEPT
@@ -925,14 +925,14 @@ script_body() {
     # 
     echo "Rule 29 (global)"
     # 
-    $IPTABLES -A FORWARD  -m mac --mac-source 00:10:4b:de:e9:6f  -s 192.168.1.10   -d 192.168.1.10   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -m mac --mac-source 00:10:4b:de:e9:6f  -s 192.168.1.10   -d 192.168.1.10   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 30 (global)
     # 
     echo "Rule 30 (global)"
     # 
     $IPTABLES -N Cid3E0AA611.0
-    $IPTABLES -A INPUT  -m mac --mac-source 00:10:4b:de:e9:6f  -s 192.168.1.10   -m state --state NEW  -j Cid3E0AA611.0
+    $IPTABLES -A INPUT  -m mac --mac-source 00:10:4b:de:e9:6f  -s 192.168.1.10   -m conntrack --ctstate NEW  -j Cid3E0AA611.0
     $IPTABLES -A Cid3E0AA611.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid3E0AA611.0  -d 222.222.222.222   -j ACCEPT
     # 
@@ -940,14 +940,14 @@ script_body() {
     # 
     echo "Rule 31 (global)"
     # 
-    $IPTABLES -A FORWARD  -m mac --mac-source 00:10:4b:de:e9:70  -d 192.168.1.10   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -m mac --mac-source 00:10:4b:de:e9:70  -d 192.168.1.10   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 32 (global)
     # 
     echo "Rule 32 (global)"
     # 
     $IPTABLES -N Cid3E0AA504.0
-    $IPTABLES -A INPUT  -m mac --mac-source 00:10:4b:de:e9:70  -m state --state NEW  -j Cid3E0AA504.0
+    $IPTABLES -A INPUT  -m mac --mac-source 00:10:4b:de:e9:70  -m conntrack --ctstate NEW  -j Cid3E0AA504.0
     $IPTABLES -A Cid3E0AA504.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid3E0AA504.0  -d 222.222.222.222   -j ACCEPT
     # 
@@ -955,14 +955,14 @@ script_body() {
     # 
     echo "Rule 33 (global)"
     # 
-    $IPTABLES -A FORWARD  -m mac --mac-source 00:10:4b:de:e9:70  -d 200.200.200.200   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -m mac --mac-source 00:10:4b:de:e9:70  -d 200.200.200.200   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 34 (global)
     # 
     echo "Rule 34 (global)"
     # 
     $IPTABLES -N Cid3E0F40D5.0
-    $IPTABLES -A INPUT  -m mac --mac-source aa:bb:cc:dd:ee:ff  -s 192.168.1.15   -m state --state NEW  -j Cid3E0F40D5.0
+    $IPTABLES -A INPUT  -m mac --mac-source aa:bb:cc:dd:ee:ff  -s 192.168.1.15   -m conntrack --ctstate NEW  -j Cid3E0F40D5.0
     $IPTABLES -A Cid3E0F40D5.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid3E0F40D5.0  -d 222.222.222.222   -j ACCEPT
     # 
@@ -971,7 +971,7 @@ script_body() {
     echo "Rule 35 (global)"
     # 
     $IPTABLES -N Cid3E0F452C.0
-    $IPTABLES -A INPUT  -m mac --mac-source aa:bb:cc:dd:ee:ff  -m state --state NEW  -j Cid3E0F452C.0
+    $IPTABLES -A INPUT  -m mac --mac-source aa:bb:cc:dd:ee:ff  -m conntrack --ctstate NEW  -j Cid3E0F452C.0
     $IPTABLES -A Cid3E0F452C.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid3E0F452C.0  -d 222.222.222.222   -j ACCEPT
     # 
@@ -982,7 +982,7 @@ script_body() {
     # firewall:Policy:36: warning: Empty MAC address in rule
 
     $IPTABLES -N Cid3DB0B422.0
-    $IPTABLES -A FORWARD  -d 192.168.1.10   -m state --state NEW  -j Cid3DB0B422.0
+    $IPTABLES -A FORWARD  -d 192.168.1.10   -m conntrack --ctstate NEW  -j Cid3DB0B422.0
     $IPTABLES -A Cid3DB0B422.0  -m mac --mac-source 00:10:4b:de:e9:70  -j ACCEPT
     $IPTABLES -A Cid3DB0B422.0  -m mac --mac-source 00:10:4b:de:e9:71  -j ACCEPT
     $IPTABLES -A Cid3DB0B422.0  -m mac --mac-source 00:00:00:00:00:00  -j ACCEPT
@@ -995,7 +995,7 @@ script_body() {
     # firewall:Policy:37: warning: Empty MAC address in rule
 
     $IPTABLES -N Cid3DB0B628.0
-    $IPTABLES -A FORWARD  -d 192.168.1.10   -m state --state NEW  -j Cid3DB0B628.0
+    $IPTABLES -A FORWARD  -d 192.168.1.10   -m conntrack --ctstate NEW  -j Cid3DB0B628.0
     $IPTABLES -A Cid3DB0B628.0  -m mac --mac-source 00:10:4b:de:e9:70  -j ACCEPT
     $IPTABLES -A Cid3DB0B628.0  -m mac --mac-source 00:10:4b:de:e9:71  -j ACCEPT
     $IPTABLES -A Cid3DB0B628.0  -m mac --mac-source 00:00:00:00:00:00  -j ACCEPT
@@ -1009,7 +1009,7 @@ script_body() {
     # firewall:Policy:38: warning: Empty MAC address in rule
 
     $IPTABLES -N Cid3DE474B7.0
-    $IPTABLES -A FORWARD -p tcp -m tcp  --sport 53  -d 192.168.1.10   -m state --state NEW  -j Cid3DE474B7.0
+    $IPTABLES -A FORWARD -p tcp -m tcp  --sport 53  -d 192.168.1.10   -m conntrack --ctstate NEW  -j Cid3DE474B7.0
     $IPTABLES -A Cid3DE474B7.0  -m mac --mac-source 00:10:4b:de:e9:70  -j ACCEPT
     $IPTABLES -A Cid3DE474B7.0  -m mac --mac-source 00:10:4b:de:e9:71  -j ACCEPT
     $IPTABLES -A Cid3DE474B7.0  -m mac --mac-source 00:00:00:00:00:00  -j ACCEPT
@@ -1022,10 +1022,10 @@ script_body() {
     # firewall:Policy:39: warning: Empty MAC address in rule
 
     $IPTABLES -N Cpol-firewall2-2.0
-    $IPTABLES -A FORWARD -p tcp -m tcp  -d 192.168.1.10   --dport 10000:11000  -m state --state NEW  -j Cpol-firewall2-2.0
-    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  -d 192.168.1.10   --dports 113,13,53,2105,21,70,80,443,143,993,6667,6667,543,544,389  -m state --state NEW  -j Cpol-firewall2-2.0
-    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  -d 192.168.1.10   --dports 98,3306,2049,119,110,5432,515,26000,512,513,514,4321,25,465,1080  -m state --state NEW  -j Cpol-firewall2-2.0
-    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  -d 192.168.1.10   --dports 3128,22,111,23,540,7100  -m state --state NEW  -j Cpol-firewall2-2.0
+    $IPTABLES -A FORWARD -p tcp -m tcp  -d 192.168.1.10   --dport 10000:11000  -m conntrack --ctstate NEW  -j Cpol-firewall2-2.0
+    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  -d 192.168.1.10   --dports 113,13,53,2105,21,70,80,443,143,993,6667,6667,543,544,389  -m conntrack --ctstate NEW  -j Cpol-firewall2-2.0
+    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  -d 192.168.1.10   --dports 98,3306,2049,119,110,5432,515,26000,512,513,514,4321,25,465,1080  -m conntrack --ctstate NEW  -j Cpol-firewall2-2.0
+    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  -d 192.168.1.10   --dports 3128,22,111,23,540,7100  -m conntrack --ctstate NEW  -j Cpol-firewall2-2.0
     $IPTABLES -A Cpol-firewall2-2.0  -m mac --mac-source 00:10:4b:de:e9:70  -j ACCEPT
     $IPTABLES -A Cpol-firewall2-2.0  -m mac --mac-source 00:10:4b:de:e9:71  -j ACCEPT
     $IPTABLES -A Cpol-firewall2-2.0  -m mac --mac-source 00:00:00:00:00:00  -j ACCEPT
@@ -1038,13 +1038,13 @@ script_body() {
     # firewall:Policy:40: warning: Empty MAC address in rule
 
     $IPTABLES -N Cid445FAA6D31658.0
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 80  -m state --state NEW  -j Cid445FAA6D31658.0
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j Cid445FAA6D31658.0
     $IPTABLES -A Cid445FAA6D31658.0  -m mac --mac-source 00:10:4b:de:e9:70  -j ACCEPT
     $IPTABLES -A Cid445FAA6D31658.0  -m mac --mac-source 00:10:4b:de:e9:71  -j ACCEPT
     $IPTABLES -A Cid445FAA6D31658.0  -m mac --mac-source 00:00:00:00:00:00  -j ACCEPT
     $IPTABLES -A Cid445FAA6D31658.0  -m mac --mac-source 00:10:4b:de:e9:6f  -s 192.168.1.10   -j ACCEPT
     $IPTABLES -N Cid445FAA6D31658.1
-    $IPTABLES -A FORWARD -p tcp -m tcp  --dport 80  -m state --state NEW  -j Cid445FAA6D31658.1
+    $IPTABLES -A FORWARD -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j Cid445FAA6D31658.1
     $IPTABLES -A Cid445FAA6D31658.1  -m mac --mac-source 00:10:4b:de:e9:70  -j ACCEPT
     $IPTABLES -A Cid445FAA6D31658.1  -m mac --mac-source 00:10:4b:de:e9:71  -j ACCEPT
     $IPTABLES -A Cid445FAA6D31658.1  -m mac --mac-source 00:00:00:00:00:00  -j ACCEPT
@@ -1056,14 +1056,14 @@ script_body() {
     # 
     # firewall:Policy:41: warning: Can not match MAC address of the firewall (chain OUTPUT) 
 
-    $IPTABLES -A OUTPUT  -s 192.168.1.1   -d 192.168.1.10   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.1   -d 192.168.1.10   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 42 (global)
     # 
     echo "Rule 42 (global)"
     # 
     $IPTABLES -N Cpol-firewall2-3.0
-    $IPTABLES -A FORWARD  -d 192.168.1.10   -m state --state NEW  -j Cpol-firewall2-3.0
+    $IPTABLES -A FORWARD  -d 192.168.1.10   -m conntrack --ctstate NEW  -j Cpol-firewall2-3.0
     $IPTABLES -N Cpol-firewall2-3.1
     $IPTABLES -A Cpol-firewall2-3.0  -s 211.11.11.11   -j Cpol-firewall2-3.1
     $IPTABLES -A Cpol-firewall2-3.0  -s 211.22.22.22   -j Cpol-firewall2-3.1
@@ -1080,10 +1080,10 @@ script_body() {
     echo "Rule 43 (global)"
     # 
     $IPTABLES -N Cid3FB8455E.0
-    $IPTABLES -A FORWARD -p tcp -m tcp  --dport 10000:11000  -m state --state NEW  -j Cid3FB8455E.0
-    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  --dports 113,13,53,2105,21,70,80,443,143,993,6667,6667,543,544,389  -m state --state NEW  -j Cid3FB8455E.0
-    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  --dports 98,3306,2049,119,110,5432,515,26000,512,513,514,4321,25,465,1080  -m state --state NEW  -j Cid3FB8455E.0
-    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  --dports 3128,22,111,23,540,7100  -m state --state NEW  -j Cid3FB8455E.0
+    $IPTABLES -A FORWARD -p tcp -m tcp  --dport 10000:11000  -m conntrack --ctstate NEW  -j Cid3FB8455E.0
+    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  --dports 113,13,53,2105,21,70,80,443,143,993,6667,6667,543,544,389  -m conntrack --ctstate NEW  -j Cid3FB8455E.0
+    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  --dports 98,3306,2049,119,110,5432,515,26000,512,513,514,4321,25,465,1080  -m conntrack --ctstate NEW  -j Cid3FB8455E.0
+    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  --dports 3128,22,111,23,540,7100  -m conntrack --ctstate NEW  -j Cid3FB8455E.0
     $IPTABLES -N Cid3FB8455E.1
     $IPTABLES -A Cid3FB8455E.0  -s 211.11.11.11   -j Cid3FB8455E.1
     $IPTABLES -A Cid3FB8455E.0  -s 211.22.22.22   -j Cid3FB8455E.1
@@ -1094,41 +1094,41 @@ script_body() {
     # 
     echo "Rule 44 (global)"
     # 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --sport 1024:65535  -d 192.168.1.10   --dport 80  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  --sport 1024:65535  -d 192.168.1.10   --dport 80  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --sport 1024:65535  -d 192.168.1.10   --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  --sport 1024:65535  -d 192.168.1.10   --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 45 (global)
     # 
     echo "Rule 45 (global)"
     # 
     # Rule #20 test: from Rock
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --sport 1024:65535  -d 192.168.1.10   --dport 80  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --sport 53  -d 192.168.1.10   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -m multiport  -d 192.168.1.10   --dports 53,3128  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  --sport 1024:65535  -d 192.168.1.10   --dport 80  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  --sport 53  -d 192.168.1.10   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  -d 192.168.1.10   --dports 53,3128  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --sport 1024:65535  -d 192.168.1.10   --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --sport 53  -d 192.168.1.10   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -m multiport  -d 192.168.1.10   --dports 53,3128  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  --sport 1024:65535  -d 192.168.1.10   --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  --sport 53  -d 192.168.1.10   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  -d 192.168.1.10   --dports 53,3128  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 46 (global)
     # 
     echo "Rule 46 (global)"
     # 
     $IPTABLES -N Cpol-firewall2-4.0
-    $IPTABLES -A OUTPUT  -d 192.168.1.0/24   -m state --state NEW  -j Cpol-firewall2-4.0
+    $IPTABLES -A OUTPUT  -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cpol-firewall2-4.0
     $IPTABLES -A Cpol-firewall2-4.0 -p icmp  -m icmp  --icmp-type 3  -j ACCEPT
     $IPTABLES -A Cpol-firewall2-4.0 -p icmp  -m icmp  --icmp-type 0/0   -j ACCEPT
     $IPTABLES -A Cpol-firewall2-4.0 -p icmp  -m icmp  --icmp-type 11/0   -j ACCEPT
     $IPTABLES -A Cpol-firewall2-4.0 -p icmp  -m icmp  --icmp-type 11/1   -j ACCEPT
     $IPTABLES -A Cpol-firewall2-4.0  -m ip_conntrack_talk -m ip_nat_talk  -j ACCEPT
     $IPTABLES -N Cpol-firewall2-4.1
-    $IPTABLES -A INPUT  -d 192.168.1.0/24   -m state --state NEW  -j Cpol-firewall2-4.1
+    $IPTABLES -A INPUT  -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cpol-firewall2-4.1
     $IPTABLES -A Cpol-firewall2-4.1 -p icmp  -m icmp  --icmp-type 3  -j ACCEPT
     $IPTABLES -A Cpol-firewall2-4.1 -p icmp  -m icmp  --icmp-type 0/0   -j ACCEPT
     $IPTABLES -A Cpol-firewall2-4.1 -p icmp  -m icmp  --icmp-type 11/0   -j ACCEPT
     $IPTABLES -A Cpol-firewall2-4.1 -p icmp  -m icmp  --icmp-type 11/1   -j ACCEPT
     $IPTABLES -A Cpol-firewall2-4.1  -m ip_conntrack_talk -m ip_nat_talk  -j ACCEPT
     $IPTABLES -N Cpol-firewall2-4.2
-    $IPTABLES -A FORWARD  -d 192.168.1.0/24   -m state --state NEW  -j Cpol-firewall2-4.2
+    $IPTABLES -A FORWARD  -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cpol-firewall2-4.2
     $IPTABLES -A Cpol-firewall2-4.2 -p icmp  -m icmp  --icmp-type 3  -j ACCEPT
     $IPTABLES -A Cpol-firewall2-4.2 -p icmp  -m icmp  --icmp-type 0/0   -j ACCEPT
     $IPTABLES -A Cpol-firewall2-4.2 -p icmp  -m icmp  --icmp-type 11/0   -j ACCEPT
@@ -1140,18 +1140,18 @@ script_body() {
     echo "Rule 47 (global)"
     # 
     $IPTABLES -N Cid3CD8770E.0
-    $IPTABLES -A OUTPUT  -d 192.168.1.11   -m state --state NEW  -j Cid3CD8770E.0
-    $IPTABLES -A OUTPUT  -d 192.168.1.12/30   -m state --state NEW  -j Cid3CD8770E.0
+    $IPTABLES -A OUTPUT  -d 192.168.1.11   -m conntrack --ctstate NEW  -j Cid3CD8770E.0
+    $IPTABLES -A OUTPUT  -d 192.168.1.12/30   -m conntrack --ctstate NEW  -j Cid3CD8770E.0
     $IPTABLES -A Cid3CD8770E.0 -p tcp -m tcp  -m multiport  --dports 113,80,443,143,25,22,540  -j ACCEPT
     $IPTABLES -A Cid3CD8770E.0  -m ip_conntrack_talk -m ip_nat_talk  -j ACCEPT
     $IPTABLES -N Cid3CD8770E.1
-    $IPTABLES -A INPUT  -d 192.168.1.11   -m state --state NEW  -j Cid3CD8770E.1
-    $IPTABLES -A INPUT  -d 192.168.1.12/30   -m state --state NEW  -j Cid3CD8770E.1
+    $IPTABLES -A INPUT  -d 192.168.1.11   -m conntrack --ctstate NEW  -j Cid3CD8770E.1
+    $IPTABLES -A INPUT  -d 192.168.1.12/30   -m conntrack --ctstate NEW  -j Cid3CD8770E.1
     $IPTABLES -A Cid3CD8770E.1 -p tcp -m tcp  -m multiport  --dports 113,80,443,143,25,22,540  -j ACCEPT
     $IPTABLES -A Cid3CD8770E.1  -m ip_conntrack_talk -m ip_nat_talk  -j ACCEPT
     $IPTABLES -N Cid3CD8770E.2
-    $IPTABLES -A FORWARD  -d 192.168.1.11   -m state --state NEW  -j Cid3CD8770E.2
-    $IPTABLES -A FORWARD  -d 192.168.1.12/30   -m state --state NEW  -j Cid3CD8770E.2
+    $IPTABLES -A FORWARD  -d 192.168.1.11   -m conntrack --ctstate NEW  -j Cid3CD8770E.2
+    $IPTABLES -A FORWARD  -d 192.168.1.12/30   -m conntrack --ctstate NEW  -j Cid3CD8770E.2
     $IPTABLES -A Cid3CD8770E.2 -p tcp -m tcp  -m multiport  --dports 113,80,443,143,25,22,540  -j ACCEPT
     $IPTABLES -A Cid3CD8770E.2  -m ip_conntrack_talk -m ip_nat_talk  -j ACCEPT
     # 
@@ -1160,19 +1160,19 @@ script_body() {
     echo "Rule 48 (global)"
     # 
     $IPTABLES -N Cid3CD87B1E.0
-    $IPTABLES -A OUTPUT  -d 192.168.1.11   -m state --state NEW  -j Cid3CD87B1E.0
-    $IPTABLES -A OUTPUT  -d 192.168.1.12   -m state --state NEW  -j Cid3CD87B1E.0
-    $IPTABLES -A OUTPUT  -d 192.168.1.13   -m state --state NEW  -j Cid3CD87B1E.0
-    $IPTABLES -A OUTPUT  -d 192.168.1.14   -m state --state NEW  -j Cid3CD87B1E.0
-    $IPTABLES -A OUTPUT  -d 192.168.1.15   -m state --state NEW  -j Cid3CD87B1E.0
+    $IPTABLES -A OUTPUT  -d 192.168.1.11   -m conntrack --ctstate NEW  -j Cid3CD87B1E.0
+    $IPTABLES -A OUTPUT  -d 192.168.1.12   -m conntrack --ctstate NEW  -j Cid3CD87B1E.0
+    $IPTABLES -A OUTPUT  -d 192.168.1.13   -m conntrack --ctstate NEW  -j Cid3CD87B1E.0
+    $IPTABLES -A OUTPUT  -d 192.168.1.14   -m conntrack --ctstate NEW  -j Cid3CD87B1E.0
+    $IPTABLES -A OUTPUT  -d 192.168.1.15   -m conntrack --ctstate NEW  -j Cid3CD87B1E.0
     $IPTABLES -A Cid3CD87B1E.0 -p tcp -m tcp  -m multiport  --dports 113,80,443,143,25,22,540  -j ACCEPT
     $IPTABLES -A Cid3CD87B1E.0  -m ip_conntrack_talk -m ip_nat_talk  -j ACCEPT
     $IPTABLES -N Cid3CD87B1E.1
-    $IPTABLES -A FORWARD  -d 192.168.1.11   -m state --state NEW  -j Cid3CD87B1E.1
-    $IPTABLES -A FORWARD  -d 192.168.1.12   -m state --state NEW  -j Cid3CD87B1E.1
-    $IPTABLES -A FORWARD  -d 192.168.1.13   -m state --state NEW  -j Cid3CD87B1E.1
-    $IPTABLES -A FORWARD  -d 192.168.1.14   -m state --state NEW  -j Cid3CD87B1E.1
-    $IPTABLES -A FORWARD  -d 192.168.1.15   -m state --state NEW  -j Cid3CD87B1E.1
+    $IPTABLES -A FORWARD  -d 192.168.1.11   -m conntrack --ctstate NEW  -j Cid3CD87B1E.1
+    $IPTABLES -A FORWARD  -d 192.168.1.12   -m conntrack --ctstate NEW  -j Cid3CD87B1E.1
+    $IPTABLES -A FORWARD  -d 192.168.1.13   -m conntrack --ctstate NEW  -j Cid3CD87B1E.1
+    $IPTABLES -A FORWARD  -d 192.168.1.14   -m conntrack --ctstate NEW  -j Cid3CD87B1E.1
+    $IPTABLES -A FORWARD  -d 192.168.1.15   -m conntrack --ctstate NEW  -j Cid3CD87B1E.1
     $IPTABLES -A Cid3CD87B1E.1 -p tcp -m tcp  -m multiport  --dports 113,80,443,143,25,22,540  -j ACCEPT
     $IPTABLES -A Cid3CD87B1E.1  -m ip_conntrack_talk -m ip_nat_talk  -j ACCEPT
     # 
@@ -1186,8 +1186,8 @@ script_body() {
     # empty ports specs. This is special
     # case for multiport.
     $IPTABLES -N Cid3E1FD93A.0
-    $IPTABLES -A INPUT -p udp -m udp  -s 192.168.1.0/24   -m state --state NEW  -j Cid3E1FD93A.0
-    $IPTABLES -A INPUT -p udp -m udp  -m multiport  -s 192.168.1.0/24   --dports 68,67  -m state --state NEW  -j Cid3E1FD93A.0
+    $IPTABLES -A INPUT -p udp -m udp  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid3E1FD93A.0
+    $IPTABLES -A INPUT -p udp -m udp  -m multiport  -s 192.168.1.0/24   --dports 68,67  -m conntrack --ctstate NEW  -j Cid3E1FD93A.0
     $IPTABLES -A Cid3E1FD93A.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid3E1FD93A.0  -d 222.222.222.222   -j ACCEPT
     # 
@@ -1202,19 +1202,19 @@ script_body() {
     # It may be acceptable to not use multiport
     # in the rule with a single service at all.
     $IPTABLES -N Cid41D0F052.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 10000:11000  -m state --state NEW  -j Cid41D0F052.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -m multiport  -s 192.168.1.0/24   --dports 113,13,53,2105,21,70,80,443,6667,119,25,3128,22,23,540  -m state --state NEW  -j Cid41D0F052.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 10000:11000  -m conntrack --ctstate NEW  -j Cid41D0F052.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -m multiport  -s 192.168.1.0/24   --dports 113,13,53,2105,21,70,80,443,6667,119,25,3128,22,23,540  -m conntrack --ctstate NEW  -j Cid41D0F052.0
     $IPTABLES -N RULE_50
     $IPTABLES -A Cid41D0F052.0  -d 192.168.1.11   -j RULE_50
     $IPTABLES -A Cid41D0F052.0  -d 192.168.1.12/30   -j RULE_50
     $IPTABLES -N Cid41D0F052.1
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 10000:11000  -m state --state NEW  -j Cid41D0F052.1
-    $IPTABLES -A INPUT -p tcp -m tcp  -m multiport  -s 192.168.1.0/24   --dports 113,13,53,2105,21,70,80,443,6667,119,25,3128,22,23,540  -m state --state NEW  -j Cid41D0F052.1
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 10000:11000  -m conntrack --ctstate NEW  -j Cid41D0F052.1
+    $IPTABLES -A INPUT -p tcp -m tcp  -m multiport  -s 192.168.1.0/24   --dports 113,13,53,2105,21,70,80,443,6667,119,25,3128,22,23,540  -m conntrack --ctstate NEW  -j Cid41D0F052.1
     $IPTABLES -A Cid41D0F052.1  -d 192.168.1.11   -j RULE_50
     $IPTABLES -A Cid41D0F052.1  -d 192.168.1.12/30   -j RULE_50
     $IPTABLES -N Cid41D0F052.2
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 10000:11000  -m state --state NEW  -j Cid41D0F052.2
-    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  -s 192.168.1.0/24   --dports 113,13,53,2105,21,70,80,443,6667,119,25,3128,22,23,540  -m state --state NEW  -j Cid41D0F052.2
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 10000:11000  -m conntrack --ctstate NEW  -j Cid41D0F052.2
+    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  -s 192.168.1.0/24   --dports 113,13,53,2105,21,70,80,443,6667,119,25,3128,22,23,540  -m conntrack --ctstate NEW  -j Cid41D0F052.2
     $IPTABLES -A Cid41D0F052.2  -d 192.168.1.11   -j RULE_50
     $IPTABLES -A Cid41D0F052.2  -d 192.168.1.12/30   -j RULE_50
     $IPTABLES -A RULE_50  -m limit --limit 5/second -j LOG  --log-level 7 --log-prefix "CUSTOM LOGGING"
@@ -1225,14 +1225,14 @@ script_body() {
     echo "Rule 51 (global)"
     # 
     $IPTABLES -N Cid3B58E180.0
-    $IPTABLES -A INPUT  -s 192.168.1.1   -m state --state NEW  -j Cid3B58E180.0
-    $IPTABLES -A INPUT  -s 222.222.222.222   -m state --state NEW  -j Cid3B58E180.0
+    $IPTABLES -A INPUT  -s 192.168.1.1   -m conntrack --ctstate NEW  -j Cid3B58E180.0
+    $IPTABLES -A INPUT  -s 222.222.222.222   -m conntrack --ctstate NEW  -j Cid3B58E180.0
     $IPTABLES -N RULE_51
     $IPTABLES -A Cid3B58E180.0  -d 192.168.1.1   -j RULE_51
     $IPTABLES -A Cid3B58E180.0  -d 222.222.222.222   -j RULE_51
     $IPTABLES -N Cid3B58E180.1
-    $IPTABLES -A OUTPUT  -s 192.168.1.1   -m state --state NEW  -j Cid3B58E180.1
-    $IPTABLES -A OUTPUT  -s 222.222.222.222   -m state --state NEW  -j Cid3B58E180.1
+    $IPTABLES -A OUTPUT  -s 192.168.1.1   -m conntrack --ctstate NEW  -j Cid3B58E180.1
+    $IPTABLES -A OUTPUT  -s 222.222.222.222   -m conntrack --ctstate NEW  -j Cid3B58E180.1
     $IPTABLES -A Cid3B58E180.1  -d 192.168.1.1   -j RULE_51
     $IPTABLES -A Cid3B58E180.1  -d 222.222.222.222   -j RULE_51
     $IPTABLES -A RULE_51  -m limit --limit 5/second -j LOG  --log-level 7 --log-prefix "CUSTOM LOGGING"
@@ -1243,21 +1243,21 @@ script_body() {
     echo "Rule 52 (global)"
     # 
     $IPTABLES -N Cid3D41A4F4.0
-    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid3D41A4F4.0
+    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid3D41A4F4.0
     $IPTABLES -N Cid3D41A4F4.1
     $IPTABLES -A Cid3D41A4F4.0  -s 192.168.1.1   -j Cid3D41A4F4.1
     $IPTABLES -A Cid3D41A4F4.0  -s 222.222.222.222   -j Cid3D41A4F4.1
     $IPTABLES -A Cid3D41A4F4.1  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid3D41A4F4.1  -d 222.222.222.222   -j ACCEPT
     $IPTABLES -N Cid3D41A4F4.2
-    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid3D41A4F4.2
+    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid3D41A4F4.2
     $IPTABLES -N Cid3D41A4F4.3
     $IPTABLES -A Cid3D41A4F4.2  -s 192.168.1.1   -j Cid3D41A4F4.3
     $IPTABLES -A Cid3D41A4F4.2  -s 222.222.222.222   -j Cid3D41A4F4.3
     $IPTABLES -A Cid3D41A4F4.3  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid3D41A4F4.3  -d 222.222.222.222   -j ACCEPT
     $IPTABLES -N Cid3D41A4F4.4
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 200.200.200.200   --dport 161  -m state --state NEW  -j Cid3D41A4F4.4
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 200.200.200.200   --dport 161  -m conntrack --ctstate NEW  -j Cid3D41A4F4.4
     $IPTABLES -A Cid3D41A4F4.4  -s 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid3D41A4F4.4  -s 222.222.222.222   -j ACCEPT
     # 
@@ -1266,13 +1266,13 @@ script_body() {
     echo "Rule 53 (global)"
     # 
     # Automatically generated 'masquerading' rule
-    $IPTABLES -A INPUT  -s 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -s 222.222.222.222   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 222.222.222.222   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 222.222.222.222   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 222.222.222.222   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 54 (global)
     # 
@@ -1282,25 +1282,25 @@ script_body() {
     # rule, but not so permissive as it does 
     # not allow access to the firewall
     $IPTABLES -N Cid3CE894DA.0
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j Cid3CE894DA.0
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid3CE894DA.0
     $IPTABLES -A Cid3CE894DA.0  -d 192.168.1.1   -j RETURN
     $IPTABLES -A Cid3CE894DA.0  -d 222.222.222.222   -j RETURN
     $IPTABLES -A Cid3CE894DA.0  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 55 (global)
     # 
     echo "Rule 55 (global)"
     # 
     $IPTABLES -N Cid40F1CFA3.0
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j Cid40F1CFA3.0
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid40F1CFA3.0
     $IPTABLES -A Cid40F1CFA3.0  -d 192.168.1.1   -j RETURN
     $IPTABLES -A Cid40F1CFA3.0  -d 222.222.222.222   -j RETURN
     $IPTABLES -A Cid40F1CFA3.0  -j ACCEPT
     $IPTABLES -N Cid40F1CFA3.1
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j Cid40F1CFA3.1
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j Cid40F1CFA3.1
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid40F1CFA3.1
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid40F1CFA3.1
     $IPTABLES -A Cid40F1CFA3.1  -d 33.33.33.0/24   -j RETURN
     $IPTABLES -A Cid40F1CFA3.1  -j ACCEPT
     # 
@@ -1309,27 +1309,27 @@ script_body() {
     echo "Rule 56 (global)"
     # 
     $IPTABLES -N Cid413D6500.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 10000:11000  -m state --state NEW  -j Cid413D6500.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 113  -m state --state NEW  -j Cid413D6500.0
-    $IPTABLES -A OUTPUT -p udp -m udp  -m multiport  --dports 53,161  -m state --state NEW  -j Cid413D6500.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 10000:11000  -m conntrack --ctstate NEW  -j Cid413D6500.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 113  -m conntrack --ctstate NEW  -j Cid413D6500.0
+    $IPTABLES -A OUTPUT -p udp -m udp  -m multiport  --dports 53,161  -m conntrack --ctstate NEW  -j Cid413D6500.0
     $IPTABLES -N Cid413D6500.1
     $IPTABLES -A Cid413D6500.0  -s 192.168.1.0/24   -j Cid413D6500.1
     $IPTABLES -A Cid413D6500.0  -s 192.168.2.0/24   -j Cid413D6500.1
     $IPTABLES -A Cid413D6500.1  -d 192.168.1.0/24   -j ACCEPT
     $IPTABLES -A Cid413D6500.1  -d 192.168.2.0/24   -j ACCEPT
     $IPTABLES -N Cid413D6500.2
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 10000:11000  -m state --state NEW  -j Cid413D6500.2
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 113  -m state --state NEW  -j Cid413D6500.2
-    $IPTABLES -A INPUT -p udp -m udp  -m multiport  --dports 53,161  -m state --state NEW  -j Cid413D6500.2
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 10000:11000  -m conntrack --ctstate NEW  -j Cid413D6500.2
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 113  -m conntrack --ctstate NEW  -j Cid413D6500.2
+    $IPTABLES -A INPUT -p udp -m udp  -m multiport  --dports 53,161  -m conntrack --ctstate NEW  -j Cid413D6500.2
     $IPTABLES -N Cid413D6500.3
     $IPTABLES -A Cid413D6500.2  -s 192.168.1.0/24   -j Cid413D6500.3
     $IPTABLES -A Cid413D6500.2  -s 192.168.2.0/24   -j Cid413D6500.3
     $IPTABLES -A Cid413D6500.3  -d 192.168.1.0/24   -j ACCEPT
     $IPTABLES -A Cid413D6500.3  -d 192.168.2.0/24   -j ACCEPT
     $IPTABLES -N Cid413D6500.4
-    $IPTABLES -A FORWARD -p tcp -m tcp  --dport 10000:11000  -m state --state NEW  -j Cid413D6500.4
-    $IPTABLES -A FORWARD -p tcp -m tcp  --dport 113  -m state --state NEW  -j Cid413D6500.4
-    $IPTABLES -A FORWARD -p udp -m udp  -m multiport  --dports 53,161  -m state --state NEW  -j Cid413D6500.4
+    $IPTABLES -A FORWARD -p tcp -m tcp  --dport 10000:11000  -m conntrack --ctstate NEW  -j Cid413D6500.4
+    $IPTABLES -A FORWARD -p tcp -m tcp  --dport 113  -m conntrack --ctstate NEW  -j Cid413D6500.4
+    $IPTABLES -A FORWARD -p udp -m udp  -m multiport  --dports 53,161  -m conntrack --ctstate NEW  -j Cid413D6500.4
     $IPTABLES -N Cid413D6500.5
     $IPTABLES -A Cid413D6500.4  -s 192.168.1.0/24   -j Cid413D6500.5
     $IPTABLES -A Cid413D6500.4  -s 192.168.2.0/24   -j Cid413D6500.5
@@ -1362,8 +1362,8 @@ reset_all() {
 block_action() {
     reset_all
     # backup ssh access
-    $IPTABLES -A INPUT  -p tcp -m tcp  -s 192.168.1.100/255.255.255.255  --dport 22  -m state --state NEW,ESTABLISHED -j  ACCEPT
-    $IPTABLES -A OUTPUT  -p tcp -m tcp  -d 192.168.1.100/255.255.255.255  --sport 22  -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT  -p tcp -m tcp  -s 192.168.1.100/255.255.255.255  --dport 22  -m conntrack --ctstate NEW,ESTABLISHED -j  ACCEPT
+    $IPTABLES -A OUTPUT  -p tcp -m tcp  -d 192.168.1.100/255.255.255.255  --sport 22  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 }
 
 stop_action() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall1.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall1.fw.orig	2014-07-08 16:51:10.465006252 +0200
@@ -317,14 +317,14 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop packets that do not match any valid state and log them
     $IPTABLES -N drop_invalid
-    $IPTABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IPTABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IPTABLES -A drop_invalid -j LOG --log-level debug --log-prefix "INVALID state -- DENY "
     $IPTABLES -A drop_invalid -j DROP
 
@@ -640,10 +640,10 @@ script_body() {
     # 
     echo "Rule 5 (eth2)"
     # 
-    $IPTABLES -A INPUT -i eth2   -s 192.168.2.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth2   -s 192.168.2.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth2   -s 192.168.2.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth2   -s 192.168.2.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth2   -s 192.168.2.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth2   -s 192.168.2.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth2   -s 192.168.2.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth2   -s 192.168.2.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 6 (eth2)
     # 
@@ -675,8 +675,8 @@ script_body() {
     # 
     echo "Rule 8 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 9 (eth0,eth2)
     # 
@@ -699,10 +699,10 @@ script_body() {
     echo "Rule 10 (eth1,eth3)"
     # 
     $IPTABLES -N Cid434D389E26912.0
-    $IPTABLES -A INPUT -i eth1   -m state --state NEW  -j Cid434D389E26912.0
-    $IPTABLES -A INPUT -i eth3   -m state --state NEW  -j Cid434D389E26912.0
-    $IPTABLES -A FORWARD -i eth1   -m state --state NEW  -j Cid434D389E26912.0
-    $IPTABLES -A FORWARD -i eth3   -m state --state NEW  -j Cid434D389E26912.0
+    $IPTABLES -A INPUT -i eth1   -m conntrack --ctstate NEW  -j Cid434D389E26912.0
+    $IPTABLES -A INPUT -i eth3   -m conntrack --ctstate NEW  -j Cid434D389E26912.0
+    $IPTABLES -A FORWARD -i eth1   -m conntrack --ctstate NEW  -j Cid434D389E26912.0
+    $IPTABLES -A FORWARD -i eth3   -m conntrack --ctstate NEW  -j Cid434D389E26912.0
     $IPTABLES -A Cid434D389E26912.0  -s 22.22.23.128/25   -j RETURN
     $IPTABLES -A Cid434D389E26912.0  -s 33.33.33.0/24   -j RETURN
     $IPTABLES -A Cid434D389E26912.0  -j ACCEPT
@@ -748,8 +748,8 @@ script_body() {
     # 
     # hostF has the same IP address as firewal.
     $IPTABLES -N RULE_14
-    $IPTABLES -A OUTPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m state --state NEW  -j RULE_14
-    $IPTABLES -A INPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m state --state NEW  -j RULE_14
+    $IPTABLES -A OUTPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j RULE_14
+    $IPTABLES -A INPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j RULE_14
     $IPTABLES -A RULE_14  -j LOG  --log-level debug
     $IPTABLES -A RULE_14  -j ACCEPT
     # 
@@ -758,9 +758,9 @@ script_body() {
     echo "Rule 15 (global)"
     # 
     $IPTABLES -N Cid434B03D526912.0
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j Cid434B03D526912.0
-    $IPTABLES -A INPUT  -m state --state NEW  -j Cid434B03D526912.0
-    $IPTABLES -A FORWARD  -m state --state NEW  -j Cid434B03D526912.0
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j Cid434B03D526912.0
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j Cid434B03D526912.0
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j Cid434B03D526912.0
     $IPTABLES -A Cid434B03D526912.0  -s 192.168.1.0/24   -j RETURN
     $IPTABLES -A Cid434B03D526912.0  -s 192.168.2.0/24   -j RETURN
     $IPTABLES -A Cid434B03D526912.0  -j ACCEPT
@@ -803,9 +803,9 @@ script_body() {
     # 
     # testing negation in the policy rule
     $IPTABLES -N Cid40C0D10A.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -m multiport  --dports 80,443  -m state --state NEW  -j Cid40C0D10A.0
-    $IPTABLES -A INPUT -p tcp -m tcp  -m multiport  --dports 80,443  -m state --state NEW  -j Cid40C0D10A.0
-    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  --dports 80,443  -m state --state NEW  -j Cid40C0D10A.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -m multiport  --dports 80,443  -m conntrack --ctstate NEW  -j Cid40C0D10A.0
+    $IPTABLES -A INPUT -p tcp -m tcp  -m multiport  --dports 80,443  -m conntrack --ctstate NEW  -j Cid40C0D10A.0
+    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  --dports 80,443  -m conntrack --ctstate NEW  -j Cid40C0D10A.0
     $IPTABLES -A Cid40C0D10A.0  -s 192.168.1.10   -j RETURN
     $IPTABLES -A Cid40C0D10A.0  -s 192.168.1.20   -j RETURN
     $IPTABLES -N RULE_18_3
@@ -936,10 +936,10 @@ script_body() {
     # 
     # testing negation in service field
     $IPTABLES -N Cid3CCA2CF4.0
-    $IPTABLES -A OUTPUT  -d 192.168.1.10   -m state --state NEW  -j Cid3CCA2CF4.0
-    $IPTABLES -A OUTPUT  -d 192.168.1.20   -m state --state NEW  -j Cid3CCA2CF4.0
-    $IPTABLES -A FORWARD  -d 192.168.1.10   -m state --state NEW  -j Cid3CCA2CF4.0
-    $IPTABLES -A FORWARD  -d 192.168.1.20   -m state --state NEW  -j Cid3CCA2CF4.0
+    $IPTABLES -A OUTPUT  -d 192.168.1.10   -m conntrack --ctstate NEW  -j Cid3CCA2CF4.0
+    $IPTABLES -A OUTPUT  -d 192.168.1.20   -m conntrack --ctstate NEW  -j Cid3CCA2CF4.0
+    $IPTABLES -A FORWARD  -d 192.168.1.10   -m conntrack --ctstate NEW  -j Cid3CCA2CF4.0
+    $IPTABLES -A FORWARD  -d 192.168.1.20   -m conntrack --ctstate NEW  -j Cid3CCA2CF4.0
     $IPTABLES -A Cid3CCA2CF4.0 -p tcp -m tcp  -m multiport  --dports 25,22  -j RETURN
     $IPTABLES -N RULE_25_3
     $IPTABLES -A Cid3CCA2CF4.0  -j RULE_25_3
@@ -952,10 +952,10 @@ script_body() {
     # 
     # testing negation in service field
     $IPTABLES -N Cid3EA925F1.0
-    $IPTABLES -A OUTPUT  -d 192.168.1.10   -m state --state NEW  -j Cid3EA925F1.0
-    $IPTABLES -A OUTPUT  -d 192.168.1.20   -m state --state NEW  -j Cid3EA925F1.0
-    $IPTABLES -A FORWARD  -d 192.168.1.10   -m state --state NEW  -j Cid3EA925F1.0
-    $IPTABLES -A FORWARD  -d 192.168.1.20   -m state --state NEW  -j Cid3EA925F1.0
+    $IPTABLES -A OUTPUT  -d 192.168.1.10   -m conntrack --ctstate NEW  -j Cid3EA925F1.0
+    $IPTABLES -A OUTPUT  -d 192.168.1.20   -m conntrack --ctstate NEW  -j Cid3EA925F1.0
+    $IPTABLES -A FORWARD  -d 192.168.1.10   -m conntrack --ctstate NEW  -j Cid3EA925F1.0
+    $IPTABLES -A FORWARD  -d 192.168.1.20   -m conntrack --ctstate NEW  -j Cid3EA925F1.0
     $IPTABLES -A Cid3EA925F1.0 -p tcp -m tcp  --dport 25  -j RETURN
     $IPTABLES -N RULE_26_3
     $IPTABLES -A Cid3EA925F1.0  -j RULE_26_3
@@ -968,10 +968,10 @@ script_body() {
     # 
     # testing negation in service field
     $IPTABLES -N Cid3EA9225C.0
-    $IPTABLES -A OUTPUT  -d 192.168.1.10   -m state --state NEW  -j Cid3EA9225C.0
-    $IPTABLES -A OUTPUT  -d 192.168.1.20   -m state --state NEW  -j Cid3EA9225C.0
-    $IPTABLES -A FORWARD  -d 192.168.1.10   -m state --state NEW  -j Cid3EA9225C.0
-    $IPTABLES -A FORWARD  -d 192.168.1.20   -m state --state NEW  -j Cid3EA9225C.0
+    $IPTABLES -A OUTPUT  -d 192.168.1.10   -m conntrack --ctstate NEW  -j Cid3EA9225C.0
+    $IPTABLES -A OUTPUT  -d 192.168.1.20   -m conntrack --ctstate NEW  -j Cid3EA9225C.0
+    $IPTABLES -A FORWARD  -d 192.168.1.10   -m conntrack --ctstate NEW  -j Cid3EA9225C.0
+    $IPTABLES -A FORWARD  -d 192.168.1.20   -m conntrack --ctstate NEW  -j Cid3EA9225C.0
     $IPTABLES -A Cid3EA9225C.0 -p icmp  -m icmp  --icmp-type any  -j RETURN
     $IPTABLES -N RULE_27_3
     $IPTABLES -A Cid3EA9225C.0  -j RULE_27_3
@@ -984,9 +984,9 @@ script_body() {
     # 
     # testing negation in service field
     $IPTABLES -N Cid4144E299.1
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j Cid4144E299.1
-    $IPTABLES -A INPUT  -m state --state NEW  -j Cid4144E299.1
-    $IPTABLES -A FORWARD  -m state --state NEW  -j Cid4144E299.1
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j Cid4144E299.1
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j Cid4144E299.1
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j Cid4144E299.1
     $IPTABLES -A Cid4144E299.1  -d 192.168.1.10   -j RETURN
     $IPTABLES -A Cid4144E299.1  -d 192.168.1.20   -j RETURN
     $IPTABLES -N Cid4144E299.0
@@ -1000,12 +1000,12 @@ script_body() {
     # 
     # testing negation in service field
     $IPTABLES -N Cid41449248.1
-    $IPTABLES -A OUTPUT  -m state --state NEW -m time  --timestart 09:00  --timestop 17:00  --days Mon,Tue,Wed,Thu,Fri -j Cid41449248.1
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW -m time  --timestart 09:00  --timestop 17:00  --days Mon,Tue,Wed,Thu,Fri -j Cid41449248.1
     $IPTABLES -N Cid41449248.0
     $IPTABLES -A Cid41449248.1  -d 192.168.1.10   -j Cid41449248.0
     $IPTABLES -A Cid41449248.1  -d 192.168.1.20   -j Cid41449248.0
     $IPTABLES -N Cid41449248.2
-    $IPTABLES -A FORWARD  -m state --state NEW -m time  --timestart 09:00  --timestop 17:00  --days Mon,Tue,Wed,Thu,Fri -j Cid41449248.2
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW -m time  --timestart 09:00  --timestop 17:00  --days Mon,Tue,Wed,Thu,Fri -j Cid41449248.2
     $IPTABLES -A Cid41449248.2  -d 192.168.1.10   -j Cid41449248.0
     $IPTABLES -A Cid41449248.2  -d 192.168.1.20   -j Cid41449248.0
     $IPTABLES -A Cid41449248.0 -p tcp -m tcp  --dport 80  -j RETURN
@@ -1017,9 +1017,9 @@ script_body() {
     # 
     # testing negation in service field
     $IPTABLES -N Cid414532F3.1
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 80  -m state --state NEW  -j Cid414532F3.1
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 80  -m state --state NEW  -j Cid414532F3.1
-    $IPTABLES -A FORWARD -p tcp -m tcp  --dport 80  -m state --state NEW  -j Cid414532F3.1
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j Cid414532F3.1
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j Cid414532F3.1
+    $IPTABLES -A FORWARD -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j Cid414532F3.1
     $IPTABLES -A Cid414532F3.1 -m time  --timestart 09:00  --timestop 17:00  --days Mon,Tue,Wed,Thu,Fri -j RETURN
     $IPTABLES -N Cid414532F3.0
     $IPTABLES -A Cid414532F3.1  -j Cid414532F3.0
@@ -1033,10 +1033,10 @@ script_body() {
     # 
     # testing negation in service field
     $IPTABLES -N Cid41449257.1
-    $IPTABLES -A OUTPUT  -d 192.168.1.10   -m state --state NEW  -j Cid41449257.1
-    $IPTABLES -A OUTPUT  -d 192.168.1.20   -m state --state NEW  -j Cid41449257.1
-    $IPTABLES -A FORWARD  -d 192.168.1.10   -m state --state NEW  -j Cid41449257.1
-    $IPTABLES -A FORWARD  -d 192.168.1.20   -m state --state NEW  -j Cid41449257.1
+    $IPTABLES -A OUTPUT  -d 192.168.1.10   -m conntrack --ctstate NEW  -j Cid41449257.1
+    $IPTABLES -A OUTPUT  -d 192.168.1.20   -m conntrack --ctstate NEW  -j Cid41449257.1
+    $IPTABLES -A FORWARD  -d 192.168.1.10   -m conntrack --ctstate NEW  -j Cid41449257.1
+    $IPTABLES -A FORWARD  -d 192.168.1.20   -m conntrack --ctstate NEW  -j Cid41449257.1
     $IPTABLES -A Cid41449257.1 -m time  --timestart 09:00  --timestop 17:00  --days Mon,Tue,Wed,Thu,Fri -j RETURN
     $IPTABLES -N Cid41449257.0
     $IPTABLES -A Cid41449257.1  -j Cid41449257.0
@@ -1048,7 +1048,7 @@ script_body() {
     echo "Rule 32 (global)"
     # 
     $IPTABLES -N Cid4368F08A15884.1
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 80  -m state --state NEW  -j Cid4368F08A15884.1
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j Cid4368F08A15884.1
     $IPTABLES -N Cid4368F08A15884.0
     $IPTABLES -A Cid4368F08A15884.1  -s 22.22.22.22   -j Cid4368F08A15884.0
     $IPTABLES -A Cid4368F08A15884.1  -s 22.22.23.23   -j Cid4368F08A15884.0
@@ -1060,7 +1060,7 @@ script_body() {
     $IPTABLES -A Cid4368F08A15884.0  -d 192.168.2.1   -j RETURN
     $IPTABLES -A Cid4368F08A15884.0  -j ACCEPT
     $IPTABLES -N Cid4368F08A15884.2
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 80  -m state --state NEW  -j Cid4368F08A15884.2
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j Cid4368F08A15884.2
     $IPTABLES -A Cid4368F08A15884.2  -s 22.22.22.22   -j ACCEPT
     $IPTABLES -A Cid4368F08A15884.2  -s 22.22.23.23   -j ACCEPT
     $IPTABLES -A Cid4368F08A15884.2  -s 192.168.1.1   -j ACCEPT
@@ -1071,27 +1071,27 @@ script_body() {
     echo "Rule 33 (global)"
     # 
     $IPTABLES -N Cid3E74D8BB.1
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid3E74D8BB.1
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid3E74D8BB.1
     $IPTABLES -N Cid3E74D8BB.0
     $IPTABLES -A Cid3E74D8BB.1  -s 22.22.22.22   -j Cid3E74D8BB.0
     $IPTABLES -A Cid3E74D8BB.1  -s 22.22.23.23   -j Cid3E74D8BB.0
     $IPTABLES -A Cid3E74D8BB.1  -s 192.168.1.1   -j Cid3E74D8BB.0
     $IPTABLES -A Cid3E74D8BB.1  -s 192.168.2.1   -j Cid3E74D8BB.0
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.2.0/24   --dport 22  -m state --state NEW  -j Cid3E74D8BB.0
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.2.0/24   --dport 22  -m conntrack --ctstate NEW  -j Cid3E74D8BB.0
     $IPTABLES -A Cid3E74D8BB.0  -d 22.22.22.22   -j RETURN
     $IPTABLES -A Cid3E74D8BB.0  -d 22.22.23.23   -j RETURN
     $IPTABLES -A Cid3E74D8BB.0  -d 192.168.1.1   -j RETURN
     $IPTABLES -A Cid3E74D8BB.0  -d 192.168.2.1   -j RETURN
     $IPTABLES -A Cid3E74D8BB.0  -j ACCEPT
     $IPTABLES -N Cid3E74D8BB.3
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid3E74D8BB.3
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid3E74D8BB.3
     $IPTABLES -N Cid3E74D8BB.2
     $IPTABLES -A Cid3E74D8BB.3  -s 22.22.22.22   -j Cid3E74D8BB.2
     $IPTABLES -A Cid3E74D8BB.3  -s 22.22.23.23   -j Cid3E74D8BB.2
     $IPTABLES -A Cid3E74D8BB.3  -s 192.168.1.1   -j Cid3E74D8BB.2
     $IPTABLES -A Cid3E74D8BB.3  -s 192.168.2.1   -j Cid3E74D8BB.2
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.2.0/24   --dport 22  -m state --state NEW  -j Cid3E74D8BB.2
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.2.0/24   --dport 22  -m state --state NEW  -j Cid3E74D8BB.2
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.2.0/24   --dport 22  -m conntrack --ctstate NEW  -j Cid3E74D8BB.2
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.2.0/24   --dport 22  -m conntrack --ctstate NEW  -j Cid3E74D8BB.2
     $IPTABLES -A Cid3E74D8BB.2  -d 192.168.1.0/24   -j RETURN
     $IPTABLES -A Cid3E74D8BB.2  -j ACCEPT
     # 
@@ -1147,33 +1147,33 @@ script_body() {
     echo "Rule 36 (global)"
     # 
     $IPTABLES -N Cid41A88DF6.0
-    $IPTABLES -A INPUT  -m state --state NEW  -j Cid41A88DF6.0
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j Cid41A88DF6.0
     $IPTABLES -A Cid41A88DF6.0  -d 192.168.1.1   -j RETURN
     $IPTABLES -A Cid41A88DF6.0  -d 192.168.2.1   -j RETURN
     $IPTABLES -A Cid41A88DF6.0  -j ACCEPT
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 37 (global)
     # 
     echo "Rule 37 (global)"
     # 
     $IPTABLES -N Cid41B5176E.0
-    $IPTABLES -A OUTPUT  -d 192.168.1.0/24   -m state --state NEW  -j Cid41B5176E.0
+    $IPTABLES -A OUTPUT  -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid41B5176E.0
     $IPTABLES -A Cid41B5176E.0  -s 192.168.1.1   -j RETURN
     $IPTABLES -A Cid41B5176E.0  -s 192.168.2.1   -j RETURN
     $IPTABLES -A Cid41B5176E.0  -j ACCEPT
-    $IPTABLES -A INPUT  -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 38 (global)
     # 
     echo "Rule 38 (global)"
     # 
     $IPTABLES -N Cid4143BD3F.0
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 25  -m state --state NEW  -j Cid4143BD3F.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 25  -m state --state NEW  -j Cid4143BD3F.0
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 25  -m state --state NEW  -j Cid4143BD3F.0
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 25  -m conntrack --ctstate NEW  -j Cid4143BD3F.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 25  -m conntrack --ctstate NEW  -j Cid4143BD3F.0
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 25  -m conntrack --ctstate NEW  -j Cid4143BD3F.0
     $IPTABLES -A Cid4143BD3F.0 -m time  --timestart 00:00  --timestop 23:59  --days Sat -j RETURN
     $IPTABLES -A Cid4143BD3F.0 -m time  --timestart 00:00  --timestop 23:59  --days Sun -j RETURN
     $IPTABLES -A Cid4143BD3F.0  -j ACCEPT
@@ -1183,9 +1183,9 @@ script_body() {
     echo "Rule 39 (global)"
     # 
     $IPTABLES -N Cid4143BD1A.0
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 80  -m state --state NEW  -j Cid4143BD1A.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 80  -m state --state NEW  -j Cid4143BD1A.0
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 80  -m state --state NEW  -j Cid4143BD1A.0
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 80  -m conntrack --ctstate NEW  -j Cid4143BD1A.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 80  -m conntrack --ctstate NEW  -j Cid4143BD1A.0
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 80  -m conntrack --ctstate NEW  -j Cid4143BD1A.0
     $IPTABLES -A Cid4143BD1A.0 -m time  --timestart 09:00  --timestop 17:00  --days Mon,Tue,Wed,Thu,Fri -j RETURN
     $IPTABLES -A Cid4143BD1A.0  -j ACCEPT
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall10.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall10.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall10.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall10.fw.orig	2014-07-08 16:51:11.074998626 +0200
@@ -311,9 +311,9 @@ script_body() {
     $IPTABLES -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
 
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall11.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall11.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall11.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall11.fw.orig	2014-07-08 16:51:10.360007565 +0200
@@ -319,9 +319,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -364,56 +364,56 @@ script_body() {
     # 
     echo "Rule 0 (eth0)"
     # 
-    $IPTABLES -A FORWARD -i eth0   -d 192.168.1.255   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth0   -d 192.168.1.255   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (eth0)
     # 
     echo "Rule 1 (eth0)"
     # 
-    $IPTABLES -A FORWARD -i eth0   -d 255.255.255.255   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth0   -d 255.255.255.255   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (eth0)
     # 
     echo "Rule 2 (eth0)"
     # 
-    $IPTABLES -A FORWARD -o eth0   -d 255.255.255.255   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth0   -d 255.255.255.255   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (eth0)
     # 
     echo "Rule 3 (eth0)"
     # 
-    $IPTABLES -A FORWARD -i eth0   -d 255.255.255.255   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth0   -d 255.255.255.255   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth0   -d 255.255.255.255   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth0   -d 255.255.255.255   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (eth0)
     # 
     echo "Rule 4 (eth0)"
     # 
-    $IPTABLES -A FORWARD -i eth0   -d 224.0.1.141   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth0   -d 224.0.1.141   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (eth0)
     # 
     echo "Rule 5 (eth0)"
     # 
-    $IPTABLES -A FORWARD -i eth0   -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth0   -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 6 (eth0)
     # 
     echo "Rule 6 (eth0)"
     # 
-    $IPTABLES -A FORWARD -i eth0   -d ! 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth0   -d ! 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 7 (br0)
     # 
     echo "Rule 7 (br0)"
     # 
-    $IPTABLES -A INPUT -i br0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i br0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 8 (br0)
     # 
     echo "Rule 8 (br0)"
     # 
-    $IPTABLES -A INPUT -i br0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i br0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 9 (br0)
     # 
@@ -421,7 +421,7 @@ script_body() {
     # 
     for i_br0 in $i_br0_list
     do
-    test -n "$i_br0" && $IPTABLES -A INPUT -i br0  -p tcp -m tcp  -d $i_br0   --dport 22  -m state --state NEW  -j ACCEPT 
+    test -n "$i_br0" && $IPTABLES -A INPUT -i br0  -p tcp -m tcp  -d $i_br0   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 10 (br0)
@@ -443,15 +443,15 @@ script_body() {
     # 
     echo "Rule 11 (global)"
     # 
-    $IPTABLES -A FORWARD -p udp -m udp  -d 255.255.255.255   --dport 68  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p udp -m udp  -d 255.255.255.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 12 (global)
     # 
     echo "Rule 12 (global)"
     # 
     $IPTABLES -N Cid3D94D513.0
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 68  -m state --state NEW  -j Cid3D94D513.0
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 68  -m conntrack --ctstate NEW  -j Cid3D94D513.0
     $IPTABLES -A Cid3D94D513.0  -d 192.168.1.10   -j ACCEPT
     $IPTABLES -A Cid3D94D513.0  -d 192.168.1.255   -j ACCEPT
     # 
@@ -459,35 +459,35 @@ script_body() {
     # 
     echo "Rule 13 (global)"
     # 
-    $IPTABLES -A FORWARD -p udp -m udp  -d 192.168.1.0   --dport 68  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p udp -m udp  -d 192.168.1.0   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 14 (global)
     # 
     echo "Rule 14 (global)"
     # 
-    $IPTABLES -A FORWARD  -d 224.0.1.141   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 224.0.1.141   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 192.168.1.20   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 224.0.1.141   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 224.0.1.141   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 192.168.1.20   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 15 (global)
     # 
     echo "Rule 15 (global)"
     # 
-    $IPTABLES -A FORWARD  -d 224.0.0.5   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 224.0.0.5   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 224.0.0.5   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 224.0.0.5   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 16 (global)
     # 
     echo "Rule 16 (global)"
     # 
-    $IPTABLES -A FORWARD  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 17 (global)
     # 
     echo "Rule 17 (global)"
     # 
-    $IPTABLES -A FORWARD -p tcp -m tcp  -d 192.168.1.10   --dport 6667  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -d 192.168.1.10   --dport 6667  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 18 (global)
     # 
@@ -507,7 +507,7 @@ script_body() {
     # because this is a bridging firewall
     # see bug #811860
     $IPTABLES -N Cid3DD4BBC7.0
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j Cid3DD4BBC7.0
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j Cid3DD4BBC7.0
     for i_br0 in $i_br0_list
     do
     test -n "$i_br0" && $IPTABLES -A Cid3DD4BBC7.0  -d $i_br0   -j ACCEPT 
@@ -517,7 +517,7 @@ script_body() {
     test -n "$i_eth2" && $IPTABLES -A Cid3DD4BBC7.0  -d $i_eth2   -j ACCEPT 
     done
     $IPTABLES -A Cid3DD4BBC7.0  -d 10.1.1.1   -j ACCEPT
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 20 (global)
     # 
@@ -525,21 +525,21 @@ script_body() {
     # 
     for i_br0 in $i_br0_list
     do
-    test -n "$i_br0" && $IPTABLES -A FORWARD  -d $i_br0   -m state --state NEW  -j ACCEPT 
+    test -n "$i_br0" && $IPTABLES -A FORWARD  -d $i_br0   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     for i_eth2 in $i_eth2_list
     do
-    test -n "$i_eth2" && $IPTABLES -A FORWARD  -d $i_eth2   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth2" && $IPTABLES -A FORWARD  -d $i_eth2   -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A FORWARD  -d 10.1.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 10.1.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 21 (global)
     # 
     echo "Rule 21 (global)"
     # 
-    $IPTABLES -A FORWARD  -d 10.1.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 10.1.1.1   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 10.1.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 10.1.1.1   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 23 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall12.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall12.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall12.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall12.fw.orig	2014-07-08 16:51:11.097998339 +0200
@@ -340,9 +340,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -472,8 +472,8 @@ script_body() {
     # 
     echo "Rule 0 (global)"
     # 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 22.22.22.23   --dport 8080  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -d 22.22.22.23   --dport 8080  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 22.22.22.23   --dport 8080  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -d 22.22.22.23   --dport 8080  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall13.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall13.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall13.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall13.fw.orig	2014-07-08 16:51:11.076998601 +0200
@@ -331,9 +331,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall14.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall14.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall14.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall14.fw.orig	2014-07-08 16:51:11.048998951 +0200
@@ -328,9 +328,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall15.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall15.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall15.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall15.fw.orig	2014-07-08 16:51:10.552005165 +0200
@@ -322,13 +322,13 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop TCP sessions opened prior firewall restart
-    $IPTABLES -A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
-    $IPTABLES -A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
-    $IPTABLES -A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP
+    $IPTABLES -A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
+    $IPTABLES -A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
+    $IPTABLES -A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP
 
 
 
@@ -344,8 +344,8 @@ script_body() {
     # option 'assume firewall is part of any'
     # is off, but this rule should go into 
     # INPUT/OUTPUT chains anyway
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall16.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall16.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall16.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall16.fw.orig	2014-07-08 16:51:10.387007227 +0200
@@ -322,9 +322,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -446,8 +446,8 @@ script_body() {
     # 
     echo "Rule 0 (global)"
     # 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.2.10   --dport 80  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -d 192.168.2.10   --dport 80  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.2.10   --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -d 192.168.2.10   --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall17.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall17.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall17.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall17.fw.orig	2014-07-08 16:51:10.405007002 +0200
@@ -327,9 +327,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -442,9 +442,9 @@ script_body() {
     # 
     echo "Rule 6 (global)"
     # 
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
 }
 
 ip_forward() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall18.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall18.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall18.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall18.fw.orig	2014-07-08 16:51:10.519005577 +0200
@@ -331,9 +331,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -430,8 +430,8 @@ script_body() {
     # 
     echo "Rule 1 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (ppp0)
     # 
@@ -461,7 +461,7 @@ script_body() {
     echo "Rule 3 (ppp0)"
     # 
     # but old broadcast is permitted
-    $IPTABLES -A INPUT -i ppp0   -s 0.0.0.0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i ppp0   -s 0.0.0.0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall19.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall19.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall19.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall19.fw.orig	2014-07-08 16:51:10.992999652 +0200
@@ -331,9 +331,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -346,50 +346,50 @@ script_body() {
     # 
     echo "Rule 0 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
     for i_ppp0 in $i_ppp0_list
     do
-    test -n "$i_ppp0" && $IPTABLES -A OUTPUT -o lo   -d $i_ppp0   -m state --state NEW  -j ACCEPT 
+    test -n "$i_ppp0" && $IPTABLES -A OUTPUT -o lo   -d $i_ppp0   -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A OUTPUT -o lo   -d 66.66.66.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -d 66.66.66.130   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -d 127.0.0.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -d 192.168.1.1   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -d 66.66.66.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -d 66.66.66.130   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -d 127.0.0.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (lo)
     # 
     echo "Rule 1 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -d 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i lo   -d 66.66.66.130   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i lo   -d 66.66.66.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i lo   -d 127.0.0.1   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -d 66.66.66.130   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -d 66.66.66.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -d 127.0.0.1   -m conntrack --ctstate NEW  -j ACCEPT
     for i_ppp0 in $i_ppp0_list
     do
-    test -n "$i_ppp0" && $IPTABLES -A INPUT -i lo   -d $i_ppp0   -m state --state NEW  -j ACCEPT 
+    test -n "$i_ppp0" && $IPTABLES -A INPUT -i lo   -d $i_ppp0   -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A OUTPUT -o lo   -d 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -d 66.66.66.130   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -d 66.66.66.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -d 127.0.0.1   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -d 66.66.66.130   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -d 66.66.66.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -d 127.0.0.1   -m conntrack --ctstate NEW  -j ACCEPT
     for i_ppp0 in $i_ppp0_list
     do
-    test -n "$i_ppp0" && $IPTABLES -A OUTPUT -o lo   -d $i_ppp0   -m state --state NEW  -j ACCEPT 
+    test -n "$i_ppp0" && $IPTABLES -A OUTPUT -o lo   -d $i_ppp0   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 2 (lo)
     # 
     echo "Rule 2 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -d 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -d 192.168.1.1   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (lo)
     # 
     echo "Rule 3 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
@@ -425,9 +425,9 @@ script_body() {
     # 
     echo "Rule 7 (global)"
     # 
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 5190   --tcp-flags SYN,RST,ACK SYN   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 5190   --tcp-flags SYN,RST,ACK SYN   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 5190   --tcp-flags SYN,RST,ACK SYN   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 5190   --tcp-flags SYN,RST,ACK SYN   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 5190   --tcp-flags SYN,RST,ACK SYN   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 5190   --tcp-flags SYN,RST,ACK SYN   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 8 (global)
     # 
@@ -454,18 +454,18 @@ script_body() {
     # 
     # firewall19:Policy:10: warning: Rule action 'Reject' with TCP RST can be used only with TCP services.
 
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -p tcp ! --syn -dport 5190 -m state --state NEW  -j REJECT  --reject-with icmp-host-prohibited
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -p tcp ! --syn -dport 5190 -m state --state NEW  -j REJECT  --reject-with icmp-host-prohibited
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -p tcp ! --syn -dport 5190 -m state --state NEW  -j REJECT  --reject-with icmp-host-prohibited
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -p tcp ! --syn -dport 5190 -m conntrack --ctstate NEW  -j REJECT  --reject-with icmp-host-prohibited
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -p tcp ! --syn -dport 5190 -m conntrack --ctstate NEW  -j REJECT  --reject-with icmp-host-prohibited
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -p tcp ! --syn -dport 5190 -m conntrack --ctstate NEW  -j REJECT  --reject-with icmp-host-prohibited
     # 
     # Rule 11 (global)
     # 
     echo "Rule 11 (global)"
     # 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 66.66.66.130   --dport 3128  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 127.0.0.1   --dport 3128  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p tcp -m tcp  -d 66.66.66.130   --dport 3128  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p tcp -m tcp  -d 127.0.0.1   --dport 3128  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 66.66.66.130   --dport 3128  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 127.0.0.1   --dport 3128  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -d 66.66.66.130   --dport 3128  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -d 127.0.0.1   --dport 3128  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 12 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall2-1.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall2-1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall2-1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall2-1.fw.orig	2014-07-08 16:51:10.484006015 +0200
@@ -347,18 +347,18 @@ script_body() {
     $IPTABLES -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
 
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop TCP sessions opened prior firewall restart
-    $IPTABLES -A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
-    $IPTABLES -A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
-    $IPTABLES -A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
+    $IPTABLES -A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
+    $IPTABLES -A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
+    $IPTABLES -A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
     # drop packets that do not match any valid state and log them
     $IPTABLES -N drop_invalid
-    $IPTABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IPTABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IPTABLES -A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix "INVALID state -- DENY "
     $IPTABLES -A drop_invalid -j DROP
 
@@ -924,24 +924,24 @@ script_body() {
     # firewall2-1:Policy:4: error: Rule '4 (eth1,eth3)' shadows rule '5 (eth1,eth3)'  below it
     # firewall2-1:Policy:4: error: Rule '4 (eth1,eth3)' shadows rule '6 (eth1,eth3)'  below it
 
-    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -m multiport  -d 255.255.255.255   --destination-port 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth3  -p udp -m udp  -m multiport  -d 255.255.255.255   --destination-port 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -m multiport  -d 255.255.255.255   --destination-port 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth3  -p udp -m udp  -m multiport  -d 255.255.255.255   --destination-port 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -m multiport  -d 255.255.255.255   --destination-port 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth3  -p udp -m udp  -m multiport  -d 255.255.255.255   --destination-port 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -m multiport  -d 255.255.255.255   --destination-port 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth3  -p udp -m udp  -m multiport  -d 255.255.255.255   --destination-port 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (eth1,eth3)
     # 
     echo "Rule 5 (eth1,eth3)"
     # 
-    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --destination-port 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth3  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --destination-port 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --destination-port 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth3  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --destination-port 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 6 (eth1,eth3)
     # 
     echo "Rule 6 (eth1,eth3)"
     # 
-    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -m multiport  -s 192.168.1.0/24   -d 255.255.255.255   --destination-port 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth3  -p udp -m udp  -m multiport  -s 192.168.1.0/24   -d 255.255.255.255   --destination-port 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -m multiport  -s 192.168.1.0/24   -d 255.255.255.255   --destination-port 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth3  -p udp -m udp  -m multiport  -s 192.168.1.0/24   -d 255.255.255.255   --destination-port 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 7 (global)
     # 
@@ -1007,7 +1007,7 @@ script_body() {
     # using module iprange if
     # iptables version is >= 1.2.11
     $IPTABLES -N Cid112778X70161.0
-    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid112778X70161.0
+    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid112778X70161.0
     $IPTABLES -A Cid112778X70161.0  -d 192.168.1.10/31   -j ACCEPT
     $IPTABLES -A Cid112778X70161.0  -d 192.168.1.12/30   -j ACCEPT
     $IPTABLES -A Cid112778X70161.0  -d 192.168.1.16/28   -j ACCEPT
@@ -1016,7 +1016,7 @@ script_body() {
     $IPTABLES -A Cid112778X70161.0  -d 192.168.1.96/30   -j ACCEPT
     $IPTABLES -A Cid112778X70161.0  -d 192.168.1.100   -j ACCEPT
     $IPTABLES -N Cid112778X70161.1
-    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid112778X70161.1
+    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid112778X70161.1
     $IPTABLES -A Cid112778X70161.1  -d 192.168.1.10/31   -j ACCEPT
     $IPTABLES -A Cid112778X70161.1  -d 192.168.1.12/30   -j ACCEPT
     $IPTABLES -A Cid112778X70161.1  -d 192.168.1.16/28   -j ACCEPT
@@ -1025,7 +1025,7 @@ script_body() {
     $IPTABLES -A Cid112778X70161.1  -d 192.168.1.96/30   -j ACCEPT
     $IPTABLES -A Cid112778X70161.1  -d 192.168.1.100   -j ACCEPT
     $IPTABLES -N Cid112778X70161.2
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid112778X70161.2
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid112778X70161.2
     $IPTABLES -A Cid112778X70161.2  -d 192.168.1.10/31   -j ACCEPT
     $IPTABLES -A Cid112778X70161.2  -d 192.168.1.12/30   -j ACCEPT
     $IPTABLES -A Cid112778X70161.2  -d 192.168.1.16/28   -j ACCEPT
@@ -1041,7 +1041,7 @@ script_body() {
     # using module iprange if
     # iptables version is >= 1.2.11
     $IPTABLES -N Cid94383X70161.0
-    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94383X70161.0
+    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94383X70161.0
     $IPTABLES -A Cid94383X70161.0  -s 192.168.1.10/31   -j ACCEPT
     $IPTABLES -A Cid94383X70161.0  -s 192.168.1.12/30   -j ACCEPT
     $IPTABLES -A Cid94383X70161.0  -s 192.168.1.16/28   -j ACCEPT
@@ -1050,7 +1050,7 @@ script_body() {
     $IPTABLES -A Cid94383X70161.0  -s 192.168.1.96/30   -j ACCEPT
     $IPTABLES -A Cid94383X70161.0  -s 192.168.1.100   -j ACCEPT
     $IPTABLES -N Cid94383X70161.1
-    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94383X70161.1
+    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94383X70161.1
     $IPTABLES -A Cid94383X70161.1  -s 192.168.1.10/31   -j ACCEPT
     $IPTABLES -A Cid94383X70161.1  -s 192.168.1.12/30   -j ACCEPT
     $IPTABLES -A Cid94383X70161.1  -s 192.168.1.16/28   -j ACCEPT
@@ -1059,7 +1059,7 @@ script_body() {
     $IPTABLES -A Cid94383X70161.1  -s 192.168.1.96/30   -j ACCEPT
     $IPTABLES -A Cid94383X70161.1  -s 192.168.1.100   -j ACCEPT
     $IPTABLES -N Cid94383X70161.2
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94383X70161.2
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94383X70161.2
     $IPTABLES -A Cid94383X70161.2  -s 192.168.1.10/31   -j ACCEPT
     $IPTABLES -A Cid94383X70161.2  -s 192.168.1.12/30   -j ACCEPT
     $IPTABLES -A Cid94383X70161.2  -s 192.168.1.16/28   -j ACCEPT
@@ -1075,7 +1075,7 @@ script_body() {
     # using module iprange if
     # iptables version is >= 1.2.11
     $IPTABLES -N Cid131133X70161.0
-    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid131133X70161.0
+    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid131133X70161.0
     $IPTABLES -N Cid131133X70161.1
     $IPTABLES -A Cid131133X70161.0  -s 222.222.222.10/31   -j Cid131133X70161.1
     $IPTABLES -A Cid131133X70161.0  -s 222.222.222.12/30   -j Cid131133X70161.1
@@ -1092,7 +1092,7 @@ script_body() {
     $IPTABLES -A Cid131133X70161.1  -d 192.168.1.96/30   -j ACCEPT
     $IPTABLES -A Cid131133X70161.1  -d 192.168.1.100   -j ACCEPT
     $IPTABLES -N Cid131133X70161.2
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid131133X70161.2
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid131133X70161.2
     $IPTABLES -N Cid131133X70161.3
     $IPTABLES -A Cid131133X70161.2  -s 222.222.222.10/31   -j Cid131133X70161.3
     $IPTABLES -A Cid131133X70161.2  -s 222.222.222.12/30   -j Cid131133X70161.3
@@ -1116,7 +1116,7 @@ script_body() {
     # using module iprange if
     # iptables version is >= 1.2.11
     $IPTABLES -N Cid131116X70161.0
-    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid131116X70161.0
+    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid131116X70161.0
     $IPTABLES -N Cid131116X70161.1
     $IPTABLES -A Cid131116X70161.0  -s 192.168.1.10/31   -j Cid131116X70161.1
     $IPTABLES -A Cid131116X70161.0  -s 192.168.1.12/30   -j Cid131116X70161.1
@@ -1133,7 +1133,7 @@ script_body() {
     $IPTABLES -A Cid131116X70161.1  -d 222.222.222.96/30   -j ACCEPT
     $IPTABLES -A Cid131116X70161.1  -d 222.222.222.100   -j ACCEPT
     $IPTABLES -N Cid131116X70161.2
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid131116X70161.2
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid131116X70161.2
     $IPTABLES -N Cid131116X70161.3
     $IPTABLES -A Cid131116X70161.2  -s 192.168.1.10/31   -j Cid131116X70161.3
     $IPTABLES -A Cid131116X70161.2  -s 192.168.1.12/30   -j Cid131116X70161.3
@@ -1157,9 +1157,9 @@ script_body() {
     # using module iprange if
     # iptables version is >= 1.2.11
     $IPTABLES -N Cid94366X70161.0
-    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94366X70161.0
-    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94366X70161.0
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94366X70161.0
+    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94366X70161.0
+    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94366X70161.0
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94366X70161.0
     $IPTABLES -A Cid94366X70161.0  -d 192.168.1.10/31   -j RETURN
     $IPTABLES -A Cid94366X70161.0  -d 192.168.1.12/30   -j RETURN
     $IPTABLES -A Cid94366X70161.0  -d 192.168.1.16/28   -j RETURN
@@ -1176,9 +1176,9 @@ script_body() {
     # using module iprange if
     # iptables version is >= 1.2.11
     $IPTABLES -N Cid94349X70161.0
-    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94349X70161.0
-    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94349X70161.0
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94349X70161.0
+    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94349X70161.0
+    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94349X70161.0
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94349X70161.0
     $IPTABLES -A Cid94349X70161.0  -s 192.168.1.10/31   -j RETURN
     $IPTABLES -A Cid94349X70161.0  -s 192.168.1.12/30   -j RETURN
     $IPTABLES -A Cid94349X70161.0  -s 192.168.1.16/28   -j RETURN
@@ -1195,12 +1195,12 @@ script_body() {
     # using module iprange if
     # iptables version is >= 1.2.11
     $IPTABLES -N Cid94331X70161.0
-    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94331X70161.0
+    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94331X70161.0
     $IPTABLES -A Cid94331X70161.0  -d 192.168.1.0   -j RETURN
     $IPTABLES -A Cid94331X70161.0  -j ACCEPT
     $IPTABLES -N Cid94331X70161.1
-    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94331X70161.1
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94331X70161.1
+    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94331X70161.1
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94331X70161.1
     $IPTABLES -A Cid94331X70161.1  -d 192.168.1.10/31   -j RETURN
     $IPTABLES -A Cid94331X70161.1  -d 192.168.1.12/30   -j RETURN
     $IPTABLES -A Cid94331X70161.1  -d 192.168.1.16/28   -j RETURN
@@ -1217,12 +1217,12 @@ script_body() {
     # using module iprange if
     # iptables version is >= 1.2.11
     $IPTABLES -N Cid94313X70161.0
-    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94313X70161.0
+    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94313X70161.0
     $IPTABLES -A Cid94313X70161.0  -s 192.168.1.0   -j RETURN
     $IPTABLES -A Cid94313X70161.0  -j ACCEPT
     $IPTABLES -N Cid94313X70161.1
-    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94313X70161.1
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94313X70161.1
+    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94313X70161.1
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94313X70161.1
     $IPTABLES -A Cid94313X70161.1  -s 192.168.1.10/31   -j RETURN
     $IPTABLES -A Cid94313X70161.1  -s 192.168.1.12/30   -j RETURN
     $IPTABLES -A Cid94313X70161.1  -s 192.168.1.16/28   -j RETURN
@@ -1251,9 +1251,9 @@ script_body() {
     # 
     # using module iprange if
     # iptables version is >= 1.2.11
-    $IPTABLES -A INPUT -p udp -m udp  -s 192.168.1.1   --dport 161  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p udp -m udp  -s 192.168.1.1   --dport 161  -m conntrack --ctstate NEW  -j ACCEPT
     $IPTABLES -N Cid80837X35957.0
-    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid80837X35957.0
+    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid80837X35957.0
     $IPTABLES -A Cid80837X35957.0  -s 192.168.1.2/31   -j ACCEPT
     $IPTABLES -A Cid80837X35957.0  -s 192.168.1.4/30   -j ACCEPT
     $IPTABLES -A Cid80837X35957.0  -s 192.168.1.8/29   -j ACCEPT
@@ -1262,9 +1262,9 @@ script_body() {
     $IPTABLES -A Cid80837X35957.0  -s 192.168.1.64/27   -j ACCEPT
     $IPTABLES -A Cid80837X35957.0  -s 192.168.1.96/30   -j ACCEPT
     $IPTABLES -A Cid80837X35957.0  -s 192.168.1.100   -j ACCEPT
-    $IPTABLES -A OUTPUT -p udp -m udp  -s 192.168.1.1   --dport 161  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -s 192.168.1.1   --dport 161  -m conntrack --ctstate NEW  -j ACCEPT
     $IPTABLES -N Cid80837X35957.1
-    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid80837X35957.1
+    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid80837X35957.1
     $IPTABLES -A Cid80837X35957.1  -s 192.168.1.2/31   -j ACCEPT
     $IPTABLES -A Cid80837X35957.1  -s 192.168.1.4/30   -j ACCEPT
     $IPTABLES -A Cid80837X35957.1  -s 192.168.1.8/29   -j ACCEPT
@@ -1274,7 +1274,7 @@ script_body() {
     $IPTABLES -A Cid80837X35957.1  -s 192.168.1.96/30   -j ACCEPT
     $IPTABLES -A Cid80837X35957.1  -s 192.168.1.100   -j ACCEPT
     $IPTABLES -N Cid80837X35957.2
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid80837X35957.2
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid80837X35957.2
     $IPTABLES -A Cid80837X35957.2  -s 192.168.1.2/31   -j ACCEPT
     $IPTABLES -A Cid80837X35957.2  -s 192.168.1.4/30   -j ACCEPT
     $IPTABLES -A Cid80837X35957.2  -s 192.168.1.8/29   -j ACCEPT
@@ -1289,7 +1289,7 @@ script_body() {
     echo "Rule 21 (global)"
     # 
     $IPTABLES -N Cid31303X1798.0
-    $IPTABLES -A INPUT -p icmp  -s 192.168.2.0/24   -m state --state NEW  -j Cid31303X1798.0
+    $IPTABLES -A INPUT -p icmp  -s 192.168.2.0/24   -m conntrack --ctstate NEW  -j Cid31303X1798.0
     $IPTABLES -N RULE_21
     $IPTABLES -A Cid31303X1798.0  -d 192.168.2.1   -j RULE_21
     $IPTABLES -A Cid31303X1798.0  -d 192.168.2.40   -j RULE_21
@@ -1301,7 +1301,7 @@ script_body() {
     echo "Rule 22 (global)"
     # 
     $IPTABLES -N Cid31315X1798.0
-    $IPTABLES -A FORWARD  -d 211.11.11.11   -m state --state NEW  -j Cid31315X1798.0
+    $IPTABLES -A FORWARD  -d 211.11.11.11   -m conntrack --ctstate NEW  -j Cid31315X1798.0
     $IPTABLES -A Cid31315X1798.0  -s 192.168.1.10   -j ACCEPT
     $IPTABLES -A Cid31315X1798.0  -s 192.168.1.20   -j ACCEPT
     # 
@@ -1310,7 +1310,7 @@ script_body() {
     echo "Rule 23 (global)"
     # 
     $IPTABLES -N Cid31328X1798.0
-    $IPTABLES -A FORWARD  -s 211.11.11.11   -m state --state NEW  -j Cid31328X1798.0
+    $IPTABLES -A FORWARD  -s 211.11.11.11   -m conntrack --ctstate NEW  -j Cid31328X1798.0
     $IPTABLES -A Cid31328X1798.0  -d 192.168.1.10   -j ACCEPT
     $IPTABLES -A Cid31328X1798.0  -d 192.168.1.20   -j ACCEPT
     # 
@@ -1339,12 +1339,12 @@ script_body() {
     # 
     # firewall2-1:Policy:25: error: Rule '25 (global)' shadows rule '26 (global)'  below it
 
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -s 192.168.2.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.2.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.2.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.2.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.2.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.2.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 26 (global)
     # 
@@ -1364,8 +1364,8 @@ script_body() {
     # host-fw2 has the same address as 
     #         one of the firewall's interfaces
     $IPTABLES -N RULE_27
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 22.22.22.22   --dport 21  -m state --state NEW  -m limit --limit 5/minute --limit-burst 10 -j RULE_27
-    $IPTABLES -A INPUT -p tcp -m tcp  -d 22.22.22.22   --dport 21  -m state --state NEW  -m limit --limit 5/minute --limit-burst 10 -j RULE_27
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 22.22.22.22   --dport 21  -m conntrack --ctstate NEW  -m limit --limit 5/minute --limit-burst 10 -j RULE_27
+    $IPTABLES -A INPUT -p tcp -m tcp  -d 22.22.22.22   --dport 21  -m conntrack --ctstate NEW  -m limit --limit 5/minute --limit-burst 10 -j RULE_27
     $IPTABLES -A RULE_27  -m limit --limit 5/second -j ULOG  --ulog-nlgroup 1 --ulog-prefix "RULE 27 - ACCEPT **" --ulog-qthreshold 1
     $IPTABLES -A RULE_27  -j ACCEPT
     # 
@@ -1374,7 +1374,7 @@ script_body() {
     echo "Rule 28 (global)"
     # 
     $IPTABLES -N Cid31391X1798.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 21  -m state --state NEW  -j Cid31391X1798.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 21  -m conntrack --ctstate NEW  -j Cid31391X1798.0
     $IPTABLES -N RULE_28
     $IPTABLES -A Cid31391X1798.0  -d 22.22.22.22   -j RULE_28
     $IPTABLES -A Cid31391X1798.0  -d 22.22.23.23   -j RULE_28
@@ -1383,7 +1383,7 @@ script_body() {
     $IPTABLES -A Cid31391X1798.0  -d 192.168.2.1   -j RULE_28
     $IPTABLES -A Cid31391X1798.0  -d 192.168.2.40   -j RULE_28
     $IPTABLES -N Cid31391X1798.1
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 21  -m state --state NEW  -j Cid31391X1798.1
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 21  -m conntrack --ctstate NEW  -j Cid31391X1798.1
     $IPTABLES -A Cid31391X1798.1  -d 22.22.22.22   -j RULE_28
     $IPTABLES -A Cid31391X1798.1  -d 22.22.23.23   -j RULE_28
     $IPTABLES -A Cid31391X1798.1  -d 22.22.25.50   -j RULE_28
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall2-2.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall2-2.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall2-2.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall2-2.fw.orig	2014-07-08 16:51:10.981999789 +0200
@@ -345,18 +345,18 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop TCP sessions opened prior firewall restart
-    $IPTABLES -A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
-    $IPTABLES -A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
-    $IPTABLES -A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
+    $IPTABLES -A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
+    $IPTABLES -A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
+    $IPTABLES -A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
     # drop packets that do not match any valid state and log them
     $IPTABLES -N drop_invalid
-    $IPTABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IPTABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IPTABLES -A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix "INVALID state -- DENY "
     $IPTABLES -A drop_invalid -j DROP
     # ================ Table 'mangle', automatic rules
@@ -923,24 +923,24 @@ script_body() {
     # firewall2-2:Policy:4: error: Rule '4 (eth1,eth3)' shadows rule '5 (eth1,eth3)'  below it
     # firewall2-2:Policy:4: error: Rule '4 (eth1,eth3)' shadows rule '6 (eth1,eth3)'  below it
 
-    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth3  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth3  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth3  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth3  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (eth1,eth3)
     # 
     echo "Rule 5 (eth1,eth3)"
     # 
-    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth3  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth3  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 6 (eth1,eth3)
     # 
     echo "Rule 6 (eth1,eth3)"
     # 
-    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -m multiport  -s 192.168.1.0/24   -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth3  -p udp -m udp  -m multiport  -s 192.168.1.0/24   -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -m multiport  -s 192.168.1.0/24   -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth3  -p udp -m udp  -m multiport  -s 192.168.1.0/24   -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 7 (global)
     # 
@@ -1005,8 +1005,8 @@ script_body() {
     # 
     # using module iprange if
     # iptables version is >= 1.2.11
-    $IPTABLES -A OUTPUT -p udp -m udp -m iprange --dst-range 192.168.1.10-192.168.1.100  --dport 161  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p udp -m udp -m iprange --dst-range 192.168.1.10-192.168.1.100  --dport 161  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp -m iprange --dst-range 192.168.1.10-192.168.1.100  --dport 161  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p udp -m udp -m iprange --dst-range 192.168.1.10-192.168.1.100  --dport 161  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 12 (global)
     # 
@@ -1014,8 +1014,8 @@ script_body() {
     # 
     # using module iprange if
     # iptables version is >= 1.2.11
-    $IPTABLES -A INPUT -p udp -m udp -m iprange --src-range 192.168.1.10-192.168.1.100  --dport 161  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p udp -m udp -m iprange --src-range 192.168.1.10-192.168.1.100  --dport 161  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p udp -m udp -m iprange --src-range 192.168.1.10-192.168.1.100  --dport 161  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p udp -m udp -m iprange --src-range 192.168.1.10-192.168.1.100  --dport 161  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 13 (global)
     # 
@@ -1023,7 +1023,7 @@ script_body() {
     # 
     # using module iprange if
     # iptables version is >= 1.2.11
-    $IPTABLES -A FORWARD -p udp -m udp -m iprange --src-range 222.222.222.10-222.222.222.100 --dst-range 192.168.1.10-192.168.1.100  --dport 161  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p udp -m udp -m iprange --src-range 222.222.222.10-222.222.222.100 --dst-range 192.168.1.10-192.168.1.100  --dport 161  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 14 (global)
     # 
@@ -1031,7 +1031,7 @@ script_body() {
     # 
     # using module iprange if
     # iptables version is >= 1.2.11
-    $IPTABLES -A FORWARD -p udp -m udp -m iprange --src-range 192.168.1.10-192.168.1.100 --dst-range 222.222.222.10-222.222.222.100  --dport 161  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p udp -m udp -m iprange --src-range 192.168.1.10-192.168.1.100 --dst-range 222.222.222.10-222.222.222.100  --dport 161  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 15 (global)
     # 
@@ -1040,9 +1040,9 @@ script_body() {
     # using module iprange if
     # iptables version is >= 1.2.11
     $IPTABLES -N Cid94453X70161.0
-    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94453X70161.0
-    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94453X70161.0
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94453X70161.0
+    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94453X70161.0
+    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94453X70161.0
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94453X70161.0
     $IPTABLES -A Cid94453X70161.0 -m iprange --dst-range 192.168.1.10-192.168.1.100  -j RETURN
     $IPTABLES -A Cid94453X70161.0  -j ACCEPT
     # 
@@ -1053,9 +1053,9 @@ script_body() {
     # using module iprange if
     # iptables version is >= 1.2.11
     $IPTABLES -N Cid94436X70161.0
-    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94436X70161.0
-    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94436X70161.0
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94436X70161.0
+    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94436X70161.0
+    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94436X70161.0
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94436X70161.0
     $IPTABLES -A Cid94436X70161.0 -m iprange --src-range 192.168.1.10-192.168.1.100  -j RETURN
     $IPTABLES -A Cid94436X70161.0  -j ACCEPT
     # 
@@ -1066,12 +1066,12 @@ script_body() {
     # using module iprange if
     # iptables version is >= 1.2.11
     $IPTABLES -N Cid94418X70161.0
-    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94418X70161.0
+    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94418X70161.0
     $IPTABLES -A Cid94418X70161.0  -d 192.168.1.0   -j RETURN
     $IPTABLES -A Cid94418X70161.0  -j ACCEPT
     $IPTABLES -N Cid94418X70161.1
-    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94418X70161.1
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94418X70161.1
+    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94418X70161.1
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94418X70161.1
     $IPTABLES -A Cid94418X70161.1 -m iprange --dst-range 192.168.1.10-192.168.1.100  -j RETURN
     $IPTABLES -A Cid94418X70161.1  -j ACCEPT
     # 
@@ -1082,12 +1082,12 @@ script_body() {
     # using module iprange if
     # iptables version is >= 1.2.11
     $IPTABLES -N Cid94400X70161.0
-    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94400X70161.0
+    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94400X70161.0
     $IPTABLES -A Cid94400X70161.0  -s 192.168.1.0   -j RETURN
     $IPTABLES -A Cid94400X70161.0  -j ACCEPT
     $IPTABLES -N Cid94400X70161.1
-    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94400X70161.1
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid94400X70161.1
+    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94400X70161.1
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid94400X70161.1
     $IPTABLES -A Cid94400X70161.1 -m iprange --src-range 192.168.1.10-192.168.1.100  -j RETURN
     $IPTABLES -A Cid94400X70161.1  -j ACCEPT
     # 
@@ -1110,16 +1110,16 @@ script_body() {
     # 
     # using module iprange if
     # iptables version is >= 1.2.11
-    $IPTABLES -A INPUT -p udp -m udp -m iprange --src-range 192.168.1.1-192.168.1.100  --dport 161  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p udp -m udp -m iprange --src-range 192.168.1.1-192.168.1.100  --dport 161  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p udp -m udp -m iprange --src-range 192.168.1.1-192.168.1.100  --dport 161  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p udp -m udp -m iprange --src-range 192.168.1.1-192.168.1.100  --dport 161  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp -m iprange --src-range 192.168.1.1-192.168.1.100  --dport 161  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p udp -m udp -m iprange --src-range 192.168.1.1-192.168.1.100  --dport 161  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 21 (global)
     # 
     echo "Rule 21 (global)"
     # 
     $IPTABLES -N Cid32259X1798.0
-    $IPTABLES -A INPUT -p icmp  -m icmp  -s 192.168.2.0/24   --icmp-type any  -m state --state NEW  -j Cid32259X1798.0
+    $IPTABLES -A INPUT -p icmp  -m icmp  -s 192.168.2.0/24   --icmp-type any  -m conntrack --ctstate NEW  -j Cid32259X1798.0
     $IPTABLES -N RULE_21
     $IPTABLES -A Cid32259X1798.0  -d 192.168.2.1   -j RULE_21
     $IPTABLES -A Cid32259X1798.0  -d 192.168.2.40   -j RULE_21
@@ -1131,7 +1131,7 @@ script_body() {
     echo "Rule 22 (global)"
     # 
     $IPTABLES -N Cid32271X1798.0
-    $IPTABLES -A FORWARD  -d 211.11.11.11   -m state --state NEW  -j Cid32271X1798.0
+    $IPTABLES -A FORWARD  -d 211.11.11.11   -m conntrack --ctstate NEW  -j Cid32271X1798.0
     $IPTABLES -A Cid32271X1798.0  -s 192.168.1.10   -j ACCEPT
     $IPTABLES -A Cid32271X1798.0  -s 192.168.1.20   -j ACCEPT
     # 
@@ -1140,7 +1140,7 @@ script_body() {
     echo "Rule 23 (global)"
     # 
     $IPTABLES -N Cid32284X1798.0
-    $IPTABLES -A FORWARD  -s 211.11.11.11   -m state --state NEW  -j Cid32284X1798.0
+    $IPTABLES -A FORWARD  -s 211.11.11.11   -m conntrack --ctstate NEW  -j Cid32284X1798.0
     $IPTABLES -A Cid32284X1798.0  -d 192.168.1.10   -j ACCEPT
     $IPTABLES -A Cid32284X1798.0  -d 192.168.1.20   -j ACCEPT
     # 
@@ -1169,12 +1169,12 @@ script_body() {
     # 
     # firewall2-2:Policy:25: error: Rule '25 (global)' shadows rule '26 (global)'  below it
 
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -s 192.168.2.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.2.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.2.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.2.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.2.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.2.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 26 (global)
     # 
@@ -1194,8 +1194,8 @@ script_body() {
     # host-fw2 has the same address as 
     #         one of the firewall's interfaces
     $IPTABLES -N RULE_27
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 22.22.22.22   --dport 21  -m state --state NEW  -m limit --limit 5/minute --limit-burst 10 -j RULE_27
-    $IPTABLES -A INPUT -p tcp -m tcp  -d 22.22.22.22   --dport 21  -m state --state NEW  -m limit --limit 5/minute --limit-burst 10 -j RULE_27
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 22.22.22.22   --dport 21  -m conntrack --ctstate NEW  -m limit --limit 5/minute --limit-burst 10 -j RULE_27
+    $IPTABLES -A INPUT -p tcp -m tcp  -d 22.22.22.22   --dport 21  -m conntrack --ctstate NEW  -m limit --limit 5/minute --limit-burst 10 -j RULE_27
     $IPTABLES -A RULE_27  -m limit --limit 5/second -j ULOG  --ulog-nlgroup 1 --ulog-prefix "RULE 27 - ACCEPT **" --ulog-qthreshold 1
     $IPTABLES -A RULE_27  -j ACCEPT
     # 
@@ -1204,7 +1204,7 @@ script_body() {
     echo "Rule 28 (global)"
     # 
     $IPTABLES -N Cid32347X1798.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 21  -m state --state NEW  -j Cid32347X1798.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 21  -m conntrack --ctstate NEW  -j Cid32347X1798.0
     $IPTABLES -N RULE_28
     $IPTABLES -A Cid32347X1798.0  -d 22.22.22.22   -j RULE_28
     $IPTABLES -A Cid32347X1798.0  -d 22.22.23.23   -j RULE_28
@@ -1213,7 +1213,7 @@ script_body() {
     $IPTABLES -A Cid32347X1798.0  -d 192.168.2.1   -j RULE_28
     $IPTABLES -A Cid32347X1798.0  -d 192.168.2.40   -j RULE_28
     $IPTABLES -N Cid32347X1798.1
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 21  -m state --state NEW  -j Cid32347X1798.1
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 21  -m conntrack --ctstate NEW  -j Cid32347X1798.1
     $IPTABLES -A Cid32347X1798.1  -d 22.22.22.22   -j RULE_28
     $IPTABLES -A Cid32347X1798.1  -d 22.22.23.23   -j RULE_28
     $IPTABLES -A Cid32347X1798.1  -d 22.22.25.50   -j RULE_28
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall2-3.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall2-3.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall2-3.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall2-3.fw.orig	2014-07-08 16:51:10.967999964 +0200
@@ -331,18 +331,18 @@ script_body() {
     $IPTABLES -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
 
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop TCP sessions opened prior firewall restart
-    $IPTABLES -A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
-    $IPTABLES -A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
-    $IPTABLES -A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
+    $IPTABLES -A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
+    $IPTABLES -A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
+    $IPTABLES -A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
     # drop packets that do not match any valid state and log them
     $IPTABLES -N drop_invalid
-    $IPTABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IPTABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IPTABLES -A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix "INVALID state -- DENY "
     $IPTABLES -A drop_invalid -j DROP
 
@@ -903,24 +903,24 @@ script_body() {
     # testing choice of chains in case when several
     # interfaces are used and rule matches 'any' or
     # broadcast 
-    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth3  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth3  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth3  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth3  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (eth1,eth3)
     # 
     echo "Rule 5 (eth1,eth3)"
     # 
-    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth3  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth3  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 6 (eth1,eth3)
     # 
     echo "Rule 6 (eth1,eth3)"
     # 
-    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -m multiport  -s 192.168.1.0/24   -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth3  -p udp -m udp  -m multiport  -s 192.168.1.0/24   -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -m multiport  -s 192.168.1.0/24   -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth3  -p udp -m udp  -m multiport  -s 192.168.1.0/24   -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 7 (global)
     # 
@@ -979,7 +979,7 @@ script_body() {
     echo "Rule 11 (global)"
     # 
     $IPTABLES -N Cid35252X1833.0
-    $IPTABLES -A INPUT -p icmp  -s 192.168.2.0/24   -m state --state NEW  -j Cid35252X1833.0
+    $IPTABLES -A INPUT -p icmp  -s 192.168.2.0/24   -m conntrack --ctstate NEW  -j Cid35252X1833.0
     $IPTABLES -N RULE_11
     $IPTABLES -A Cid35252X1833.0  -d 192.168.2.1   -j RULE_11
     $IPTABLES -A Cid35252X1833.0  -d 192.168.2.40   -j RULE_11
@@ -991,7 +991,7 @@ script_body() {
     echo "Rule 12 (global)"
     # 
     $IPTABLES -N Cid35264X1833.0
-    $IPTABLES -A FORWARD  -d 211.11.11.11   -m state --state NEW  -j Cid35264X1833.0
+    $IPTABLES -A FORWARD  -d 211.11.11.11   -m conntrack --ctstate NEW  -j Cid35264X1833.0
     $IPTABLES -A Cid35264X1833.0  -s 192.168.1.10   -j ACCEPT
     $IPTABLES -A Cid35264X1833.0  -s 192.168.1.20   -j ACCEPT
     # 
@@ -1000,7 +1000,7 @@ script_body() {
     echo "Rule 13 (global)"
     # 
     $IPTABLES -N Cid35277X1833.0
-    $IPTABLES -A FORWARD  -s 211.11.11.11   -m state --state NEW  -j Cid35277X1833.0
+    $IPTABLES -A FORWARD  -s 211.11.11.11   -m conntrack --ctstate NEW  -j Cid35277X1833.0
     $IPTABLES -A Cid35277X1833.0  -d 192.168.1.10   -j ACCEPT
     $IPTABLES -A Cid35277X1833.0  -d 192.168.1.20   -j ACCEPT
     # 
@@ -1027,12 +1027,12 @@ script_body() {
     # 
     echo "Rule 15 (global)"
     # 
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -s 192.168.2.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.2.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.2.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.2.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.2.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.2.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 16 (global)
     # 
@@ -1052,8 +1052,8 @@ script_body() {
     # host-fw2 has the same address as 
     #         one of the firewall's interfaces
     $IPTABLES -N RULE_17
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 22.22.22.22   --dport 21  -m state --state NEW  -m limit --limit 5/minute --limit-burst 10 -j RULE_17
-    $IPTABLES -A INPUT -p tcp -m tcp  -d 22.22.22.22   --dport 21  -m state --state NEW  -m limit --limit 5/minute --limit-burst 10 -j RULE_17
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 22.22.22.22   --dport 21  -m conntrack --ctstate NEW  -m limit --limit 5/minute --limit-burst 10 -j RULE_17
+    $IPTABLES -A INPUT -p tcp -m tcp  -d 22.22.22.22   --dport 21  -m conntrack --ctstate NEW  -m limit --limit 5/minute --limit-burst 10 -j RULE_17
     $IPTABLES -A RULE_17  -m limit --limit 5/second -j ULOG  --ulog-nlgroup 1 --ulog-prefix "RULE 17 - ACCEPT **" --ulog-qthreshold 1
     $IPTABLES -A RULE_17  -j ACCEPT
     # 
@@ -1062,7 +1062,7 @@ script_body() {
     echo "Rule 18 (global)"
     # 
     $IPTABLES -N Cid35340X1833.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 21  -m state --state NEW  -j Cid35340X1833.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 21  -m conntrack --ctstate NEW  -j Cid35340X1833.0
     $IPTABLES -N RULE_18
     $IPTABLES -A Cid35340X1833.0  -d 22.22.22.22   -j RULE_18
     $IPTABLES -A Cid35340X1833.0  -d 22.22.23.23   -j RULE_18
@@ -1071,7 +1071,7 @@ script_body() {
     $IPTABLES -A Cid35340X1833.0  -d 192.168.2.1   -j RULE_18
     $IPTABLES -A Cid35340X1833.0  -d 192.168.2.40   -j RULE_18
     $IPTABLES -N Cid35340X1833.1
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 21  -m state --state NEW  -j Cid35340X1833.1
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 21  -m conntrack --ctstate NEW  -j Cid35340X1833.1
     $IPTABLES -A Cid35340X1833.1  -d 22.22.22.22   -j RULE_18
     $IPTABLES -A Cid35340X1833.1  -d 22.22.23.23   -j RULE_18
     $IPTABLES -A Cid35340X1833.1  -d 22.22.25.50   -j RULE_18
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall2-4.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall2-4.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall2-4.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall2-4.fw.orig	2014-07-08 16:51:10.926000489 +0200
@@ -337,18 +337,18 @@ script_body() {
     $IPTABLES -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
 
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop TCP sessions opened prior firewall restart
-    $IPTABLES -A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
-    $IPTABLES -A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
-    $IPTABLES -A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
+    $IPTABLES -A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
+    $IPTABLES -A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
+    $IPTABLES -A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
     # drop packets that do not match any valid state and log them
     $IPTABLES -N drop_invalid
-    $IPTABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IPTABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IPTABLES -A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix "INVALID state -- DENY "
     $IPTABLES -A drop_invalid -j DROP
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall2-5.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall2-5.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall2-5.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall2-5.fw.orig	2014-07-08 16:51:10.986999727 +0200
@@ -328,18 +328,18 @@ script_body() {
     $IPTABLES -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
 
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop TCP sessions opened prior firewall restart
-    $IPTABLES -A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
-    $IPTABLES -A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
-    $IPTABLES -A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
+    $IPTABLES -A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
+    $IPTABLES -A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
+    $IPTABLES -A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
     # drop packets that do not match any valid state and log them
     $IPTABLES -N drop_invalid
-    $IPTABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IPTABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IPTABLES -A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix "INVALID state -- DENY "
     $IPTABLES -A drop_invalid -j DROP
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall2-6.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall2-6.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall2-6.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall2-6.fw.orig	2014-07-08 16:51:11.059998814 +0200
@@ -338,18 +338,18 @@ script_body() {
     $IPTABLES -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
 
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop TCP sessions opened prior firewall restart
-    $IPTABLES -A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
-    $IPTABLES -A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
-    $IPTABLES -A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
+    $IPTABLES -A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
+    $IPTABLES -A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
+    $IPTABLES -A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
     # drop packets that do not match any valid state and log them
     $IPTABLES -N drop_invalid
-    $IPTABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IPTABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IPTABLES -A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix "INVALID state -- DENY "
     $IPTABLES -A drop_invalid -j DROP
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall2-7.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall2-7.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall2-7.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall2-7.fw.orig	2014-07-08 16:51:10.960000064 +0200
@@ -325,18 +325,18 @@ script_body() {
     $IPTABLES -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
 
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop TCP sessions opened prior firewall restart
-    $IPTABLES -A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
-    $IPTABLES -A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
-    $IPTABLES -A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
+    $IPTABLES -A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
+    $IPTABLES -A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
+    $IPTABLES -A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
     # drop packets that do not match any valid state and log them
     $IPTABLES -N drop_invalid
-    $IPTABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IPTABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IPTABLES -A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix "INVALID state -- DENY "
     $IPTABLES -A drop_invalid -j DROP
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall2.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall2.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall2.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall2.fw.orig	2014-07-08 16:51:10.622004290 +0200
@@ -356,18 +356,18 @@ script_body() {
     $IPTABLES -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
 
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop TCP sessions opened prior firewall restart
-    $IPTABLES -A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
-    $IPTABLES -A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
-    $IPTABLES -A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP 
+    $IPTABLES -A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
+    $IPTABLES -A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
+    $IPTABLES -A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP 
     # drop packets that do not match any valid state and log them
     $IPTABLES -N drop_invalid
-    $IPTABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IPTABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IPTABLES -A drop_invalid -j ULOG --ulog-nlgroup 1  --ulog-qthreshold 1 --ulog-prefix "INVALID state -- DENY "
     $IPTABLES -A drop_invalid -j DROP
 
@@ -974,24 +974,24 @@ script_body() {
     # firewall2:Policy:4: error: Rule '4 (eth1,eth3)' shadows rule '5 (eth1,eth3)'  below it
     # firewall2:Policy:4: error: Rule '4 (eth1,eth3)' shadows rule '6 (eth1,eth3)'  below it
 
-    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth3  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth3  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth3  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth3  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (eth1,eth3)
     # 
     echo "Rule 5 (eth1,eth3)"
     # 
-    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth3  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth3  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 6 (eth1,eth3)
     # 
     echo "Rule 6 (eth1,eth3)"
     # 
-    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -m multiport  -s 192.168.1.0/24   -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth3  -p udp -m udp  -m multiport  -s 192.168.1.0/24   -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p udp -m udp  -m multiport  -s 192.168.1.0/24   -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth3  -p udp -m udp  -m multiport  -s 192.168.1.0/24   -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 7 (global)
     # 
@@ -1057,7 +1057,7 @@ script_body() {
     # using module iprange if
     # iptables version is >= 1.2.11
     $IPTABLES -N Cid39895X70161.0
-    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid39895X70161.0
+    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid39895X70161.0
     $IPTABLES -A Cid39895X70161.0  -d 192.168.1.10/31   -j ACCEPT
     $IPTABLES -A Cid39895X70161.0  -d 192.168.1.12/30   -j ACCEPT
     $IPTABLES -A Cid39895X70161.0  -d 192.168.1.16/28   -j ACCEPT
@@ -1066,7 +1066,7 @@ script_body() {
     $IPTABLES -A Cid39895X70161.0  -d 192.168.1.96/30   -j ACCEPT
     $IPTABLES -A Cid39895X70161.0  -d 192.168.1.100   -j ACCEPT
     $IPTABLES -N Cid39895X70161.1
-    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid39895X70161.1
+    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid39895X70161.1
     $IPTABLES -A Cid39895X70161.1  -d 192.168.1.10/31   -j ACCEPT
     $IPTABLES -A Cid39895X70161.1  -d 192.168.1.12/30   -j ACCEPT
     $IPTABLES -A Cid39895X70161.1  -d 192.168.1.16/28   -j ACCEPT
@@ -1075,7 +1075,7 @@ script_body() {
     $IPTABLES -A Cid39895X70161.1  -d 192.168.1.96/30   -j ACCEPT
     $IPTABLES -A Cid39895X70161.1  -d 192.168.1.100   -j ACCEPT
     $IPTABLES -N Cid39895X70161.2
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid39895X70161.2
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid39895X70161.2
     $IPTABLES -A Cid39895X70161.2  -d 192.168.1.10/31   -j ACCEPT
     $IPTABLES -A Cid39895X70161.2  -d 192.168.1.12/30   -j ACCEPT
     $IPTABLES -A Cid39895X70161.2  -d 192.168.1.16/28   -j ACCEPT
@@ -1091,7 +1091,7 @@ script_body() {
     # using module iprange if
     # iptables version is >= 1.2.11
     $IPTABLES -N Cid39909X70161.0
-    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid39909X70161.0
+    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid39909X70161.0
     $IPTABLES -A Cid39909X70161.0  -s 192.168.1.10/31   -j ACCEPT
     $IPTABLES -A Cid39909X70161.0  -s 192.168.1.12/30   -j ACCEPT
     $IPTABLES -A Cid39909X70161.0  -s 192.168.1.16/28   -j ACCEPT
@@ -1100,7 +1100,7 @@ script_body() {
     $IPTABLES -A Cid39909X70161.0  -s 192.168.1.96/30   -j ACCEPT
     $IPTABLES -A Cid39909X70161.0  -s 192.168.1.100   -j ACCEPT
     $IPTABLES -N Cid39909X70161.1
-    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid39909X70161.1
+    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid39909X70161.1
     $IPTABLES -A Cid39909X70161.1  -s 192.168.1.10/31   -j ACCEPT
     $IPTABLES -A Cid39909X70161.1  -s 192.168.1.12/30   -j ACCEPT
     $IPTABLES -A Cid39909X70161.1  -s 192.168.1.16/28   -j ACCEPT
@@ -1109,7 +1109,7 @@ script_body() {
     $IPTABLES -A Cid39909X70161.1  -s 192.168.1.96/30   -j ACCEPT
     $IPTABLES -A Cid39909X70161.1  -s 192.168.1.100   -j ACCEPT
     $IPTABLES -N Cid39909X70161.2
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid39909X70161.2
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid39909X70161.2
     $IPTABLES -A Cid39909X70161.2  -s 192.168.1.10/31   -j ACCEPT
     $IPTABLES -A Cid39909X70161.2  -s 192.168.1.12/30   -j ACCEPT
     $IPTABLES -A Cid39909X70161.2  -s 192.168.1.16/28   -j ACCEPT
@@ -1125,7 +1125,7 @@ script_body() {
     # using module iprange if
     # iptables version is >= 1.2.11
     $IPTABLES -N Cid131093X70161.0
-    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid131093X70161.0
+    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid131093X70161.0
     $IPTABLES -N Cid131093X70161.1
     $IPTABLES -A Cid131093X70161.0  -s 222.222.222.10/31   -j Cid131093X70161.1
     $IPTABLES -A Cid131093X70161.0  -s 222.222.222.12/30   -j Cid131093X70161.1
@@ -1142,7 +1142,7 @@ script_body() {
     $IPTABLES -A Cid131093X70161.1  -d 192.168.1.96/30   -j ACCEPT
     $IPTABLES -A Cid131093X70161.1  -d 192.168.1.100   -j ACCEPT
     $IPTABLES -N Cid131093X70161.2
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid131093X70161.2
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid131093X70161.2
     $IPTABLES -N Cid131093X70161.3
     $IPTABLES -A Cid131093X70161.2  -s 222.222.222.10/31   -j Cid131093X70161.3
     $IPTABLES -A Cid131093X70161.2  -s 222.222.222.12/30   -j Cid131093X70161.3
@@ -1166,7 +1166,7 @@ script_body() {
     # using module iprange if
     # iptables version is >= 1.2.11
     $IPTABLES -N Cid131076X70161.0
-    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid131076X70161.0
+    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid131076X70161.0
     $IPTABLES -N Cid131076X70161.1
     $IPTABLES -A Cid131076X70161.0  -s 192.168.1.10/31   -j Cid131076X70161.1
     $IPTABLES -A Cid131076X70161.0  -s 192.168.1.12/30   -j Cid131076X70161.1
@@ -1183,7 +1183,7 @@ script_body() {
     $IPTABLES -A Cid131076X70161.1  -d 222.222.222.96/30   -j ACCEPT
     $IPTABLES -A Cid131076X70161.1  -d 222.222.222.100   -j ACCEPT
     $IPTABLES -N Cid131076X70161.2
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid131076X70161.2
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid131076X70161.2
     $IPTABLES -N Cid131076X70161.3
     $IPTABLES -A Cid131076X70161.2  -s 192.168.1.10/31   -j Cid131076X70161.3
     $IPTABLES -A Cid131076X70161.2  -s 192.168.1.12/30   -j Cid131076X70161.3
@@ -1207,9 +1207,9 @@ script_body() {
     # using module iprange if
     # iptables version is >= 1.2.11
     $IPTABLES -N Cid57999X70161.0
-    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid57999X70161.0
-    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid57999X70161.0
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid57999X70161.0
+    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid57999X70161.0
+    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid57999X70161.0
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid57999X70161.0
     $IPTABLES -A Cid57999X70161.0  -d 192.168.1.10/31   -j RETURN
     $IPTABLES -A Cid57999X70161.0  -d 192.168.1.12/30   -j RETURN
     $IPTABLES -A Cid57999X70161.0  -d 192.168.1.16/28   -j RETURN
@@ -1226,9 +1226,9 @@ script_body() {
     # using module iprange if
     # iptables version is >= 1.2.11
     $IPTABLES -N Cid58016X70161.0
-    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid58016X70161.0
-    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid58016X70161.0
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid58016X70161.0
+    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid58016X70161.0
+    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid58016X70161.0
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid58016X70161.0
     $IPTABLES -A Cid58016X70161.0  -s 192.168.1.10/31   -j RETURN
     $IPTABLES -A Cid58016X70161.0  -s 192.168.1.12/30   -j RETURN
     $IPTABLES -A Cid58016X70161.0  -s 192.168.1.16/28   -j RETURN
@@ -1245,12 +1245,12 @@ script_body() {
     # using module iprange if
     # iptables version is >= 1.2.11
     $IPTABLES -N Cid76132X70161.0
-    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid76132X70161.0
+    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid76132X70161.0
     $IPTABLES -A Cid76132X70161.0  -d 192.168.1.0   -j RETURN
     $IPTABLES -A Cid76132X70161.0  -j ACCEPT
     $IPTABLES -N Cid76132X70161.1
-    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid76132X70161.1
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid76132X70161.1
+    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid76132X70161.1
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid76132X70161.1
     $IPTABLES -A Cid76132X70161.1  -d 192.168.1.10/31   -j RETURN
     $IPTABLES -A Cid76132X70161.1  -d 192.168.1.12/30   -j RETURN
     $IPTABLES -A Cid76132X70161.1  -d 192.168.1.16/28   -j RETURN
@@ -1267,12 +1267,12 @@ script_body() {
     # using module iprange if
     # iptables version is >= 1.2.11
     $IPTABLES -N Cid76149X70161.0
-    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid76149X70161.0
+    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid76149X70161.0
     $IPTABLES -A Cid76149X70161.0  -s 192.168.1.0   -j RETURN
     $IPTABLES -A Cid76149X70161.0  -j ACCEPT
     $IPTABLES -N Cid76149X70161.1
-    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid76149X70161.1
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid76149X70161.1
+    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid76149X70161.1
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid76149X70161.1
     $IPTABLES -A Cid76149X70161.1  -s 192.168.1.10/31   -j RETURN
     $IPTABLES -A Cid76149X70161.1  -s 192.168.1.12/30   -j RETURN
     $IPTABLES -A Cid76149X70161.1  -s 192.168.1.16/28   -j RETURN
@@ -1301,9 +1301,9 @@ script_body() {
     # 
     # using module iprange if
     # iptables version is >= 1.2.11
-    $IPTABLES -A INPUT -p udp -m udp  -s 192.168.1.1   --dport 161  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p udp -m udp  -s 192.168.1.1   --dport 161  -m conntrack --ctstate NEW  -j ACCEPT
     $IPTABLES -N Cid42387X35957.0
-    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid42387X35957.0
+    $IPTABLES -A INPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid42387X35957.0
     $IPTABLES -A Cid42387X35957.0  -s 192.168.1.2/31   -j ACCEPT
     $IPTABLES -A Cid42387X35957.0  -s 192.168.1.4/30   -j ACCEPT
     $IPTABLES -A Cid42387X35957.0  -s 192.168.1.8/29   -j ACCEPT
@@ -1312,9 +1312,9 @@ script_body() {
     $IPTABLES -A Cid42387X35957.0  -s 192.168.1.64/27   -j ACCEPT
     $IPTABLES -A Cid42387X35957.0  -s 192.168.1.96/30   -j ACCEPT
     $IPTABLES -A Cid42387X35957.0  -s 192.168.1.100   -j ACCEPT
-    $IPTABLES -A OUTPUT -p udp -m udp  -s 192.168.1.1   --dport 161  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -s 192.168.1.1   --dport 161  -m conntrack --ctstate NEW  -j ACCEPT
     $IPTABLES -N Cid42387X35957.1
-    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m state --state NEW  -j Cid42387X35957.1
+    $IPTABLES -A OUTPUT -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid42387X35957.1
     $IPTABLES -A Cid42387X35957.1  -s 192.168.1.2/31   -j ACCEPT
     $IPTABLES -A Cid42387X35957.1  -s 192.168.1.4/30   -j ACCEPT
     $IPTABLES -A Cid42387X35957.1  -s 192.168.1.8/29   -j ACCEPT
@@ -1324,7 +1324,7 @@ script_body() {
     $IPTABLES -A Cid42387X35957.1  -s 192.168.1.96/30   -j ACCEPT
     $IPTABLES -A Cid42387X35957.1  -s 192.168.1.100   -j ACCEPT
     $IPTABLES -N Cid42387X35957.2
-    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m state --state NEW  -j Cid42387X35957.2
+    $IPTABLES -A FORWARD -p udp -m udp  --dport 161  -m conntrack --ctstate NEW  -j Cid42387X35957.2
     $IPTABLES -A Cid42387X35957.2  -s 192.168.1.2/31   -j ACCEPT
     $IPTABLES -A Cid42387X35957.2  -s 192.168.1.4/30   -j ACCEPT
     $IPTABLES -A Cid42387X35957.2  -s 192.168.1.8/29   -j ACCEPT
@@ -1339,7 +1339,7 @@ script_body() {
     echo "Rule 21 (global)"
     # 
     $IPTABLES -N Cid3DD1E1E0.0
-    $IPTABLES -A INPUT -p icmp  -m icmp  -s 192.168.2.0/24   --icmp-type any  -m state --state NEW  -j Cid3DD1E1E0.0
+    $IPTABLES -A INPUT -p icmp  -m icmp  -s 192.168.2.0/24   --icmp-type any  -m conntrack --ctstate NEW  -j Cid3DD1E1E0.0
     $IPTABLES -N RULE_21
     $IPTABLES -A Cid3DD1E1E0.0  -d 192.168.2.1   -j RULE_21
     $IPTABLES -A Cid3DD1E1E0.0  -d 192.168.2.40   -j RULE_21
@@ -1351,7 +1351,7 @@ script_body() {
     echo "Rule 22 (global)"
     # 
     $IPTABLES -N Cid3D8FC846.0
-    $IPTABLES -A FORWARD  -d 211.11.11.11   -m state --state NEW  -j Cid3D8FC846.0
+    $IPTABLES -A FORWARD  -d 211.11.11.11   -m conntrack --ctstate NEW  -j Cid3D8FC846.0
     $IPTABLES -A Cid3D8FC846.0  -s 192.168.1.10   -j ACCEPT
     $IPTABLES -A Cid3D8FC846.0  -s 192.168.1.20   -j ACCEPT
     # 
@@ -1360,7 +1360,7 @@ script_body() {
     echo "Rule 23 (global)"
     # 
     $IPTABLES -N Cid3D8FC984.0
-    $IPTABLES -A FORWARD  -s 211.11.11.11   -m state --state NEW  -j Cid3D8FC984.0
+    $IPTABLES -A FORWARD  -s 211.11.11.11   -m conntrack --ctstate NEW  -j Cid3D8FC984.0
     $IPTABLES -A Cid3D8FC984.0  -d 192.168.1.10   -j ACCEPT
     $IPTABLES -A Cid3D8FC984.0  -d 192.168.1.20   -j ACCEPT
     # 
@@ -1389,12 +1389,12 @@ script_body() {
     # 
     # firewall2:Policy:25: error: Rule '25 (global)' shadows rule '26 (global)'  below it
 
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -s 192.168.2.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.2.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.2.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.2.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.2.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.2.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 26 (global)
     # 
@@ -1414,8 +1414,8 @@ script_body() {
     # host-fw2 has the same address as 
     #         one of the firewall's interfaces
     $IPTABLES -N RULE_27
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 22.22.22.22   --dport 21  -m state --state NEW  -m limit --limit 5/minute --limit-burst 10 -j RULE_27
-    $IPTABLES -A INPUT -p tcp -m tcp  -d 22.22.22.22   --dport 21  -m state --state NEW  -m limit --limit 5/minute --limit-burst 10 -j RULE_27
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 22.22.22.22   --dport 21  -m conntrack --ctstate NEW  -m limit --limit 5/minute --limit-burst 10 -j RULE_27
+    $IPTABLES -A INPUT -p tcp -m tcp  -d 22.22.22.22   --dport 21  -m conntrack --ctstate NEW  -m limit --limit 5/minute --limit-burst 10 -j RULE_27
     $IPTABLES -A RULE_27  -m limit --limit 5/second -j ULOG  --ulog-nlgroup 1 --ulog-prefix "RULE 27 - ACCEPT **" --ulog-qthreshold 1
     $IPTABLES -A RULE_27  -j ACCEPT
     # 
@@ -1424,7 +1424,7 @@ script_body() {
     echo "Rule 28 (global)"
     # 
     $IPTABLES -N Cid3C447BCB.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 21  -m state --state NEW  -j Cid3C447BCB.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 21  -m conntrack --ctstate NEW  -j Cid3C447BCB.0
     $IPTABLES -N RULE_28
     $IPTABLES -A Cid3C447BCB.0  -d 22.22.22.22   -j RULE_28
     $IPTABLES -A Cid3C447BCB.0  -d 22.22.23.23   -j RULE_28
@@ -1433,7 +1433,7 @@ script_body() {
     $IPTABLES -A Cid3C447BCB.0  -d 192.168.2.1   -j RULE_28
     $IPTABLES -A Cid3C447BCB.0  -d 192.168.2.40   -j RULE_28
     $IPTABLES -N Cid3C447BCB.1
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 21  -m state --state NEW  -j Cid3C447BCB.1
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 21  -m conntrack --ctstate NEW  -j Cid3C447BCB.1
     $IPTABLES -A Cid3C447BCB.1  -d 22.22.22.22   -j RULE_28
     $IPTABLES -A Cid3C447BCB.1  -d 22.22.23.23   -j RULE_28
     $IPTABLES -A Cid3C447BCB.1  -d 22.22.25.50   -j RULE_28
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall20-ipv6.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall20-ipv6.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall20-ipv6.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall20-ipv6.fw.orig	2014-07-08 16:51:10.611004427 +0200
@@ -368,7 +368,7 @@ script_body() {
     echo "Rule 8 (global)"
     # 
     $IP6TABLES -N Cid30296X26784.0
-    $IP6TABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid30296X26784.0
+    $IP6TABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid30296X26784.0
     getinterfaces ppp | while read I; do
         ivar=$(getInterfaceVarName $I)
         getaddr6 $I $ivar
@@ -381,7 +381,7 @@ script_body() {
     done
     $IP6TABLES -A Cid30296X26784.0  -d 2001:470:1f05:590::1   -j ACCEPT
     $IP6TABLES -A Cid30296X26784.0  -d fe80::1   -j ACCEPT
-    $IP6TABLES -A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 9 (global)
     # 
@@ -394,7 +394,7 @@ script_body() {
         eval "addr_list=$cmd"
         for addr in $addr_list
         do
-            test -n "$addr" && $IP6TABLES -A OUTPUT -p tcp -m tcp  -d $addr   --dport 22  -m state --state NEW  -j ACCEPT
+            test -n "$addr" && $IP6TABLES -A OUTPUT -p tcp -m tcp  -d $addr   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
         done
     done
     getinterfaces ppp | while read I; do
@@ -404,7 +404,7 @@ script_body() {
         eval "addr_list=$cmd"
         for addr in $addr_list
         do
-            test -n "$addr" && $IP6TABLES -A INPUT -p tcp -m tcp  -d $addr   --dport 22  -m state --state NEW  -j ACCEPT
+            test -n "$addr" && $IP6TABLES -A INPUT -p tcp -m tcp  -d $addr   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
         done
     done
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall20.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall20.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall20.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall20.fw.orig	2014-07-08 16:51:11.091998414 +0200
@@ -454,7 +454,7 @@ script_body() {
     # 
     # ppp clients can only connect to the mail
     # server and web proxy on DMZ
-    $IPTABLES -A FORWARD -i ppp+  -p tcp -m tcp  -m multiport  -d 192.168.2.10   --dports 25,3128  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i ppp+  -p tcp -m tcp  -m multiport  -d 192.168.2.10   --dports 25,3128  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (ppp*)
     # 
@@ -475,8 +475,8 @@ script_body() {
     # 
     echo "Rule 5 (ppp*)"
     # 
-    $IPTABLES -A INPUT -i ppp+   -s ! 33.33.33.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i ppp+   -s ! 33.33.33.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i ppp+   -s ! 33.33.33.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i ppp+   -s ! 33.33.33.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 6 (eth2)
     # 
@@ -494,8 +494,8 @@ script_body() {
     # 
     # hostF has the same IP address as firewal.
     $IPTABLES -N RULE_7
-    $IPTABLES -A OUTPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m state --state NEW  -j RULE_7
-    $IPTABLES -A INPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m state --state NEW  -j RULE_7
+    $IPTABLES -A OUTPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j RULE_7
+    $IPTABLES -A INPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j RULE_7
     $IPTABLES -A RULE_7  -j LOG
     $IPTABLES -A RULE_7  -j ACCEPT
     # 
@@ -504,7 +504,7 @@ script_body() {
     echo "Rule 8 (global)"
     # 
     $IPTABLES -N Cid3EFBC67F.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid3EFBC67F.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid3EFBC67F.0
     getinterfaces ppp | while read I; do
         ivar=$(getInterfaceVarName $I)
         getaddr $I $ivar
@@ -517,7 +517,7 @@ script_body() {
     done
     $IPTABLES -A Cid3EFBC67F.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid3EFBC67F.0  -d 192.168.2.1   -j ACCEPT
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 9 (global)
     # 
@@ -530,7 +530,7 @@ script_body() {
         eval "addr_list=$cmd"
         for addr in $addr_list
         do
-            test -n "$addr" && $IPTABLES -A OUTPUT -p tcp -m tcp  -d $addr   --dport 22  -m state --state NEW  -j ACCEPT
+            test -n "$addr" && $IPTABLES -A OUTPUT -p tcp -m tcp  -d $addr   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
         done
     done
     getinterfaces ppp | while read I; do
@@ -540,7 +540,7 @@ script_body() {
         eval "addr_list=$cmd"
         for addr in $addr_list
         do
-            test -n "$addr" && $IPTABLES -A INPUT -p tcp -m tcp  -d $addr   --dport 22  -m state --state NEW  -j ACCEPT
+            test -n "$addr" && $IPTABLES -A INPUT -p tcp -m tcp  -d $addr   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
         done
     done
     # 
@@ -548,26 +548,26 @@ script_body() {
     # 
     echo "Rule 10 (global)"
     # 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.1   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p tcp -m tcp  -d 192.168.1.1   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.1   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -d 192.168.1.1   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 11 (global)
     # 
     echo "Rule 11 (global)"
     # 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -m multiport  -d 192.168.1.1   --dports 22,23  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p tcp -m tcp  -m multiport  -d 192.168.1.1   --dports 22,23  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -m multiport  -d 192.168.1.1   --dports 22,23  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -m multiport  -d 192.168.1.1   --dports 22,23  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 12 (global)
     # 
     echo "Rule 12 (global)"
     # 
     $IPTABLES -N Cid3EFBC6A8.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m state --state NEW  -j Cid3EFBC6A8.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m conntrack --ctstate NEW  -j Cid3EFBC6A8.0
     $IPTABLES -A Cid3EFBC6A8.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid3EFBC6A8.0  -d 192.168.2.1   -j ACCEPT
     $IPTABLES -N Cid3EFBC6A8.1
-    $IPTABLES -A INPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m state --state NEW  -j Cid3EFBC6A8.1
+    $IPTABLES -A INPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m conntrack --ctstate NEW  -j Cid3EFBC6A8.1
     $IPTABLES -A Cid3EFBC6A8.1  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid3EFBC6A8.1  -d 192.168.2.1   -j ACCEPT
     # 
@@ -576,12 +576,12 @@ script_body() {
     echo "Rule 13 (global)"
     # 
     $IPTABLES -N Cid3EFBC6B3.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m state --state NEW  -j Cid3EFBC6B3.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m conntrack --ctstate NEW  -j Cid3EFBC6B3.0
     $IPTABLES -N RULE_13
     $IPTABLES -A Cid3EFBC6B3.0  -d 192.168.1.1   -j RULE_13
     $IPTABLES -A Cid3EFBC6B3.0  -d 192.168.2.1   -j RULE_13
     $IPTABLES -N Cid3EFBC6B3.1
-    $IPTABLES -A INPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m state --state NEW  -j Cid3EFBC6B3.1
+    $IPTABLES -A INPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m conntrack --ctstate NEW  -j Cid3EFBC6B3.1
     $IPTABLES -A Cid3EFBC6B3.1  -d 192.168.1.1   -j RULE_13
     $IPTABLES -A Cid3EFBC6B3.1  -d 192.168.2.1   -j RULE_13
     $IPTABLES -A RULE_13  -j LOG
@@ -594,8 +594,8 @@ script_body() {
     # firewall is part of Any, so compiler should
     # generate code in both FORWARD and
     # OUTPUT chains
-    $IPTABLES -A OUTPUT  -d 200.200.200.200   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 200.200.200.200   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 200.200.200.200   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 200.200.200.200   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 15 (global)
     # 
@@ -604,8 +604,8 @@ script_body() {
     # firewall is part of Any, compiler should
     # generate code for both FORWARD and
     # INPUT chains
-    $IPTABLES -A INPUT  -s 200.200.200.200   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 200.200.200.200   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 200.200.200.200   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 200.200.200.200   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 16 (global)
     # 
@@ -614,19 +614,19 @@ script_body() {
     # because firewall has interface on network
     # internal_net, compiler should generate code
     # for both FORWARD and INPUT chains
-    $IPTABLES -A INPUT  -s 192.168.1.10   -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.10   -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.10   -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.10   -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 17 (global)
     # 
     echo "Rule 17 (global)"
     # 
     $IPTABLES -N Cid3EFBC6DC.0
-    $IPTABLES -A OUTPUT  -d 200.200.200.200   -m state --state NEW  -j Cid3EFBC6DC.0
+    $IPTABLES -A OUTPUT  -d 200.200.200.200   -m conntrack --ctstate NEW  -j Cid3EFBC6DC.0
     $IPTABLES -A Cid3EFBC6DC.0  -s 192.168.1.0/24   -j ACCEPT
     $IPTABLES -A Cid3EFBC6DC.0  -s 192.168.2.0/24   -j ACCEPT
     $IPTABLES -N Cid3EFBC6DC.1
-    $IPTABLES -A FORWARD  -d 200.200.200.200   -m state --state NEW  -j Cid3EFBC6DC.1
+    $IPTABLES -A FORWARD  -d 200.200.200.200   -m conntrack --ctstate NEW  -j Cid3EFBC6DC.1
     $IPTABLES -A Cid3EFBC6DC.1  -s 192.168.1.0/24   -j ACCEPT
     $IPTABLES -A Cid3EFBC6DC.1  -s 192.168.2.0/24   -j ACCEPT
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall21-1.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall21-1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall21-1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall21-1.fw.orig	2014-07-08 16:51:11.094998376 +0200
@@ -316,9 +316,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -389,7 +389,7 @@ script_body() {
     # 
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A OUTPUT -o eth0   -s $i_eth0   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A OUTPUT -o eth0   -s $i_eth0   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 1 (global)
@@ -398,37 +398,37 @@ script_body() {
     # 
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A INPUT  -s $i_eth0   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A INPUT  -s $i_eth0   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     for i_eth1 in $i_eth1_list
     do
-    test -n "$i_eth1" && $IPTABLES -A INPUT  -s $i_eth1   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth1" && $IPTABLES -A INPUT  -s $i_eth1   -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A OUTPUT  -s $i_eth0   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A OUTPUT  -s $i_eth0   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     for i_eth1 in $i_eth1_list
     do
-    test -n "$i_eth1" && $IPTABLES -A OUTPUT  -s $i_eth1   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth1" && $IPTABLES -A OUTPUT  -s $i_eth1   -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (global)
     # 
     echo "Rule 2 (global)"
     # 
-    $IPTABLES -A OUTPUT -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A OUTPUT -p udp -m udp  -m multiport  -d $i_eth0   --dports 68,67  -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A OUTPUT -p udp -m udp  -m multiport  -d $i_eth0   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A INPUT -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A INPUT -p udp -m udp  -m multiport  -d $i_eth0   --dports 68,67  -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A INPUT -p udp -m udp  -m multiport  -d $i_eth0   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 3 (global)
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall21.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall21.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall21.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall21.fw.orig	2014-07-08 16:51:10.420006815 +0200
@@ -315,9 +315,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -388,7 +388,7 @@ script_body() {
     # 
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A OUTPUT -o eth0   -s $i_eth0   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A OUTPUT -o eth0   -s $i_eth0   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 1 (global)
@@ -397,37 +397,37 @@ script_body() {
     # 
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A INPUT  -s $i_eth0   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A INPUT  -s $i_eth0   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     for i_eth1 in $i_eth1_list
     do
-    test -n "$i_eth1" && $IPTABLES -A INPUT  -s $i_eth1   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth1" && $IPTABLES -A INPUT  -s $i_eth1   -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A OUTPUT  -s $i_eth0   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A OUTPUT  -s $i_eth0   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     for i_eth1 in $i_eth1_list
     do
-    test -n "$i_eth1" && $IPTABLES -A OUTPUT  -s $i_eth1   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth1" && $IPTABLES -A OUTPUT  -s $i_eth1   -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (global)
     # 
     echo "Rule 2 (global)"
     # 
-    $IPTABLES -A OUTPUT -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A OUTPUT -p udp -m udp  -m multiport  -d $i_eth0   --dports 68,67  -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A OUTPUT -p udp -m udp  -m multiport  -d $i_eth0   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A INPUT -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A INPUT -p udp -m udp  -m multiport  -d $i_eth0   --dports 68,67  -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A INPUT -p udp -m udp  -m multiport  -d $i_eth0   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 3 (global)
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall23-1.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall23-1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall23-1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall23-1.fw.orig	2014-07-08 16:51:10.567004977 +0200
@@ -307,9 +307,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
     # ================ Table 'mangle', automatic rules
     $IPTABLES -t mangle -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
 
@@ -341,29 +341,29 @@ script_body() {
     # 
     echo "Rule 0 (eth2,eth3)"
     # 
-    $IPTABLES -A FORWARD -m physdev --physdev-in eth2  -d 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -m physdev --physdev-in eth3  -d 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -m physdev --physdev-in eth2  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -m physdev --physdev-in eth3  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m physdev --physdev-in eth2  -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m physdev --physdev-in eth3  -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -m physdev --physdev-in eth2  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -m physdev --physdev-in eth3  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (eth2,eth3)
     # 
     echo "Rule 1 (eth2,eth3)"
     # 
-    $IPTABLES -A INPUT -m physdev --physdev-in eth2  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -m physdev --physdev-in eth3  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -m physdev --physdev-in eth2  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -m physdev --physdev-in eth3  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -m physdev --physdev-in eth2  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -m physdev --physdev-in eth3  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m physdev --physdev-in eth2  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m physdev --physdev-in eth3  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (eth2,eth3)
     # 
     echo "Rule 2 (eth2,eth3)"
     # 
     $IPTABLES -N In_RULE_2
-    $IPTABLES -A FORWARD -m physdev --physdev-in eth2  -d 192.168.1.10   -m state --state NEW  -j In_RULE_2
-    $IPTABLES -A FORWARD -m physdev --physdev-in eth2  -d 192.168.1.20   -m state --state NEW  -j In_RULE_2
-    $IPTABLES -A FORWARD -m physdev --physdev-in eth3  -d 192.168.1.10   -m state --state NEW  -j In_RULE_2
-    $IPTABLES -A FORWARD -m physdev --physdev-in eth3  -d 192.168.1.20   -m state --state NEW  -j In_RULE_2
+    $IPTABLES -A FORWARD -m physdev --physdev-in eth2  -d 192.168.1.10   -m conntrack --ctstate NEW  -j In_RULE_2
+    $IPTABLES -A FORWARD -m physdev --physdev-in eth2  -d 192.168.1.20   -m conntrack --ctstate NEW  -j In_RULE_2
+    $IPTABLES -A FORWARD -m physdev --physdev-in eth3  -d 192.168.1.10   -m conntrack --ctstate NEW  -j In_RULE_2
+    $IPTABLES -A FORWARD -m physdev --physdev-in eth3  -d 192.168.1.20   -m conntrack --ctstate NEW  -j In_RULE_2
     $IPTABLES -A In_RULE_2  -j LOG  --log-level debug
     $IPTABLES -A In_RULE_2  -j ACCEPT
     # 
@@ -373,12 +373,12 @@ script_body() {
     # 
     # testing for bug 1593221
     $IPTABLES -N Cid45546AAE30629.0
-    $IPTABLES -A FORWARD -m physdev --physdev-in eth2  -s 192.168.1.0/24   -m state --state NEW  -j Cid45546AAE30629.0
+    $IPTABLES -A FORWARD -m physdev --physdev-in eth2  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid45546AAE30629.0
     $IPTABLES -N In_RULE_3
     $IPTABLES -A Cid45546AAE30629.0  -d 192.168.1.10   -j In_RULE_3
     $IPTABLES -A Cid45546AAE30629.0  -d 192.168.1.20   -j In_RULE_3
     $IPTABLES -N Cid45546AAE30629.1
-    $IPTABLES -A FORWARD -m physdev --physdev-in eth3  -s 192.168.1.0/24   -m state --state NEW  -j Cid45546AAE30629.1
+    $IPTABLES -A FORWARD -m physdev --physdev-in eth3  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid45546AAE30629.1
     $IPTABLES -A Cid45546AAE30629.1  -d 192.168.1.10   -j In_RULE_3
     $IPTABLES -A Cid45546AAE30629.1  -d 192.168.1.20   -j In_RULE_3
     $IPTABLES -A In_RULE_3  -j LOG  --log-level debug
@@ -388,36 +388,36 @@ script_body() {
     # 
     echo "Rule 4 (eth2,eth3)"
     # 
-    $IPTABLES -A FORWARD -m physdev --physdev-in eth2  -d 192.168.1.255   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -m physdev --physdev-in eth3  -d 192.168.1.255   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m physdev --physdev-in eth2  -d 192.168.1.255   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m physdev --physdev-in eth3  -d 192.168.1.255   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (eth2,eth3)
     # 
     echo "Rule 5 (eth2,eth3)"
     # 
-    $IPTABLES -A FORWARD -m physdev --physdev-in eth2  -d 255.255.255.255   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -m physdev --physdev-in eth3  -d 255.255.255.255   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m physdev --physdev-in eth2  -d 255.255.255.255   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m physdev --physdev-in eth3  -d 255.255.255.255   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 6 (eth2,eth3)
     # 
     echo "Rule 6 (eth2,eth3)"
     # 
-    $IPTABLES -A FORWARD -m physdev --physdev-in eth2  -d 224.0.1.141   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -m physdev --physdev-in eth3  -d 224.0.1.141   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m physdev --physdev-in eth2  -d 224.0.1.141   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m physdev --physdev-in eth3  -d 224.0.1.141   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 7 (eth2,eth3)
     # 
     echo "Rule 7 (eth2,eth3)"
     # 
-    $IPTABLES -A FORWARD -m physdev --physdev-in eth2  -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -m physdev --physdev-in eth3  -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m physdev --physdev-in eth2  -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m physdev --physdev-in eth3  -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 8 (eth2,eth3)
     # 
     echo "Rule 8 (eth2,eth3)"
     # 
-    $IPTABLES -A FORWARD -m physdev --physdev-is-bridged --physdev-out eth2  -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -m physdev --physdev-is-bridged --physdev-out eth3  -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m physdev --physdev-is-bridged --physdev-out eth2  -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m physdev --physdev-is-bridged --physdev-out eth3  -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 9 (eth2,eth3)
     # 
@@ -430,19 +430,19 @@ script_body() {
     # 
     echo "Rule 10 (eth2)"
     # 
-    $IPTABLES -A FORWARD -m physdev --physdev-is-bridged --physdev-out eth2  -d 224.0.0.0/4   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m physdev --physdev-is-bridged --physdev-out eth2  -d 224.0.0.0/4   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 11 (eth2)
     # 
     echo "Rule 11 (eth2)"
     # 
-    $IPTABLES -A FORWARD -m physdev --physdev-in eth2  -s 192.168.1.10   -d 224.0.0.0/4   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m physdev --physdev-in eth2  -s 192.168.1.10   -d 224.0.0.0/4   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 12 (eth3)
     # 
     echo "Rule 12 (eth3)"
     # 
-    $IPTABLES -A FORWARD -m physdev --physdev-is-bridged --physdev-out eth3  -s 192.168.1.10   -d 224.0.0.0/4   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m physdev --physdev-is-bridged --physdev-out eth3  -s 192.168.1.10   -d 224.0.0.0/4   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 15 (eth2)
     # 
@@ -454,44 +454,44 @@ script_body() {
     # 
     echo "Rule 16 (global)"
     # 
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p udp -m udp  -d 255.255.255.255   --dport 68  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p udp -m udp  -d 255.255.255.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 17 (global)
     # 
     echo "Rule 17 (global)"
     # 
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.255   --dport 68  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.10   --dport 68  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p udp -m udp  -d 192.168.1.255   --dport 68  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p udp -m udp  -d 192.168.1.255   --dport 68  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p udp -m udp  -d 192.168.1.10   --dport 68  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.10   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p udp -m udp  -d 192.168.1.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p udp -m udp  -d 192.168.1.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p udp -m udp  -d 192.168.1.10   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 18 (global)
     # 
     echo "Rule 18 (global)"
     # 
-    $IPTABLES -A OUTPUT  -d 224.0.1.141   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -d 192.168.1.20   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 224.0.1.141   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 224.0.1.141   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 192.168.1.20   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 224.0.1.141   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 192.168.1.20   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 224.0.1.141   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 224.0.1.141   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 192.168.1.20   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 19 (global)
     # 
     echo "Rule 19 (global)"
     # 
-    $IPTABLES -A OUTPUT  -d 224.0.0.5   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 224.0.0.5   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 224.0.0.5   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 224.0.0.5   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 224.0.0.5   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 224.0.0.5   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 20 (global)
     # 
     echo "Rule 20 (global)"
     # 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.10   --dport 6667  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -d 192.168.1.10   --dport 6667  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.10   --dport 6667  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -d 192.168.1.10   --dport 6667  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 21 (global)
     # 
@@ -511,16 +511,16 @@ script_body() {
     # in both INPUT and FORWARD chains
     # because this is a bridging firewall
     # see bug #811860
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.1   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.1   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 23 (global)
     # 
     echo "Rule 23 (global)"
     # 
-    $IPTABLES -A OUTPUT  -d 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 24 (global)
     # 
@@ -529,8 +529,8 @@ script_body() {
     # interface of another firewall
     # (firewall11)
     # Why do we need to test for this?
-    $IPTABLES -A OUTPUT  -d 10.1.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 10.1.1.1   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 10.1.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 10.1.1.1   -m conntrack --ctstate NEW  -j ACCEPT
 }
 
 ip_forward() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall23-2.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall23-2.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall23-2.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall23-2.fw.orig	2014-07-08 16:51:10.362007540 +0200
@@ -308,9 +308,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
     # ================ Table 'mangle', automatic rules
     $IPTABLES -t mangle -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
 
@@ -325,28 +325,28 @@ script_body() {
     echo "Rule 0 (vnet+)"
     # 
     # -i br0
-    $IPTABLES -A INPUT -i br0 -m physdev --physdev-in vnet+  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i br0 -m physdev --physdev-in vnet+  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (vnet+)
     # 
     echo "Rule 1 (vnet+)"
     # 
     # -i br1
-    $IPTABLES -A INPUT -i br1 -m physdev --physdev-in vnet+  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i br1 -m physdev --physdev-in vnet+  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (vnet+)
     # 
     echo "Rule 2 (vnet+)"
     # 
     # -o br0
-    $IPTABLES -A OUTPUT -o br0 -m physdev --physdev-is-bridged --physdev-out vnet+  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o br0 -m physdev --physdev-is-bridged --physdev-out vnet+  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (vnet+)
     # 
     echo "Rule 3 (vnet+)"
     # 
     # -o br1
-    $IPTABLES -A OUTPUT -o br1 -m physdev --physdev-is-bridged --physdev-out vnet+  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o br1 -m physdev --physdev-is-bridged --physdev-out vnet+  -m conntrack --ctstate NEW  -j ACCEPT
 }
 
 ip_forward() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall23-3.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall23-3.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall23-3.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall23-3.fw.orig	2014-07-08 16:51:11.099998314 +0200
@@ -309,9 +309,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
     # ================ Table 'mangle', automatic rules
     $IPTABLES -t mangle -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
 
@@ -325,14 +325,14 @@ script_body() {
     # 
     echo "Rule 0 (vnet+)"
     # 
-    $IPTABLES -A INPUT -m physdev --physdev-in vnet+  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -m physdev --physdev-in vnet+  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (vnet+)
     # 
     echo "Rule 1 (vnet+)"
     # 
     # -o br0
-    $IPTABLES -A OUTPUT -m physdev --physdev-is-bridged --physdev-out vnet+  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -m physdev --physdev-is-bridged --physdev-out vnet+  -m conntrack --ctstate NEW  -j ACCEPT
 }
 
 ip_forward() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall23.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall23.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall23.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall23.fw.orig	2014-07-08 16:51:10.390007190 +0200
@@ -308,9 +308,9 @@ script_body() {
     $IPTABLES -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
 
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -323,87 +323,87 @@ script_body() {
     # 
     echo "Rule 0 (eth*)"
     # 
-    $IPTABLES -A INPUT -i eth+   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth+   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (eth*)
     # 
     echo "Rule 1 (eth*)"
     # 
-    $IPTABLES -A INPUT -i eth+   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth+   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth+   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth+   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (eth*)
     # 
     echo "Rule 2 (eth*)"
     # 
-    $IPTABLES -A FORWARD -i eth+   -d 192.168.1.255   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth+   -d 192.168.1.255   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (eth*)
     # 
     echo "Rule 3 (eth*)"
     # 
-    $IPTABLES -A FORWARD -i eth+   -d 255.255.255.255   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth+   -d 255.255.255.255   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (eth*)
     # 
     echo "Rule 4 (eth*)"
     # 
-    $IPTABLES -A FORWARD -i eth+   -d 224.0.1.141   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth+   -d 224.0.1.141   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (eth*)
     # 
     echo "Rule 5 (eth*)"
     # 
-    $IPTABLES -A FORWARD -i eth+   -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth+   -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 6 (eth*)
     # 
     echo "Rule 6 (eth*)"
     # 
-    $IPTABLES -A FORWARD -i eth+   -d ! 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth+   -d ! 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 7 (global)
     # 
     echo "Rule 7 (global)"
     # 
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p udp -m udp  -d 255.255.255.255   --dport 68  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p udp -m udp  -d 255.255.255.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 8 (global)
     # 
     echo "Rule 8 (global)"
     # 
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.255   --dport 68  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.10   --dport 68  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p udp -m udp  -d 192.168.1.255   --dport 68  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p udp -m udp  -d 192.168.1.255   --dport 68  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p udp -m udp  -d 192.168.1.10   --dport 68  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.10   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p udp -m udp  -d 192.168.1.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p udp -m udp  -d 192.168.1.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p udp -m udp  -d 192.168.1.10   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 9 (global)
     # 
     echo "Rule 9 (global)"
     # 
-    $IPTABLES -A OUTPUT  -d 224.0.1.141   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -d 192.168.1.20   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 224.0.1.141   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 224.0.1.141   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 192.168.1.20   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 224.0.1.141   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 192.168.1.20   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 224.0.1.141   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 224.0.1.141   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 192.168.1.20   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 10 (global)
     # 
     echo "Rule 10 (global)"
     # 
-    $IPTABLES -A OUTPUT  -d 224.0.0.5   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 224.0.0.5   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 224.0.0.5   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 224.0.0.5   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 224.0.0.5   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 224.0.0.5   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 11 (global)
     # 
     echo "Rule 11 (global)"
     # 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.10   --dport 6667  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -d 192.168.1.10   --dport 6667  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.10   --dport 6667  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -d 192.168.1.10   --dport 6667  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 12 (global)
     # 
@@ -423,16 +423,16 @@ script_body() {
     # in both INPUT and FORWARD chains
     # because this is a bridging firewall
     # see bug #811860
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.1   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.1   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 14 (global)
     # 
     echo "Rule 14 (global)"
     # 
-    $IPTABLES -A OUTPUT  -d 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 15 (global)
     # 
@@ -441,8 +441,8 @@ script_body() {
     # interface of another firewall
     # (firewall11)
     # Why do we need to test for this?
-    $IPTABLES -A OUTPUT  -d 10.1.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 10.1.1.1   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 10.1.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 10.1.1.1   -m conntrack --ctstate NEW  -j ACCEPT
 }
 
 ip_forward() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall24.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall24.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall24.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall24.fw.orig	2014-07-08 16:51:10.983999764 +0200
@@ -306,9 +306,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -321,115 +321,115 @@ script_body() {
     # 
     echo "Rule 0 (tun*)"
     # 
-    $IPTABLES -A INPUT -i tun+   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i tun+   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (tun*)
     # 
     echo "Rule 1 (tun*)"
     # 
-    $IPTABLES -A INPUT -i tun+   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i tun+   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i tun+   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i tun+   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (tun*)
     # 
     echo "Rule 2 (tun*)"
     # 
-    $IPTABLES -A OUTPUT -o tun+   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o tun+   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o tun+   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o tun+   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (tun*)
     # 
     echo "Rule 3 (tun*)"
     # 
-    $IPTABLES -A INPUT -i tun+   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i tun+   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o tun+   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o tun+   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i tun+   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i tun+   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o tun+   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o tun+   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (tun*)
     # 
     echo "Rule 4 (tun*)"
     # 
-    $IPTABLES -A INPUT -i tun+  -p udp -m udp  -m multiport  --dports 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i tun+  -p udp -m udp  -m multiport  --dports 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i tun+  -p udp -m udp  -m multiport  --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i tun+  -p udp -m udp  -m multiport  --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (tun*)
     # 
     echo "Rule 5 (tun*)"
     # 
-    $IPTABLES -A INPUT -i tun+   -d 192.168.1.255   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i tun+   -d 192.168.1.255   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 6 (tun*)
     # 
     echo "Rule 6 (tun*)"
     # 
-    $IPTABLES -A INPUT -i tun+   -d 255.255.255.255   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i tun+   -d 255.255.255.255   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 7 (tun*)
     # 
     echo "Rule 7 (tun*)"
     # 
-    $IPTABLES -A INPUT -i tun+   -d 224.0.1.141   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i tun+   -d 224.0.1.141   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 8 (tun*)
     # 
     echo "Rule 8 (tun*)"
     # 
-    $IPTABLES -A INPUT -i tun+   -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i tun+   -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i tun+   -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i tun+   -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 9 (tun*)
     # 
     echo "Rule 9 (tun*)"
     # 
-    $IPTABLES -A INPUT -i tun+   -d ! 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i tun+   -d ! 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i tun+   -d ! 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i tun+   -d ! 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 10 (global)
     # 
     echo "Rule 10 (global)"
     # 
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 11 (global)
     # 
     echo "Rule 11 (global)"
     # 
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.255   --dport 68  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.10   --dport 68  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p udp -m udp  -d 192.168.1.255   --dport 68  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p udp -m udp  -d 192.168.1.10   --dport 68  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.10   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p udp -m udp  -d 192.168.1.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p udp -m udp  -d 192.168.1.10   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 12 (global)
     # 
     echo "Rule 12 (global)"
     # 
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0   --dport 68  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p udp -m udp  -d 192.168.1.0   --dport 68  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p udp -m udp  -d 192.168.1.0   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 13 (global)
     # 
     echo "Rule 13 (global)"
     # 
-    $IPTABLES -A OUTPUT  -d 224.0.1.141   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -d 192.168.1.20   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 224.0.1.141   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 192.168.1.20   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 224.0.1.141   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 192.168.1.20   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 224.0.1.141   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 192.168.1.20   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 14 (global)
     # 
     echo "Rule 14 (global)"
     # 
-    $IPTABLES -A OUTPUT  -d 224.0.0.5   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 224.0.0.5   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 224.0.0.5   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 224.0.0.5   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 15 (global)
     # 
     echo "Rule 15 (global)"
     # 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.10   --dport 6667  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -d 192.168.1.10   --dport 6667  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.10   --dport 6667  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -d 192.168.1.10   --dport 6667  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 16 (global)
     # 
@@ -445,21 +445,21 @@ script_body() {
     # 
     echo "Rule 17 (global)"
     # 
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 18 (global)
     # 
     echo "Rule 18 (global)"
     # 
-    $IPTABLES -A OUTPUT  -d 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 19 (global)
     # 
     echo "Rule 19 (global)"
     # 
-    $IPTABLES -A OUTPUT  -d 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 192.168.1.1   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
 }
 
 ip_forward() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall25.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall25.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall25.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall25.fw.orig	2014-07-08 16:51:10.515005627 +0200
@@ -328,25 +328,25 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # backup ssh access
-    echo "-A INPUT  -p tcp -m tcp  -s 192.168.1.1/255.255.255.255  --dport 22  -m state --state NEW,ESTABLISHED -j  ACCEPT "
-    echo "-A OUTPUT  -p tcp -m tcp  -d 192.168.1.1/255.255.255.255  --sport 22  -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT  -p tcp -m tcp  -s 192.168.1.1/255.255.255.255  --dport 22  -m conntrack --ctstate NEW,ESTABLISHED -j  ACCEPT "
+    echo "-A OUTPUT  -p tcp -m tcp  -d 192.168.1.1/255.255.255.255  --sport 22  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # drop TCP sessions opened prior firewall restart
-    echo "-A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP "
-    echo "-A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP "
-    echo "-A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP "
+    echo "-A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP "
+    echo "-A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP "
+    echo "-A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP "
     # drop packets that do not match any valid state 
-    echo "-A OUTPUT   -m state --state INVALID  -j DROP "
-    echo "-A INPUT    -m state --state INVALID  -j DROP "
-    echo "-A FORWARD  -m state --state INVALID  -j DROP "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j DROP "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j DROP "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j DROP "
     # ================ Table 'filter', rule set policy_2
     # 
     # Rule  policy_2 0 (eth2)
     echo ":policy_2 - [0:0]"
-    echo "-A policy_2 -o eth2   -m state --state NEW  -j ACCEPT "
+    echo "-A policy_2 -o eth2   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  policy_2 1 (global)
     echo ":policy_2_1 - [0:0]"
@@ -398,7 +398,7 @@ script_body() {
     # Rule  3 (ppp*)
     # ppp clients can only connect to the mail
     # server and web proxy on DMZ
-    echo "-A FORWARD -i ppp+  -p tcp -m tcp  -m multiport  -d 192.168.2.10   --dports 25,3128  -m state --state NEW  -j ACCEPT "
+    echo "-A FORWARD -i ppp+  -p tcp -m tcp  -m multiport  -d 192.168.2.10   --dports 25,3128  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  4 (ppp*)
     # ppp clients can not connect to
@@ -422,14 +422,14 @@ script_body() {
     # Rule  6 (global)
     # hostF has the same IP address as firewal.
     echo ":RULE_6 - [0:0]"
-    echo "-A OUTPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m state --state NEW  -j RULE_6 "
-    echo "-A INPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m state --state NEW  -j RULE_6 "
+    echo "-A OUTPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j RULE_6 "
+    echo "-A INPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j RULE_6 "
     echo "-A RULE_6  -j LOG "
     echo "-A RULE_6  -j ACCEPT "
     # 
     # Rule  7 (global)
     echo ":Cid417C681B.0 - [0:0]"
-    echo "-A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid417C681B.0 "
+    echo "-A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid417C681B.0 "
     getinterfaces ppp | while read I; do
         ivar=$(getInterfaceVarName $I)
         getaddr $I $ivar
@@ -442,7 +442,7 @@ script_body() {
     done
     echo "-A Cid417C681B.0  -d 192.168.1.1   -j ACCEPT "
     echo "-A Cid417C681B.0  -d 192.168.2.1   -j ACCEPT "
-    echo "-A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j ACCEPT "
+    echo "-A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  8 (global)
     getinterfaces ppp | while read I; do
@@ -452,7 +452,7 @@ script_body() {
         eval "addr_list=$cmd"
         for addr in $addr_list
         do
-            test -n "$addr" && echo "-A OUTPUT -p tcp -m tcp  -d $addr   --dport 22  -m state --state NEW  -j ACCEPT "
+            test -n "$addr" && echo "-A OUTPUT -p tcp -m tcp  -d $addr   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT "
         done
     done
     getinterfaces ppp | while read I; do
@@ -462,36 +462,36 @@ script_body() {
         eval "addr_list=$cmd"
         for addr in $addr_list
         do
-            test -n "$addr" && echo "-A INPUT -p tcp -m tcp  -d $addr   --dport 22  -m state --state NEW  -j ACCEPT "
+            test -n "$addr" && echo "-A INPUT -p tcp -m tcp  -d $addr   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT "
         done
     done
     # 
     # Rule  9 (global)
-    echo "-A OUTPUT -p tcp -m tcp  -d 192.168.1.1   --dport 22  -m state --state NEW  -j ACCEPT "
-    echo "-A INPUT -p tcp -m tcp  -d 192.168.1.1   --dport 22  -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT -p tcp -m tcp  -d 192.168.1.1   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A INPUT -p tcp -m tcp  -d 192.168.1.1   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  10 (global)
-    echo "-A OUTPUT -p tcp -m tcp  -m multiport  -d 192.168.1.1   --dports 22,23  -m state --state NEW  -j ACCEPT "
-    echo "-A INPUT -p tcp -m tcp  -m multiport  -d 192.168.1.1   --dports 22,23  -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT -p tcp -m tcp  -m multiport  -d 192.168.1.1   --dports 22,23  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A INPUT -p tcp -m tcp  -m multiport  -d 192.168.1.1   --dports 22,23  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  11 (global)
     echo ":Cid417C6844.0 - [0:0]"
-    echo "-A OUTPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m state --state NEW  -j Cid417C6844.0 "
+    echo "-A OUTPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m conntrack --ctstate NEW  -j Cid417C6844.0 "
     echo "-A Cid417C6844.0  -d 192.168.1.1   -j ACCEPT "
     echo "-A Cid417C6844.0  -d 192.168.2.1   -j ACCEPT "
     echo ":Cid417C6844.1 - [0:0]"
-    echo "-A INPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m state --state NEW  -j Cid417C6844.1 "
+    echo "-A INPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m conntrack --ctstate NEW  -j Cid417C6844.1 "
     echo "-A Cid417C6844.1  -d 192.168.1.1   -j ACCEPT "
     echo "-A Cid417C6844.1  -d 192.168.2.1   -j ACCEPT "
     # 
     # Rule  12 (global)
     echo ":Cid417C684F.0 - [0:0]"
-    echo "-A OUTPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m state --state NEW  -j Cid417C684F.0 "
+    echo "-A OUTPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m conntrack --ctstate NEW  -j Cid417C684F.0 "
     echo ":RULE_12 - [0:0]"
     echo "-A Cid417C684F.0  -d 192.168.1.1   -j RULE_12 "
     echo "-A Cid417C684F.0  -d 192.168.2.1   -j RULE_12 "
     echo ":Cid417C684F.1 - [0:0]"
-    echo "-A INPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m state --state NEW  -j Cid417C684F.1 "
+    echo "-A INPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m conntrack --ctstate NEW  -j Cid417C684F.1 "
     echo "-A Cid417C684F.1  -d 192.168.1.1   -j RULE_12 "
     echo "-A Cid417C684F.1  -d 192.168.2.1   -j RULE_12 "
     echo "-A RULE_12  -j LOG "
@@ -501,30 +501,30 @@ script_body() {
     # firewall is part of Any, so compiler should
     # generate code in both FORWARD and
     # OUTPUT chains
-    echo "-A OUTPUT  -d 200.200.200.200   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d 200.200.200.200   -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 200.200.200.200   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 200.200.200.200   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  14 (global)
     # firewall is part of Any, compiler should
     # generate code for both FORWARD and
     # INPUT chains
-    echo "-A INPUT  -s 200.200.200.200   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -s 200.200.200.200   -m state --state NEW  -j ACCEPT "
+    echo "-A INPUT  -s 200.200.200.200   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -s 200.200.200.200   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  15 (global)
     # because firewall has interface on network
     # internal_net, compiler should generate code
     # for both FORWARD and INPUT chains
-    echo "-A INPUT  -s 192.168.1.10   -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -s 192.168.1.10   -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT "
+    echo "-A INPUT  -s 192.168.1.10   -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -s 192.168.1.10   -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  16 (global)
     echo ":Cid417C6878.0 - [0:0]"
-    echo "-A OUTPUT  -d 200.200.200.200   -m state --state NEW  -j Cid417C6878.0 "
+    echo "-A OUTPUT  -d 200.200.200.200   -m conntrack --ctstate NEW  -j Cid417C6878.0 "
     echo "-A Cid417C6878.0  -s 192.168.1.0/24   -j ACCEPT "
     echo "-A Cid417C6878.0  -s 192.168.2.0/24   -j ACCEPT "
     echo ":Cid417C6878.1 - [0:0]"
-    echo "-A FORWARD  -d 200.200.200.200   -m state --state NEW  -j Cid417C6878.1 "
+    echo "-A FORWARD  -d 200.200.200.200   -m conntrack --ctstate NEW  -j Cid417C6878.1 "
     echo "-A Cid417C6878.1  -s 192.168.1.0/24   -j ACCEPT "
     echo "-A Cid417C6878.1  -s 192.168.2.0/24   -j ACCEPT "
     # 
@@ -533,9 +533,9 @@ script_body() {
     # since we also have default rule that goes to mangle (TCPMSS)
     # and pure mangle ruleset, making sure all rules for 
     # mangle table end up with one COMMIT
-    echo "-A OUTPUT  -m state --state NEW  -j LOG "
-    echo "-A INPUT  -m state --state NEW  -j LOG "
-    echo "-A FORWARD  -m state --state NEW  -j LOG "
+    echo "-A OUTPUT  -m conntrack --ctstate NEW  -j LOG "
+    echo "-A INPUT  -m conntrack --ctstate NEW  -j LOG "
+    echo "-A FORWARD  -m conntrack --ctstate NEW  -j LOG "
     # 
     # Rule  18 (global)
     echo "-A OUTPUT  -j policy_2 "
@@ -565,7 +565,7 @@ script_body() {
     # 
     # Rule  policy_2_mangle 0 (eth2)
     echo ":policy_2_mangle - [0:0]"
-    echo "-A policy_2_mangle -o eth2   -m state --state NEW  -j ACCEPT "
+    echo "-A policy_2_mangle -o eth2   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  policy_2_mangle 1 (global)
     # SF bug report 3034628
@@ -589,8 +589,8 @@ script_body() {
     # since we also have default rule that goes to mangle (TCPMSS)
     # and pure mangle ruleset, making sure all rules for 
     # mangle table end up with one COMMIT
-    echo "-A OUTPUT  -m state --state NEW  -j MARK --set-mark 10"
-    echo "-A PREROUTING  -m state --state NEW  -j MARK --set-mark 10"
+    echo "-A OUTPUT  -m conntrack --ctstate NEW  -j MARK --set-mark 10"
+    echo "-A PREROUTING  -m conntrack --ctstate NEW  -j MARK --set-mark 10"
     # 
     # Rule  18 (global)
     echo ":policy_2 - [0:0]"
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall26.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall26.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall26.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall26.fw.orig	2014-07-08 16:51:10.600004565 +0200
@@ -326,20 +326,20 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # backup ssh access
-    echo "-A INPUT  -p tcp -m tcp  -s 192.168.1.1/255.255.255.255  --dport 22  -m state --state NEW,ESTABLISHED -j  ACCEPT "
-    echo "-A OUTPUT  -p tcp -m tcp  -d 192.168.1.1/255.255.255.255  --sport 22  -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT  -p tcp -m tcp  -s 192.168.1.1/255.255.255.255  --dport 22  -m conntrack --ctstate NEW,ESTABLISHED -j  ACCEPT "
+    echo "-A OUTPUT  -p tcp -m tcp  -d 192.168.1.1/255.255.255.255  --sport 22  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # drop TCP sessions opened prior firewall restart
-    echo "-A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP "
-    echo "-A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP "
-    echo "-A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP "
+    echo "-A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP "
+    echo "-A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP "
+    echo "-A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP "
     # drop packets that do not match any valid state 
-    echo "-A OUTPUT   -m state --state INVALID  -j DROP "
-    echo "-A INPUT    -m state --state INVALID  -j DROP "
-    echo "-A FORWARD  -m state --state INVALID  -j DROP "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j DROP "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j DROP "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j DROP "
     # ================ Table 'filter', rule set Policy
     # 
     # Rule  0 (ppp)
@@ -369,7 +369,7 @@ script_body() {
     # Rule  3 (ppp)
     # ppp clients can only connect to the mail
     # server and web proxy on DMZ
-    echo "-A FORWARD -i ppp  -p tcp -m tcp  -m multiport  -d 192.168.2.10   --dports 25,3128  -m state --state NEW  -j ACCEPT "
+    echo "-A FORWARD -i ppp  -p tcp -m tcp  -m multiport  -d 192.168.2.10   --dports 25,3128  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  4 (ppp)
     # ppp clients can not connect to
@@ -393,58 +393,58 @@ script_body() {
     # Rule  6 (global)
     # hostF has the same IP address as firewal.
     echo ":RULE_6 - [0:0]"
-    echo "-A OUTPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m state --state NEW  -j RULE_6 "
-    echo "-A INPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m state --state NEW  -j RULE_6 "
+    echo "-A OUTPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j RULE_6 "
+    echo "-A INPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j RULE_6 "
     echo "-A RULE_6  -j LOG "
     echo "-A RULE_6  -j ACCEPT "
     # 
     # Rule  7 (global)
     echo ":Cid418C4619.0 - [0:0]"
-    echo "-A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid418C4619.0 "
+    echo "-A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid418C4619.0 "
     for i_ppp in $i_ppp_list
     do
     test -n "$i_ppp" && echo "-A Cid418C4619.0  -d $i_ppp   -j ACCEPT " 
     done
     echo "-A Cid418C4619.0  -d 192.168.1.1   -j ACCEPT "
     echo "-A Cid418C4619.0  -d 192.168.2.1   -j ACCEPT "
-    echo "-A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j ACCEPT "
+    echo "-A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  8 (global)
     for i_ppp in $i_ppp_list
     do
-    test -n "$i_ppp" && echo "-A OUTPUT -p tcp -m tcp  -d $i_ppp   --dport 22  -m state --state NEW  -j ACCEPT " 
+    test -n "$i_ppp" && echo "-A OUTPUT -p tcp -m tcp  -d $i_ppp   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT " 
     done
     for i_ppp in $i_ppp_list
     do
-    test -n "$i_ppp" && echo "-A INPUT -p tcp -m tcp  -d $i_ppp   --dport 22  -m state --state NEW  -j ACCEPT " 
+    test -n "$i_ppp" && echo "-A INPUT -p tcp -m tcp  -d $i_ppp   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT " 
     done
     # 
     # Rule  9 (global)
-    echo "-A OUTPUT -p tcp -m tcp  -d 192.168.1.1   --dport 22  -m state --state NEW  -j ACCEPT "
-    echo "-A INPUT -p tcp -m tcp  -d 192.168.1.1   --dport 22  -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT -p tcp -m tcp  -d 192.168.1.1   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A INPUT -p tcp -m tcp  -d 192.168.1.1   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  10 (global)
-    echo "-A OUTPUT -p tcp -m tcp  -m multiport  -d 192.168.1.1   --dports 22,23  -m state --state NEW  -j ACCEPT "
-    echo "-A INPUT -p tcp -m tcp  -m multiport  -d 192.168.1.1   --dports 22,23  -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT -p tcp -m tcp  -m multiport  -d 192.168.1.1   --dports 22,23  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A INPUT -p tcp -m tcp  -m multiport  -d 192.168.1.1   --dports 22,23  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  11 (global)
     echo ":Cid418C4642.0 - [0:0]"
-    echo "-A OUTPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m state --state NEW  -j Cid418C4642.0 "
+    echo "-A OUTPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m conntrack --ctstate NEW  -j Cid418C4642.0 "
     echo "-A Cid418C4642.0  -d 192.168.1.1   -j ACCEPT "
     echo "-A Cid418C4642.0  -d 192.168.2.1   -j ACCEPT "
     echo ":Cid418C4642.1 - [0:0]"
-    echo "-A INPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m state --state NEW  -j Cid418C4642.1 "
+    echo "-A INPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m conntrack --ctstate NEW  -j Cid418C4642.1 "
     echo "-A Cid418C4642.1  -d 192.168.1.1   -j ACCEPT "
     echo "-A Cid418C4642.1  -d 192.168.2.1   -j ACCEPT "
     # 
     # Rule  12 (global)
     echo ":Cid418C464D.0 - [0:0]"
-    echo "-A OUTPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m state --state NEW  -j Cid418C464D.0 "
+    echo "-A OUTPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m conntrack --ctstate NEW  -j Cid418C464D.0 "
     echo ":RULE_12 - [0:0]"
     echo "-A Cid418C464D.0  -d 192.168.1.1   -j RULE_12 "
     echo "-A Cid418C464D.0  -d 192.168.2.1   -j RULE_12 "
     echo ":Cid418C464D.1 - [0:0]"
-    echo "-A INPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m state --state NEW  -j Cid418C464D.1 "
+    echo "-A INPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m conntrack --ctstate NEW  -j Cid418C464D.1 "
     echo "-A Cid418C464D.1  -d 192.168.1.1   -j RULE_12 "
     echo "-A Cid418C464D.1  -d 192.168.2.1   -j RULE_12 "
     echo "-A RULE_12  -j LOG "
@@ -454,30 +454,30 @@ script_body() {
     # firewall is part of Any, so compiler should
     # generate code in both FORWARD and
     # OUTPUT chains
-    echo "-A OUTPUT  -d 200.200.200.200   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d 200.200.200.200   -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 200.200.200.200   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 200.200.200.200   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  14 (global)
     # firewall is part of Any, compiler should
     # generate code for both FORWARD and
     # INPUT chains
-    echo "-A INPUT  -s 200.200.200.200   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -s 200.200.200.200   -m state --state NEW  -j ACCEPT "
+    echo "-A INPUT  -s 200.200.200.200   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -s 200.200.200.200   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  15 (global)
     # because firewall has interface on network
     # internal_net, compiler should generate code
     # for both FORWARD and INPUT chains
-    echo "-A INPUT  -s 192.168.1.10   -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -s 192.168.1.10   -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT "
+    echo "-A INPUT  -s 192.168.1.10   -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -s 192.168.1.10   -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  16 (global)
     echo ":Cid418C4676.0 - [0:0]"
-    echo "-A OUTPUT  -d 200.200.200.200   -m state --state NEW  -j Cid418C4676.0 "
+    echo "-A OUTPUT  -d 200.200.200.200   -m conntrack --ctstate NEW  -j Cid418C4676.0 "
     echo "-A Cid418C4676.0  -s 192.168.1.0/24   -j ACCEPT "
     echo "-A Cid418C4676.0  -s 192.168.2.0/24   -j ACCEPT "
     echo ":Cid418C4676.1 - [0:0]"
-    echo "-A FORWARD  -d 200.200.200.200   -m state --state NEW  -j Cid418C4676.1 "
+    echo "-A FORWARD  -d 200.200.200.200   -m conntrack --ctstate NEW  -j Cid418C4676.1 "
     echo "-A Cid418C4676.1  -s 192.168.1.0/24   -j ACCEPT "
     echo "-A Cid418C4676.1  -s 192.168.2.0/24   -j ACCEPT "
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall27.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall27.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall27.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall27.fw.orig	2014-07-08 16:51:11.051998914 +0200
@@ -323,20 +323,20 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # backup ssh access
-    echo "-A INPUT  -p tcp -m tcp  -s 192.168.1.1/255.255.255.255  --dport 22  -m state --state NEW,ESTABLISHED -j  ACCEPT "
-    echo "-A OUTPUT  -p tcp -m tcp  -d 192.168.1.1/255.255.255.255  --sport 22  -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT  -p tcp -m tcp  -s 192.168.1.1/255.255.255.255  --dport 22  -m conntrack --ctstate NEW,ESTABLISHED -j  ACCEPT "
+    echo "-A OUTPUT  -p tcp -m tcp  -d 192.168.1.1/255.255.255.255  --sport 22  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # drop TCP sessions opened prior firewall restart
-    echo "-A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP "
-    echo "-A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP "
-    echo "-A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP "
+    echo "-A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP "
+    echo "-A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP "
+    echo "-A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP "
     # drop packets that do not match any valid state 
-    echo "-A OUTPUT   -m state --state INVALID  -j DROP "
-    echo "-A INPUT    -m state --state INVALID  -j DROP "
-    echo "-A FORWARD  -m state --state INVALID  -j DROP "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j DROP "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j DROP "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j DROP "
     # ================ Table 'filter', rule set Policy
     # 
     # Rule  0 (ppp)
@@ -363,7 +363,7 @@ script_body() {
     # Rule  3 (ppp)
     # ppp clients can only connect to the mail
     # server and web proxy on DMZ
-    echo "-A FORWARD -i ppp  -p tcp -m tcp  -m multiport  -d 192.168.2.10   --dports 25,3128  -m state --state NEW  -j ACCEPT "
+    echo "-A FORWARD -i ppp  -p tcp -m tcp  -m multiport  -d 192.168.2.10   --dports 25,3128  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  4 (ppp)
     # ppp clients can not connect to
@@ -387,49 +387,49 @@ script_body() {
     # Rule  6 (global)
     # hostF has the same IP address as firewal.
     echo ":RULE_6 - [0:0]"
-    echo "-A OUTPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m state --state NEW  -j RULE_6 "
-    echo "-A INPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m state --state NEW  -j RULE_6 "
+    echo "-A OUTPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j RULE_6 "
+    echo "-A INPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j RULE_6 "
     echo "-A RULE_6  -j LOG "
     echo "-A RULE_6  -j ACCEPT "
     # 
     # Rule  7 (global)
     echo ":Cid4183D051.0 - [0:0]"
-    echo "-A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid4183D051.0 "
+    echo "-A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid4183D051.0 "
     echo "-A Cid4183D051.0  -d 192.0.2.1   -j ACCEPT "
     echo "-A Cid4183D051.0  -d 192.168.1.1   -j ACCEPT "
     echo "-A Cid4183D051.0  -d 192.168.2.1   -j ACCEPT "
-    echo "-A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j ACCEPT "
+    echo "-A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  8 (global)
-    echo "-A OUTPUT -p tcp -m tcp  -d 192.0.2.1   --dport 22  -m state --state NEW  -j ACCEPT "
-    echo "-A INPUT -p tcp -m tcp  -d 192.0.2.1   --dport 22  -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT -p tcp -m tcp  -d 192.0.2.1   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A INPUT -p tcp -m tcp  -d 192.0.2.1   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  9 (global)
-    echo "-A OUTPUT -p tcp -m tcp  -d 192.168.1.1   --dport 22  -m state --state NEW  -j ACCEPT "
-    echo "-A INPUT -p tcp -m tcp  -d 192.168.1.1   --dport 22  -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT -p tcp -m tcp  -d 192.168.1.1   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A INPUT -p tcp -m tcp  -d 192.168.1.1   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  10 (global)
-    echo "-A OUTPUT -p tcp -m tcp  -m multiport  -d 192.168.1.1   --dports 22,23  -m state --state NEW  -j ACCEPT "
-    echo "-A INPUT -p tcp -m tcp  -m multiport  -d 192.168.1.1   --dports 22,23  -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT -p tcp -m tcp  -m multiport  -d 192.168.1.1   --dports 22,23  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A INPUT -p tcp -m tcp  -m multiport  -d 192.168.1.1   --dports 22,23  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  11 (global)
     echo ":Cid4183D07A.0 - [0:0]"
-    echo "-A OUTPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m state --state NEW  -j Cid4183D07A.0 "
+    echo "-A OUTPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m conntrack --ctstate NEW  -j Cid4183D07A.0 "
     echo "-A Cid4183D07A.0  -d 192.168.1.1   -j ACCEPT "
     echo "-A Cid4183D07A.0  -d 192.168.2.1   -j ACCEPT "
     echo ":Cid4183D07A.1 - [0:0]"
-    echo "-A INPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m state --state NEW  -j Cid4183D07A.1 "
+    echo "-A INPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m conntrack --ctstate NEW  -j Cid4183D07A.1 "
     echo "-A Cid4183D07A.1  -d 192.168.1.1   -j ACCEPT "
     echo "-A Cid4183D07A.1  -d 192.168.2.1   -j ACCEPT "
     # 
     # Rule  12 (global)
     echo ":Cid4183D085.0 - [0:0]"
-    echo "-A OUTPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m state --state NEW  -j Cid4183D085.0 "
+    echo "-A OUTPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m conntrack --ctstate NEW  -j Cid4183D085.0 "
     echo ":RULE_12 - [0:0]"
     echo "-A Cid4183D085.0  -d 192.168.1.1   -j RULE_12 "
     echo "-A Cid4183D085.0  -d 192.168.2.1   -j RULE_12 "
     echo ":Cid4183D085.1 - [0:0]"
-    echo "-A INPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m state --state NEW  -j Cid4183D085.1 "
+    echo "-A INPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m conntrack --ctstate NEW  -j Cid4183D085.1 "
     echo "-A Cid4183D085.1  -d 192.168.1.1   -j RULE_12 "
     echo "-A Cid4183D085.1  -d 192.168.2.1   -j RULE_12 "
     echo "-A RULE_12  -j LOG "
@@ -439,30 +439,30 @@ script_body() {
     # firewall is part of Any, so compiler should
     # generate code in both FORWARD and
     # OUTPUT chains
-    echo "-A OUTPUT  -d 200.200.200.200   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d 200.200.200.200   -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 200.200.200.200   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 200.200.200.200   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  14 (global)
     # firewall is part of Any, compiler should
     # generate code for both FORWARD and
     # INPUT chains
-    echo "-A INPUT  -s 200.200.200.200   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -s 200.200.200.200   -m state --state NEW  -j ACCEPT "
+    echo "-A INPUT  -s 200.200.200.200   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -s 200.200.200.200   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  15 (global)
     # because firewall has interface on network
     # internal_net, compiler should generate code
     # for both FORWARD and INPUT chains
-    echo "-A INPUT  -s 192.168.1.10   -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -s 192.168.1.10   -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT "
+    echo "-A INPUT  -s 192.168.1.10   -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -s 192.168.1.10   -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  16 (global)
     echo ":Cid4183D0AE.0 - [0:0]"
-    echo "-A OUTPUT  -d 200.200.200.200   -m state --state NEW  -j Cid4183D0AE.0 "
+    echo "-A OUTPUT  -d 200.200.200.200   -m conntrack --ctstate NEW  -j Cid4183D0AE.0 "
     echo "-A Cid4183D0AE.0  -s 192.168.1.0/24   -j ACCEPT "
     echo "-A Cid4183D0AE.0  -s 192.168.2.0/24   -j ACCEPT "
     echo ":Cid4183D0AE.1 - [0:0]"
-    echo "-A FORWARD  -d 200.200.200.200   -m state --state NEW  -j Cid4183D0AE.1 "
+    echo "-A FORWARD  -d 200.200.200.200   -m conntrack --ctstate NEW  -j Cid4183D0AE.1 "
     echo "-A Cid4183D0AE.1  -s 192.168.1.0/24   -j ACCEPT "
     echo "-A Cid4183D0AE.1  -s 192.168.2.0/24   -j ACCEPT "
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall28.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall28.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall28.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall28.fw.orig	2014-07-08 16:51:10.336007865 +0200
@@ -318,9 +318,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -343,9 +343,9 @@ script_body() {
     # it uses IPService object with protocol 0
     # firewall28:Policy:0: error: Rule '0 (global)' shadows rule '1 (global)'  below it
 
-    $IPTABLES -A OUTPUT -p all  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p all  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p all  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p all  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p all  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p all  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (global)
     # 
@@ -362,9 +362,9 @@ script_body() {
     # 
     echo "Rule 2 (global)"
     # 
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall29.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall29.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall29.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall29.fw.orig	2014-07-08 16:51:10.475006127 +0200
@@ -315,9 +315,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -345,7 +345,7 @@ script_body() {
     # 
     for i_eth0_200 in $i_eth0_200_list
     do
-    test -n "$i_eth0_200" && $IPTABLES -A OUTPUT -o eth0.200   -s $i_eth0_200   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0_200" && $IPTABLES -A OUTPUT -o eth0.200   -s $i_eth0_200   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 1 (global)
@@ -354,37 +354,37 @@ script_body() {
     # 
     for i_eth0_100 in $i_eth0_100_list
     do
-    test -n "$i_eth0_100" && $IPTABLES -A INPUT  -s $i_eth0_100   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0_100" && $IPTABLES -A INPUT  -s $i_eth0_100   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     for i_eth0_200 in $i_eth0_200_list
     do
-    test -n "$i_eth0_200" && $IPTABLES -A INPUT  -s $i_eth0_200   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0_200" && $IPTABLES -A INPUT  -s $i_eth0_200   -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     for i_eth0_100 in $i_eth0_100_list
     do
-    test -n "$i_eth0_100" && $IPTABLES -A OUTPUT  -s $i_eth0_100   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0_100" && $IPTABLES -A OUTPUT  -s $i_eth0_100   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     for i_eth0_200 in $i_eth0_200_list
     do
-    test -n "$i_eth0_200" && $IPTABLES -A OUTPUT  -s $i_eth0_200   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0_200" && $IPTABLES -A OUTPUT  -s $i_eth0_200   -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (global)
     # 
     echo "Rule 2 (global)"
     # 
-    $IPTABLES -A OUTPUT -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     for i_eth0_200 in $i_eth0_200_list
     do
-    test -n "$i_eth0_200" && $IPTABLES -A OUTPUT -p udp -m udp  -m multiport  -d $i_eth0_200   --dports 68,67  -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0_200" && $IPTABLES -A OUTPUT -p udp -m udp  -m multiport  -d $i_eth0_200   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A INPUT -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     for i_eth0_200 in $i_eth0_200_list
     do
-    test -n "$i_eth0_200" && $IPTABLES -A INPUT -p udp -m udp  -m multiport  -d $i_eth0_200   --dports 68,67  -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0_200" && $IPTABLES -A INPUT -p udp -m udp  -m multiport  -d $i_eth0_200   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 3 (global)
@@ -392,14 +392,14 @@ script_body() {
     echo "Rule 3 (global)"
     # 
     # should be --connlimit-above 10
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -m connlimit --connlimit-above 10 -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -m connlimit --connlimit-above 10 -j ACCEPT
     # 
     # Rule 4 (global)
     # 
     echo "Rule 4 (global)"
     # 
     # should be ! --connlimit-above 10
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -m connlimit \! --connlimit-above 10 -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -m connlimit \! --connlimit-above 10 -j ACCEPT
     # 
     # Rule 5 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall3.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall3.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall3.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall3.fw.orig	2014-07-08 16:51:10.970999927 +0200
@@ -331,8 +331,8 @@ script_body() {
     # 
     echo "Rule 0 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (eth1)
     # 
@@ -368,7 +368,7 @@ script_body() {
     # 
     # testing choice of chains in case when several interfaces
     # are used and rule matches on any or broadcast 
-    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (eth0,eth2)
     # 
@@ -376,21 +376,21 @@ script_body() {
     # 
     # testing choice of chains in case when several interfaces
     # are used and rule matches on any or broadcast 
-    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth2  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth2  -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 6 (eth0)
     # 
     echo "Rule 6 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 7 (eth0,eth2)
     # 
     echo "Rule 7 (eth0,eth2)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth2  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth2  -p udp -m udp  -m multiport  -s 0.0.0.0   -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 10 (eth1)
     # 
@@ -430,7 +430,7 @@ script_body() {
     # 
     # hostF has the same IP address as firewal.
     $IPTABLES -N RULE_12
-    $IPTABLES -A INPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m state --state NEW  -j RULE_12
+    $IPTABLES -A INPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j RULE_12
     $IPTABLES -A RULE_12  -j LOG  --log-level debug
     $IPTABLES -A RULE_12  -j ACCEPT
     # 
@@ -438,7 +438,7 @@ script_body() {
     # 
     echo "Rule 13 (global)"
     # 
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 14 (global)
     # 
@@ -458,14 +458,14 @@ script_body() {
     # 
     echo "Rule 15 (global)"
     # 
-    $IPTABLES -A FORWARD  -d ! 33.33.33.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d ! 33.33.33.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 16 (global)
     # 
     echo "Rule 16 (global)"
     # 
     $IPTABLES -N Cid40F57E72.0
-    $IPTABLES -A FORWARD  -m state --state NEW  -j Cid40F57E72.0
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j Cid40F57E72.0
     $IPTABLES -A Cid40F57E72.0  -d 33.33.33.0/24   -j RETURN
     $IPTABLES -A Cid40F57E72.0  -d 222.222.222.0/24   -j RETURN
     $IPTABLES -A Cid40F57E72.0  -j ACCEPT
@@ -475,11 +475,11 @@ script_body() {
     echo "Rule 17 (global)"
     # 
     $IPTABLES -N Cid41A8EF1D.0
-    $IPTABLES -A INPUT  -m state --state NEW  -j Cid41A8EF1D.0
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j Cid41A8EF1D.0
     $IPTABLES -A Cid41A8EF1D.0  -d 192.168.1.1   -j RETURN
     $IPTABLES -A Cid41A8EF1D.0  -d 192.168.2.1   -j RETURN
     $IPTABLES -A Cid41A8EF1D.0  -j ACCEPT
-    $IPTABLES -A FORWARD  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 18 (global)
     # 
@@ -500,7 +500,7 @@ script_body() {
     echo "Rule 19 (global)"
     # 
     # 'masquerading' rule
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 20 (global)
     # 
@@ -517,24 +517,24 @@ script_body() {
     echo "Rule 21 (global)"
     # 
     $IPTABLES -N Cid440D600617760.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j Cid440D600617760.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j Cid440D600617760.0
     $IPTABLES -A Cid440D600617760.0  -s 22.22.22.22   -j RETURN
     $IPTABLES -A Cid440D600617760.0  -s 192.168.1.1   -j RETURN
     $IPTABLES -A Cid440D600617760.0  -s 192.168.2.1   -j RETURN
     $IPTABLES -A Cid440D600617760.0  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 22 (global)
     # 
     echo "Rule 22 (global)"
     # 
     $IPTABLES -N Cid440D880417760.0
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j Cid440D880417760.0
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j Cid440D880417760.0
     $IPTABLES -A Cid440D880417760.0  -d 22.22.22.22   -j RETURN
     $IPTABLES -A Cid440D880417760.0  -d 192.168.1.1   -j RETURN
     $IPTABLES -A Cid440D880417760.0  -d 192.168.2.1   -j RETURN
     $IPTABLES -A Cid440D880417760.0  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 23 (eth1,eth0,eth2)
     # 
@@ -542,9 +542,9 @@ script_body() {
     # 
     # this rule should go only to the FORWARD
     # chain but should have "-i eth" clause
-    $IPTABLES -A FORWARD -i eth0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth2   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth2   -m conntrack --ctstate NEW  -j ACCEPT
 }
 
 ip_forward() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall30.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall30.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall30.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall30.fw.orig	2014-07-08 16:51:10.347007728 +0200
@@ -307,9 +307,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -322,15 +322,15 @@ script_body() {
     # 
     echo "Rule 0 (global)"
     # 
-    $IPTABLES -A INPUT  -m mac --mac-source 00:10:4b:de:e9:6f  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -m mac --mac-source 00:10:4b:de:e9:6f  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -m mac --mac-source 00:10:4b:de:e9:6f  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -m mac --mac-source 00:10:4b:de:e9:6f  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (global)
     # 
     echo "Rule 1 (global)"
     # 
-    $IPTABLES -A INPUT  -m mac --mac-source 00:10:4b:de:e9:70  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -m mac --mac-source 00:10:4b:de:e9:70  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -m mac --mac-source 00:10:4b:de:e9:70  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -m mac --mac-source 00:10:4b:de:e9:70  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall31.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall31.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall31.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall31.fw.orig	2014-07-08 16:51:10.529005452 +0200
@@ -323,9 +323,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -350,9 +350,9 @@ script_body() {
     echo "Rule 1 (global)"
     # 
     $IPTABLES -N RULE_1
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW -m time  --timestart 18:00  --timestop 23:59  -j RULE_1
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW -m time  --timestart 18:00  --timestop 23:59  -j RULE_1
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW -m time  --timestart 18:00  --timestop 23:59  -j RULE_1
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW -m time  --timestart 18:00  --timestop 23:59  -j RULE_1
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW -m time  --timestart 18:00  --timestop 23:59  -j RULE_1
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW -m time  --timestart 18:00  --timestop 23:59  -j RULE_1
     $IPTABLES -A RULE_1  -j LOG  --log-level info --log-prefix "RULE 1 -- ACCEPT "
     $IPTABLES -A RULE_1  -j ACCEPT
     # 
@@ -360,18 +360,18 @@ script_body() {
     # 
     echo "Rule 2 (global)"
     # 
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW -m time  --timestart 00:00  --timestop 23:59  --days Sat,Sun -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW -m time  --timestart 00:00  --timestop 23:59  --days Sat,Sun -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW -m time  --timestart 00:00  --timestop 23:59  --days Sat,Sun -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW -m time  --timestart 00:00  --timestop 23:59  --days Sat,Sun -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW -m time  --timestart 00:00  --timestop 23:59  --days Sat,Sun -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW -m time  --timestart 00:00  --timestop 23:59  --days Sat,Sun -j ACCEPT
     # 
     # Rule 3 (global)
     # 
     echo "Rule 3 (global)"
     # 
     $IPTABLES -N RULE_3
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW -m time  --timestart 09:00  --timestop 17:00  --days Mon,Tue,Wed,Thu,Fri -j RULE_3
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW -m time  --timestart 09:00  --timestop 17:00  --days Mon,Tue,Wed,Thu,Fri -j RULE_3
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW -m time  --timestart 09:00  --timestop 17:00  --days Mon,Tue,Wed,Thu,Fri -j RULE_3
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW -m time  --timestart 09:00  --timestop 17:00  --days Mon,Tue,Wed,Thu,Fri -j RULE_3
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW -m time  --timestart 09:00  --timestop 17:00  --days Mon,Tue,Wed,Thu,Fri -j RULE_3
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW -m time  --timestart 09:00  --timestop 17:00  --days Mon,Tue,Wed,Thu,Fri -j RULE_3
     $IPTABLES -A RULE_3  -j LOG  --log-level info --log-prefix "RULE 3 -- ACCEPT "
     $IPTABLES -A RULE_3  -j ACCEPT
     # 
@@ -380,9 +380,9 @@ script_body() {
     echo "Rule 4 (global)"
     # 
     $IPTABLES -N Cid4299E23B.0
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j Cid4299E23B.0
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j Cid4299E23B.0
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j Cid4299E23B.0
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid4299E23B.0
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid4299E23B.0
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid4299E23B.0
     $IPTABLES -A Cid4299E23B.0 -m time  --timestart 00:00  --timestop 23:59  --days Sat,Sun -j RETURN
     $IPTABLES -N RULE_4_3
     $IPTABLES -A Cid4299E23B.0  -j RULE_4_3
@@ -394,9 +394,9 @@ script_body() {
     echo "Rule 5 (global)"
     # 
     $IPTABLES -N Cid4299E247.0
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j Cid4299E247.0
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j Cid4299E247.0
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j Cid4299E247.0
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid4299E247.0
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid4299E247.0
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid4299E247.0
     $IPTABLES -A Cid4299E247.0 -m time  --timestart 00:00  --timestop 23:59  --days Sat -j RETURN
     $IPTABLES -A Cid4299E247.0 -m time  --timestart 00:00  --timestop 23:59  --days Sun -j RETURN
     $IPTABLES -N RULE_5_3
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall32.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall32.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall32.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall32.fw.orig	2014-07-08 16:51:10.941000302 +0200
@@ -310,9 +310,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -349,31 +349,31 @@ script_body() {
     # 
     echo "Rule Policy_fw32 1 (global)"
     # 
-    $IPTABLES -A INPUT  -s 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -s 192.168.1.2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -s 192.168.1.3/30   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -s 192.168.1.200   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -s 192.168.1.201   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -s 192.168.2.128/25   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.3/30   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.200   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.201   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.2.128/25   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.3/30   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.200   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.201   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.2.128/25   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.3/30   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.200   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.201   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.2.128/25   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.3/30   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.200   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.201   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.2.128/25   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.3/30   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.200   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.201   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.2.128/25   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule Policy_fw32 2 (global)
     # 
     echo "Rule Policy_fw32 2 (global)"
     # 
-    $IPTABLES -A OUTPUT -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p udp -m udp  -m multiport  -d 255.255.255.255   --dports 68,67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule Policy_fw32 3 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall33-1.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall33-1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall33-1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall33-1.fw.orig	2014-07-08 16:51:10.504005765 +0200
@@ -323,9 +323,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -339,16 +339,16 @@ script_body() {
     echo "Rule 0 (global)"
     # 
     $IPTABLES -N Policy
-    $IPTABLES -A Policy  -s 157.166.226.25   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A Policy  -s 157.166.226.26   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A Policy  -s 157.166.255.18   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A Policy  -s 157.166.255.19   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A Policy  -s 157.166.226.25   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A Policy  -s 157.166.226.26   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A Policy  -s 157.166.255.18   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A Policy  -s 157.166.255.19   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (global)
     # 
     echo "Rule 1 (global)"
     # 
-    $IPTABLES -A Policy  -s www.cnn.com  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A Policy  -s www.cnn.com  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (global)
     # 
@@ -356,13 +356,13 @@ script_body() {
     # 
     # firewall33-1:Policy:2: error: DNSName object "buildmaster (ct)" (compile time) can not resolve dns name "buildmaster" (AF_INET): Host or network 'buildmaster' not found; last error: Unknown error Using dummy address in test mode
 
-    $IPTABLES -A Policy  -s 192.0.2.1   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A Policy  -s 192.0.2.1   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
     echo "Rule 3 (global)"
     # 
-    $IPTABLES -A Policy  -s buildmaster  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A Policy  -s buildmaster  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
@@ -392,7 +392,7 @@ script_body() {
     # firewall33-1:Policy:6: error: DNSName object "buildmaster (ct)" (compile time) can not resolve dns name "buildmaster" (AF_INET): Host or network 'buildmaster' not found; last error: Unknown error Using dummy address in test mode
 
     $IPTABLES -N Cid43867C3018346.0
-    $IPTABLES -A Policy  -m state --state NEW  -j Cid43867C3018346.0
+    $IPTABLES -A Policy  -m conntrack --ctstate NEW  -j Cid43867C3018346.0
     $IPTABLES -A Cid43867C3018346.0  -d 192.0.2.1   -j RETURN
     $IPTABLES -A Cid43867C3018346.0  -j ACCEPT
     # 
@@ -401,7 +401,7 @@ script_body() {
     echo "Rule 7 (global)"
     # 
     $IPTABLES -N Cid4386C10D18346.0
-    $IPTABLES -A Policy  -m state --state NEW  -j Cid4386C10D18346.0
+    $IPTABLES -A Policy  -m conntrack --ctstate NEW  -j Cid4386C10D18346.0
     $IPTABLES -A Cid4386C10D18346.0  -d buildmaster  -j RETURN
     $IPTABLES -A Cid4386C10D18346.0  -j ACCEPT
     # 
@@ -410,7 +410,7 @@ script_body() {
     echo "Rule 8 (global)"
     # 
     $IPTABLES -N Cid438728A918346.0
-    $IPTABLES -A Policy  -m state --state NEW  -j Cid438728A918346.0
+    $IPTABLES -A Policy  -m conntrack --ctstate NEW  -j Cid438728A918346.0
     $IPTABLES -A Cid438728A918346.0  -d 74.125.224.112   -j RETURN
     $IPTABLES -A Cid438728A918346.0  -d 74.125.224.113   -j RETURN
     $IPTABLES -A Cid438728A918346.0  -d 74.125.224.114   -j RETURN
@@ -427,7 +427,7 @@ script_body() {
     echo "Rule 9 (global)"
     # 
     $IPTABLES -N Cid438728BA18346.0
-    $IPTABLES -A Policy  -m state --state NEW  -j Cid438728BA18346.0
+    $IPTABLES -A Policy  -m conntrack --ctstate NEW  -j Cid438728BA18346.0
     $IPTABLES -A Cid438728BA18346.0  -d www.cnn.com  -j RETURN
     $IPTABLES -A Cid438728BA18346.0  -d www.google.com  -j RETURN
     $IPTABLES -A Cid438728BA18346.0  -j ACCEPT
@@ -437,7 +437,7 @@ script_body() {
     echo "Rule 10 (global)"
     # 
     $IPTABLES -N Cid438728CD18346.0
-    $IPTABLES -A Policy  -m state --state NEW  -j Cid438728CD18346.0
+    $IPTABLES -A Policy  -m conntrack --ctstate NEW  -j Cid438728CD18346.0
     $IPTABLES -A Cid438728CD18346.0  -d www.google.com  -j RETURN
     $IPTABLES -A Cid438728CD18346.0  -d 157.166.226.25   -j RETURN
     $IPTABLES -A Cid438728CD18346.0  -d 157.166.226.26   -j RETURN
@@ -451,15 +451,15 @@ script_body() {
     # 
     # test for bug #1905718
     # Group of DNS Name objects considered empty
-    $IPTABLES -A Policy  -d 6bone.net  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A Policy  -d ny6ix.net  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A Policy  -d 6bone.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A Policy  -d ny6ix.net  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 12 (global)
     # 
     echo "Rule 12 (global)"
     # 
-    $IPTABLES -A Policy  -d 72.55.148.116   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A Policy  -d 207.251.84.150   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A Policy  -d 72.55.148.116   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A Policy  -d 207.251.84.150   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 13 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall33.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall33.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall33.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall33.fw.orig	2014-07-08 16:51:11.105998239 +0200
@@ -312,9 +312,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -368,21 +368,21 @@ script_body() {
     # 
     echo "Rule 0 (global)"
     # 
-    $IPTABLES -A INPUT  -s 157.166.226.25   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -s 157.166.226.26   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -s 157.166.255.18   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -s 157.166.255.19   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 157.166.226.25   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 157.166.226.26   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 157.166.255.18   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 157.166.255.19   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 157.166.226.25   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 157.166.226.26   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 157.166.255.18   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 157.166.255.19   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 157.166.226.25   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 157.166.226.26   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 157.166.255.18   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 157.166.255.19   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (global)
     # 
     echo "Rule 1 (global)"
     # 
-    $IPTABLES -A INPUT  -s www.cnn.com  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s www.cnn.com  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s www.cnn.com  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s www.cnn.com  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (global)
     # 
@@ -390,15 +390,15 @@ script_body() {
     # 
     # firewall33:Policy:2: error: DNSName object "buildmaster (ct)" (compile time) can not resolve dns name "buildmaster" (AF_INET): Host or network 'buildmaster' not found; last error: Unknown error Using dummy address in test mode
 
-    $IPTABLES -A INPUT  -s 192.0.2.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.0.2.1   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.0.2.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.0.2.1   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
     echo "Rule 3 (global)"
     # 
-    $IPTABLES -A INPUT  -s buildmaster  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s buildmaster  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s buildmaster  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s buildmaster  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
@@ -432,9 +432,9 @@ script_body() {
     # firewall33:Policy:6: error: DNSName object "buildmaster (ct)" (compile time) can not resolve dns name "buildmaster" (AF_INET): Host or network 'buildmaster' not found; last error: Unknown error Using dummy address in test mode
 
     $IPTABLES -N Cid43867C3018346.0
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j Cid43867C3018346.0
-    $IPTABLES -A INPUT  -m state --state NEW  -j Cid43867C3018346.0
-    $IPTABLES -A FORWARD  -m state --state NEW  -j Cid43867C3018346.0
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j Cid43867C3018346.0
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j Cid43867C3018346.0
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j Cid43867C3018346.0
     $IPTABLES -A Cid43867C3018346.0  -d 192.0.2.1   -j RETURN
     $IPTABLES -A Cid43867C3018346.0  -j ACCEPT
     # 
@@ -443,9 +443,9 @@ script_body() {
     echo "Rule 7 (global)"
     # 
     $IPTABLES -N Cid4386C10D18346.0
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j Cid4386C10D18346.0
-    $IPTABLES -A INPUT  -m state --state NEW  -j Cid4386C10D18346.0
-    $IPTABLES -A FORWARD  -m state --state NEW  -j Cid4386C10D18346.0
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j Cid4386C10D18346.0
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j Cid4386C10D18346.0
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j Cid4386C10D18346.0
     $IPTABLES -A Cid4386C10D18346.0  -d buildmaster  -j RETURN
     $IPTABLES -A Cid4386C10D18346.0  -j ACCEPT
     # 
@@ -454,9 +454,9 @@ script_body() {
     echo "Rule 8 (global)"
     # 
     $IPTABLES -N Cid438728A918346.0
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j Cid438728A918346.0
-    $IPTABLES -A INPUT  -m state --state NEW  -j Cid438728A918346.0
-    $IPTABLES -A FORWARD  -m state --state NEW  -j Cid438728A918346.0
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j Cid438728A918346.0
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j Cid438728A918346.0
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j Cid438728A918346.0
     $IPTABLES -A Cid438728A918346.0  -d 74.125.224.112   -j RETURN
     $IPTABLES -A Cid438728A918346.0  -d 74.125.224.113   -j RETURN
     $IPTABLES -A Cid438728A918346.0  -d 74.125.224.114   -j RETURN
@@ -473,9 +473,9 @@ script_body() {
     echo "Rule 9 (global)"
     # 
     $IPTABLES -N Cid438728BA18346.0
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j Cid438728BA18346.0
-    $IPTABLES -A INPUT  -m state --state NEW  -j Cid438728BA18346.0
-    $IPTABLES -A FORWARD  -m state --state NEW  -j Cid438728BA18346.0
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j Cid438728BA18346.0
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j Cid438728BA18346.0
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j Cid438728BA18346.0
     $IPTABLES -A Cid438728BA18346.0  -d www.cnn.com  -j RETURN
     $IPTABLES -A Cid438728BA18346.0  -d www.google.com  -j RETURN
     $IPTABLES -A Cid438728BA18346.0  -j ACCEPT
@@ -485,9 +485,9 @@ script_body() {
     echo "Rule 10 (global)"
     # 
     $IPTABLES -N Cid438728CD18346.0
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j Cid438728CD18346.0
-    $IPTABLES -A INPUT  -m state --state NEW  -j Cid438728CD18346.0
-    $IPTABLES -A FORWARD  -m state --state NEW  -j Cid438728CD18346.0
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j Cid438728CD18346.0
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j Cid438728CD18346.0
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j Cid438728CD18346.0
     $IPTABLES -A Cid438728CD18346.0  -d www.google.com  -j RETURN
     $IPTABLES -A Cid438728CD18346.0  -d 157.166.226.25   -j RETURN
     $IPTABLES -A Cid438728CD18346.0  -d 157.166.226.26   -j RETURN
@@ -501,19 +501,19 @@ script_body() {
     # 
     # test for bug #1905718
     # Group of DNS Name objects considered empty
-    $IPTABLES -A OUTPUT  -d 6bone.net  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -d ny6ix.net  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 6bone.net  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d ny6ix.net  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 6bone.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d ny6ix.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 6bone.net  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d ny6ix.net  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 12 (global)
     # 
     echo "Rule 12 (global)"
     # 
-    $IPTABLES -A OUTPUT  -d 72.55.148.116   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -d 207.251.84.150   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 72.55.148.116   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 207.251.84.150   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 72.55.148.116   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 207.251.84.150   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 72.55.148.116   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 207.251.84.150   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 13 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall34.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall34.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall34.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall34.fw.orig	2014-07-08 16:51:11.029999189 +0200
@@ -313,9 +313,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -353,24 +353,24 @@ script_body() {
     # 
     echo "Rule 0 (global)"
     # 
-    $IPTABLES -A OUTPUT  -d 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -d 192.168.1.2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -d 192.168.1.3/30   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -d 192.168.1.200   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -d 192.168.1.201   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -d 192.168.2.128/25   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 192.168.1.2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 192.168.1.3/30   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 192.168.1.200   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 192.168.1.201   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 192.168.2.128/25   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 192.168.1.2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 192.168.1.3/30   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 192.168.1.200   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 192.168.1.201   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 192.168.2.128/25   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 192.168.1.2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 192.168.1.3/30   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 192.168.1.200   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 192.168.1.201   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 192.168.2.128/25   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 192.168.1.2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 192.168.1.3/30   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 192.168.1.200   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 192.168.1.201   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 192.168.2.128/25   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 192.168.1.2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 192.168.1.3/30   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 192.168.1.200   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 192.168.1.201   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 192.168.2.128/25   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (global)
     # 
@@ -467,9 +467,9 @@ script_body() {
     echo "Rule 7 (global)"
     # 
     $IPTABLES -N Cid4388F5A9674.0
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j Cid4388F5A9674.0
-    $IPTABLES -A INPUT  -m state --state NEW  -j Cid4388F5A9674.0
-    $IPTABLES -A FORWARD  -m state --state NEW  -j Cid4388F5A9674.0
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j Cid4388F5A9674.0
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j Cid4388F5A9674.0
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j Cid4388F5A9674.0
     grep -Ev '^#|^;|^\s*$' block-hosts.tbl | while read L ; do
       set $L; at_block_these=$1; $IPTABLES -A Cid4388F5A9674.0  -s $at_block_these   -j RETURN 
     done
@@ -483,11 +483,11 @@ script_body() {
     $IPTABLES -N Cid4392312525682.0
     for i_eth0_100 in $i_eth0_100_list
     do
-    test -n "$i_eth0_100" && $IPTABLES -A INPUT  -s $i_eth0_100   -m state --state NEW  -j Cid4392312525682.0 
+    test -n "$i_eth0_100" && $IPTABLES -A INPUT  -s $i_eth0_100   -m conntrack --ctstate NEW  -j Cid4392312525682.0 
     done
     for i_eth0_100 in $i_eth0_100_list
     do
-    test -n "$i_eth0_100" && $IPTABLES -A OUTPUT  -s $i_eth0_100   -m state --state NEW  -j Cid4392312525682.0 
+    test -n "$i_eth0_100" && $IPTABLES -A OUTPUT  -s $i_eth0_100   -m conntrack --ctstate NEW  -j Cid4392312525682.0 
     done
     grep -Ev '^#|^;|^\s*$' block-hosts.tbl | while read L ; do
       set $L; at_block_these=$1; $IPTABLES -A Cid4392312525682.0  -d $at_block_these   -j RETURN 
@@ -499,16 +499,16 @@ script_body() {
     # 
     echo "Rule 9 (global)"
     # 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.10   --dport 25  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -d 192.168.1.10   --dport 25  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.10   --dport 25  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -d 192.168.1.10   --dport 25  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 10 (global)
     # 
     echo "Rule 10 (global)"
     # 
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 11 (global)
     # 
@@ -542,7 +542,7 @@ script_body() {
     # is only valid in combination
     # with "-p tcp -m tcp"
     $IPTABLES -N Cid45948F957794.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 25  -m state --state NEW  -m connlimit --connlimit-above 2 -j Cid45948F957794.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 25  -m conntrack --ctstate NEW  -m connlimit --connlimit-above 2 -j Cid45948F957794.0
     $IPTABLES -A Cid45948F957794.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid45948F957794.0  -d 192.168.1.2   -j ACCEPT
     $IPTABLES -A Cid45948F957794.0  -d 192.168.1.3/30   -j ACCEPT
@@ -550,7 +550,7 @@ script_body() {
     $IPTABLES -A Cid45948F957794.0  -d 192.168.1.201   -j ACCEPT
     $IPTABLES -A Cid45948F957794.0  -d 192.168.2.128/25   -j ACCEPT
     $IPTABLES -N Cid45948F957794.1
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 25  -m state --state NEW  -m connlimit --connlimit-above 2 -j Cid45948F957794.1
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 25  -m conntrack --ctstate NEW  -m connlimit --connlimit-above 2 -j Cid45948F957794.1
     $IPTABLES -A Cid45948F957794.1  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid45948F957794.1  -d 192.168.1.2   -j ACCEPT
     $IPTABLES -A Cid45948F957794.1  -d 192.168.1.3/30   -j ACCEPT
@@ -558,7 +558,7 @@ script_body() {
     $IPTABLES -A Cid45948F957794.1  -d 192.168.1.201   -j ACCEPT
     $IPTABLES -A Cid45948F957794.1  -d 192.168.2.128/25   -j ACCEPT
     $IPTABLES -N Cid45948F957794.2
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 25  -m state --state NEW  -m connlimit --connlimit-above 2 -j Cid45948F957794.2
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 25  -m conntrack --ctstate NEW  -m connlimit --connlimit-above 2 -j Cid45948F957794.2
     $IPTABLES -A Cid45948F957794.2  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid45948F957794.2  -d 192.168.1.2   -j ACCEPT
     $IPTABLES -A Cid45948F957794.2  -d 192.168.1.3/30   -j ACCEPT
@@ -571,10 +571,10 @@ script_body() {
     echo "Rule 15 (global)"
     # 
     grep -Ev '^#|^;|^\s*$' addr-table-1.tbl | while read L ; do
-      set $L; at_addr_table_1_a=$1; $IPTABLES -A OUTPUT  -d $at_addr_table_1_a   -m state --state NEW  -j ACCEPT 
+      set $L; at_addr_table_1_a=$1; $IPTABLES -A OUTPUT  -d $at_addr_table_1_a   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     grep -Ev '^#|^;|^\s*$' addr-table-1.tbl | while read L ; do
-      set $L; at_addr_table_1_a=$1; $IPTABLES -A FORWARD  -d $at_addr_table_1_a   -m state --state NEW  -j ACCEPT 
+      set $L; at_addr_table_1_a=$1; $IPTABLES -A FORWARD  -d $at_addr_table_1_a   -m conntrack --ctstate NEW  -j ACCEPT 
     done
 
 
@@ -583,9 +583,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IP6TABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IP6TABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -598,10 +598,10 @@ script_body() {
     # 
     echo "Rule Policy_ipv6 0 (global)"
     # 
-    $IP6TABLES -A OUTPUT  -d 2001:458:20:100:250:b7ff:fe00:2af   -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A OUTPUT  -d fe80::21d:9ff:fe8b:8e94/64   -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A FORWARD  -d 2001:458:20:100:250:b7ff:fe00:2af   -m state --state NEW  -j ACCEPT
-    $IP6TABLES -A FORWARD  -d fe80::21d:9ff:fe8b:8e94/64   -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A OUTPUT  -d 2001:458:20:100:250:b7ff:fe00:2af   -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A OUTPUT  -d fe80::21d:9ff:fe8b:8e94/64   -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A FORWARD  -d 2001:458:20:100:250:b7ff:fe00:2af   -m conntrack --ctstate NEW  -j ACCEPT
+    $IP6TABLES -A FORWARD  -d fe80::21d:9ff:fe8b:8e94/64   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule Policy_ipv6 1 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall35.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall35.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall35.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall35.fw.orig	2014-07-08 16:51:11.065998739 +0200
@@ -322,9 +322,9 @@ script_body() {
     echo "-A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu"
 
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # ================ Table 'filter', rule set block_local_bcast
     # 
     # Rule  block_local_bcast 0 (global)
@@ -335,24 +335,24 @@ script_body() {
     # ================ Table 'filter', rule set Policy
     # 
     # Rule  0 (global)
-    echo "-A OUTPUT  -d 192.168.1.1   -m state --state NEW  -j ACCEPT "
-    echo "-A OUTPUT  -d 192.168.1.2   -m state --state NEW  -j ACCEPT "
-    echo "-A OUTPUT  -d 192.168.1.3/30   -m state --state NEW  -j ACCEPT "
-    echo "-A OUTPUT  -d 192.168.1.200   -m state --state NEW  -j ACCEPT "
-    echo "-A OUTPUT  -d 192.168.1.201   -m state --state NEW  -j ACCEPT "
-    echo "-A OUTPUT  -d 192.168.2.128/25   -m state --state NEW  -j ACCEPT "
-    echo "-A INPUT  -d 192.168.1.1   -m state --state NEW  -j ACCEPT "
-    echo "-A INPUT  -d 192.168.1.2   -m state --state NEW  -j ACCEPT "
-    echo "-A INPUT  -d 192.168.1.3/30   -m state --state NEW  -j ACCEPT "
-    echo "-A INPUT  -d 192.168.1.200   -m state --state NEW  -j ACCEPT "
-    echo "-A INPUT  -d 192.168.1.201   -m state --state NEW  -j ACCEPT "
-    echo "-A INPUT  -d 192.168.2.128/25   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d 192.168.1.1   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d 192.168.1.2   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d 192.168.1.3/30   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d 192.168.1.200   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d 192.168.1.201   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -d 192.168.2.128/25   -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 192.168.1.2   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 192.168.1.3/30   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 192.168.1.200   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 192.168.1.201   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A OUTPUT  -d 192.168.2.128/25   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A INPUT  -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A INPUT  -d 192.168.1.2   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A INPUT  -d 192.168.1.3/30   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A INPUT  -d 192.168.1.200   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A INPUT  -d 192.168.1.201   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A INPUT  -d 192.168.2.128/25   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 192.168.1.2   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 192.168.1.3/30   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 192.168.1.200   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 192.168.1.201   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -d 192.168.2.128/25   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  1 (global)
     echo ":RULE_1 - [0:0]"
@@ -433,9 +433,9 @@ script_body() {
     # 
     # Rule  8 (global)
     echo ":Cid4392555025682.0 - [0:0]"
-    echo "-A OUTPUT  -m state --state NEW  -j Cid4392555025682.0 "
-    echo "-A INPUT  -m state --state NEW  -j Cid4392555025682.0 "
-    echo "-A FORWARD  -m state --state NEW  -j Cid4392555025682.0 "
+    echo "-A OUTPUT  -m conntrack --ctstate NEW  -j Cid4392555025682.0 "
+    echo "-A INPUT  -m conntrack --ctstate NEW  -j Cid4392555025682.0 "
+    echo "-A FORWARD  -m conntrack --ctstate NEW  -j Cid4392555025682.0 "
     grep -Ev '^#|^;|^\s*$' block-hosts.tbl | while read L ; do
       set $L; at_block_these=$1; echo "-A Cid4392555025682.0  -s $at_block_these   -j RETURN " 
     done
@@ -446,11 +446,11 @@ script_body() {
     echo ":Cid4392555D25682.0 - [0:0]"
     for i_eth0_100 in $i_eth0_100_list
     do
-    test -n "$i_eth0_100" && echo "-A INPUT  -s $i_eth0_100   -m state --state NEW  -j Cid4392555D25682.0 " 
+    test -n "$i_eth0_100" && echo "-A INPUT  -s $i_eth0_100   -m conntrack --ctstate NEW  -j Cid4392555D25682.0 " 
     done
     for i_eth0_100 in $i_eth0_100_list
     do
-    test -n "$i_eth0_100" && echo "-A OUTPUT  -s $i_eth0_100   -m state --state NEW  -j Cid4392555D25682.0 " 
+    test -n "$i_eth0_100" && echo "-A OUTPUT  -s $i_eth0_100   -m conntrack --ctstate NEW  -j Cid4392555D25682.0 " 
     done
     grep -Ev '^#|^;|^\s*$' block-hosts.tbl | while read L ; do
       set $L; at_block_these=$1; echo "-A Cid4392555D25682.0  -d $at_block_these   -j RETURN " 
@@ -459,13 +459,13 @@ script_body() {
     echo "-A Cid4392555D25682.0  -j ACCEPT "
     # 
     # Rule  10 (global)
-    echo "-A OUTPUT -p tcp -m tcp  -d 192.168.1.10   --dport 25  -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD -p tcp -m tcp  -d 192.168.1.10   --dport 25  -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT -p tcp -m tcp  -d 192.168.1.10   --dport 25  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD -p tcp -m tcp  -d 192.168.1.10   --dport 25  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  11 (global)
-    echo "-A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT "
-    echo "-A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT "
+    echo "-A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  12 (global)
     echo ":RULE_12 - [0:0]"
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall36-1.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall36-1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall36-1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall36-1.fw.orig	2014-07-08 16:51:10.531005427 +0200
@@ -323,9 +323,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall36-2.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall36-2.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall36-2.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall36-2.fw.orig	2014-07-08 16:51:11.046998976 +0200
@@ -323,9 +323,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall36.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall36.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall36.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall36.fw.orig	2014-07-08 16:51:10.496005865 +0200
@@ -326,9 +326,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall37-1.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall37-1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall37-1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall37-1.fw.orig	2014-07-08 16:51:11.056998851 +0200
@@ -322,9 +322,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
     # ================ Table 'mangle', automatic rules
     $IPTABLES -t mangle -A PREROUTING -j CONNMARK --restore-mark
     $IPTABLES -t mangle -A OUTPUT -j CONNMARK --restore-mark
@@ -357,20 +357,20 @@ script_body() {
     echo "Rule 0 (global)"
     # 
     # terminating target
-    $IPTABLES -t mangle -A OUTPUT -p 50  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A OUTPUT -p ah  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A PREROUTING -p 50  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A PREROUTING -p ah  -m state --state NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A PREROUTING -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A PREROUTING -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16
     # 
     # Rule 1 (global)
     # 
     echo "Rule 1 (global)"
     # 
     # terminating target
-    $IPTABLES -t mangle -A OUTPUT -p 50  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A OUTPUT -p ah  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A PREROUTING -p 50  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A PREROUTING -p ah  -m state --state NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A PREROUTING -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A PREROUTING -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16
     # 
     # Rule 2 (global)
     # 
@@ -378,10 +378,10 @@ script_body() {
     # 
     # terminating target
     $IPTABLES -N Cid45AB5AC525451.0 -t mangle
-    $IPTABLES -t mangle -A OUTPUT -p 50  -m state --state NEW  -j Cid45AB5AC525451.0
-    $IPTABLES -t mangle -A OUTPUT -p ah  -m state --state NEW  -j Cid45AB5AC525451.0
-    $IPTABLES -t mangle -A PREROUTING -p 50  -m state --state NEW  -j Cid45AB5AC525451.0
-    $IPTABLES -t mangle -A PREROUTING -p ah  -m state --state NEW  -j Cid45AB5AC525451.0
+    $IPTABLES -t mangle -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j Cid45AB5AC525451.0
+    $IPTABLES -t mangle -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j Cid45AB5AC525451.0
+    $IPTABLES -t mangle -A PREROUTING -p 50  -m conntrack --ctstate NEW  -j Cid45AB5AC525451.0
+    $IPTABLES -t mangle -A PREROUTING -p ah  -m conntrack --ctstate NEW  -j Cid45AB5AC525451.0
     $IPTABLES -t mangle -A Cid45AB5AC525451.0  -s 192.168.1.0/24   -j RETURN
     $IPTABLES -t mangle -A Cid45AB5AC525451.0  -s 192.168.2.0/24   -j RETURN
     $IPTABLES -t mangle -A Cid45AB5AC525451.0  -j MARK --set-mark 16
@@ -391,46 +391,46 @@ script_body() {
     echo "Rule 3 (eth1)"
     # 
     # terminating target
-    $IPTABLES -t mangle -A PREROUTING -i eth1  -p 50  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A PREROUTING -i eth1  -p ah  -m state --state NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A PREROUTING -i eth1  -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A PREROUTING -i eth1  -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16
     # 
     # Rule 4 (eth1)
     # 
     echo "Rule 4 (eth1)"
     # 
     # temrinating target
-    $IPTABLES -t mangle -A OUTPUT -o eth1  -p 50  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A OUTPUT -o eth1  -p ah  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p 50  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p ah  -m state --state NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -o eth1  -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -o eth1  -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16
     # 
     # Rule 5 (global)
     # 
     echo "Rule 5 (global)"
     # 
     # terminating and CONNMARK
-    $IPTABLES -t mangle -A OUTPUT -p 50  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A OUTPUT -p ah  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A PREROUTING -p 50  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A PREROUTING -p ah  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A OUTPUT -p 50  -m state --state NEW  -j CONNMARK --save-mark
-    $IPTABLES -t mangle -A OUTPUT -p ah  -m state --state NEW  -j CONNMARK --save-mark
-    $IPTABLES -t mangle -A PREROUTING -p 50  -m state --state NEW  -j CONNMARK --save-mark
-    $IPTABLES -t mangle -A PREROUTING -p ah  -m state --state NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A PREROUTING -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A PREROUTING -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A PREROUTING -p 50  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A PREROUTING -p ah  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
     # 
     # Rule 6 (global)
     # 
     echo "Rule 6 (global)"
     # 
     # terminating and CONNMARK
-    $IPTABLES -t mangle -A OUTPUT -p 50  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A OUTPUT -p ah  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A PREROUTING -p 50  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A PREROUTING -p ah  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A OUTPUT -p 50  -m state --state NEW  -j CONNMARK --save-mark
-    $IPTABLES -t mangle -A OUTPUT -p ah  -m state --state NEW  -j CONNMARK --save-mark
-    $IPTABLES -t mangle -A PREROUTING -p 50  -m state --state NEW  -j CONNMARK --save-mark
-    $IPTABLES -t mangle -A PREROUTING -p ah  -m state --state NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A PREROUTING -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A PREROUTING -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A PREROUTING -p 50  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A PREROUTING -p ah  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
     # 
     # Rule 7 (global)
     # 
@@ -438,10 +438,10 @@ script_body() {
     # 
     # terminating and  CONNMARK
     $IPTABLES -N Cid45AB5B0225451.0 -t mangle
-    $IPTABLES -t mangle -A OUTPUT -p 50  -m state --state NEW  -j Cid45AB5B0225451.0
-    $IPTABLES -t mangle -A OUTPUT -p ah  -m state --state NEW  -j Cid45AB5B0225451.0
-    $IPTABLES -t mangle -A PREROUTING -p 50  -m state --state NEW  -j Cid45AB5B0225451.0
-    $IPTABLES -t mangle -A PREROUTING -p ah  -m state --state NEW  -j Cid45AB5B0225451.0
+    $IPTABLES -t mangle -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j Cid45AB5B0225451.0
+    $IPTABLES -t mangle -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j Cid45AB5B0225451.0
+    $IPTABLES -t mangle -A PREROUTING -p 50  -m conntrack --ctstate NEW  -j Cid45AB5B0225451.0
+    $IPTABLES -t mangle -A PREROUTING -p ah  -m conntrack --ctstate NEW  -j Cid45AB5B0225451.0
     $IPTABLES -t mangle -A Cid45AB5B0225451.0  -s 192.168.1.0/24   -j RETURN
     $IPTABLES -t mangle -A Cid45AB5B0225451.0  -s 192.168.2.0/24   -j RETURN
     $IPTABLES -t mangle -A Cid45AB5B0225451.0  -j MARK --set-mark 10
@@ -452,24 +452,24 @@ script_body() {
     echo "Rule 8 (eth1)"
     # 
     # terminating and CONNMARK
-    $IPTABLES -t mangle -A PREROUTING -i eth1  -p 50  -m state --state NEW  -j MARK --set-mark 8
-    $IPTABLES -t mangle -A PREROUTING -i eth1  -p ah  -m state --state NEW  -j MARK --set-mark 8
-    $IPTABLES -t mangle -A PREROUTING -i eth1  -p 50  -m state --state NEW  -j CONNMARK --save-mark
-    $IPTABLES -t mangle -A PREROUTING -i eth1  -p ah  -m state --state NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A PREROUTING -i eth1  -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 8
+    $IPTABLES -t mangle -A PREROUTING -i eth1  -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 8
+    $IPTABLES -t mangle -A PREROUTING -i eth1  -p 50  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A PREROUTING -i eth1  -p ah  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
     # 
     # Rule 9 (eth1)
     # 
     echo "Rule 9 (eth1)"
     # 
     # terminating and CONNMARK
-    $IPTABLES -t mangle -A OUTPUT -o eth1  -p 50  -m state --state NEW  -j MARK --set-mark 9
-    $IPTABLES -t mangle -A OUTPUT -o eth1  -p ah  -m state --state NEW  -j MARK --set-mark 9
-    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p 50  -m state --state NEW  -j MARK --set-mark 9
-    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p ah  -m state --state NEW  -j MARK --set-mark 9
-    $IPTABLES -t mangle -A OUTPUT -o eth1  -p 50  -m state --state NEW  -j CONNMARK --save-mark
-    $IPTABLES -t mangle -A OUTPUT -o eth1  -p ah  -m state --state NEW  -j CONNMARK --save-mark
-    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p 50  -m state --state NEW  -j CONNMARK --save-mark
-    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p ah  -m state --state NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A OUTPUT -o eth1  -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 9
+    $IPTABLES -t mangle -A OUTPUT -o eth1  -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 9
+    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 9
+    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 9
+    $IPTABLES -t mangle -A OUTPUT -o eth1  -p 50  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A OUTPUT -o eth1  -p ah  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p 50  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p ah  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
     # 
     # Rule 11 (global)
     # 
@@ -606,7 +606,7 @@ script_body() {
     echo "Rule rule27_branch 1 (global)"
     # 
     $IPTABLES -N rule27_branch_1
-    $IPTABLES -A rule27_branch -p tcp -m tcp  --dport 80  -m state --state NEW  -j rule27_branch_1
+    $IPTABLES -A rule27_branch -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j rule27_branch_1
     $IPTABLES -A rule27_branch_1  -j LOG  --log-level info --log-prefix "RULE 1 -- ACCEPT "
     $IPTABLES -A rule27_branch_1  -j ACCEPT
     # ================ Table 'filter', rule set Policy
@@ -616,12 +616,12 @@ script_body() {
     echo "Rule 0 (global)"
     # 
     # terminating target
-    $IPTABLES -A OUTPUT -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p ah  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p ah  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p ah  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p ah  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p ah  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (global)
     # 
@@ -629,12 +629,12 @@ script_body() {
     # 
     # terminating target
     $IPTABLES -N RULE_1
-    $IPTABLES -A OUTPUT -p 50  -m state --state NEW  -j RULE_1
-    $IPTABLES -A OUTPUT -p ah  -m state --state NEW  -j RULE_1
-    $IPTABLES -A INPUT -p 50  -m state --state NEW  -j RULE_1
-    $IPTABLES -A INPUT -p ah  -m state --state NEW  -j RULE_1
-    $IPTABLES -A FORWARD -p 50  -m state --state NEW  -j RULE_1
-    $IPTABLES -A FORWARD -p ah  -m state --state NEW  -j RULE_1
+    $IPTABLES -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j RULE_1
+    $IPTABLES -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j RULE_1
+    $IPTABLES -A INPUT -p 50  -m conntrack --ctstate NEW  -j RULE_1
+    $IPTABLES -A INPUT -p ah  -m conntrack --ctstate NEW  -j RULE_1
+    $IPTABLES -A FORWARD -p 50  -m conntrack --ctstate NEW  -j RULE_1
+    $IPTABLES -A FORWARD -p ah  -m conntrack --ctstate NEW  -j RULE_1
     $IPTABLES -A RULE_1  -j LOG  --log-level info --log-prefix "RULE 1 -- ACCEPT "
     $IPTABLES -A RULE_1  -j ACCEPT
     # 
@@ -644,12 +644,12 @@ script_body() {
     # 
     # terminating target
     $IPTABLES -N Cid45AB5AC525451.0
-    $IPTABLES -A OUTPUT -p 50  -m state --state NEW  -j Cid45AB5AC525451.0
-    $IPTABLES -A OUTPUT -p ah  -m state --state NEW  -j Cid45AB5AC525451.0
-    $IPTABLES -A INPUT -p 50  -m state --state NEW  -j Cid45AB5AC525451.0
-    $IPTABLES -A INPUT -p ah  -m state --state NEW  -j Cid45AB5AC525451.0
-    $IPTABLES -A FORWARD -p 50  -m state --state NEW  -j Cid45AB5AC525451.0
-    $IPTABLES -A FORWARD -p ah  -m state --state NEW  -j Cid45AB5AC525451.0
+    $IPTABLES -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j Cid45AB5AC525451.0
+    $IPTABLES -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j Cid45AB5AC525451.0
+    $IPTABLES -A INPUT -p 50  -m conntrack --ctstate NEW  -j Cid45AB5AC525451.0
+    $IPTABLES -A INPUT -p ah  -m conntrack --ctstate NEW  -j Cid45AB5AC525451.0
+    $IPTABLES -A FORWARD -p 50  -m conntrack --ctstate NEW  -j Cid45AB5AC525451.0
+    $IPTABLES -A FORWARD -p ah  -m conntrack --ctstate NEW  -j Cid45AB5AC525451.0
     $IPTABLES -A Cid45AB5AC525451.0  -s 192.168.1.0/24   -j RETURN
     $IPTABLES -A Cid45AB5AC525451.0  -s 192.168.2.0/24   -j RETURN
     $IPTABLES -N RULE_2_3
@@ -662,32 +662,32 @@ script_body() {
     echo "Rule 3 (eth1)"
     # 
     # terminating target
-    $IPTABLES -A INPUT -i eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth1  -p ah  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth1  -p ah  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (eth1)
     # 
     echo "Rule 4 (eth1)"
     # 
     # temrinating target
-    $IPTABLES -A OUTPUT -o eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth1  -p ah  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth1  -p ah  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (global)
     # 
     echo "Rule 5 (global)"
     # 
     # terminating and CONNMARK
-    $IPTABLES -A OUTPUT -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p ah  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p ah  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p ah  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p ah  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p ah  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 6 (global)
     # 
@@ -695,12 +695,12 @@ script_body() {
     # 
     # terminating and CONNMARK
     $IPTABLES -N RULE_6
-    $IPTABLES -A OUTPUT -p 50  -m state --state NEW  -j RULE_6
-    $IPTABLES -A OUTPUT -p ah  -m state --state NEW  -j RULE_6
-    $IPTABLES -A INPUT -p 50  -m state --state NEW  -j RULE_6
-    $IPTABLES -A INPUT -p ah  -m state --state NEW  -j RULE_6
-    $IPTABLES -A FORWARD -p 50  -m state --state NEW  -j RULE_6
-    $IPTABLES -A FORWARD -p ah  -m state --state NEW  -j RULE_6
+    $IPTABLES -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j RULE_6
+    $IPTABLES -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j RULE_6
+    $IPTABLES -A INPUT -p 50  -m conntrack --ctstate NEW  -j RULE_6
+    $IPTABLES -A INPUT -p ah  -m conntrack --ctstate NEW  -j RULE_6
+    $IPTABLES -A FORWARD -p 50  -m conntrack --ctstate NEW  -j RULE_6
+    $IPTABLES -A FORWARD -p ah  -m conntrack --ctstate NEW  -j RULE_6
     $IPTABLES -A RULE_6  -j LOG  --log-level info --log-prefix "RULE 6 -- ACCEPT "
     $IPTABLES -A RULE_6  -j ACCEPT
     # 
@@ -710,12 +710,12 @@ script_body() {
     # 
     # terminating and  CONNMARK
     $IPTABLES -N Cid45AB5B0225451.0
-    $IPTABLES -A OUTPUT -p 50  -m state --state NEW  -j Cid45AB5B0225451.0
-    $IPTABLES -A OUTPUT -p ah  -m state --state NEW  -j Cid45AB5B0225451.0
-    $IPTABLES -A INPUT -p 50  -m state --state NEW  -j Cid45AB5B0225451.0
-    $IPTABLES -A INPUT -p ah  -m state --state NEW  -j Cid45AB5B0225451.0
-    $IPTABLES -A FORWARD -p 50  -m state --state NEW  -j Cid45AB5B0225451.0
-    $IPTABLES -A FORWARD -p ah  -m state --state NEW  -j Cid45AB5B0225451.0
+    $IPTABLES -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j Cid45AB5B0225451.0
+    $IPTABLES -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j Cid45AB5B0225451.0
+    $IPTABLES -A INPUT -p 50  -m conntrack --ctstate NEW  -j Cid45AB5B0225451.0
+    $IPTABLES -A INPUT -p ah  -m conntrack --ctstate NEW  -j Cid45AB5B0225451.0
+    $IPTABLES -A FORWARD -p 50  -m conntrack --ctstate NEW  -j Cid45AB5B0225451.0
+    $IPTABLES -A FORWARD -p ah  -m conntrack --ctstate NEW  -j Cid45AB5B0225451.0
     $IPTABLES -A Cid45AB5B0225451.0  -s 192.168.1.0/24   -j RETURN
     $IPTABLES -A Cid45AB5B0225451.0  -s 192.168.2.0/24   -j RETURN
     $IPTABLES -N RULE_7_3
@@ -728,20 +728,20 @@ script_body() {
     echo "Rule 8 (eth1)"
     # 
     # terminating and CONNMARK
-    $IPTABLES -A INPUT -i eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth1  -p ah  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth1  -p ah  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 9 (eth1)
     # 
     echo "Rule 9 (eth1)"
     # 
     # terminating and CONNMARK
-    $IPTABLES -A OUTPUT -o eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth1  -p ah  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth1  -p ah  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 10 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall37-2.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall37-2.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall37-2.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall37-2.fw.orig	2014-07-08 16:51:10.564005015 +0200
@@ -322,9 +322,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -350,15 +350,15 @@ script_body() {
     # 
     echo "Rule 1 (eth0)"
     # 
-    $IPTABLES -t mangle -A PREROUTING -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j MARK --set-mark 2
-    $IPTABLES -t mangle -A POSTROUTING -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j CLASSIFY --set-class 1:2
+    $IPTABLES -t mangle -A PREROUTING -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j MARK --set-mark 2
+    $IPTABLES -t mangle -A POSTROUTING -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j CLASSIFY --set-class 1:2
     # 
     # Rule 2 (eth0)
     # 
     echo "Rule 2 (eth0)"
     # 
-    $IPTABLES -t mangle -A PREROUTING -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j MARK --set-mark 2
-    $IPTABLES -t mangle -A POSTROUTING -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j CLASSIFY --set-class 1:2
+    $IPTABLES -t mangle -A PREROUTING -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j MARK --set-mark 2
+    $IPTABLES -t mangle -A POSTROUTING -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j CLASSIFY --set-class 1:2
     # 
     # Rule 3 (eth0)
     # 
@@ -378,15 +378,15 @@ script_body() {
     # 
     echo "Rule 5 (eth0)"
     # 
-    $IPTABLES -t mangle -A PREROUTING -i eth0   -s ! 192.168.1.0/24   -m state --state NEW  -j MARK --set-mark 2
-    $IPTABLES -t mangle -A POSTROUTING -i eth0   -s ! 192.168.1.0/24   -m state --state NEW  -j CLASSIFY --set-class 1:2
+    $IPTABLES -t mangle -A PREROUTING -i eth0   -s ! 192.168.1.0/24   -m conntrack --ctstate NEW  -j MARK --set-mark 2
+    $IPTABLES -t mangle -A POSTROUTING -i eth0   -s ! 192.168.1.0/24   -m conntrack --ctstate NEW  -j CLASSIFY --set-class 1:2
     # 
     # Rule 6 (eth0)
     # 
     echo "Rule 6 (eth0)"
     # 
-    $IPTABLES -t mangle -A PREROUTING -i eth0   -s ! 192.168.1.0/24   -m state --state NEW  -j MARK --set-mark 2
-    $IPTABLES -t mangle -A POSTROUTING -i eth0   -s ! 192.168.1.0/24   -m state --state NEW  -j CLASSIFY --set-class 1:2
+    $IPTABLES -t mangle -A PREROUTING -i eth0   -s ! 192.168.1.0/24   -m conntrack --ctstate NEW  -j MARK --set-mark 2
+    $IPTABLES -t mangle -A POSTROUTING -i eth0   -s ! 192.168.1.0/24   -m conntrack --ctstate NEW  -j CLASSIFY --set-class 1:2
     # 
     # Rule 7 (eth0)
     # 
@@ -415,12 +415,12 @@ script_body() {
     echo "Rule 9 (eth0)"
     # 
     $IPTABLES -N Cid591842X26049.0 -t mangle
-    $IPTABLES -t mangle -A PREROUTING -i eth0   -m state --state NEW  -j Cid591842X26049.0
+    $IPTABLES -t mangle -A PREROUTING -i eth0   -m conntrack --ctstate NEW  -j Cid591842X26049.0
     $IPTABLES -t mangle -A Cid591842X26049.0  -s 192.168.1.0/24   -j RETURN
     $IPTABLES -t mangle -A Cid591842X26049.0  -s 192.168.2.0/24   -j RETURN
     $IPTABLES -t mangle -A Cid591842X26049.0  -j MARK --set-mark 2
     $IPTABLES -N Cid591842X26049.1 -t mangle
-    $IPTABLES -t mangle -A POSTROUTING -i eth0   -m state --state NEW  -j Cid591842X26049.1
+    $IPTABLES -t mangle -A POSTROUTING -i eth0   -m conntrack --ctstate NEW  -j Cid591842X26049.1
     $IPTABLES -t mangle -A Cid591842X26049.1  -s 192.168.1.0/24   -j RETURN
     $IPTABLES -t mangle -A Cid591842X26049.1  -s 192.168.2.0/24   -j RETURN
     $IPTABLES -t mangle -A Cid591842X26049.1  -j CLASSIFY --set-class 1:2
@@ -430,12 +430,12 @@ script_body() {
     echo "Rule 10 (eth0)"
     # 
     $IPTABLES -N Cid591786X26049.0 -t mangle
-    $IPTABLES -t mangle -A PREROUTING -i eth0   -m state --state NEW  -j Cid591786X26049.0
+    $IPTABLES -t mangle -A PREROUTING -i eth0   -m conntrack --ctstate NEW  -j Cid591786X26049.0
     $IPTABLES -t mangle -A Cid591786X26049.0  -s 192.168.1.0/24   -j RETURN
     $IPTABLES -t mangle -A Cid591786X26049.0  -s 192.168.2.0/24   -j RETURN
     $IPTABLES -t mangle -A Cid591786X26049.0  -j MARK --set-mark 2
     $IPTABLES -N Cid591786X26049.1 -t mangle
-    $IPTABLES -t mangle -A POSTROUTING -i eth0   -m state --state NEW  -j Cid591786X26049.1
+    $IPTABLES -t mangle -A POSTROUTING -i eth0   -m conntrack --ctstate NEW  -j Cid591786X26049.1
     $IPTABLES -t mangle -A Cid591786X26049.1  -s 192.168.1.0/24   -j RETURN
     $IPTABLES -t mangle -A Cid591786X26049.1  -s 192.168.2.0/24   -j RETURN
     $IPTABLES -t mangle -A Cid591786X26049.1  -j CLASSIFY --set-class 1:2
@@ -473,11 +473,11 @@ script_body() {
     echo "Rule 13 (eth0)"
     # 
     $IPTABLES -N Cid994873X26049.0 -t mangle
-    $IPTABLES -t mangle -A PREROUTING -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j Cid994873X26049.0
+    $IPTABLES -t mangle -A PREROUTING -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid994873X26049.0
     $IPTABLES -t mangle -A Cid994873X26049.0 -p icmp  -m icmp  --icmp-type 8/0   -j MARK --set-mark 2
     $IPTABLES -t mangle -A Cid994873X26049.0 -p tcp -m tcp  --dport 80  -j MARK --set-mark 2
     $IPTABLES -N Cid994873X26049.1 -t mangle
-    $IPTABLES -t mangle -A POSTROUTING -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j Cid994873X26049.1
+    $IPTABLES -t mangle -A POSTROUTING -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid994873X26049.1
     $IPTABLES -t mangle -A Cid994873X26049.1 -p icmp  -m icmp  --icmp-type 8/0   -j CLASSIFY --set-class 1:2
     $IPTABLES -t mangle -A Cid994873X26049.1 -p tcp -m tcp  --dport 80  -j CLASSIFY --set-class 1:2
     # 
@@ -486,11 +486,11 @@ script_body() {
     echo "Rule 14 (eth0)"
     # 
     $IPTABLES -N Cid994817X26049.0 -t mangle
-    $IPTABLES -t mangle -A PREROUTING -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j Cid994817X26049.0
+    $IPTABLES -t mangle -A PREROUTING -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid994817X26049.0
     $IPTABLES -t mangle -A Cid994817X26049.0 -p icmp  -m icmp  --icmp-type 8/0   -j MARK --set-mark 2
     $IPTABLES -t mangle -A Cid994817X26049.0 -p tcp -m tcp  --dport 80  -j MARK --set-mark 2
     $IPTABLES -N Cid994817X26049.1 -t mangle
-    $IPTABLES -t mangle -A POSTROUTING -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j Cid994817X26049.1
+    $IPTABLES -t mangle -A POSTROUTING -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid994817X26049.1
     $IPTABLES -t mangle -A Cid994817X26049.1 -p icmp  -m icmp  --icmp-type 8/0   -j CLASSIFY --set-class 1:2
     $IPTABLES -t mangle -A Cid994817X26049.1 -p tcp -m tcp  --dport 80  -j CLASSIFY --set-class 1:2
     # 
@@ -545,8 +545,8 @@ script_body() {
     # 
     echo "Rule 1 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (eth0)
     # 
@@ -559,8 +559,8 @@ script_body() {
     # 
     echo "Rule 5 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0   -s ! 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth0   -s ! 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0   -s ! 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth0   -s ! 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 7 (eth0)
     # 
@@ -574,8 +574,8 @@ script_body() {
     echo "Rule 9 (eth0)"
     # 
     $IPTABLES -N Cid591842X26049.0
-    $IPTABLES -A INPUT -i eth0   -m state --state NEW  -j Cid591842X26049.0
-    $IPTABLES -A FORWARD -i eth0   -m state --state NEW  -j Cid591842X26049.0
+    $IPTABLES -A INPUT -i eth0   -m conntrack --ctstate NEW  -j Cid591842X26049.0
+    $IPTABLES -A FORWARD -i eth0   -m conntrack --ctstate NEW  -j Cid591842X26049.0
     $IPTABLES -A Cid591842X26049.0  -s 192.168.1.0/24   -j RETURN
     $IPTABLES -A Cid591842X26049.0  -s 192.168.2.0/24   -j RETURN
     $IPTABLES -A Cid591842X26049.0  -j ACCEPT
@@ -596,11 +596,11 @@ script_body() {
     echo "Rule 13 (eth0)"
     # 
     $IPTABLES -N Cid994873X26049.0
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j Cid994873X26049.0
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid994873X26049.0
     $IPTABLES -A Cid994873X26049.0 -p icmp  -m icmp  --icmp-type 8/0   -j ACCEPT
     $IPTABLES -A Cid994873X26049.0 -p tcp -m tcp  --dport 80  -j ACCEPT
     $IPTABLES -N Cid994873X26049.1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j Cid994873X26049.1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid994873X26049.1
     $IPTABLES -A Cid994873X26049.1 -p icmp  -m icmp  --icmp-type 8/0   -j ACCEPT
     $IPTABLES -A Cid994873X26049.1 -p tcp -m tcp  --dport 80  -j ACCEPT
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall37.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall37.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall37.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall37.fw.orig	2014-07-08 16:51:10.608004465 +0200
@@ -324,9 +324,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
     # ================ Table 'mangle', automatic rules
     $IPTABLES -t mangle -A PREROUTING -j CONNMARK --restore-mark
     $IPTABLES -t mangle -A OUTPUT -j CONNMARK --restore-mark
@@ -351,60 +351,60 @@ script_body() {
     echo "Rule mymark 0 (global)"
     # 
     $IPTABLES -N mymark -t mangle
-    $IPTABLES -t mangle -A mymark  -d 192.168.2.0/24   -m state --state NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A mymark  -d 192.168.2.0/24   -m conntrack --ctstate NEW  -j MARK --set-mark 16
     # 
     # Rule mymark 1 (global)
     # 
     echo "Rule mymark 1 (global)"
     # 
-    $IPTABLES -t mangle -A mymark  -m state --state NEW  -j MARK --set-mark 2
+    $IPTABLES -t mangle -A mymark  -m conntrack --ctstate NEW  -j MARK --set-mark 2
     # ================ Table 'mangle', rule set Policy
     # 
     # Rule 0 (global)
     # 
     echo "Rule 0 (global)"
     # 
-    $IPTABLES -t mangle -A OUTPUT -p 50  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A OUTPUT -p ah  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A PREROUTING -p 50  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A PREROUTING -p ah  -m state --state NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A PREROUTING -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A PREROUTING -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16
     # 
     # Rule 1 (global)
     # 
     echo "Rule 1 (global)"
     # 
-    $IPTABLES -t mangle -A OUTPUT -p 50  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A OUTPUT -p ah  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A PREROUTING -p 50  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A PREROUTING -p ah  -m state --state NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A PREROUTING -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A PREROUTING -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16
     # 
     # Rule 2 (global)
     # 
     echo "Rule 2 (global)"
     # 
-    $IPTABLES -t mangle -A OUTPUT -p 50  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A OUTPUT -p ah  -m state --state NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16
     # 
     # Rule 3 (eth1)
     # 
     echo "Rule 3 (eth1)"
     # 
-    $IPTABLES -t mangle -A OUTPUT -o eth1  -p 50  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A OUTPUT -o eth1  -p ah  -m state --state NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -o eth1  -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -o eth1  -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16
     # 
     # Rule 4 (global)
     # 
     echo "Rule 4 (global)"
     # 
-    $IPTABLES -t mangle -A OUTPUT -p 50  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A OUTPUT -p ah  -m state --state NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16
     # 
     # Rule 5 (eth1)
     # 
     echo "Rule 5 (eth1)"
     # 
     $IPTABLES -N Cid43501X5007.0 -t mangle
-    $IPTABLES -t mangle -A OUTPUT -o eth1   -s 22.22.23.22   -m state --state NEW  -j Cid43501X5007.0
+    $IPTABLES -t mangle -A OUTPUT -o eth1   -s 22.22.23.22   -m conntrack --ctstate NEW  -j Cid43501X5007.0
     $IPTABLES -t mangle -A Cid43501X5007.0 -p 50  -j MARK --set-mark 16
     $IPTABLES -t mangle -A Cid43501X5007.0 -p ah  -j MARK --set-mark 16
     # 
@@ -413,7 +413,7 @@ script_body() {
     echo "Rule 6 (eth1)"
     # 
     $IPTABLES -N Cid43518X5007.0 -t mangle
-    $IPTABLES -t mangle -A OUTPUT -o eth1   -s 22.22.23.22   -m state --state NEW  -j Cid43518X5007.0
+    $IPTABLES -t mangle -A OUTPUT -o eth1   -s 22.22.23.22   -m conntrack --ctstate NEW  -j Cid43518X5007.0
     $IPTABLES -t mangle -A Cid43518X5007.0 -p 50  -j MARK --set-mark 16
     $IPTABLES -t mangle -A Cid43518X5007.0 -p ah  -j MARK --set-mark 16
     # 
@@ -421,8 +421,8 @@ script_body() {
     # 
     echo "Rule 7 (eth1)"
     # 
-    $IPTABLES -t mangle -A OUTPUT -o eth1  -p 50  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A OUTPUT -o eth1  -p ah  -m state --state NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -o eth1  -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -o eth1  -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16
     # 
     # Rule 8 (eth1)
     # 
@@ -454,10 +454,10 @@ script_body() {
     echo "Rule 11 (global)"
     # 
     $IPTABLES -N Cid43BBCC139745.0 -t mangle
-    $IPTABLES -t mangle -A OUTPUT -p 50  -m state --state NEW  -j Cid43BBCC139745.0
-    $IPTABLES -t mangle -A OUTPUT -p ah  -m state --state NEW  -j Cid43BBCC139745.0
-    $IPTABLES -t mangle -A PREROUTING -p 50  -m state --state NEW  -j Cid43BBCC139745.0
-    $IPTABLES -t mangle -A PREROUTING -p ah  -m state --state NEW  -j Cid43BBCC139745.0
+    $IPTABLES -t mangle -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j Cid43BBCC139745.0
+    $IPTABLES -t mangle -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j Cid43BBCC139745.0
+    $IPTABLES -t mangle -A PREROUTING -p 50  -m conntrack --ctstate NEW  -j Cid43BBCC139745.0
+    $IPTABLES -t mangle -A PREROUTING -p ah  -m conntrack --ctstate NEW  -j Cid43BBCC139745.0
     $IPTABLES -t mangle -A Cid43BBCC139745.0  -s 192.168.1.0/24   -j RETURN
     $IPTABLES -t mangle -A Cid43BBCC139745.0  -s 192.168.2.0/24   -j RETURN
     $IPTABLES -t mangle -A Cid43BBCC139745.0  -j MARK --set-mark 16
@@ -466,56 +466,56 @@ script_body() {
     # 
     echo "Rule 12 (eth1)"
     # 
-    $IPTABLES -t mangle -A PREROUTING -i eth1  -p 50  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A PREROUTING -i eth1  -p ah  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A OUTPUT -o eth1  -p 50  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A OUTPUT -o eth1  -p ah  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p 50  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p ah  -m state --state NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A PREROUTING -i eth1  -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A PREROUTING -i eth1  -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -o eth1  -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -o eth1  -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16
     # 
     # Rule 13 (eth1)
     # 
     echo "Rule 13 (eth1)"
     # 
-    $IPTABLES -t mangle -A PREROUTING -i eth1  -p 50  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A PREROUTING -i eth1  -p ah  -m state --state NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A PREROUTING -i eth1  -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A PREROUTING -i eth1  -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16
     # 
     # Rule 14 (eth1)
     # 
     echo "Rule 14 (eth1)"
     # 
-    $IPTABLES -t mangle -A OUTPUT -o eth1  -p 50  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A OUTPUT -o eth1  -p ah  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p 50  -m state --state NEW  -j MARK --set-mark 16
-    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p ah  -m state --state NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -o eth1  -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A OUTPUT -o eth1  -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16
+    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16
     # 
     # Rule 15 (global)
     # 
     echo "Rule 15 (global)"
     # 
     # using CONNMARK
-    $IPTABLES -t mangle -A OUTPUT -p 50  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A OUTPUT -p ah  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A PREROUTING -p 50  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A PREROUTING -p ah  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A OUTPUT -p 50  -m state --state NEW  -j CONNMARK --save-mark
-    $IPTABLES -t mangle -A OUTPUT -p ah  -m state --state NEW  -j CONNMARK --save-mark
-    $IPTABLES -t mangle -A PREROUTING -p 50  -m state --state NEW  -j CONNMARK --save-mark
-    $IPTABLES -t mangle -A PREROUTING -p ah  -m state --state NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A PREROUTING -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A PREROUTING -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A PREROUTING -p 50  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A PREROUTING -p ah  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
     # 
     # Rule 16 (global)
     # 
     echo "Rule 16 (global)"
     # 
     # using CONNMARK
-    $IPTABLES -t mangle -A OUTPUT -p 50  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A OUTPUT -p ah  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A PREROUTING -p 50  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A PREROUTING -p ah  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A OUTPUT -p 50  -m state --state NEW  -j CONNMARK --save-mark
-    $IPTABLES -t mangle -A OUTPUT -p ah  -m state --state NEW  -j CONNMARK --save-mark
-    $IPTABLES -t mangle -A PREROUTING -p 50  -m state --state NEW  -j CONNMARK --save-mark
-    $IPTABLES -t mangle -A PREROUTING -p ah  -m state --state NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A PREROUTING -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A PREROUTING -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A PREROUTING -p 50  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A PREROUTING -p ah  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
     # 
     # Rule 17 (global)
     # 
@@ -523,10 +523,10 @@ script_body() {
     # 
     # using CONNMARK
     $IPTABLES -N Cid4483A4DF1810.0 -t mangle
-    $IPTABLES -t mangle -A OUTPUT -p 50  -m state --state NEW  -j Cid4483A4DF1810.0
-    $IPTABLES -t mangle -A OUTPUT -p ah  -m state --state NEW  -j Cid4483A4DF1810.0
-    $IPTABLES -t mangle -A PREROUTING -p 50  -m state --state NEW  -j Cid4483A4DF1810.0
-    $IPTABLES -t mangle -A PREROUTING -p ah  -m state --state NEW  -j Cid4483A4DF1810.0
+    $IPTABLES -t mangle -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j Cid4483A4DF1810.0
+    $IPTABLES -t mangle -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j Cid4483A4DF1810.0
+    $IPTABLES -t mangle -A PREROUTING -p 50  -m conntrack --ctstate NEW  -j Cid4483A4DF1810.0
+    $IPTABLES -t mangle -A PREROUTING -p ah  -m conntrack --ctstate NEW  -j Cid4483A4DF1810.0
     $IPTABLES -t mangle -A Cid4483A4DF1810.0  -s 192.168.1.0/24   -j RETURN
     $IPTABLES -t mangle -A Cid4483A4DF1810.0  -s 192.168.2.0/24   -j RETURN
     $IPTABLES -t mangle -A Cid4483A4DF1810.0  -j MARK --set-mark 10
@@ -537,24 +537,24 @@ script_body() {
     echo "Rule 18 (eth1)"
     # 
     # using CONNMARK
-    $IPTABLES -t mangle -A PREROUTING -i eth1  -p 50  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A PREROUTING -i eth1  -p ah  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A PREROUTING -i eth1  -p 50  -m state --state NEW  -j CONNMARK --save-mark
-    $IPTABLES -t mangle -A PREROUTING -i eth1  -p ah  -m state --state NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A PREROUTING -i eth1  -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A PREROUTING -i eth1  -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A PREROUTING -i eth1  -p 50  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A PREROUTING -i eth1  -p ah  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
     # 
     # Rule 19 (eth1)
     # 
     echo "Rule 19 (eth1)"
     # 
     # using CONNMARK
-    $IPTABLES -t mangle -A OUTPUT -o eth1  -p 50  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A OUTPUT -o eth1  -p ah  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p 50  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p ah  -m state --state NEW  -j MARK --set-mark 10
-    $IPTABLES -t mangle -A OUTPUT -o eth1  -p 50  -m state --state NEW  -j CONNMARK --save-mark
-    $IPTABLES -t mangle -A OUTPUT -o eth1  -p ah  -m state --state NEW  -j CONNMARK --save-mark
-    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p 50  -m state --state NEW  -j CONNMARK --save-mark
-    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p ah  -m state --state NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A OUTPUT -o eth1  -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A OUTPUT -o eth1  -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 10
+    $IPTABLES -t mangle -A OUTPUT -o eth1  -p 50  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A OUTPUT -o eth1  -p ah  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p 50  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A POSTROUTING -o eth1  -p ah  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
     # 
     # Rule 22 (global)
     # 
@@ -684,18 +684,18 @@ script_body() {
     # 
     echo "Rule mangle_rules 0 (global)"
     # 
-    $IPTABLES -t mangle -A OUTPUT -m mark ! --mark 0  -m state --state NEW  -j ACCEPT
-    $IPTABLES -t mangle -A INPUT -m mark ! --mark 0  -m state --state NEW  -j ACCEPT
-    $IPTABLES -t mangle -A PREROUTING -m mark ! --mark 0  -m state --state NEW  -j ACCEPT
+    $IPTABLES -t mangle -A OUTPUT -m mark ! --mark 0  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -t mangle -A INPUT -m mark ! --mark 0  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -t mangle -A PREROUTING -m mark ! --mark 0  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule mangle_rules 1 (global)
     # 
     echo "Rule mangle_rules 1 (global)"
     # 
-    $IPTABLES -t mangle -A OUTPUT -p tcp -m tcp  --dport 80  -m state --state NEW  -j MARK --set-mark 1
-    $IPTABLES -t mangle -A PREROUTING -p tcp -m tcp  --dport 80  -m state --state NEW  -j MARK --set-mark 1
-    $IPTABLES -t mangle -A OUTPUT -p tcp -m tcp  --dport 80  -m state --state NEW  -j CONNMARK --save-mark
-    $IPTABLES -t mangle -A PREROUTING -p tcp -m tcp  --dport 80  -m state --state NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A OUTPUT -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j MARK --set-mark 1
+    $IPTABLES -t mangle -A PREROUTING -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j MARK --set-mark 1
+    $IPTABLES -t mangle -A OUTPUT -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A PREROUTING -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j CONNMARK --save-mark
     # 
     # Rule mangle_rules 2 (global)
     # 
@@ -707,26 +707,26 @@ script_body() {
     # 
     echo "Rule mangle_rules 4 (global)"
     # 
-    $IPTABLES -t mangle -A INPUT  -s 72.55.148.116  -m mark --mark 1  -m state --state NEW  -j ACCEPT
-    $IPTABLES -t mangle -A PREROUTING  -s 72.55.148.116  -m mark --mark 1  -m state --state NEW  -j ACCEPT
+    $IPTABLES -t mangle -A INPUT  -s 72.55.148.116  -m mark --mark 1  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -t mangle -A PREROUTING  -s 72.55.148.116  -m mark --mark 1  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule mangle_rules 5 (global)
     # 
     echo "Rule mangle_rules 5 (global)"
     # 
-    $IPTABLES -t mangle -A INPUT  -s 6bone.net -m mark --mark 1  -m state --state NEW  -j ACCEPT
-    $IPTABLES -t mangle -A PREROUTING  -s 6bone.net -m mark --mark 1  -m state --state NEW  -j ACCEPT
+    $IPTABLES -t mangle -A INPUT  -s 6bone.net -m mark --mark 1  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -t mangle -A PREROUTING  -s 6bone.net -m mark --mark 1  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule mangle_rules 6 (global)
     # 
     echo "Rule mangle_rules 6 (global)"
     # 
     $IPTABLES -N Cid122277X13558.0 -t mangle
-    $IPTABLES -t mangle -A INPUT -m mark --mark 1  -m state --state NEW  -j Cid122277X13558.0
+    $IPTABLES -t mangle -A INPUT -m mark --mark 1  -m conntrack --ctstate NEW  -j Cid122277X13558.0
     $IPTABLES -t mangle -A Cid122277X13558.0  -s 6bone.net  -j ACCEPT
     $IPTABLES -t mangle -A Cid122277X13558.0  -s ny6ix.net  -j ACCEPT
     $IPTABLES -N Cid122277X13558.1 -t mangle
-    $IPTABLES -t mangle -A PREROUTING -m mark --mark 1  -m state --state NEW  -j Cid122277X13558.1
+    $IPTABLES -t mangle -A PREROUTING -m mark --mark 1  -m conntrack --ctstate NEW  -j Cid122277X13558.1
     $IPTABLES -t mangle -A Cid122277X13558.1  -s 6bone.net  -j ACCEPT
     $IPTABLES -t mangle -A Cid122277X13558.1  -s ny6ix.net  -j ACCEPT
     # 
@@ -734,43 +734,43 @@ script_body() {
     # 
     echo "Rule mangle_rules 8 (global)"
     # 
-    $IPTABLES -t mangle -A OUTPUT -m mark --mark 1  -m state --state NEW  -j ACCEPT
+    $IPTABLES -t mangle -A OUTPUT -m mark --mark 1  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule mangle_rules 9 (global)
     # 
     echo "Rule mangle_rules 9 (global)"
     # 
-    $IPTABLES -t mangle -A OUTPUT  -s 22.22.23.22  -m mark --mark 1  -m state --state NEW  -j ACCEPT
+    $IPTABLES -t mangle -A OUTPUT  -s 22.22.23.22  -m mark --mark 1  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule mangle_rules 10 (global)
     # 
     echo "Rule mangle_rules 10 (global)"
     # 
     $IPTABLES -N Cid207332X13558.0 -t mangle
-    $IPTABLES -t mangle -A OUTPUT -m mark --mark 1  -m state --state NEW  -j Cid207332X13558.0
+    $IPTABLES -t mangle -A OUTPUT -m mark --mark 1  -m conntrack --ctstate NEW  -j Cid207332X13558.0
     $IPTABLES -t mangle -A Cid207332X13558.0  -d 22.22.23.22   -j ACCEPT
     $IPTABLES -t mangle -A Cid207332X13558.0  -d 192.168.1.22   -j ACCEPT
     $IPTABLES -t mangle -A Cid207332X13558.0  -d 192.168.2.1   -j ACCEPT
-    $IPTABLES -t mangle -A INPUT -m mark --mark 1  -m state --state NEW  -j ACCEPT
+    $IPTABLES -t mangle -A INPUT -m mark --mark 1  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule mangle_rules 11 (global)
     # 
     echo "Rule mangle_rules 11 (global)"
     # 
-    $IPTABLES -t mangle -A PREROUTING -i +   -s ! 192.168.1.0/24  -m mark --mark 1  -m state --state NEW  -j ACCEPT
+    $IPTABLES -t mangle -A PREROUTING -i +   -s ! 192.168.1.0/24  -m mark --mark 1  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule mangle_rules 12 (global)
     # 
     echo "Rule mangle_rules 12 (global)"
     # 
-    $IPTABLES -t mangle -A PREROUTING -i +   -s ! 1.1.1.1  -m mark --mark 1  -m state --state NEW  -j ACCEPT
+    $IPTABLES -t mangle -A PREROUTING -i +   -s ! 1.1.1.1  -m mark --mark 1  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule mangle_rules 13 (global)
     # 
     echo "Rule mangle_rules 13 (global)"
     # 
     $IPTABLES -N Cid480281X13558.0 -t mangle
-    $IPTABLES -t mangle -A PREROUTING -i +  -m mark --mark 1  -m state --state NEW  -j Cid480281X13558.0
+    $IPTABLES -t mangle -A PREROUTING -i +  -m mark --mark 1  -m conntrack --ctstate NEW  -j Cid480281X13558.0
     $IPTABLES -t mangle -A Cid480281X13558.0  -s 72.55.148.116   -j RETURN
     $IPTABLES -t mangle -A Cid480281X13558.0  -j ACCEPT
     # 
@@ -779,7 +779,7 @@ script_body() {
     echo "Rule mangle_rules 14 (global)"
     # 
     $IPTABLES -N Cid480300X13558.0 -t mangle
-    $IPTABLES -t mangle -A PREROUTING -i +  -m mark --mark 1  -m state --state NEW  -j Cid480300X13558.0
+    $IPTABLES -t mangle -A PREROUTING -i +  -m mark --mark 1  -m conntrack --ctstate NEW  -j Cid480300X13558.0
     $IPTABLES -t mangle -A Cid480300X13558.0  -s 6bone.net  -j RETURN
     $IPTABLES -t mangle -A Cid480300X13558.0  -j ACCEPT
     # 
@@ -796,7 +796,7 @@ script_body() {
     # that such rule should be placed in
     # POSTROUTING.
     $IPTABLES -N Cid43052X80179.0 -t mangle
-    $IPTABLES -t mangle -A POSTROUTING -o +  -m mark --mark 1  -m state --state NEW  -j Cid43052X80179.0
+    $IPTABLES -t mangle -A POSTROUTING -o +  -m mark --mark 1  -m conntrack --ctstate NEW  -j Cid43052X80179.0
     $IPTABLES -t mangle -A Cid43052X80179.0  -s 6bone.net  -j ACCEPT
     $IPTABLES -t mangle -A Cid43052X80179.0  -s ny6ix.net  -j ACCEPT
 
@@ -807,37 +807,37 @@ script_body() {
     echo "Rule mymark 0 (global)"
     # 
     $IPTABLES -N mymark
-    $IPTABLES -A mymark  -d 192.168.2.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A mymark  -d 192.168.2.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule mymark 1 (global)
     # 
     echo "Rule mymark 1 (global)"
     # 
-    $IPTABLES -A mymark  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A mymark  -m conntrack --ctstate NEW  -j ACCEPT
     # ================ Table 'filter', rule set Policy
     # 
     # Rule 0 (global)
     # 
     echo "Rule 0 (global)"
     # 
-    $IPTABLES -A OUTPUT -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p ah  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p ah  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p ah  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p ah  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p ah  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (global)
     # 
     echo "Rule 1 (global)"
     # 
     $IPTABLES -N RULE_1
-    $IPTABLES -A OUTPUT -p 50  -m state --state NEW  -j RULE_1
-    $IPTABLES -A OUTPUT -p ah  -m state --state NEW  -j RULE_1
-    $IPTABLES -A INPUT -p 50  -m state --state NEW  -j RULE_1
-    $IPTABLES -A INPUT -p ah  -m state --state NEW  -j RULE_1
-    $IPTABLES -A FORWARD -p 50  -m state --state NEW  -j RULE_1
-    $IPTABLES -A FORWARD -p ah  -m state --state NEW  -j RULE_1
+    $IPTABLES -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j RULE_1
+    $IPTABLES -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j RULE_1
+    $IPTABLES -A INPUT -p 50  -m conntrack --ctstate NEW  -j RULE_1
+    $IPTABLES -A INPUT -p ah  -m conntrack --ctstate NEW  -j RULE_1
+    $IPTABLES -A FORWARD -p 50  -m conntrack --ctstate NEW  -j RULE_1
+    $IPTABLES -A FORWARD -p ah  -m conntrack --ctstate NEW  -j RULE_1
     $IPTABLES -A RULE_1  -j LOG  --log-level info --log-prefix "RULE 1 -- ACCEPT "
     $IPTABLES -A RULE_1  -j ACCEPT
     # 
@@ -846,34 +846,34 @@ script_body() {
     echo "Rule 2 (global)"
     # 
     $IPTABLES -N Cid483502D710047.0
-    $IPTABLES -A INPUT -p 50  -m state --state NEW  -j Cid483502D710047.0
-    $IPTABLES -A INPUT -p ah  -m state --state NEW  -j Cid483502D710047.0
+    $IPTABLES -A INPUT -p 50  -m conntrack --ctstate NEW  -j Cid483502D710047.0
+    $IPTABLES -A INPUT -p ah  -m conntrack --ctstate NEW  -j Cid483502D710047.0
     $IPTABLES -A Cid483502D710047.0  -s 22.22.23.22   -j ACCEPT
     $IPTABLES -A Cid483502D710047.0  -s 192.168.1.22   -j ACCEPT
     $IPTABLES -A Cid483502D710047.0  -s 192.168.2.1   -j ACCEPT
-    $IPTABLES -A OUTPUT -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p ah  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (eth1)
     # 
     echo "Rule 3 (eth1)"
     # 
-    $IPTABLES -A OUTPUT -o eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth1  -p ah  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
     echo "Rule 4 (global)"
     # 
     $IPTABLES -N Cid483502E810047.0
-    $IPTABLES -A INPUT -p 50  -m state --state NEW  -j Cid483502E810047.0
-    $IPTABLES -A INPUT -p ah  -m state --state NEW  -j Cid483502E810047.0
+    $IPTABLES -A INPUT -p 50  -m conntrack --ctstate NEW  -j Cid483502E810047.0
+    $IPTABLES -A INPUT -p ah  -m conntrack --ctstate NEW  -j Cid483502E810047.0
     $IPTABLES -N RULE_4
     $IPTABLES -A Cid483502E810047.0  -s 22.22.23.22   -j RULE_4
     $IPTABLES -A Cid483502E810047.0  -s 192.168.1.22   -j RULE_4
     $IPTABLES -A Cid483502E810047.0  -s 192.168.2.1   -j RULE_4
-    $IPTABLES -A OUTPUT -p 50  -m state --state NEW  -j RULE_4
-    $IPTABLES -A OUTPUT -p ah  -m state --state NEW  -j RULE_4
+    $IPTABLES -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j RULE_4
+    $IPTABLES -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j RULE_4
     $IPTABLES -A RULE_4  -j LOG  --log-level info --log-prefix "RULE 4 -- ACCEPT "
     $IPTABLES -A RULE_4  -j ACCEPT
     # 
@@ -882,7 +882,7 @@ script_body() {
     echo "Rule 5 (eth1)"
     # 
     $IPTABLES -N Cid43501X5007.0
-    $IPTABLES -A OUTPUT -o eth1   -s 22.22.23.22   -m state --state NEW  -j Cid43501X5007.0
+    $IPTABLES -A OUTPUT -o eth1   -s 22.22.23.22   -m conntrack --ctstate NEW  -j Cid43501X5007.0
     $IPTABLES -A Cid43501X5007.0 -p 50  -j ACCEPT
     $IPTABLES -A Cid43501X5007.0 -p ah  -j ACCEPT
     # 
@@ -891,7 +891,7 @@ script_body() {
     echo "Rule 6 (eth1)"
     # 
     $IPTABLES -N Cid43518X5007.0
-    $IPTABLES -A OUTPUT -o eth1   -s 22.22.23.22   -m state --state NEW  -j Cid43518X5007.0
+    $IPTABLES -A OUTPUT -o eth1   -s 22.22.23.22   -m conntrack --ctstate NEW  -j Cid43518X5007.0
     $IPTABLES -A Cid43518X5007.0 -p 50  -j ACCEPT
     $IPTABLES -A Cid43518X5007.0 -p ah  -j ACCEPT
     # 
@@ -899,8 +899,8 @@ script_body() {
     # 
     echo "Rule 7 (eth1)"
     # 
-    $IPTABLES -A OUTPUT -o eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth1  -p ah  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 8 (eth1)
     # 
@@ -932,12 +932,12 @@ script_body() {
     echo "Rule 11 (global)"
     # 
     $IPTABLES -N Cid43BBCC139745.0
-    $IPTABLES -A OUTPUT -p 50  -m state --state NEW  -j Cid43BBCC139745.0
-    $IPTABLES -A OUTPUT -p ah  -m state --state NEW  -j Cid43BBCC139745.0
-    $IPTABLES -A INPUT -p 50  -m state --state NEW  -j Cid43BBCC139745.0
-    $IPTABLES -A INPUT -p ah  -m state --state NEW  -j Cid43BBCC139745.0
-    $IPTABLES -A FORWARD -p 50  -m state --state NEW  -j Cid43BBCC139745.0
-    $IPTABLES -A FORWARD -p ah  -m state --state NEW  -j Cid43BBCC139745.0
+    $IPTABLES -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j Cid43BBCC139745.0
+    $IPTABLES -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j Cid43BBCC139745.0
+    $IPTABLES -A INPUT -p 50  -m conntrack --ctstate NEW  -j Cid43BBCC139745.0
+    $IPTABLES -A INPUT -p ah  -m conntrack --ctstate NEW  -j Cid43BBCC139745.0
+    $IPTABLES -A FORWARD -p 50  -m conntrack --ctstate NEW  -j Cid43BBCC139745.0
+    $IPTABLES -A FORWARD -p ah  -m conntrack --ctstate NEW  -j Cid43BBCC139745.0
     $IPTABLES -A Cid43BBCC139745.0  -s 192.168.1.0/24   -j RETURN
     $IPTABLES -A Cid43BBCC139745.0  -s 192.168.2.0/24   -j RETURN
     $IPTABLES -N RULE_11_3
@@ -949,44 +949,44 @@ script_body() {
     # 
     echo "Rule 12 (eth1)"
     # 
-    $IPTABLES -A INPUT -i eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth1  -p ah  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth1  -p ah  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth1  -p ah  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth1  -p ah  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 13 (eth1)
     # 
     echo "Rule 13 (eth1)"
     # 
-    $IPTABLES -A INPUT -i eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth1  -p ah  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth1  -p ah  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 14 (eth1)
     # 
     echo "Rule 14 (eth1)"
     # 
-    $IPTABLES -A OUTPUT -o eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth1  -p ah  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth1  -p ah  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 15 (global)
     # 
     echo "Rule 15 (global)"
     # 
     # using CONNMARK
-    $IPTABLES -A OUTPUT -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p ah  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p ah  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p ah  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p ah  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p ah  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 16 (global)
     # 
@@ -994,12 +994,12 @@ script_body() {
     # 
     # using CONNMARK
     $IPTABLES -N RULE_16
-    $IPTABLES -A OUTPUT -p 50  -m state --state NEW  -j RULE_16
-    $IPTABLES -A OUTPUT -p ah  -m state --state NEW  -j RULE_16
-    $IPTABLES -A INPUT -p 50  -m state --state NEW  -j RULE_16
-    $IPTABLES -A INPUT -p ah  -m state --state NEW  -j RULE_16
-    $IPTABLES -A FORWARD -p 50  -m state --state NEW  -j RULE_16
-    $IPTABLES -A FORWARD -p ah  -m state --state NEW  -j RULE_16
+    $IPTABLES -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j RULE_16
+    $IPTABLES -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j RULE_16
+    $IPTABLES -A INPUT -p 50  -m conntrack --ctstate NEW  -j RULE_16
+    $IPTABLES -A INPUT -p ah  -m conntrack --ctstate NEW  -j RULE_16
+    $IPTABLES -A FORWARD -p 50  -m conntrack --ctstate NEW  -j RULE_16
+    $IPTABLES -A FORWARD -p ah  -m conntrack --ctstate NEW  -j RULE_16
     $IPTABLES -A RULE_16  -j LOG  --log-level info --log-prefix "RULE 16 -- ACCEPT "
     $IPTABLES -A RULE_16  -j ACCEPT
     # 
@@ -1009,12 +1009,12 @@ script_body() {
     # 
     # using CONNMARK
     $IPTABLES -N Cid4483A4DF1810.0
-    $IPTABLES -A OUTPUT -p 50  -m state --state NEW  -j Cid4483A4DF1810.0
-    $IPTABLES -A OUTPUT -p ah  -m state --state NEW  -j Cid4483A4DF1810.0
-    $IPTABLES -A INPUT -p 50  -m state --state NEW  -j Cid4483A4DF1810.0
-    $IPTABLES -A INPUT -p ah  -m state --state NEW  -j Cid4483A4DF1810.0
-    $IPTABLES -A FORWARD -p 50  -m state --state NEW  -j Cid4483A4DF1810.0
-    $IPTABLES -A FORWARD -p ah  -m state --state NEW  -j Cid4483A4DF1810.0
+    $IPTABLES -A OUTPUT -p 50  -m conntrack --ctstate NEW  -j Cid4483A4DF1810.0
+    $IPTABLES -A OUTPUT -p ah  -m conntrack --ctstate NEW  -j Cid4483A4DF1810.0
+    $IPTABLES -A INPUT -p 50  -m conntrack --ctstate NEW  -j Cid4483A4DF1810.0
+    $IPTABLES -A INPUT -p ah  -m conntrack --ctstate NEW  -j Cid4483A4DF1810.0
+    $IPTABLES -A FORWARD -p 50  -m conntrack --ctstate NEW  -j Cid4483A4DF1810.0
+    $IPTABLES -A FORWARD -p ah  -m conntrack --ctstate NEW  -j Cid4483A4DF1810.0
     $IPTABLES -A Cid4483A4DF1810.0  -s 192.168.1.0/24   -j RETURN
     $IPTABLES -A Cid4483A4DF1810.0  -s 192.168.2.0/24   -j RETURN
     $IPTABLES -N RULE_17_3
@@ -1027,29 +1027,29 @@ script_body() {
     echo "Rule 18 (eth1)"
     # 
     # using CONNMARK
-    $IPTABLES -A INPUT -i eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth1  -p ah  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth1  -p ah  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 19 (eth1)
     # 
     echo "Rule 19 (eth1)"
     # 
     # using CONNMARK
-    $IPTABLES -A OUTPUT -o eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth1  -p ah  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth1  -p 50  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth1  -p ah  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth1  -p 50  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth1  -p ah  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 20 (global)
     # 
     echo "Rule 20 (global)"
     # 
     # tag 0 matches packet that has not been marked yet.
-    $IPTABLES -A OUTPUT -m mark ! --mark 0  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -m mark ! --mark 0  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -m mark ! --mark 0  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -m mark ! --mark 0  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -m mark ! --mark 0  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m mark ! --mark 0  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 21 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall38.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall38.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall38.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall38.fw.orig	2014-07-08 16:51:10.345007753 +0200
@@ -330,64 +330,64 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # ================ Table 'filter', rule set Policy
     # 
     # Rule  1 (global)
-    echo "-A OUTPUT -p 50  -m state --state NEW  -j LOG  --log-level info --log-prefix \"RULE 1 -- CONTINUE \""
-    echo "-A OUTPUT -p ah  -m state --state NEW  -j LOG  --log-level info --log-prefix \"RULE 1 -- CONTINUE \""
-    echo "-A INPUT -p 50  -m state --state NEW  -j LOG  --log-level info --log-prefix \"RULE 1 -- CONTINUE \""
-    echo "-A INPUT -p ah  -m state --state NEW  -j LOG  --log-level info --log-prefix \"RULE 1 -- CONTINUE \""
-    echo "-A FORWARD -p 50  -m state --state NEW  -j LOG  --log-level info --log-prefix \"RULE 1 -- CONTINUE \""
-    echo "-A FORWARD -p ah  -m state --state NEW  -j LOG  --log-level info --log-prefix \"RULE 1 -- CONTINUE \""
+    echo "-A OUTPUT -p 50  -m conntrack --ctstate NEW  -j LOG  --log-level info --log-prefix \"RULE 1 -- CONTINUE \""
+    echo "-A OUTPUT -p ah  -m conntrack --ctstate NEW  -j LOG  --log-level info --log-prefix \"RULE 1 -- CONTINUE \""
+    echo "-A INPUT -p 50  -m conntrack --ctstate NEW  -j LOG  --log-level info --log-prefix \"RULE 1 -- CONTINUE \""
+    echo "-A INPUT -p ah  -m conntrack --ctstate NEW  -j LOG  --log-level info --log-prefix \"RULE 1 -- CONTINUE \""
+    echo "-A FORWARD -p 50  -m conntrack --ctstate NEW  -j LOG  --log-level info --log-prefix \"RULE 1 -- CONTINUE \""
+    echo "-A FORWARD -p ah  -m conntrack --ctstate NEW  -j LOG  --log-level info --log-prefix \"RULE 1 -- CONTINUE \""
     # 
     # Rule  2 (global)
     echo ":Cid43BBF1AD9745.0 - [0:0]"
-    echo "-A OUTPUT  -s ! 192.168.1.0/24   -m state --state NEW  -j Cid43BBF1AD9745.0 "
+    echo "-A OUTPUT  -s ! 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid43BBF1AD9745.0 "
     echo "-A Cid43BBF1AD9745.0 -p 50  -j LOG  --log-level info --log-prefix \"RULE 2 -- CONTINUE \""
     echo "-A Cid43BBF1AD9745.0 -p ah  -j LOG  --log-level info --log-prefix \"RULE 2 -- CONTINUE \""
     echo ":Cid43BBF1AD9745.1 - [0:0]"
-    echo "-A INPUT  -s ! 192.168.1.0/24   -m state --state NEW  -j Cid43BBF1AD9745.1 "
+    echo "-A INPUT  -s ! 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid43BBF1AD9745.1 "
     echo "-A Cid43BBF1AD9745.1 -p 50  -j LOG  --log-level info --log-prefix \"RULE 2 -- CONTINUE \""
     echo "-A Cid43BBF1AD9745.1 -p ah  -j LOG  --log-level info --log-prefix \"RULE 2 -- CONTINUE \""
     echo ":Cid43BBF1AD9745.2 - [0:0]"
-    echo "-A OUTPUT  -s ! 192.168.1.0/24   -m state --state NEW  -j Cid43BBF1AD9745.2 "
+    echo "-A OUTPUT  -s ! 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid43BBF1AD9745.2 "
     echo "-A Cid43BBF1AD9745.2 -p 50  -j LOG  --log-level info --log-prefix \"RULE 2 -- CONTINUE \""
     echo "-A Cid43BBF1AD9745.2 -p ah  -j LOG  --log-level info --log-prefix \"RULE 2 -- CONTINUE \""
     echo ":Cid43BBF1AD9745.3 - [0:0]"
-    echo "-A FORWARD  -s ! 192.168.1.0/24   -m state --state NEW  -j Cid43BBF1AD9745.3 "
+    echo "-A FORWARD  -s ! 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid43BBF1AD9745.3 "
     echo "-A Cid43BBF1AD9745.3 -p 50  -j LOG  --log-level info --log-prefix \"RULE 2 -- CONTINUE \""
     echo "-A Cid43BBF1AD9745.3 -p ah  -j LOG  --log-level info --log-prefix \"RULE 2 -- CONTINUE \""
     # 
     # Rule  5 (global)
-    echo "-A INPUT -p tcp -m tcp  -s 22.22.23.22   --dport 80  -m state --state NEW  -j LOG  --log-level info --log-prefix \"RULE 5 -- CONTINUE \""
-    echo "-A OUTPUT -p tcp -m tcp  -s 22.22.23.22   --dport 80  -m state --state NEW  -j LOG  --log-level info --log-prefix \"RULE 5 -- CONTINUE \""
+    echo "-A INPUT -p tcp -m tcp  -s 22.22.23.22   --dport 80  -m conntrack --ctstate NEW  -j LOG  --log-level info --log-prefix \"RULE 5 -- CONTINUE \""
+    echo "-A OUTPUT -p tcp -m tcp  -s 22.22.23.22   --dport 80  -m conntrack --ctstate NEW  -j LOG  --log-level info --log-prefix \"RULE 5 -- CONTINUE \""
     # 
     # Rule  9 (global)
-    echo "-A OUTPUT -m mark --mark 16  -m state --state NEW  -j ACCEPT "
-    echo "-A INPUT -m mark --mark 16  -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD -m mark --mark 16  -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT -m mark --mark 16  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A INPUT -m mark --mark 16  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD -m mark --mark 16  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  10 (global)
-    echo "-A OUTPUT -m mark ! --mark 16  -m state --state NEW  -j ACCEPT "
-    echo "-A INPUT -m mark ! --mark 16  -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD -m mark ! --mark 16  -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT -m mark ! --mark 16  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A INPUT -m mark ! --mark 16  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD -m mark ! --mark 16  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  11 (global)
-    echo "-A OUTPUT -p tcp -m tcp  --dport 80  -m state --state NEW  -j ACCEPT "
-    echo "-A OUTPUT -m mark --mark 16  -m state --state NEW  -j ACCEPT "
-    echo "-A INPUT -p tcp -m tcp  --dport 80  -m state --state NEW  -j ACCEPT "
-    echo "-A INPUT -m mark --mark 16  -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD -p tcp -m tcp  --dport 80  -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD -m mark --mark 16  -m state --state NEW  -j ACCEPT "
+    echo "-A OUTPUT -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A OUTPUT -m mark --mark 16  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A INPUT -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A INPUT -m mark --mark 16  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD -m mark --mark 16  -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  12 (global)
     echo ":Cid43EC87C832486.0 - [0:0]"
-    echo "-A OUTPUT  -m state --state NEW  -j Cid43EC87C832486.0 "
-    echo "-A INPUT  -m state --state NEW  -j Cid43EC87C832486.0 "
-    echo "-A FORWARD  -m state --state NEW  -j Cid43EC87C832486.0 "
+    echo "-A OUTPUT  -m conntrack --ctstate NEW  -j Cid43EC87C832486.0 "
+    echo "-A INPUT  -m conntrack --ctstate NEW  -j Cid43EC87C832486.0 "
+    echo "-A FORWARD  -m conntrack --ctstate NEW  -j Cid43EC87C832486.0 "
     echo "-A Cid43EC87C832486.0 -p tcp -m tcp  --dport 80  -j RETURN "
     echo "-A Cid43EC87C832486.0 -m mark --mark 16  -j RETURN "
     echo "-A Cid43EC87C832486.0  -j ACCEPT "
@@ -397,9 +397,9 @@ script_body() {
     echo "-A FORWARD -p tcp -m tcp  -d 192.168.2.10   --dport 80  -j QUEUE "
     # 
     # Rule  14 (global)
-    echo "-A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT "
-    echo "-A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT "
-    echo "-A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT "
+    echo "-A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT "
+    echo "-A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT "
     # 
     # Rule  15 (global)
     echo ":RULE_15 - [0:0]"
@@ -418,50 +418,50 @@ script_body() {
     # ================ Table 'mangle', rule set Policy
     # 
     # Rule  0 (global)
-    echo "-A OUTPUT -p 50  -m state --state NEW  -j MARK --set-mark 16"
-    echo "-A OUTPUT -p ah  -m state --state NEW  -j MARK --set-mark 16"
-    echo "-A PREROUTING -p 50  -m state --state NEW  -j MARK --set-mark 16"
-    echo "-A PREROUTING -p ah  -m state --state NEW  -j MARK --set-mark 16"
+    echo "-A OUTPUT -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16"
+    echo "-A OUTPUT -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16"
+    echo "-A PREROUTING -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16"
+    echo "-A PREROUTING -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16"
     # 
     # Rule  1 (global)
-    echo "-A OUTPUT -p 50  -m state --state NEW  -j MARK --set-mark 16"
-    echo "-A OUTPUT -p ah  -m state --state NEW  -j MARK --set-mark 16"
-    echo "-A PREROUTING -p 50  -m state --state NEW  -j MARK --set-mark 16"
-    echo "-A PREROUTING -p ah  -m state --state NEW  -j MARK --set-mark 16"
+    echo "-A OUTPUT -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16"
+    echo "-A OUTPUT -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16"
+    echo "-A PREROUTING -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16"
+    echo "-A PREROUTING -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16"
     # 
     # Rule  2 (global)
     echo ":Cid43BBF1AD9745.0 - [0:0]"
-    echo "-A OUTPUT  -s ! 192.168.1.0/24   -m state --state NEW  -j Cid43BBF1AD9745.0 "
+    echo "-A OUTPUT  -s ! 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid43BBF1AD9745.0 "
     echo "-A Cid43BBF1AD9745.0 -p 50  -j MARK --set-mark 16"
     echo "-A Cid43BBF1AD9745.0 -p ah  -j MARK --set-mark 16"
     echo ":Cid43BBF1AD9745.1 - [0:0]"
-    echo "-A PREROUTING  -s ! 192.168.1.0/24   -m state --state NEW  -j Cid43BBF1AD9745.1 "
+    echo "-A PREROUTING  -s ! 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid43BBF1AD9745.1 "
     echo "-A Cid43BBF1AD9745.1 -p 50  -j MARK --set-mark 16"
     echo "-A Cid43BBF1AD9745.1 -p ah  -j MARK --set-mark 16"
     # 
     # Rule  3 (eth1)
-    echo "-A PREROUTING -i eth1  -p 50  -m state --state NEW  -j MARK --set-mark 16"
-    echo "-A PREROUTING -i eth1  -p ah  -m state --state NEW  -j MARK --set-mark 16"
+    echo "-A PREROUTING -i eth1  -p 50  -m conntrack --ctstate NEW  -j MARK --set-mark 16"
+    echo "-A PREROUTING -i eth1  -p ah  -m conntrack --ctstate NEW  -j MARK --set-mark 16"
     # 
     # Rule  4 (global)
     # rule comment: rule 4
-    echo "-A OUTPUT -p tcp -m tcp  --dport 80  -m state --state NEW  -j MARK --set-mark 2"
+    echo "-A OUTPUT -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j MARK --set-mark 2"
     # 
     # Rule  5 (global)
-    echo "-A OUTPUT -p tcp -m tcp  -s 22.22.23.22   --dport 80  -m state --state NEW  -j MARK --set-mark 2"
+    echo "-A OUTPUT -p tcp -m tcp  -s 22.22.23.22   --dport 80  -m conntrack --ctstate NEW  -j MARK --set-mark 2"
     # 
     # Rule  6 (eth1)
-    echo "-A OUTPUT -o eth1  -p tcp -m tcp  -s 22.22.23.22   --dport 80  -m state --state NEW  -j MARK --set-mark 2"
+    echo "-A OUTPUT -o eth1  -p tcp -m tcp  -s 22.22.23.22   --dport 80  -m conntrack --ctstate NEW  -j MARK --set-mark 2"
     # 
     # Rule  7 (eth1)
-    echo "-A PREROUTING -i eth1  -p tcp -m tcp  -s 22.22.23.22   --dport 80  -m state --state NEW  -j MARK --set-mark 2"
+    echo "-A PREROUTING -i eth1  -p tcp -m tcp  -s 22.22.23.22   --dport 80  -m conntrack --ctstate NEW  -j MARK --set-mark 2"
     # 
     # Rule  8 (eth1)
     echo ":Cid462EA8B230547.0 - [0:0]"
-    echo "-A OUTPUT -o eth1  -p tcp -m tcp  --dport 80  -m state --state NEW  -j Cid462EA8B230547.0 "
+    echo "-A OUTPUT -o eth1  -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j Cid462EA8B230547.0 "
     echo "-A Cid462EA8B230547.0  -s 22.22.23.22   -j RETURN "
     echo "-A Cid462EA8B230547.0  -j MARK --set-mark 2"
-    echo "-A POSTROUTING -o eth1  -p tcp -m tcp  --dport 80  -m state --state NEW  -j MARK --set-mark 2"
+    echo "-A POSTROUTING -o eth1  -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j MARK --set-mark 2"
     #
     echo COMMIT
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall39.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall39.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall39.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall39.fw.orig	2014-07-08 16:51:10.413006902 +0200
@@ -323,9 +323,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -431,7 +431,7 @@ script_body() {
     echo "Rule rule_4_0_branch 0 (eth2)"
     # 
     $IPTABLES -N rule_4_0_branch
-    $IPTABLES -A rule_4_0_branch -o eth2   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A rule_4_0_branch -o eth2   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule rule_4_0_branch 1 (global)
     # 
@@ -448,7 +448,7 @@ script_body() {
     echo "Rule rule_4_1_branch 0 (eth2)"
     # 
     $IPTABLES -N rule_4_1_branch
-    $IPTABLES -A rule_4_1_branch -o eth2   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A rule_4_1_branch -o eth2   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule rule_4_1_branch 1 (global)
     # 
@@ -466,7 +466,7 @@ script_body() {
     # 
     $IPTABLES -N rule0_branch
     $IPTABLES -N rule0_branch_0
-    $IPTABLES -A rule0_branch  -m state --state NEW  -j rule0_branch_0
+    $IPTABLES -A rule0_branch  -m conntrack --ctstate NEW  -j rule0_branch_0
     $IPTABLES -A rule0_branch_0  -j LOG  --log-level info --log-prefix "RULE 0 -- ACCEPT "
     $IPTABLES -A rule0_branch_0  -j ACCEPT
     # ================ Table 'filter', rule set rule1_branch
@@ -485,7 +485,7 @@ script_body() {
     # 
     echo "Rule rule1_branch 1 (global)"
     # 
-    $IPTABLES -A rule1_branch  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A rule1_branch  -m conntrack --ctstate NEW  -j ACCEPT
     # ================ Table 'filter', rule set rule2_branch
     # 
     # Rule rule2_branch 0 (global)
@@ -502,7 +502,7 @@ script_body() {
     # 
     echo "Rule rule2_branch 1 (global)"
     # 
-    $IPTABLES -A rule2_branch  -s 222.222.222.0/24   -d 192.168.2.10   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A rule2_branch  -s 222.222.222.0/24   -d 192.168.2.10   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule rule2_branch 2 (global)
     # 
@@ -519,9 +519,9 @@ script_body() {
     echo "Rule rule3_branch 0 (eth1)"
     # 
     $IPTABLES -N rule3_branch
-    $IPTABLES -A rule3_branch -i eth1   -d 22.22.23.22   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A rule3_branch -i eth1   -d 192.168.1.22   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A rule3_branch -i eth1   -d 192.168.2.1   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A rule3_branch -i eth1   -d 22.22.23.22   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A rule3_branch -i eth1   -d 192.168.1.22   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A rule3_branch -i eth1   -d 192.168.2.1   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule rule3_branch 1 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall4.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall4.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall4.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall4.fw.orig	2014-07-08 16:51:11.036999101 +0200
@@ -456,7 +456,7 @@ script_body() {
     echo "Rule 3 (eth1)"
     # 
     $IPTABLES -N Cid3E49FEF2.0
-    $IPTABLES -A INPUT -i eth1  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid3E49FEF2.0
+    $IPTABLES -A INPUT -i eth1  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid3E49FEF2.0
     for i_eth1 in $i_eth1_list
     do
     test -n "$i_eth1" && $IPTABLES -A Cid3E49FEF2.0  -d $i_eth1   -j ACCEPT 
@@ -631,7 +631,7 @@ script_body() {
     # and are added as virtual
     # addresses
     $IPTABLES -N Cid3E4DD6AD.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 25  -m state --state NEW  -j Cid3E4DD6AD.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 25  -m conntrack --ctstate NEW  -j Cid3E4DD6AD.0
     for i_eth1 in $i_eth1_list
     do
     test -n "$i_eth1" && $IPTABLES -A Cid3E4DD6AD.0  -d $i_eth1   -j ACCEPT 
@@ -640,7 +640,7 @@ script_body() {
     $IPTABLES -A Cid3E4DD6AD.0  -d 192.168.2.1   -j ACCEPT
     $IPTABLES -A Cid3E4DD6AD.0  -d 222.222.222.222   -j ACCEPT
     $IPTABLES -N Cid3E4DD6AD.1
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 25  -m state --state NEW  -j Cid3E4DD6AD.1
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 25  -m conntrack --ctstate NEW  -j Cid3E4DD6AD.1
     for i_eth1 in $i_eth1_list
     do
     test -n "$i_eth1" && $IPTABLES -A Cid3E4DD6AD.1  -d $i_eth1   -j ACCEPT 
@@ -654,16 +654,16 @@ script_body() {
     echo "Rule 17 (global)"
     # 
     # 'masquerading' rule
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 18 (global)
     # 
     echo "Rule 18 (global)"
     # 
     $IPTABLES -N Cid3E20A8E1.0
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j Cid3E20A8E1.0
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid3E20A8E1.0
     for i_eth1 in $i_eth1_list
     do
     test -n "$i_eth1" && $IPTABLES -A Cid3E20A8E1.0  -d $i_eth1   -j RETURN 
@@ -672,8 +672,8 @@ script_body() {
     $IPTABLES -A Cid3E20A8E1.0  -d 192.168.2.1   -j RETURN
     $IPTABLES -A Cid3E20A8E1.0  -d 222.222.222.222   -j RETURN
     $IPTABLES -A Cid3E20A8E1.0  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 19 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall40-1.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall40-1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall40-1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall40-1.fw.orig	2014-07-08 16:51:11.088998451 +0200
@@ -324,9 +324,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
     # ================ Table 'mangle', automatic rules
     $IPTABLES -t mangle -A PREROUTING -j CONNMARK --restore-mark
     $IPTABLES -t mangle -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
@@ -348,22 +348,22 @@ script_body() {
     echo "Rule Policy_1 0 (eth0)"
     # 
     $IPTABLES -N Policy_1 -t mangle
-    $IPTABLES -t mangle -A Policy_1 -i eth0   -m state --state NEW  -j MARK --set-mark 1
-    $IPTABLES -t mangle -A Policy_1 -i eth0   -m state --state NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A Policy_1 -i eth0   -m conntrack --ctstate NEW  -j MARK --set-mark 1
+    $IPTABLES -t mangle -A Policy_1 -i eth0   -m conntrack --ctstate NEW  -j CONNMARK --save-mark
     # 
     # Rule Policy_1 1 (eth2)
     # 
     echo "Rule Policy_1 1 (eth2)"
     # 
-    $IPTABLES -t mangle -A Policy_1 -i eth2   -m state --state NEW  -j MARK --set-mark 2
-    $IPTABLES -t mangle -A Policy_1 -i eth2   -m state --state NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A Policy_1 -i eth2   -m conntrack --ctstate NEW  -j MARK --set-mark 2
+    $IPTABLES -t mangle -A Policy_1 -i eth2   -m conntrack --ctstate NEW  -j CONNMARK --save-mark
     # 
     # Rule Policy_1 6 (global)
     # 
     echo "Rule Policy_1 6 (global)"
     # 
     $IPTABLES -N Cid55038X29165.0 -t mangle
-    $IPTABLES -t mangle -A Policy_1  -s 192.168.1.0/24   -m state --state NEW  -j Cid55038X29165.0
+    $IPTABLES -t mangle -A Policy_1  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid55038X29165.0
     $IPTABLES -t mangle -A Cid55038X29165.0  -d 22.22.22.0/24   -j MARK --set-mark 8
     $IPTABLES -t mangle -A Cid55038X29165.0  -d 33.33.33.0/24   -j MARK --set-mark 8
 
@@ -376,7 +376,7 @@ script_body() {
     # This permits access from internal net
     # to the Internet and DMZ
     $IPTABLES -N Policy_1
-    $IPTABLES -A Policy_1  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A Policy_1  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule Policy_1 5 (global)
     # 
@@ -392,7 +392,7 @@ script_body() {
     echo "Rule Policy_1 6 (global)"
     # 
     $IPTABLES -N Cid55038X29165.0
-    $IPTABLES -A Policy_1  -s 192.168.1.0/24   -m state --state NEW  -j Cid55038X29165.0
+    $IPTABLES -A Policy_1  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid55038X29165.0
     $IPTABLES -A Cid55038X29165.0  -d 22.22.22.0/24   -j LOG  --log-level info --log-prefix "RULE 6 -- CONTINUE "
     $IPTABLES -A Cid55038X29165.0  -d 33.33.33.0/24   -j LOG  --log-level info --log-prefix "RULE 6 -- CONTINUE "
     # ================ Table 'filter', rule set Policy
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall40-2.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall40-2.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall40-2.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall40-2.fw.orig	2014-07-08 16:51:10.962000039 +0200
@@ -324,9 +324,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
     # ================ Table 'mangle', automatic rules
     $IPTABLES -t mangle -A PREROUTING -j CONNMARK --restore-mark
     $IPTABLES -t mangle -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
@@ -348,22 +348,22 @@ script_body() {
     echo "Rule Policy_1 0 (eth0)"
     # 
     $IPTABLES -N Policy_1 -t mangle
-    $IPTABLES -t mangle -A Policy_1 -i eth0   -m state --state NEW  -j MARK --set-mark 1
-    $IPTABLES -t mangle -A Policy_1 -i eth0   -m state --state NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A Policy_1 -i eth0   -m conntrack --ctstate NEW  -j MARK --set-mark 1
+    $IPTABLES -t mangle -A Policy_1 -i eth0   -m conntrack --ctstate NEW  -j CONNMARK --save-mark
     # 
     # Rule Policy_1 1 (eth2)
     # 
     echo "Rule Policy_1 1 (eth2)"
     # 
-    $IPTABLES -t mangle -A Policy_1 -i eth2   -m state --state NEW  -j MARK --set-mark 2
-    $IPTABLES -t mangle -A Policy_1 -i eth2   -m state --state NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A Policy_1 -i eth2   -m conntrack --ctstate NEW  -j MARK --set-mark 2
+    $IPTABLES -t mangle -A Policy_1 -i eth2   -m conntrack --ctstate NEW  -j CONNMARK --save-mark
     # 
     # Rule Policy_1 6 (global)
     # 
     echo "Rule Policy_1 6 (global)"
     # 
     $IPTABLES -N Cid55227X22068.0 -t mangle
-    $IPTABLES -t mangle -A Policy_1  -s 192.168.1.0/24   -m state --state NEW  -j Cid55227X22068.0
+    $IPTABLES -t mangle -A Policy_1  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid55227X22068.0
     $IPTABLES -t mangle -A Cid55227X22068.0  -d 22.22.22.0/24   -j MARK --set-mark 8
     $IPTABLES -t mangle -A Cid55227X22068.0  -d 33.33.33.0/24   -j MARK --set-mark 8
 
@@ -376,7 +376,7 @@ script_body() {
     # This permits access from internal net
     # to the Internet and DMZ
     $IPTABLES -N Policy_1
-    $IPTABLES -A Policy_1  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A Policy_1  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule Policy_1 5 (global)
     # 
@@ -392,7 +392,7 @@ script_body() {
     echo "Rule Policy_1 6 (global)"
     # 
     $IPTABLES -N Cid55227X22068.0
-    $IPTABLES -A Policy_1  -s 192.168.1.0/24   -m state --state NEW  -j Cid55227X22068.0
+    $IPTABLES -A Policy_1  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid55227X22068.0
     $IPTABLES -A Cid55227X22068.0  -d 22.22.22.0/24   -j LOG  --log-level info --log-prefix "RULE 6 -- CONTINUE "
     $IPTABLES -A Cid55227X22068.0  -d 33.33.33.0/24   -j LOG  --log-level info --log-prefix "RULE 6 -- CONTINUE "
 }
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall40.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall40.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall40.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall40.fw.orig	2014-07-08 16:51:11.085998489 +0200
@@ -324,9 +324,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
     # ================ Table 'mangle', automatic rules
     $IPTABLES -t mangle -A PREROUTING -j CONNMARK --restore-mark
     $IPTABLES -t mangle -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
@@ -347,22 +347,22 @@ script_body() {
     # 
     echo "Rule 0 (eth0)"
     # 
-    $IPTABLES -t mangle -A PREROUTING -i eth0   -m state --state NEW  -j MARK --set-mark 1
-    $IPTABLES -t mangle -A PREROUTING -i eth0   -m state --state NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A PREROUTING -i eth0   -m conntrack --ctstate NEW  -j MARK --set-mark 1
+    $IPTABLES -t mangle -A PREROUTING -i eth0   -m conntrack --ctstate NEW  -j CONNMARK --save-mark
     # 
     # Rule 1 (eth2)
     # 
     echo "Rule 1 (eth2)"
     # 
-    $IPTABLES -t mangle -A PREROUTING -i eth2   -m state --state NEW  -j MARK --set-mark 2
-    $IPTABLES -t mangle -A PREROUTING -i eth2   -m state --state NEW  -j CONNMARK --save-mark
+    $IPTABLES -t mangle -A PREROUTING -i eth2   -m conntrack --ctstate NEW  -j MARK --set-mark 2
+    $IPTABLES -t mangle -A PREROUTING -i eth2   -m conntrack --ctstate NEW  -j CONNMARK --save-mark
     # 
     # Rule 6 (global)
     # 
     echo "Rule 6 (global)"
     # 
     $IPTABLES -N Cid37084X26841.0 -t mangle
-    $IPTABLES -t mangle -A PREROUTING  -s 192.168.1.0/24   -m state --state NEW  -j Cid37084X26841.0
+    $IPTABLES -t mangle -A PREROUTING  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid37084X26841.0
     $IPTABLES -t mangle -A Cid37084X26841.0  -d 22.22.22.0/24   -j MARK --set-mark 8
     $IPTABLES -t mangle -A Cid37084X26841.0  -d 33.33.33.0/24   -j MARK --set-mark 8
 
@@ -374,9 +374,9 @@ script_body() {
     # 
     # This permits access from internal net
     # to the Internet and DMZ
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (global)
     # 
@@ -394,11 +394,11 @@ script_body() {
     echo "Rule 6 (global)"
     # 
     $IPTABLES -N Cid37084X26841.0
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j Cid37084X26841.0
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid37084X26841.0
     $IPTABLES -A Cid37084X26841.0  -d 22.22.22.0/24   -j LOG  --log-level info --log-prefix "RULE 6 -- CONTINUE "
     $IPTABLES -A Cid37084X26841.0  -d 33.33.33.0/24   -j LOG  --log-level info --log-prefix "RULE 6 -- CONTINUE "
     $IPTABLES -N Cid37084X26841.1
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j Cid37084X26841.1
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid37084X26841.1
     $IPTABLES -A Cid37084X26841.1  -d 22.22.22.0/24   -j LOG  --log-level info --log-prefix "RULE 6 -- CONTINUE "
     $IPTABLES -A Cid37084X26841.1  -d 33.33.33.0/24   -j LOG  --log-level info --log-prefix "RULE 6 -- CONTINUE "
 }
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall41-1.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall41-1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall41-1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall41-1.fw.orig	2014-07-08 16:51:10.353007653 +0200
@@ -446,9 +446,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -482,59 +482,59 @@ script_body() {
     # 
     echo "Rule 0 (global)"
     # 
-    $IPTABLES -A OUTPUT -m set  --set atbl.1 dst  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -m set  --set atbl.1 dst  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (global)
     # 
     echo "Rule 1 (global)"
     # 
     $IPTABLES -N Cid1162747X27867.0
-    $IPTABLES -A INPUT -m set  ! --set atbl.1 dst  -m state --state NEW  -j Cid1162747X27867.0
+    $IPTABLES -A INPUT -m set  ! --set atbl.1 dst  -m conntrack --ctstate NEW  -j Cid1162747X27867.0
     $IPTABLES -A Cid1162747X27867.0  -s 1.1.1.1   -j ACCEPT
     $IPTABLES -A Cid1162747X27867.0  -s 2.2.2.2   -j ACCEPT
-    $IPTABLES -A OUTPUT -m set  ! --set atbl.1 dst  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -m set  ! --set atbl.1 dst  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (global)
     # 
     echo "Rule 2 (global)"
     # 
-    $IPTABLES -A OUTPUT -m set  ! --set atbl.1 dst  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -m set  ! --set atbl.1 dst  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
     echo "Rule 3 (global)"
     # 
-    $IPTABLES -A OUTPUT -m set  --set atbl.1 dst  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -m set  --set block_these dst  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -m set  --set atbl.1 dst  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -m set  --set block_these dst  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
     echo "Rule 4 (global)"
     # 
-    $IPTABLES -A INPUT -m set  --set atbl.1 src  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -m set  --set atbl.1 src  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (global)
     # 
     echo "Rule 5 (global)"
     # 
     $IPTABLES -N Cid1162799X27867.0
-    $IPTABLES -A OUTPUT -m set  ! --set atbl.1 src  -m state --state NEW  -j Cid1162799X27867.0
+    $IPTABLES -A OUTPUT -m set  ! --set atbl.1 src  -m conntrack --ctstate NEW  -j Cid1162799X27867.0
     $IPTABLES -A Cid1162799X27867.0  -d 1.1.1.1   -j ACCEPT
     $IPTABLES -A Cid1162799X27867.0  -d 2.2.2.2   -j ACCEPT
-    $IPTABLES -A INPUT -m set  ! --set atbl.1 src  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -m set  ! --set atbl.1 src  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 6 (global)
     # 
     echo "Rule 6 (global)"
     # 
-    $IPTABLES -A INPUT -m set  ! --set atbl.1 src  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -m set  ! --set atbl.1 src  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 7 (global)
     # 
     echo "Rule 7 (global)"
     # 
-    $IPTABLES -A INPUT -m set  --set atbl.1 src  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -m set  --set block_these src  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -m set  --set atbl.1 src  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -m set  --set block_these src  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 8 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall41-2.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall41-2.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall41-2.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall41-2.fw.orig	2014-07-08 16:51:10.489005952 +0200
@@ -303,9 +303,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -346,7 +346,7 @@ script_body() {
     echo "Rule 0 (global)"
     # 
     grep -Ev '^#|^;|^\s*$' addr-table-1.tbl | while read L ; do
-      set $L; at_atbl_1=$1; $IPTABLES -A OUTPUT  -d $at_atbl_1   -m state --state NEW  -j ACCEPT 
+      set $L; at_atbl_1=$1; $IPTABLES -A OUTPUT  -d $at_atbl_1   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 1 (global)
@@ -354,10 +354,10 @@ script_body() {
     echo "Rule 1 (global)"
     # 
     $IPTABLES -N Cid4374297X29460.0
-    $IPTABLES -A INPUT  -s 1.1.1.1   -m state --state NEW  -j Cid4374297X29460.0
-    $IPTABLES -A INPUT  -s 2.2.2.2   -m state --state NEW  -j Cid4374297X29460.0
-    $IPTABLES -A OUTPUT  -s 1.1.1.1   -m state --state NEW  -j Cid4374297X29460.0
-    $IPTABLES -A OUTPUT  -s 2.2.2.2   -m state --state NEW  -j Cid4374297X29460.0
+    $IPTABLES -A INPUT  -s 1.1.1.1   -m conntrack --ctstate NEW  -j Cid4374297X29460.0
+    $IPTABLES -A INPUT  -s 2.2.2.2   -m conntrack --ctstate NEW  -j Cid4374297X29460.0
+    $IPTABLES -A OUTPUT  -s 1.1.1.1   -m conntrack --ctstate NEW  -j Cid4374297X29460.0
+    $IPTABLES -A OUTPUT  -s 2.2.2.2   -m conntrack --ctstate NEW  -j Cid4374297X29460.0
     grep -Ev '^#|^;|^\s*$' addr-table-1.tbl | while read L ; do
       set $L; at_atbl_1=$1; $IPTABLES -A Cid4374297X29460.0  -d $at_atbl_1   -j RETURN 
     done
@@ -368,8 +368,8 @@ script_body() {
     echo "Rule 2 (global)"
     # 
     $IPTABLES -N Cid4374309X29460.0
-    $IPTABLES -A OUTPUT  -s 1.1.1.1   -m state --state NEW  -j Cid4374309X29460.0
-    $IPTABLES -A OUTPUT  -s 2.2.2.2   -m state --state NEW  -j Cid4374309X29460.0
+    $IPTABLES -A OUTPUT  -s 1.1.1.1   -m conntrack --ctstate NEW  -j Cid4374309X29460.0
+    $IPTABLES -A OUTPUT  -s 2.2.2.2   -m conntrack --ctstate NEW  -j Cid4374309X29460.0
     grep -Ev '^#|^;|^\s*$' addr-table-1.tbl | while read L ; do
       set $L; at_atbl_1=$1; $IPTABLES -A Cid4374309X29460.0  -d $at_atbl_1   -j RETURN 
     done
@@ -380,10 +380,10 @@ script_body() {
     echo "Rule 3 (global)"
     # 
     grep -Ev '^#|^;|^\s*$' addr-table-1.tbl | while read L ; do
-      set $L; at_atbl_1=$1; $IPTABLES -A OUTPUT  -d $at_atbl_1   -m state --state NEW  -j ACCEPT 
+      set $L; at_atbl_1=$1; $IPTABLES -A OUTPUT  -d $at_atbl_1   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     grep -Ev '^#|^;|^\s*$' block-hosts.tbl | while read L ; do
-      set $L; at_block_these=$1; $IPTABLES -A OUTPUT  -d $at_block_these   -m state --state NEW  -j ACCEPT 
+      set $L; at_block_these=$1; $IPTABLES -A OUTPUT  -d $at_block_these   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 4 (global)
@@ -391,7 +391,7 @@ script_body() {
     echo "Rule 4 (global)"
     # 
     grep -Ev '^#|^;|^\s*$' addr-table-1.tbl | while read L ; do
-      set $L; at_atbl_1=$1; $IPTABLES -A INPUT  -s $at_atbl_1   -m state --state NEW  -j ACCEPT 
+      set $L; at_atbl_1=$1; $IPTABLES -A INPUT  -s $at_atbl_1   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 5 (global)
@@ -399,10 +399,10 @@ script_body() {
     echo "Rule 5 (global)"
     # 
     $IPTABLES -N Cid4374346X29460.0
-    $IPTABLES -A OUTPUT  -d 1.1.1.1   -m state --state NEW  -j Cid4374346X29460.0
-    $IPTABLES -A OUTPUT  -d 2.2.2.2   -m state --state NEW  -j Cid4374346X29460.0
-    $IPTABLES -A INPUT  -d 1.1.1.1   -m state --state NEW  -j Cid4374346X29460.0
-    $IPTABLES -A INPUT  -d 2.2.2.2   -m state --state NEW  -j Cid4374346X29460.0
+    $IPTABLES -A OUTPUT  -d 1.1.1.1   -m conntrack --ctstate NEW  -j Cid4374346X29460.0
+    $IPTABLES -A OUTPUT  -d 2.2.2.2   -m conntrack --ctstate NEW  -j Cid4374346X29460.0
+    $IPTABLES -A INPUT  -d 1.1.1.1   -m conntrack --ctstate NEW  -j Cid4374346X29460.0
+    $IPTABLES -A INPUT  -d 2.2.2.2   -m conntrack --ctstate NEW  -j Cid4374346X29460.0
     grep -Ev '^#|^;|^\s*$' addr-table-1.tbl | while read L ; do
       set $L; at_atbl_1=$1; $IPTABLES -A Cid4374346X29460.0  -s $at_atbl_1   -j RETURN 
     done
@@ -413,8 +413,8 @@ script_body() {
     echo "Rule 6 (global)"
     # 
     $IPTABLES -N Cid4374358X29460.0
-    $IPTABLES -A INPUT  -d 1.1.1.1   -m state --state NEW  -j Cid4374358X29460.0
-    $IPTABLES -A INPUT  -d 2.2.2.2   -m state --state NEW  -j Cid4374358X29460.0
+    $IPTABLES -A INPUT  -d 1.1.1.1   -m conntrack --ctstate NEW  -j Cid4374358X29460.0
+    $IPTABLES -A INPUT  -d 2.2.2.2   -m conntrack --ctstate NEW  -j Cid4374358X29460.0
     grep -Ev '^#|^;|^\s*$' addr-table-1.tbl | while read L ; do
       set $L; at_atbl_1=$1; $IPTABLES -A Cid4374358X29460.0  -s $at_atbl_1   -j RETURN 
     done
@@ -425,10 +425,10 @@ script_body() {
     echo "Rule 7 (global)"
     # 
     grep -Ev '^#|^;|^\s*$' addr-table-1.tbl | while read L ; do
-      set $L; at_atbl_1=$1; $IPTABLES -A INPUT  -s $at_atbl_1   -m state --state NEW  -j ACCEPT 
+      set $L; at_atbl_1=$1; $IPTABLES -A INPUT  -s $at_atbl_1   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     grep -Ev '^#|^;|^\s*$' block-hosts.tbl | while read L ; do
-      set $L; at_block_these=$1; $IPTABLES -A INPUT  -s $at_block_these   -m state --state NEW  -j ACCEPT 
+      set $L; at_block_these=$1; $IPTABLES -A INPUT  -s $at_block_these   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 8 (global)
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall41.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall41.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall41.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall41.fw.orig	2014-07-08 16:51:10.393007152 +0200
@@ -329,9 +329,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -345,7 +345,7 @@ script_body() {
     echo "Rule 0 (global)"
     # 
     $IPTABLES -N RULE_0
-    $IPTABLES -A OUTPUT  -d www.heise.de  -m state --state NEW  -j RULE_0
+    $IPTABLES -A OUTPUT  -d www.heise.de  -m conntrack --ctstate NEW  -j RULE_0
     $IPTABLES -A RULE_0  -j LOG  --log-level info --log-prefix "RULE 0 -- ACCEPT "
     $IPTABLES -A RULE_0  -j ACCEPT
     # 
@@ -355,7 +355,7 @@ script_body() {
     # 
     $IPTABLES -N RULE_1
     grep -Ev '^#|^;|^\s*$' addr-table-1.tbl | while read L ; do
-      set $L; at_atbl_1=$1; $IPTABLES -A OUTPUT  -d $at_atbl_1   -m state --state NEW  -j RULE_1 
+      set $L; at_atbl_1=$1; $IPTABLES -A OUTPUT  -d $at_atbl_1   -m conntrack --ctstate NEW  -j RULE_1 
     done
     $IPTABLES -A RULE_1  -j LOG  --log-level info --log-prefix "RULE 1 -- ACCEPT "
     $IPTABLES -A RULE_1  -j ACCEPT
@@ -365,11 +365,11 @@ script_body() {
     echo "Rule 2 (global)"
     # 
     $IPTABLES -N Cid44F707E428576.0
-    $IPTABLES -A INPUT  -d 1.1.1.1   -m state --state NEW  -j Cid44F707E428576.0
+    $IPTABLES -A INPUT  -d 1.1.1.1   -m conntrack --ctstate NEW  -j Cid44F707E428576.0
     $IPTABLES -N RULE_2
     $IPTABLES -A Cid44F707E428576.0  -s 1.1.1.1   -j RULE_2
     $IPTABLES -A Cid44F707E428576.0  -s 2.2.2.2   -j RULE_2
-    $IPTABLES -A OUTPUT  -d 1.1.1.1   -m state --state NEW  -j RULE_2
+    $IPTABLES -A OUTPUT  -d 1.1.1.1   -m conntrack --ctstate NEW  -j RULE_2
     $IPTABLES -A RULE_2  -j LOG  --log-level info --log-prefix "RULE 2 -- ACCEPT "
     $IPTABLES -A RULE_2  -j ACCEPT
     # 
@@ -395,10 +395,10 @@ script_body() {
     # when two run-time objects are used in the rule, compiler adds blank command that blocks (permits) any to any
     $IPTABLES -N RULE_4
     grep -Ev '^#|^;|^\s*$' addr-table-1.tbl | while read L ; do
-      set $L; at_atbl_1=$1; $IPTABLES -A OUTPUT  -d $at_atbl_1   -m state --state NEW  -j RULE_4 
+      set $L; at_atbl_1=$1; $IPTABLES -A OUTPUT  -d $at_atbl_1   -m conntrack --ctstate NEW  -j RULE_4 
     done
     grep -Ev '^#|^;|^\s*$' block-hosts.tbl | while read L ; do
-      set $L; at_block_these=$1; $IPTABLES -A OUTPUT  -d $at_block_these   -m state --state NEW  -j RULE_4 
+      set $L; at_block_these=$1; $IPTABLES -A OUTPUT  -d $at_block_these   -m conntrack --ctstate NEW  -j RULE_4 
     done
     $IPTABLES -A RULE_4  -j LOG  --log-level info --log-prefix "RULE 4 -- ACCEPT "
     $IPTABLES -A RULE_4  -j ACCEPT
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall42.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall42.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall42.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall42.fw.orig	2014-07-08 16:51:11.067998714 +0200
@@ -308,9 +308,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -323,25 +323,25 @@ script_body() {
     # 
     echo "Rule 0 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -d 192.168.1.255   --dport 67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -d 192.168.1.255   --dport 67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (eth0)
     # 
     echo "Rule 1 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -d 255.255.255.255   --dport 67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -d 255.255.255.255   --dport 67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (eth0)
     # 
     echo "Rule 2 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -d 224.0.1.141   --dport 67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -d 224.0.1.141   --dport 67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (eth0)
     # 
     echo "Rule 3 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -s 0.0.0.0   -d 255.255.255.255   --dport 67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -s 0.0.0.0   -d 255.255.255.255   --dport 67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (eth0)
     # 
@@ -349,7 +349,7 @@ script_body() {
     # 
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A OUTPUT -o eth0  -p udp -m udp  -s $i_eth0   -d 255.255.255.255   --dport 68  -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A OUTPUT -o eth0  -p udp -m udp  -s $i_eth0   -d 255.255.255.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT 
     done
 }
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall5.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall5.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall5.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall5.fw.orig	2014-07-08 16:51:10.339007828 +0200
@@ -448,19 +448,19 @@ script_body() {
     # 
     for i_ppp0 in $i_ppp0_list
     do
-    test -n "$i_ppp0" && $IPTABLES -A OUTPUT -p tcp -m tcp  -d $i_ppp0   --dport 22  -m state --state NEW  -j ACCEPT 
+    test -n "$i_ppp0" && $IPTABLES -A OUTPUT -p tcp -m tcp  -d $i_ppp0   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT 
     done
     for i_ppp1 in $i_ppp1_list
     do
-    test -n "$i_ppp1" && $IPTABLES -A OUTPUT -p tcp -m tcp  -d $i_ppp1   --dport 22  -m state --state NEW  -j ACCEPT 
+    test -n "$i_ppp1" && $IPTABLES -A OUTPUT -p tcp -m tcp  -d $i_ppp1   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT 
     done
     for i_ppp0 in $i_ppp0_list
     do
-    test -n "$i_ppp0" && $IPTABLES -A INPUT -p tcp -m tcp  -d $i_ppp0   --dport 22  -m state --state NEW  -j ACCEPT 
+    test -n "$i_ppp0" && $IPTABLES -A INPUT -p tcp -m tcp  -d $i_ppp0   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT 
     done
     for i_ppp1 in $i_ppp1_list
     do
-    test -n "$i_ppp1" && $IPTABLES -A INPUT -p tcp -m tcp  -d $i_ppp1   --dport 22  -m state --state NEW  -j ACCEPT 
+    test -n "$i_ppp1" && $IPTABLES -A INPUT -p tcp -m tcp  -d $i_ppp1   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 5 (global)
@@ -469,8 +469,8 @@ script_body() {
     # 
     # hostF has the same IP address as firewal.
     $IPTABLES -N RULE_5
-    $IPTABLES -A OUTPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m state --state NEW  -j RULE_5
-    $IPTABLES -A INPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m state --state NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j RULE_5
+    $IPTABLES -A INPUT -p icmp  -m icmp  -d 192.168.1.1   --icmp-type 8/0   -m conntrack --ctstate NEW  -j RULE_5
     $IPTABLES -A RULE_5  -j LOG
     $IPTABLES -A RULE_5  -j ACCEPT
     # 
@@ -479,7 +479,7 @@ script_body() {
     echo "Rule 6 (global)"
     # 
     $IPTABLES -N Cid3E4A0454.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid3E4A0454.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid3E4A0454.0
     for i_ppp1 in $i_ppp1_list
     do
     test -n "$i_ppp1" && $IPTABLES -A Cid3E4A0454.0  -d $i_ppp1   -j ACCEPT 
@@ -490,33 +490,33 @@ script_body() {
     done
     $IPTABLES -A Cid3E4A0454.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid3E4A0454.0  -d 192.168.2.1   -j ACCEPT
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 7 (global)
     # 
     echo "Rule 7 (global)"
     # 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.1   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p tcp -m tcp  -d 192.168.1.1   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.1   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -d 192.168.1.1   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 8 (global)
     # 
     echo "Rule 8 (global)"
     # 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -m multiport  -d 192.168.1.1   --dports 22,23  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p tcp -m tcp  -m multiport  -d 192.168.1.1   --dports 22,23  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -m multiport  -d 192.168.1.1   --dports 22,23  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -m multiport  -d 192.168.1.1   --dports 22,23  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 9 (global)
     # 
     echo "Rule 9 (global)"
     # 
     $IPTABLES -N Cid3E987157.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m state --state NEW  -j Cid3E987157.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m conntrack --ctstate NEW  -j Cid3E987157.0
     $IPTABLES -A Cid3E987157.0  -d 77.77.77.77   -j ACCEPT
     $IPTABLES -A Cid3E987157.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid3E987157.0  -d 192.168.2.1   -j ACCEPT
     $IPTABLES -N Cid3E987157.1
-    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  --dports 22,23  -m state --state NEW  -j Cid3E987157.1
+    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  --dports 22,23  -m conntrack --ctstate NEW  -j Cid3E987157.1
     $IPTABLES -A Cid3E987157.1  -d 77.77.77.77   -j ACCEPT
     $IPTABLES -A Cid3E987157.1  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid3E987157.1  -d 192.168.2.1   -j ACCEPT
@@ -526,13 +526,13 @@ script_body() {
     echo "Rule 10 (global)"
     # 
     $IPTABLES -N Cid3E9871F4.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m state --state NEW  -j Cid3E9871F4.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -m multiport  --dports 22,23  -m conntrack --ctstate NEW  -j Cid3E9871F4.0
     $IPTABLES -N RULE_10
     $IPTABLES -A Cid3E9871F4.0  -d 77.77.77.77   -j RULE_10
     $IPTABLES -A Cid3E9871F4.0  -d 192.168.1.1   -j RULE_10
     $IPTABLES -A Cid3E9871F4.0  -d 192.168.2.1   -j RULE_10
     $IPTABLES -N Cid3E9871F4.1
-    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  --dports 22,23  -m state --state NEW  -j Cid3E9871F4.1
+    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  --dports 22,23  -m conntrack --ctstate NEW  -j Cid3E9871F4.1
     $IPTABLES -A Cid3E9871F4.1  -d 77.77.77.77   -j RULE_10
     $IPTABLES -A Cid3E9871F4.1  -d 192.168.1.1   -j RULE_10
     $IPTABLES -A Cid3E9871F4.1  -d 192.168.2.1   -j RULE_10
@@ -546,8 +546,8 @@ script_body() {
     # firewall is part of Any, so compiler should
     # generate code in both FORWARD and
     # OUTPUT chains
-    $IPTABLES -A OUTPUT  -d 200.200.200.200   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 200.200.200.200   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 200.200.200.200   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 200.200.200.200   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 12 (global)
     # 
@@ -556,8 +556,8 @@ script_body() {
     # firewall is part of Any, compiler should
     # generate code for both FORWARD and
     # INPUT chains
-    $IPTABLES -A INPUT  -s 200.200.200.200   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 200.200.200.200   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 200.200.200.200   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 200.200.200.200   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 13 (global)
     # 
@@ -566,19 +566,19 @@ script_body() {
     # because firewall has interface on network
     # internal_net, compiler should generate code
     # for both FORWARD and INPUT chains
-    $IPTABLES -A INPUT  -s 192.168.1.10   -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.10   -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.10   -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.10   -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 14 (global)
     # 
     echo "Rule 14 (global)"
     # 
     $IPTABLES -N Cid3B19C5CA.0
-    $IPTABLES -A OUTPUT  -d 200.200.200.200   -m state --state NEW  -j Cid3B19C5CA.0
+    $IPTABLES -A OUTPUT  -d 200.200.200.200   -m conntrack --ctstate NEW  -j Cid3B19C5CA.0
     $IPTABLES -A Cid3B19C5CA.0  -s 192.168.1.0/24   -j ACCEPT
     $IPTABLES -A Cid3B19C5CA.0  -s 192.168.2.0/24   -j ACCEPT
     $IPTABLES -N Cid3B19C5CA.1
-    $IPTABLES -A FORWARD  -d 200.200.200.200   -m state --state NEW  -j Cid3B19C5CA.1
+    $IPTABLES -A FORWARD  -d 200.200.200.200   -m conntrack --ctstate NEW  -j Cid3B19C5CA.1
     $IPTABLES -A Cid3B19C5CA.1  -s 192.168.1.0/24   -j ACCEPT
     $IPTABLES -A Cid3B19C5CA.1  -s 192.168.2.0/24   -j ACCEPT
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall50.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall50.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall50.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall50.fw.orig	2014-07-08 16:51:10.501005802 +0200
@@ -304,9 +304,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall51.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall51.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall51.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall51.fw.orig	2014-07-08 16:51:10.399007077 +0200
@@ -306,9 +306,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -337,14 +337,14 @@ script_body() {
     echo "Rule mail_server_inbound 0 (global)"
     # 
     $IPTABLES -N mail_server_inbound
-    $IPTABLES -A mail_server_inbound -i +  -p tcp -m tcp  --dport 25  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A mail_server_inbound -i +  -p tcp -m tcp  --dport 25  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule mail_server_inbound 1 (global)
     # 
     echo "Rule mail_server_inbound 1 (global)"
     # 
-    $IPTABLES -A mail_server_inbound -i +  -p icmp  -m icmp  --icmp-type 3  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A mail_server_inbound -i +  -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A mail_server_inbound -i +  -p icmp  -m icmp  --icmp-type 3  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A mail_server_inbound -i +  -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
     # ================ Table 'filter', rule set mail_server_outbound
     # 
     # Rule mail_server_outbound 0 (global)
@@ -352,15 +352,15 @@ script_body() {
     echo "Rule mail_server_outbound 0 (global)"
     # 
     $IPTABLES -N mail_server_outbound
-    $IPTABLES -A mail_server_outbound -o +  -p tcp -m tcp  -m multiport  --dports 53,25  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A mail_server_outbound -o +  -p udp -m udp  --dport 53  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A mail_server_outbound -o +  -p tcp -m tcp  -m multiport  --dports 53,25  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A mail_server_outbound -o +  -p udp -m udp  --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule mail_server_outbound 1 (global)
     # 
     echo "Rule mail_server_outbound 1 (global)"
     # 
-    $IPTABLES -A mail_server_outbound -o +  -p icmp  -m icmp  --icmp-type 3  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A mail_server_outbound -o +  -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A mail_server_outbound -o +  -p icmp  -m icmp  --icmp-type 3  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A mail_server_outbound -o +  -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
     # ================ Table 'filter', rule set web_server_inbound
     # 
     # Rule web_server_inbound 0 (global)
@@ -368,14 +368,14 @@ script_body() {
     echo "Rule web_server_inbound 0 (global)"
     # 
     $IPTABLES -N web_server_inbound
-    $IPTABLES -A web_server_inbound -i +  -p tcp -m tcp  --dport 80  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A web_server_inbound -i +  -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule web_server_inbound 1 (global)
     # 
     echo "Rule web_server_inbound 1 (global)"
     # 
-    $IPTABLES -A web_server_inbound -i +  -p icmp  -m icmp  --icmp-type 3  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A web_server_inbound -i +  -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A web_server_inbound -i +  -p icmp  -m icmp  --icmp-type 3  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A web_server_inbound -i +  -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule web_server_inbound 2 (global)
     # 
@@ -392,15 +392,15 @@ script_body() {
     echo "Rule web_server_outbound 0 (global)"
     # 
     $IPTABLES -N web_server_outbound
-    $IPTABLES -A web_server_outbound -o +  -p icmp  -m icmp  --icmp-type 3  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A web_server_outbound -o +  -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A web_server_outbound -o +  -p icmp  -m icmp  --icmp-type 3  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A web_server_outbound -o +  -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule web_server_outbound 1 (global)
     # 
     echo "Rule web_server_outbound 1 (global)"
     # 
-    $IPTABLES -A web_server_outbound -o +  -p tcp -m tcp  --dport 53  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A web_server_outbound -o +  -p udp -m udp  --dport 53  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A web_server_outbound -o +  -p tcp -m tcp  --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A web_server_outbound -o +  -p udp -m udp  --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
     # ================ Table 'filter', rule set base-ruleset
     # 
     # Rule base-ruleset 0 (global)
@@ -409,7 +409,7 @@ script_body() {
     # 
     $IPTABLES -N base-ruleset
     $IPTABLES -N Cid41961X1271.0
-    $IPTABLES -A base-ruleset -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid41961X1271.0
+    $IPTABLES -A base-ruleset -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid41961X1271.0
     $IPTABLES -A Cid41961X1271.0  -d 33.33.33.33   -j ACCEPT
     $IPTABLES -A Cid41961X1271.0  -d 172.16.1.1   -j ACCEPT
     $IPTABLES -A Cid41961X1271.0  -d 192.168.100.1   -j ACCEPT
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall6.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall6.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall6.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall6.fw.orig	2014-07-08 16:51:10.555005127 +0200
@@ -318,9 +318,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -454,22 +454,22 @@ script_body() {
     echo "Rule 2 (global)"
     # 
     $IPTABLES -N Cid3E9C86DD.0
-    $IPTABLES -A INPUT  -s 22.22.22.22   -m state --state NEW  -j Cid3E9C86DD.0
-    $IPTABLES -A INPUT  -s 22.22.23.23   -m state --state NEW  -j Cid3E9C86DD.0
-    $IPTABLES -A INPUT  -s 127.0.0.1   -m state --state NEW  -j Cid3E9C86DD.0
-    $IPTABLES -A INPUT  -s 192.168.1.1   -m state --state NEW  -j Cid3E9C86DD.0
-    $IPTABLES -A INPUT  -s 192.168.2.1   -m state --state NEW  -j Cid3E9C86DD.0
+    $IPTABLES -A INPUT  -s 22.22.22.22   -m conntrack --ctstate NEW  -j Cid3E9C86DD.0
+    $IPTABLES -A INPUT  -s 22.22.23.23   -m conntrack --ctstate NEW  -j Cid3E9C86DD.0
+    $IPTABLES -A INPUT  -s 127.0.0.1   -m conntrack --ctstate NEW  -j Cid3E9C86DD.0
+    $IPTABLES -A INPUT  -s 192.168.1.1   -m conntrack --ctstate NEW  -j Cid3E9C86DD.0
+    $IPTABLES -A INPUT  -s 192.168.2.1   -m conntrack --ctstate NEW  -j Cid3E9C86DD.0
     $IPTABLES -A Cid3E9C86DD.0  -d 22.22.22.22   -j ACCEPT
     $IPTABLES -A Cid3E9C86DD.0  -d 22.22.23.23   -j ACCEPT
     $IPTABLES -A Cid3E9C86DD.0  -d 127.0.0.1   -j ACCEPT
     $IPTABLES -A Cid3E9C86DD.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid3E9C86DD.0  -d 192.168.2.1   -j ACCEPT
     $IPTABLES -N Cid3E9C86DD.1
-    $IPTABLES -A OUTPUT  -s 22.22.22.22   -m state --state NEW  -j Cid3E9C86DD.1
-    $IPTABLES -A OUTPUT  -s 22.22.23.23   -m state --state NEW  -j Cid3E9C86DD.1
-    $IPTABLES -A OUTPUT  -s 127.0.0.1   -m state --state NEW  -j Cid3E9C86DD.1
-    $IPTABLES -A OUTPUT  -s 192.168.1.1   -m state --state NEW  -j Cid3E9C86DD.1
-    $IPTABLES -A OUTPUT  -s 192.168.2.1   -m state --state NEW  -j Cid3E9C86DD.1
+    $IPTABLES -A OUTPUT  -s 22.22.22.22   -m conntrack --ctstate NEW  -j Cid3E9C86DD.1
+    $IPTABLES -A OUTPUT  -s 22.22.23.23   -m conntrack --ctstate NEW  -j Cid3E9C86DD.1
+    $IPTABLES -A OUTPUT  -s 127.0.0.1   -m conntrack --ctstate NEW  -j Cid3E9C86DD.1
+    $IPTABLES -A OUTPUT  -s 192.168.1.1   -m conntrack --ctstate NEW  -j Cid3E9C86DD.1
+    $IPTABLES -A OUTPUT  -s 192.168.2.1   -m conntrack --ctstate NEW  -j Cid3E9C86DD.1
     $IPTABLES -A Cid3E9C86DD.1  -d 22.22.22.22   -j ACCEPT
     $IPTABLES -A Cid3E9C86DD.1  -d 22.22.23.23   -j ACCEPT
     $IPTABLES -A Cid3E9C86DD.1  -d 127.0.0.1   -j ACCEPT
@@ -481,9 +481,9 @@ script_body() {
     echo "Rule 4 (global)"
     # 
     $IPTABLES -N Cid141025X15403.0
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j Cid141025X15403.0
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j Cid141025X15403.0
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j Cid141025X15403.0
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid141025X15403.0
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid141025X15403.0
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j Cid141025X15403.0
     $IPTABLES -A Cid141025X15403.0  -d 222.222.222.40   -j RETURN
     $IPTABLES -A Cid141025X15403.0  -d 222.222.222.41   -j RETURN
     $IPTABLES -A Cid141025X15403.0  -j ACCEPT
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall60.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall60.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall60.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall60.fw.orig	2014-07-08 16:51:10.370007440 +0200
@@ -321,9 +321,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall61-1.2.5.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall61-1.2.5.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall61-1.2.5.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall61-1.2.5.fw.orig	2014-07-08 16:51:10.629004202 +0200
@@ -323,9 +323,9 @@ script_body() {
     $IPTABLES -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
 
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -441,9 +441,9 @@ script_body() {
     # target TCPMSS is not supported by ip6tables before v1.3.8
 
     # accept established sessions
-    $IP6TABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IP6TABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall61-1.2.6.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall61-1.2.6.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall61-1.2.6.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall61-1.2.6.fw.orig	2014-07-08 16:51:11.101998289 +0200
@@ -323,9 +323,9 @@ script_body() {
     $IPTABLES -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
 
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -447,9 +447,9 @@ script_body() {
     # target TCPMSS is not supported by ip6tables before v1.3.8
 
     # accept established sessions
-    $IP6TABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IP6TABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall61-1.3.x.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall61-1.3.x.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall61-1.3.x.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall61-1.3.x.fw.orig	2014-07-08 16:51:10.570004940 +0200
@@ -321,9 +321,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
     # ================ Table 'mangle', automatic rules
     $IPTABLES -t mangle -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
 
@@ -433,9 +433,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IP6TABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IP6TABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
     # ================ Table 'mangle', automatic rules
     # target TCPMSS is not supported by ip6tables before v1.3.8
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall61-1.4.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall61-1.4.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall61-1.4.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall61-1.4.fw.orig	2014-07-08 16:51:10.573004902 +0200
@@ -321,9 +321,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
     # ================ Table 'mangle', automatic rules
     $IPTABLES -t mangle -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
 
@@ -433,9 +433,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IP6TABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IP6TABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
     # ================ Table 'mangle', automatic rules
     $IP6TABLES -t mangle -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall62.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall62.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall62.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall62.fw.orig	2014-07-08 16:51:10.546005240 +0200
@@ -346,9 +346,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
     # ================ Table 'mangle', automatic rules
     $IPTABLES -t mangle -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
 
@@ -364,14 +364,14 @@ script_body() {
     # 
     # firewall62:Policy:0: warning: Iptables does not support module 'owner' in a chain other than OUTPUT
 
-    $IPTABLES -A OUTPUT -m owner --uid-owner 2000  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -m owner --uid-owner 2000  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (global)
     # 
     echo "Rule 1 (global)"
     # 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 80  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -m owner --uid-owner 2000  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -m owner --uid-owner 2000  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (global)
     # 
@@ -380,18 +380,18 @@ script_body() {
     # firewall62:Policy:2: warning: Iptables does not support module 'owner' in a chain other than OUTPUT
 
     $IPTABLES -N Cid484A599620246.0
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 80  -m state --state NEW  -j Cid484A599620246.0
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j Cid484A599620246.0
     $IPTABLES -A Cid484A599620246.0  -s 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid484A599620246.0  -s 222.222.222.222   -j ACCEPT
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 80  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -m owner --uid-owner 2000  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -m owner --uid-owner 2000  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
     echo "Rule 3 (global)"
     # 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 80  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -m owner --uid-owner 2000  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -m owner --uid-owner 2000  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
@@ -399,7 +399,7 @@ script_body() {
     # 
     # firewall62:Policy:4: warning: Iptables does not support module 'owner' in a chain other than OUTPUT
 
-    $IPTABLES -A OUTPUT  -s 192.168.1.1  -m owner --uid-owner 2000  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.1  -m owner --uid-owner 2000  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (global)
     # 
@@ -407,7 +407,7 @@ script_body() {
     # 
     # firewall62:Policy:5: warning: Iptables does not support module 'owner' in a chain other than OUTPUT
 
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24  -m owner --uid-owner 2000  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24  -m owner --uid-owner 2000  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 6 (global)
     # 
@@ -416,7 +416,7 @@ script_body() {
     # firewall62:Policy:6: warning: Iptables does not support module 'owner' in a chain other than OUTPUT
 
     $IPTABLES -N Cid4848F1BB20246.0
-    $IPTABLES -A OUTPUT -m owner --uid-owner 2000  -m state --state NEW  -j Cid4848F1BB20246.0
+    $IPTABLES -A OUTPUT -m owner --uid-owner 2000  -m conntrack --ctstate NEW  -j Cid4848F1BB20246.0
     $IPTABLES -A Cid4848F1BB20246.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid4848F1BB20246.0  -d 222.222.222.222   -j ACCEPT
     # 
@@ -426,7 +426,7 @@ script_body() {
     # 
     # firewall62:Policy:8: warning: Iptables does not support module 'owner' in a chain other than OUTPUT
 
-    $IPTABLES -A OUTPUT  -s ! 192.168.1.0/24  -m owner --uid-owner 2000  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s ! 192.168.1.0/24  -m owner --uid-owner 2000  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 9 (global)
     # 
@@ -434,7 +434,7 @@ script_body() {
     # 
     # firewall62:Policy:9: warning: Iptables does not support module 'owner' in a chain other than OUTPUT
 
-    $IPTABLES -A OUTPUT -m owner --uid-owner 2000  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -m owner --uid-owner 2000  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 10 (global)
     # 
@@ -443,8 +443,8 @@ script_body() {
     # bug 2186568
     # firewall62:Policy:10: warning: Iptables does not support module 'owner' in a chain other than OUTPUT
 
-    $IPTABLES -A OUTPUT -m owner --uid-owner 2000  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -m owner --uid-owner 500  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -m owner --uid-owner 2000  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -m owner --uid-owner 500  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 11 (global)
     # 
@@ -454,8 +454,8 @@ script_body() {
     # firewall62:Policy:11: warning: Iptables does not support module 'owner' in a chain other than OUTPUT
 
     $IPTABLES -N Cid55369X1137.0
-    $IPTABLES -A OUTPUT -m owner --uid-owner 2000  -m state --state NEW  -j Cid55369X1137.0
-    $IPTABLES -A OUTPUT -m owner --uid-owner 500  -m state --state NEW  -j Cid55369X1137.0
+    $IPTABLES -A OUTPUT -m owner --uid-owner 2000  -m conntrack --ctstate NEW  -j Cid55369X1137.0
+    $IPTABLES -A OUTPUT -m owner --uid-owner 500  -m conntrack --ctstate NEW  -j Cid55369X1137.0
     $IPTABLES -A Cid55369X1137.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid55369X1137.0  -d 222.222.222.222   -j ACCEPT
     # 
@@ -466,7 +466,7 @@ script_body() {
     # bug 2186568
     # firewall62:Policy:12: warning: Iptables does not support module 'owner' in a chain other than OUTPUT
 
-    $IPTABLES -A OUTPUT -m owner ! --uid-owner 2000  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -m owner ! --uid-owner 2000  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 13 (global)
     # 
@@ -476,7 +476,7 @@ script_body() {
     # firewall62:Policy:13: warning: Iptables does not support module 'owner' in a chain other than OUTPUT
 
     $IPTABLES -N Cid72626X1137.0
-    $IPTABLES -A OUTPUT -m owner ! --uid-owner 2000  -m state --state NEW  -j Cid72626X1137.0
+    $IPTABLES -A OUTPUT -m owner ! --uid-owner 2000  -m conntrack --ctstate NEW  -j Cid72626X1137.0
     $IPTABLES -A Cid72626X1137.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid72626X1137.0  -d 222.222.222.222   -j ACCEPT
     # 
@@ -486,9 +486,9 @@ script_body() {
     # 
     # bug 2186568
     $IPTABLES -N Cid124556X1137.0
-    $IPTABLES -A INPUT  -s 192.168.1.1   -m state --state NEW  -j Cid124556X1137.0
-    $IPTABLES -A INPUT  -s 222.222.222.222   -m state --state NEW  -j Cid124556X1137.0
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j Cid124556X1137.0
+    $IPTABLES -A INPUT  -s 192.168.1.1   -m conntrack --ctstate NEW  -j Cid124556X1137.0
+    $IPTABLES -A INPUT  -s 222.222.222.222   -m conntrack --ctstate NEW  -j Cid124556X1137.0
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j Cid124556X1137.0
     $IPTABLES -A Cid124556X1137.0 -m owner --uid-owner 2000  -j RETURN
     $IPTABLES -A Cid124556X1137.0 -m owner --uid-owner 500  -j RETURN
     $IPTABLES -A Cid124556X1137.0  -j ACCEPT
@@ -499,9 +499,9 @@ script_body() {
     # 
     # bug 2186568
     $IPTABLES -N Cid124573X1137.0
-    $IPTABLES -A OUTPUT  -d 192.168.1.1   -m state --state NEW  -j Cid124573X1137.0
-    $IPTABLES -A OUTPUT  -d 222.222.222.222   -m state --state NEW  -j Cid124573X1137.0
-    $IPTABLES -A INPUT  -m state --state NEW  -j Cid124573X1137.0
+    $IPTABLES -A OUTPUT  -d 192.168.1.1   -m conntrack --ctstate NEW  -j Cid124573X1137.0
+    $IPTABLES -A OUTPUT  -d 222.222.222.222   -m conntrack --ctstate NEW  -j Cid124573X1137.0
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j Cid124573X1137.0
     $IPTABLES -A Cid124573X1137.0 -m owner --uid-owner 2000  -j RETURN
     $IPTABLES -A Cid124573X1137.0 -m owner --uid-owner 500  -j RETURN
     $IPTABLES -A Cid124573X1137.0  -j ACCEPT
@@ -513,8 +513,8 @@ script_body() {
     # bug 2186568
     # firewall62:Policy:16: warning: Iptables does not support module 'owner' in a chain other than OUTPUT
 
-    $IPTABLES -A OUTPUT -m owner --uid-owner 2000  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -m owner --uid-owner 500  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -m owner --uid-owner 2000  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -m owner --uid-owner 500  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 17 (global)
     # 
@@ -524,8 +524,8 @@ script_body() {
     # firewall62:Policy:17: warning: Iptables does not support module 'owner' in a chain other than OUTPUT
 
     $IPTABLES -N Cid89930X1137.0
-    $IPTABLES -A OUTPUT -m owner --uid-owner 2000  -m state --state NEW  -j Cid89930X1137.0
-    $IPTABLES -A OUTPUT -m owner --uid-owner 500  -m state --state NEW  -j Cid89930X1137.0
+    $IPTABLES -A OUTPUT -m owner --uid-owner 2000  -m conntrack --ctstate NEW  -j Cid89930X1137.0
+    $IPTABLES -A OUTPUT -m owner --uid-owner 500  -m conntrack --ctstate NEW  -j Cid89930X1137.0
     $IPTABLES -A Cid89930X1137.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid89930X1137.0  -d 222.222.222.222   -j ACCEPT
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall63.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall63.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall63.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall63.fw.orig	2014-07-08 16:51:10.377007352 +0200
@@ -321,9 +321,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
     # ================ Table 'mangle', automatic rules
     $IPTABLES -t mangle -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
 
@@ -337,25 +337,25 @@ script_body() {
     # 
     echo "Rule 0 (global)"
     # 
-    $IPTABLES -A OUTPUT -p all  -m tos --tos 0x20  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p all  -m tos --tos 0x20  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p all  -m tos --tos 0x20  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p all  -m tos --tos 0x20  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p all  -m tos --tos 0x20  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p all  -m tos --tos 0x20  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (global)
     # 
     echo "Rule 1 (global)"
     # 
-    $IPTABLES -A OUTPUT -p all  -m dscp --dscp 0x20  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p all  -m dscp --dscp 0x20  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p all  -m dscp --dscp 0x20  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p all  -m dscp --dscp 0x20  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p all  -m dscp --dscp 0x20  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p all  -m dscp --dscp 0x20  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (global)
     # 
     echo "Rule 2 (global)"
     # 
-    $IPTABLES -A OUTPUT -p all  -m dscp --dscp-class BE  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p all  -m dscp --dscp-class BE  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p all  -m dscp --dscp-class BE  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p all  -m dscp --dscp-class BE  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p all  -m dscp --dscp-class BE  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p all  -m dscp --dscp-class BE  -m conntrack --ctstate NEW  -j ACCEPT
 }
 
 ip_forward() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall7.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall7.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall7.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall7.fw.orig	2014-07-08 16:51:10.595004627 +0200
@@ -311,9 +311,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -326,43 +326,43 @@ script_body() {
     # 
     echo "Rule 0 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -d 192.168.1.255   --dport 67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -d 192.168.1.255   --dport 67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (eth0)
     # 
     echo "Rule 1 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -d 255.255.255.255   --dport 67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -d 255.255.255.255   --dport 67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (eth0)
     # 
     echo "Rule 2 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -d 224.0.1.141   --dport 67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -d 224.0.1.141   --dport 67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (eth0)
     # 
     echo "Rule 3 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -s 0.0.0.0   -d 255.255.255.255   --dport 67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p udp -m udp  -s 0.0.0.0   -d 255.255.255.255   --dport 67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (eth0)
     # 
     echo "Rule 4 (eth0)"
     # 
-    $IPTABLES -A OUTPUT -o eth0  -p udp -m udp  -s 192.168.1.1   -d 255.255.255.255   --dport 68  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth0  -p udp -m udp  -s 192.168.1.1   -d 255.255.255.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (eth2)
     # 
     echo "Rule 5 (eth2)"
     # 
-    $IPTABLES -A OUTPUT -o eth2  -p udp -m udp  -s 192.168.2.1   -d 192.168.2.10   --dport 67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth2  -p udp -m udp  -s 192.168.2.1   -d 192.168.2.10   --dport 67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 6 (eth2)
     # 
     echo "Rule 6 (eth2)"
     # 
-    $IPTABLES -A INPUT -i eth2  -p udp -m udp  -s 192.168.2.10   -d 192.168.1.1   --dport 67  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth2  -p udp -m udp  -s 192.168.2.10   -d 192.168.1.1   --dport 67  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 7 (global)
     # 
@@ -381,32 +381,32 @@ script_body() {
     echo "Rule 8 (global)"
     # 
     # compiler should place rule in INPUT chain because this is broadcast destination
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 9 (global)
     # 
     echo "Rule 9 (global)"
     # 
     # compiler should place rule in INPUT chain because this is broadcast destination
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.255   --dport 68  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p udp -m udp  -d 192.168.1.255   --dport 68  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p udp -m udp  -d 192.168.1.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 10 (global)
     # 
     echo "Rule 10 (global)"
     # 
     # compiler should place rule in INPUT chain because this is broadcast destination
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p udp -m udp  -d 255.255.255.255   --dport 68  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 11 (global)
     # 
     echo "Rule 11 (global)"
     # 
     $IPTABLES -N RULE_11
-    $IPTABLES -A OUTPUT  -d 224.0.1.141   -m state --state NEW  -j RULE_11
-    $IPTABLES -A INPUT  -d 224.0.1.141   -m state --state NEW  -j RULE_11
+    $IPTABLES -A OUTPUT  -d 224.0.1.141   -m conntrack --ctstate NEW  -j RULE_11
+    $IPTABLES -A INPUT  -d 224.0.1.141   -m conntrack --ctstate NEW  -j RULE_11
     $IPTABLES -A RULE_11  -j LOG  --log-level debug
     $IPTABLES -A RULE_11  -j ACCEPT
     # 
@@ -415,8 +415,8 @@ script_body() {
     echo "Rule 12 (global)"
     # 
     $IPTABLES -N RULE_12
-    $IPTABLES -A OUTPUT  -d 224.0.0.5   -m state --state NEW  -j RULE_12
-    $IPTABLES -A INPUT  -d 224.0.0.5   -m state --state NEW  -j RULE_12
+    $IPTABLES -A OUTPUT  -d 224.0.0.5   -m conntrack --ctstate NEW  -j RULE_12
+    $IPTABLES -A INPUT  -d 224.0.0.5   -m conntrack --ctstate NEW  -j RULE_12
     $IPTABLES -A RULE_12  -j LOG  --log-level debug
     $IPTABLES -A RULE_12  -j ACCEPT
     # 
@@ -424,15 +424,15 @@ script_body() {
     # 
     echo "Rule 13 (global)"
     # 
-    $IPTABLES -A OUTPUT  -d 224.0.0.5   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 224.0.0.5   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 224.0.0.5   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 224.0.0.5   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 14 (global)
     # 
     echo "Rule 14 (global)"
     # 
-    $IPTABLES -A OUTPUT  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 15 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall70.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall70.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall70.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall70.fw.orig	2014-07-08 16:51:10.445006502 +0200
@@ -338,9 +338,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall71.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall71.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall71.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall71.fw.orig	2014-07-08 16:51:10.526005490 +0200
@@ -325,20 +325,20 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # backup ssh access
-    echo "-A INPUT  -p tcp -m tcp  -s 192.168.1.1/255.255.255.255  --dport 22  -m state --state NEW,ESTABLISHED -j  ACCEPT "
-    echo "-A OUTPUT  -p tcp -m tcp  -d 192.168.1.1/255.255.255.255  --sport 22  -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT  -p tcp -m tcp  -s 192.168.1.1/255.255.255.255  --dport 22  -m conntrack --ctstate NEW,ESTABLISHED -j  ACCEPT "
+    echo "-A OUTPUT  -p tcp -m tcp  -d 192.168.1.1/255.255.255.255  --sport 22  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # drop TCP sessions opened prior firewall restart
-    echo "-A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP "
-    echo "-A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP "
-    echo "-A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP "
+    echo "-A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP "
+    echo "-A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP "
+    echo "-A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP "
     # drop packets that do not match any valid state 
-    echo "-A OUTPUT   -m state --state INVALID  -j DROP "
-    echo "-A INPUT    -m state --state INVALID  -j DROP "
-    echo "-A FORWARD  -m state --state INVALID  -j DROP "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j DROP "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j DROP "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j DROP "
     # ================ Table 'filter', rule set fw71_policy_2
     # 
     # Rule  fw71_policy_2 0 (global)
@@ -352,11 +352,11 @@ script_body() {
     # 
     # Rule  0 (global)
     echo ":Cid42351X60089.0 - [0:0]"
-    echo "-A OUTPUT  -d 200.200.200.200   -m state --state NEW  -j Cid42351X60089.0 "
+    echo "-A OUTPUT  -d 200.200.200.200   -m conntrack --ctstate NEW  -j Cid42351X60089.0 "
     echo "-A Cid42351X60089.0  -s 192.168.1.0/24   -j ACCEPT "
     echo "-A Cid42351X60089.0  -s 192.168.2.0/24   -j ACCEPT "
     echo ":Cid42351X60089.1 - [0:0]"
-    echo "-A FORWARD  -d 200.200.200.200   -m state --state NEW  -j Cid42351X60089.1 "
+    echo "-A FORWARD  -d 200.200.200.200   -m conntrack --ctstate NEW  -j Cid42351X60089.1 "
     echo "-A Cid42351X60089.1  -s 192.168.1.0/24   -j ACCEPT "
     echo "-A Cid42351X60089.1  -s 192.168.2.0/24   -j ACCEPT "
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall72-1.3.x.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall72-1.3.x.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall72-1.3.x.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall72-1.3.x.fw.orig	2014-07-08 16:51:10.456006365 +0200
@@ -325,9 +325,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall72-1.4.3.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall72-1.4.3.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall72-1.4.3.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall72-1.4.3.fw.orig	2014-07-08 16:51:10.365007502 +0200
@@ -325,9 +325,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall73.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall73.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall73.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall73.fw.orig	2014-07-08 16:51:10.589004702 +0200
@@ -324,9 +324,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall74.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall74.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall74.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall74.fw.orig	2014-07-08 16:51:10.955000127 +0200
@@ -320,20 +320,20 @@ script_body() {
     echo :FORWARD DROP [0:0]
     echo :OUTPUT DROP [0:0]
     # accept established sessions
-    echo "-A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT "
-    echo "-A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # backup ssh access
-    echo "-A INPUT  -p tcp -m tcp  -s 192.168.1.1/255.255.255.255  --dport 22  -m state --state NEW,ESTABLISHED -j  ACCEPT "
-    echo "-A OUTPUT  -p tcp -m tcp  -d 192.168.1.1/255.255.255.255  --sport 22  -m state --state ESTABLISHED,RELATED -j ACCEPT "
+    echo "-A INPUT  -p tcp -m tcp  -s 192.168.1.1/255.255.255.255  --dport 22  -m conntrack --ctstate NEW,ESTABLISHED -j  ACCEPT "
+    echo "-A OUTPUT  -p tcp -m tcp  -d 192.168.1.1/255.255.255.255  --sport 22  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT "
     # drop TCP sessions opened prior firewall restart
-    echo "-A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP "
-    echo "-A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP "
-    echo "-A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m state --state NEW -j DROP "
+    echo "-A INPUT   -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP "
+    echo "-A OUTPUT  -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP "
+    echo "-A FORWARD -p tcp -m tcp ! --tcp-flags SYN,RST,ACK SYN -m conntrack --ctstate NEW -j DROP "
     # drop packets that do not match any valid state 
-    echo "-A OUTPUT   -m state --state INVALID  -j DROP "
-    echo "-A INPUT    -m state --state INVALID  -j DROP "
-    echo "-A FORWARD  -m state --state INVALID  -j DROP "
+    echo "-A OUTPUT   -m conntrack --ctstate INVALID  -j DROP "
+    echo "-A INPUT    -m conntrack --ctstate INVALID  -j DROP "
+    echo "-A FORWARD  -m conntrack --ctstate INVALID  -j DROP "
 
     echo COMMIT
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall8.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall8.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall8.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall8.fw.orig	2014-07-08 16:51:10.486005990 +0200
@@ -324,9 +324,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 }
 
 ip_forward() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall80.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall80.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall80.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall80.fw.orig	2014-07-08 16:51:10.506005740 +0200
@@ -307,9 +307,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT_1
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall82.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall82.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall82.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall82.fw.orig	2014-07-08 16:51:10.498005840 +0200
@@ -326,9 +326,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -370,7 +370,7 @@ script_body() {
     # 
     echo "Rule Policy_B 0 (global)"
     # 
-    $IPTABLES -A Policy_B  -d 192.0.2.100   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A Policy_B  -d 192.0.2.100   -m conntrack --ctstate NEW  -j ACCEPT
     # ================ Table 'filter', rule set Policy
     # 
     # Rule 0 (global)
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall82_A.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall82_A.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall82_A.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall82_A.fw.orig	2014-07-08 16:51:11.082998526 +0200
@@ -315,9 +315,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -331,7 +331,7 @@ script_body() {
     echo "Rule Policy_B 0 (global)"
     # 
     $IPTABLES -N Policy_B
-    $IPTABLES -A Policy_B  -d 192.0.2.100   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A Policy_B  -d 192.0.2.100   -m conntrack --ctstate NEW  -j ACCEPT
     # ================ Table 'filter', rule set Policy
     # 
     # Rule 0 (global)
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall82_B.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall82_B.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall82_B.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall82_B.fw.orig	2014-07-08 16:51:10.477006102 +0200
@@ -313,9 +313,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -328,8 +328,8 @@ script_body() {
     # 
     echo "Rule Policy_B 0 (global)"
     # 
-    $IPTABLES -A OUTPUT  -d 192.0.2.100   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 192.0.2.100   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 192.0.2.100   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 192.0.2.100   -m conntrack --ctstate NEW  -j ACCEPT
 }
 
 ip_forward() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall9.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall9.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall9.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall9.fw.orig	2014-07-08 16:51:10.541005302 +0200
@@ -310,9 +310,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -548,9 +548,9 @@ script_body() {
     # 
     echo "Rule 12 (global)"
     # 
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -m tcp --tcp-flags SYN,ACK SYN,ACK -m state --state NEW  -j REJECT  --reject-with tcp-reset
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -m tcp --tcp-flags SYN,ACK SYN,ACK -m state --state NEW  -j REJECT  --reject-with tcp-reset
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -m tcp --tcp-flags SYN,ACK SYN,ACK -m state --state NEW  -j REJECT  --reject-with tcp-reset
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -m tcp --tcp-flags SYN,ACK SYN,ACK -m conntrack --ctstate NEW  -j REJECT  --reject-with tcp-reset
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -m tcp --tcp-flags SYN,ACK SYN,ACK -m conntrack --ctstate NEW  -j REJECT  --reject-with tcp-reset
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -m tcp --tcp-flags SYN,ACK SYN,ACK -m conntrack --ctstate NEW  -j REJECT  --reject-with tcp-reset
     # 
     # Rule 13 (global)
     # 
@@ -559,15 +559,15 @@ script_body() {
     $IPTABLES -N Cid206275X37109.0
     $IPTABLES -A INPUT  -s 192.168.1.0/24   -j Cid206275X37109.0
     $IPTABLES -A Cid206275X37109.0 -p tcp -m tcp  --dport 80  -j REJECT  --reject-with tcp-reset
-    $IPTABLES -A Cid206275X37109.0 -p tcp -m tcp  -m tcp --tcp-flags SYN,ACK SYN,ACK -m state --state NEW  -j REJECT  --reject-with tcp-reset
+    $IPTABLES -A Cid206275X37109.0 -p tcp -m tcp  -m tcp --tcp-flags SYN,ACK SYN,ACK -m conntrack --ctstate NEW  -j REJECT  --reject-with tcp-reset
     $IPTABLES -N Cid206275X37109.1
     $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -j Cid206275X37109.1
     $IPTABLES -A Cid206275X37109.1 -p tcp -m tcp  --dport 80  -j REJECT  --reject-with tcp-reset
-    $IPTABLES -A Cid206275X37109.1 -p tcp -m tcp  -m tcp --tcp-flags SYN,ACK SYN,ACK -m state --state NEW  -j REJECT  --reject-with tcp-reset
+    $IPTABLES -A Cid206275X37109.1 -p tcp -m tcp  -m tcp --tcp-flags SYN,ACK SYN,ACK -m conntrack --ctstate NEW  -j REJECT  --reject-with tcp-reset
     $IPTABLES -N Cid206275X37109.2
     $IPTABLES -A FORWARD  -s 192.168.1.0/24   -j Cid206275X37109.2
     $IPTABLES -A Cid206275X37109.2 -p tcp -m tcp  --dport 80  -j REJECT  --reject-with tcp-reset
-    $IPTABLES -A Cid206275X37109.2 -p tcp -m tcp  -m tcp --tcp-flags SYN,ACK SYN,ACK -m state --state NEW  -j REJECT  --reject-with tcp-reset
+    $IPTABLES -A Cid206275X37109.2 -p tcp -m tcp  -m tcp --tcp-flags SYN,ACK SYN,ACK -m conntrack --ctstate NEW  -j REJECT  --reject-with tcp-reset
     # 
     # Rule 14 (global)
     # 
@@ -579,15 +579,15 @@ script_body() {
     $IPTABLES -N Cid206293X37109.0
     $IPTABLES -A INPUT  -s 192.168.1.0/24   -j Cid206293X37109.0
     $IPTABLES -A Cid206293X37109.0 -p tcp -m tcp  --dport 80  -j REJECT  --reject-with tcp-reset
-    $IPTABLES -A Cid206293X37109.0 -p tcp -m tcp  -m tcp --tcp-flags SYN,ACK SYN,ACK -m state --state NEW  -j REJECT  --reject-with tcp-reset
+    $IPTABLES -A Cid206293X37109.0 -p tcp -m tcp  -m tcp --tcp-flags SYN,ACK SYN,ACK -m conntrack --ctstate NEW  -j REJECT  --reject-with tcp-reset
     $IPTABLES -N Cid206293X37109.1
     $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -j Cid206293X37109.1
     $IPTABLES -A Cid206293X37109.1 -p tcp -m tcp  --dport 80  -j REJECT  --reject-with tcp-reset
-    $IPTABLES -A Cid206293X37109.1 -p tcp -m tcp  -m tcp --tcp-flags SYN,ACK SYN,ACK -m state --state NEW  -j REJECT  --reject-with tcp-reset
+    $IPTABLES -A Cid206293X37109.1 -p tcp -m tcp  -m tcp --tcp-flags SYN,ACK SYN,ACK -m conntrack --ctstate NEW  -j REJECT  --reject-with tcp-reset
     $IPTABLES -N Cid206293X37109.2
     $IPTABLES -A FORWARD  -s 192.168.1.0/24   -j Cid206293X37109.2
     $IPTABLES -A Cid206293X37109.2 -p tcp -m tcp  --dport 80  -j REJECT  --reject-with tcp-reset
-    $IPTABLES -A Cid206293X37109.2 -p tcp -m tcp  -m tcp --tcp-flags SYN,ACK SYN,ACK -m state --state NEW  -j REJECT  --reject-with tcp-reset
+    $IPTABLES -A Cid206293X37109.2 -p tcp -m tcp  -m tcp --tcp-flags SYN,ACK SYN,ACK -m conntrack --ctstate NEW  -j REJECT  --reject-with tcp-reset
 }
 
 ip_forward() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall90.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall90.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall90.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall90.fw.orig	2014-07-08 16:51:10.537005352 +0200
@@ -320,9 +320,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall91.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall91.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall91.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall91.fw.orig	2014-07-08 16:51:10.512005665 +0200
@@ -320,9 +320,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall92.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall92.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall92.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall92.fw.orig	2014-07-08 16:51:10.459006327 +0200
@@ -324,9 +324,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -366,8 +366,8 @@ script_body() {
     # 
     echo "Rule 0 (global)"
     # 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -m owner --uid-owner anonymous  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p udp -m udp  -m owner --uid-owner anonymous  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -m owner --uid-owner anonymous  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -m owner --uid-owner anonymous  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall93.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall93.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall93.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall93.fw.orig	2014-07-08 16:51:11.108998201 +0200
@@ -335,9 +335,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -352,22 +352,22 @@ script_body() {
     # 
     for i_ppp_dsl in $i_ppp_dsl_list
     do
-    test -n "$i_ppp_dsl" && $IPTABLES -A INPUT -i ppp0   -s $i_ppp_dsl   -m state --state NEW  -j ACCEPT 
+    test -n "$i_ppp_dsl" && $IPTABLES -A INPUT -i ppp0   -s $i_ppp_dsl   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     for i_ppp0 in $i_ppp0_list
     do
-    test -n "$i_ppp0" && $IPTABLES -A INPUT -i ppp0   -s $i_ppp0   -m state --state NEW  -j ACCEPT 
+    test -n "$i_ppp0" && $IPTABLES -A INPUT -i ppp0   -s $i_ppp0   -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A INPUT -i ppp0   -s 192.0.2.1   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i ppp0   -s 192.0.2.1   -m conntrack --ctstate NEW  -j ACCEPT
     for i_ppp_dsl in $i_ppp_dsl_list
     do
-    test -n "$i_ppp_dsl" && $IPTABLES -A FORWARD -i ppp0   -s $i_ppp_dsl   -m state --state NEW  -j ACCEPT 
+    test -n "$i_ppp_dsl" && $IPTABLES -A FORWARD -i ppp0   -s $i_ppp_dsl   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     for i_ppp0 in $i_ppp0_list
     do
-    test -n "$i_ppp0" && $IPTABLES -A FORWARD -i ppp0   -s $i_ppp0   -m state --state NEW  -j ACCEPT 
+    test -n "$i_ppp0" && $IPTABLES -A FORWARD -i ppp0   -s $i_ppp0   -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A FORWARD -i ppp0   -s 192.0.2.1   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i ppp0   -s 192.0.2.1   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (ppp-dsl)
     # 
@@ -375,22 +375,22 @@ script_body() {
     # 
     for i_ppp_dsl in $i_ppp_dsl_list
     do
-    test -n "$i_ppp_dsl" && $IPTABLES -A INPUT -i ppp-dsl   -s $i_ppp_dsl   -m state --state NEW  -j ACCEPT 
+    test -n "$i_ppp_dsl" && $IPTABLES -A INPUT -i ppp-dsl   -s $i_ppp_dsl   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     for i_ppp0 in $i_ppp0_list
     do
-    test -n "$i_ppp0" && $IPTABLES -A INPUT -i ppp-dsl   -s $i_ppp0   -m state --state NEW  -j ACCEPT 
+    test -n "$i_ppp0" && $IPTABLES -A INPUT -i ppp-dsl   -s $i_ppp0   -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A INPUT -i ppp-dsl   -s 192.0.2.1   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i ppp-dsl   -s 192.0.2.1   -m conntrack --ctstate NEW  -j ACCEPT
     for i_ppp_dsl in $i_ppp_dsl_list
     do
-    test -n "$i_ppp_dsl" && $IPTABLES -A FORWARD -i ppp-dsl   -s $i_ppp_dsl   -m state --state NEW  -j ACCEPT 
+    test -n "$i_ppp_dsl" && $IPTABLES -A FORWARD -i ppp-dsl   -s $i_ppp_dsl   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     for i_ppp0 in $i_ppp0_list
     do
-    test -n "$i_ppp0" && $IPTABLES -A FORWARD -i ppp-dsl   -s $i_ppp0   -m state --state NEW  -j ACCEPT 
+    test -n "$i_ppp0" && $IPTABLES -A FORWARD -i ppp-dsl   -s $i_ppp0   -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A FORWARD -i ppp-dsl   -s 192.0.2.1   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i ppp-dsl   -s 192.0.2.1   -m conntrack --ctstate NEW  -j ACCEPT
 
 
     # ================ IPv6
@@ -411,13 +411,13 @@ script_body() {
     $IP6TABLES -N Policy_v6
     for i_ppp_dsl_v6 in $i_ppp_dsl_v6_list
     do
-    test -n "$i_ppp_dsl_v6" && $IP6TABLES -A Policy_v6 -i ppp-dsl   -s $i_ppp_dsl_v6   -m state --state NEW  -j ACCEPT 
+    test -n "$i_ppp_dsl_v6" && $IP6TABLES -A Policy_v6 -i ppp-dsl   -s $i_ppp_dsl_v6   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     for i_ppp0_v6 in $i_ppp0_v6_list
     do
-    test -n "$i_ppp0_v6" && $IP6TABLES -A Policy_v6 -i ppp-dsl   -s $i_ppp0_v6   -m state --state NEW  -j ACCEPT 
+    test -n "$i_ppp0_v6" && $IP6TABLES -A Policy_v6 -i ppp-dsl   -s $i_ppp0_v6   -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IP6TABLES -A Policy_v6 -i ppp-dsl   -s fe80::20c:29ff:fe28:c078   -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A Policy_v6 -i ppp-dsl   -s fe80::20c:29ff:fe28:c078   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule Policy_v6 1 (ppp0)
     # 
@@ -425,13 +425,13 @@ script_body() {
     # 
     for i_ppp_dsl_v6 in $i_ppp_dsl_v6_list
     do
-    test -n "$i_ppp_dsl_v6" && $IP6TABLES -A Policy_v6 -i ppp0   -s $i_ppp_dsl_v6   -m state --state NEW  -j ACCEPT 
+    test -n "$i_ppp_dsl_v6" && $IP6TABLES -A Policy_v6 -i ppp0   -s $i_ppp_dsl_v6   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     for i_ppp0_v6 in $i_ppp0_v6_list
     do
-    test -n "$i_ppp0_v6" && $IP6TABLES -A Policy_v6 -i ppp0   -s $i_ppp0_v6   -m state --state NEW  -j ACCEPT 
+    test -n "$i_ppp0_v6" && $IP6TABLES -A Policy_v6 -i ppp0   -s $i_ppp0_v6   -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IP6TABLES -A Policy_v6 -i ppp0   -s fe80::20c:29ff:fe28:c078   -m state --state NEW  -j ACCEPT
+    $IP6TABLES -A Policy_v6 -i ppp0   -s fe80::20c:29ff:fe28:c078   -m conntrack --ctstate NEW  -j ACCEPT
 }
 
 ip_forward() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall94.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall94.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall94.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall94.fw.orig	2014-07-08 16:51:10.989999689 +0200
@@ -327,9 +327,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -343,151 +343,151 @@ script_body() {
     echo "Rule 0 (global)"
     # 
     # address range in src includes firewall
-    $IPTABLES -A INPUT -m iprange --src-range 192.168.1.1-192.168.1.3  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -m iprange --src-range 192.168.1.1-192.168.1.3  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -m iprange --src-range 192.168.1.1-192.168.1.3  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -m iprange --src-range 192.168.1.1-192.168.1.3  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -m iprange --src-range 192.168.1.1-192.168.1.3  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m iprange --src-range 192.168.1.1-192.168.1.3  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (global)
     # 
     echo "Rule 1 (global)"
     # 
-    $IPTABLES -A INPUT -m iprange --src-range 192.168.1.3-192.168.1.5  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -m iprange --src-range 192.168.1.3-192.168.1.5  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -m iprange --src-range 192.168.1.3-192.168.1.5  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m iprange --src-range 192.168.1.3-192.168.1.5  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (global)
     # 
     echo "Rule 2 (global)"
     # 
     # address range in src includes firewall
-    $IPTABLES -A OUTPUT -m iprange --src-range 192.168.1.1-192.168.1.3  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -m iprange --src-range 192.168.1.1-192.168.1.3  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -m iprange --src-range 192.168.1.1-192.168.1.3  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m iprange --src-range 192.168.1.1-192.168.1.3  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
     echo "Rule 3 (global)"
     # 
-    $IPTABLES -A FORWARD -m iprange --src-range 192.168.1.3-192.168.1.5  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m iprange --src-range 192.168.1.3-192.168.1.5  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
     echo "Rule 4 (global)"
     # 
     # address range in dst includes firewall
-    $IPTABLES -A OUTPUT -m iprange --dst-range 192.168.1.1-192.168.1.3  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -m iprange --dst-range 192.168.1.1-192.168.1.3  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -m iprange --dst-range 192.168.1.1-192.168.1.3  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -m iprange --dst-range 192.168.1.1-192.168.1.3  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -m iprange --dst-range 192.168.1.1-192.168.1.3  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m iprange --dst-range 192.168.1.1-192.168.1.3  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (global)
     # 
     echo "Rule 5 (global)"
     # 
-    $IPTABLES -A OUTPUT -m iprange --dst-range 192.168.1.3-192.168.1.5  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -m iprange --dst-range 192.168.1.3-192.168.1.5  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -m iprange --dst-range 192.168.1.3-192.168.1.5  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m iprange --dst-range 192.168.1.3-192.168.1.5  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 6 (global)
     # 
     echo "Rule 6 (global)"
     # 
     # address range in dst includes firewall
-    $IPTABLES -A INPUT -m iprange --dst-range 192.168.1.1-192.168.1.3  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -m iprange --dst-range 192.168.1.1-192.168.1.3  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -m iprange --dst-range 192.168.1.1-192.168.1.3  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m iprange --dst-range 192.168.1.1-192.168.1.3  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 7 (global)
     # 
     echo "Rule 7 (global)"
     # 
-    $IPTABLES -A FORWARD -m iprange --dst-range 192.168.1.3-192.168.1.5  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -m iprange --dst-range 192.168.1.3-192.168.1.5  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 8 (global)
     # 
     echo "Rule 8 (global)"
     # 
-    $IPTABLES -A INPUT  -s 255.255.255.255   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 255.255.255.255   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 255.255.255.255   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 255.255.255.255   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 9 (global)
     # 
     echo "Rule 9 (global)"
     # 
-    $IPTABLES -A OUTPUT  -s 255.255.255.255   -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 255.255.255.255   -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 10 (global)
     # 
     echo "Rule 10 (global)"
     # 
-    $IPTABLES -A OUTPUT  -s 255.255.255.255   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 255.255.255.255   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 11 (global)
     # 
     echo "Rule 11 (global)"
     # 
-    $IPTABLES -A OUTPUT  -s 255.255.255.255   -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 255.255.255.255   -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 12 (global)
     # 
     echo "Rule 12 (global)"
     # 
-    $IPTABLES -A INPUT  -s 0.0.0.0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 0.0.0.0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 0.0.0.0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 0.0.0.0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 13 (global)
     # 
     echo "Rule 13 (global)"
     # 
-    $IPTABLES -A OUTPUT  -s 0.0.0.0   -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 0.0.0.0   -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 14 (global)
     # 
     echo "Rule 14 (global)"
     # 
-    $IPTABLES -A OUTPUT  -s 0.0.0.0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 0.0.0.0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 15 (global)
     # 
     echo "Rule 15 (global)"
     # 
-    $IPTABLES -A OUTPUT  -s 0.0.0.0   -d 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 0.0.0.0   -d 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 16 (global)
     # 
     echo "Rule 16 (global)"
     # 
-    $IPTABLES -A OUTPUT  -d 0.0.0.0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 0.0.0.0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 0.0.0.0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 0.0.0.0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 17 (global)
     # 
     echo "Rule 17 (global)"
     # 
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -d 0.0.0.0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -d 0.0.0.0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 18 (global)
     # 
     echo "Rule 18 (global)"
     # 
-    $IPTABLES -A OUTPUT  -d 255.255.255.255   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -d 0.0.0.0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 255.255.255.255   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -d 0.0.0.0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 255.255.255.255   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 0.0.0.0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 255.255.255.255   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 0.0.0.0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 19 (global)
     # 
     echo "Rule 19 (global)"
     # 
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -d 255.255.255.255   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -d 0.0.0.0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -d 255.255.255.255   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -d 0.0.0.0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 20 (global)
     # 
     echo "Rule 20 (global)"
     # 
-    $IPTABLES -A INPUT  -d 0.0.0.0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -d 0.0.0.0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 21 (global)
     # 
     echo "Rule 21 (global)"
     # 
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -d 0.0.0.0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -d 0.0.0.0   -m conntrack --ctstate NEW  -j ACCEPT
 }
 
 ip_forward() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/firewall95.fw.orig fwbuilder-5.1.0.3599/test/ipt/firewall95.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/firewall95.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/firewall95.fw.orig	2014-07-08 16:51:10.939000327 +0200
@@ -320,9 +320,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -336,8 +336,8 @@ script_body() {
     echo "Rule 0 (global)"
     # 
     # address 192.168.1.11 should not be considered a broadcast on the subnet attached to eth0
-    $IPTABLES -A OUTPUT  -d 192.168.1.11   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -d 192.168.1.11   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -d 192.168.1.11   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -d 192.168.1.11   -m conntrack --ctstate NEW  -j ACCEPT
 }
 
 ip_forward() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/fw-A.fw.orig fwbuilder-5.1.0.3599/test/ipt/fw-A.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/fw-A.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/fw-A.fw.orig	2014-07-08 16:51:10.440006565 +0200
@@ -554,14 +554,14 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
     # drop packets that do not match any valid state and log them
     $IPTABLES -N drop_invalid
-    $IPTABLES -A OUTPUT   -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A INPUT    -m state --state INVALID  -j drop_invalid 
-    $IPTABLES -A FORWARD  -m state --state INVALID  -j drop_invalid 
+    $IPTABLES -A OUTPUT   -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A INPUT    -m conntrack --ctstate INVALID  -j drop_invalid 
+    $IPTABLES -A FORWARD  -m conntrack --ctstate INVALID  -j drop_invalid 
     $IPTABLES -A drop_invalid -j LOG --log-level debug --log-prefix "INVALID state -- DENY "
     $IPTABLES -A drop_invalid -j DROP
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/fw1.fw.orig fwbuilder-5.1.0.3599/test/ipt/fw1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/fw1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/fw1.fw.orig	2014-07-08 16:51:11.071998664 +0200
@@ -342,9 +342,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -422,11 +422,11 @@ script_body() {
     # 
     # anti spoofing rule
     $IPTABLES -N Cid45745X95438.0
-    $IPTABLES -A FORWARD -i +   -d 192.168.171.2   -m state --state NEW  -j Cid45745X95438.0
+    $IPTABLES -A FORWARD -i +   -d 192.168.171.2   -m conntrack --ctstate NEW  -j Cid45745X95438.0
     $IPTABLES -N In_RULE_0
     $IPTABLES -A Cid45745X95438.0  -s 192.0.2.1   -j In_RULE_0
     $IPTABLES -A Cid45745X95438.0  -s 192.168.1.1   -j In_RULE_0
-    $IPTABLES -A FORWARD -i +   -s 192.168.1.0/24   -d 192.168.171.2   -m state --state NEW  -j In_RULE_0
+    $IPTABLES -A FORWARD -i +   -s 192.168.1.0/24   -d 192.168.171.2   -m conntrack --ctstate NEW  -j In_RULE_0
     $IPTABLES -A In_RULE_0  -j LOG  --log-level info --log-prefix "RULE 0 -- DENY "
     $IPTABLES -A In_RULE_0  -j DROP
     # 
@@ -440,9 +440,9 @@ script_body() {
     # fw1:Policy:1: error: Rule '1 (global)' shadows rule '5 (global)'  below it
     # fw1:Policy:1: error: Rule '1 (global)' shadows rule '6 (global)'  below it
 
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (global)
     # 
@@ -450,7 +450,7 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
@@ -459,8 +459,8 @@ script_body() {
     # Firewall uses one of the machines
     # on internal network for DNS
     $IPTABLES -N RULE_3
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_3
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_3
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_3
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_3
     $IPTABLES -A RULE_3  -j LOG  --log-level info --log-prefix "RULE 3 -- ACCEPT "
     $IPTABLES -A RULE_3  -j ACCEPT
     # 
@@ -471,9 +471,9 @@ script_body() {
     # All other attempts to connect to
     # the firewall are denied and logged
     $IPTABLES -N RULE_4
-    $IPTABLES -A OUTPUT  -d 192.0.2.1   -m state --state NEW  -j RULE_4
-    $IPTABLES -A OUTPUT  -d 192.168.1.1   -m state --state NEW  -j RULE_4
-    $IPTABLES -A INPUT  -m state --state NEW  -j RULE_4
+    $IPTABLES -A OUTPUT  -d 192.0.2.1   -m conntrack --ctstate NEW  -j RULE_4
+    $IPTABLES -A OUTPUT  -d 192.168.1.1   -m conntrack --ctstate NEW  -j RULE_4
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j RULE_4
     $IPTABLES -A RULE_4  -j LOG  --log-level info --log-prefix "RULE 4 -- DENY "
     $IPTABLES -A RULE_4  -j DROP
     # 
@@ -481,9 +481,9 @@ script_body() {
     # 
     echo "Rule 5 (global)"
     # 
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 1   --tcp-flags SYN SYN  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 1   --tcp-flags SYN SYN  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 1   --tcp-flags SYN SYN  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 1   --tcp-flags SYN SYN  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 1   --tcp-flags SYN SYN  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 1   --tcp-flags SYN SYN  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 6 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/fwbuilder.fw.orig fwbuilder-5.1.0.3599/test/ipt/fwbuilder.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/fwbuilder.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/fwbuilder.fw.orig	2014-07-08 16:51:10.543005277 +0200
@@ -325,9 +325,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -368,7 +368,7 @@ script_body() {
     echo "Rule 0 (global)"
     # 
     grep -Ev '^#|^;|^\s*$' addr-table-1.tbl | while read L ; do
-      set $L; at_atbl_1=$1; $IPTABLES -A OUTPUT  -d $at_atbl_1   -m state --state NEW  -j ACCEPT 
+      set $L; at_atbl_1=$1; $IPTABLES -A OUTPUT  -d $at_atbl_1   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 1 (global)
@@ -376,10 +376,10 @@ script_body() {
     echo "Rule 1 (global)"
     # 
     $IPTABLES -N Cid4374297X29460.0
-    $IPTABLES -A INPUT  -s 1.1.1.1   -m state --state NEW  -j Cid4374297X29460.0
-    $IPTABLES -A INPUT  -s 2.2.2.2   -m state --state NEW  -j Cid4374297X29460.0
-    $IPTABLES -A OUTPUT  -s 1.1.1.1   -m state --state NEW  -j Cid4374297X29460.0
-    $IPTABLES -A OUTPUT  -s 2.2.2.2   -m state --state NEW  -j Cid4374297X29460.0
+    $IPTABLES -A INPUT  -s 1.1.1.1   -m conntrack --ctstate NEW  -j Cid4374297X29460.0
+    $IPTABLES -A INPUT  -s 2.2.2.2   -m conntrack --ctstate NEW  -j Cid4374297X29460.0
+    $IPTABLES -A OUTPUT  -s 1.1.1.1   -m conntrack --ctstate NEW  -j Cid4374297X29460.0
+    $IPTABLES -A OUTPUT  -s 2.2.2.2   -m conntrack --ctstate NEW  -j Cid4374297X29460.0
     grep -Ev '^#|^;|^\s*$' addr-table-1.tbl | while read L ; do
       set $L; at_atbl_1=$1; $IPTABLES -A Cid4374297X29460.0  -d $at_atbl_1   -j RETURN 
     done
@@ -390,8 +390,8 @@ script_body() {
     echo "Rule 2 (global)"
     # 
     $IPTABLES -N Cid4374309X29460.0
-    $IPTABLES -A OUTPUT  -s 1.1.1.1   -m state --state NEW  -j Cid4374309X29460.0
-    $IPTABLES -A OUTPUT  -s 2.2.2.2   -m state --state NEW  -j Cid4374309X29460.0
+    $IPTABLES -A OUTPUT  -s 1.1.1.1   -m conntrack --ctstate NEW  -j Cid4374309X29460.0
+    $IPTABLES -A OUTPUT  -s 2.2.2.2   -m conntrack --ctstate NEW  -j Cid4374309X29460.0
     grep -Ev '^#|^;|^\s*$' addr-table-1.tbl | while read L ; do
       set $L; at_atbl_1=$1; $IPTABLES -A Cid4374309X29460.0  -d $at_atbl_1   -j RETURN 
     done
@@ -402,10 +402,10 @@ script_body() {
     echo "Rule 3 (global)"
     # 
     grep -Ev '^#|^;|^\s*$' addr-table-1.tbl | while read L ; do
-      set $L; at_atbl_1=$1; $IPTABLES -A OUTPUT  -d $at_atbl_1   -m state --state NEW  -j ACCEPT 
+      set $L; at_atbl_1=$1; $IPTABLES -A OUTPUT  -d $at_atbl_1   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     grep -Ev '^#|^;|^\s*$' block-hosts.tbl | while read L ; do
-      set $L; at_block_these=$1; $IPTABLES -A OUTPUT  -d $at_block_these   -m state --state NEW  -j ACCEPT 
+      set $L; at_block_these=$1; $IPTABLES -A OUTPUT  -d $at_block_these   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 4 (global)
@@ -413,7 +413,7 @@ script_body() {
     echo "Rule 4 (global)"
     # 
     grep -Ev '^#|^;|^\s*$' addr-table-1.tbl | while read L ; do
-      set $L; at_atbl_1=$1; $IPTABLES -A INPUT  -s $at_atbl_1   -m state --state NEW  -j ACCEPT 
+      set $L; at_atbl_1=$1; $IPTABLES -A INPUT  -s $at_atbl_1   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 5 (global)
@@ -421,10 +421,10 @@ script_body() {
     echo "Rule 5 (global)"
     # 
     $IPTABLES -N Cid4374346X29460.0
-    $IPTABLES -A OUTPUT  -d 1.1.1.1   -m state --state NEW  -j Cid4374346X29460.0
-    $IPTABLES -A OUTPUT  -d 2.2.2.2   -m state --state NEW  -j Cid4374346X29460.0
-    $IPTABLES -A INPUT  -d 1.1.1.1   -m state --state NEW  -j Cid4374346X29460.0
-    $IPTABLES -A INPUT  -d 2.2.2.2   -m state --state NEW  -j Cid4374346X29460.0
+    $IPTABLES -A OUTPUT  -d 1.1.1.1   -m conntrack --ctstate NEW  -j Cid4374346X29460.0
+    $IPTABLES -A OUTPUT  -d 2.2.2.2   -m conntrack --ctstate NEW  -j Cid4374346X29460.0
+    $IPTABLES -A INPUT  -d 1.1.1.1   -m conntrack --ctstate NEW  -j Cid4374346X29460.0
+    $IPTABLES -A INPUT  -d 2.2.2.2   -m conntrack --ctstate NEW  -j Cid4374346X29460.0
     grep -Ev '^#|^;|^\s*$' addr-table-1.tbl | while read L ; do
       set $L; at_atbl_1=$1; $IPTABLES -A Cid4374346X29460.0  -s $at_atbl_1   -j RETURN 
     done
@@ -435,8 +435,8 @@ script_body() {
     echo "Rule 6 (global)"
     # 
     $IPTABLES -N Cid4374358X29460.0
-    $IPTABLES -A INPUT  -d 1.1.1.1   -m state --state NEW  -j Cid4374358X29460.0
-    $IPTABLES -A INPUT  -d 2.2.2.2   -m state --state NEW  -j Cid4374358X29460.0
+    $IPTABLES -A INPUT  -d 1.1.1.1   -m conntrack --ctstate NEW  -j Cid4374358X29460.0
+    $IPTABLES -A INPUT  -d 2.2.2.2   -m conntrack --ctstate NEW  -j Cid4374358X29460.0
     grep -Ev '^#|^;|^\s*$' addr-table-1.tbl | while read L ; do
       set $L; at_atbl_1=$1; $IPTABLES -A Cid4374358X29460.0  -s $at_atbl_1   -j RETURN 
     done
@@ -447,10 +447,10 @@ script_body() {
     echo "Rule 7 (global)"
     # 
     grep -Ev '^#|^;|^\s*$' addr-table-1.tbl | while read L ; do
-      set $L; at_atbl_1=$1; $IPTABLES -A INPUT  -s $at_atbl_1   -m state --state NEW  -j ACCEPT 
+      set $L; at_atbl_1=$1; $IPTABLES -A INPUT  -s $at_atbl_1   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     grep -Ev '^#|^;|^\s*$' block-hosts.tbl | while read L ; do
-      set $L; at_block_these=$1; $IPTABLES -A INPUT  -s $at_block_these   -m state --state NEW  -j ACCEPT 
+      set $L; at_block_these=$1; $IPTABLES -A INPUT  -s $at_block_these   -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 8 (global)
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/heartbeat_cluster_1_d_linux-1-d.fw.orig fwbuilder-5.1.0.3599/test/ipt/heartbeat_cluster_1_d_linux-1-d.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/heartbeat_cluster_1_d_linux-1-d.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/heartbeat_cluster_1_d_linux-1-d.fw.orig	2014-07-08 16:51:11.043999014 +0200
@@ -332,9 +332,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -441,20 +441,20 @@ script_body() {
     $IPTABLES -N In_RULE_0
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A INPUT -i eth0   -s $i_eth0   -m state --state NEW  -j In_RULE_0 
+    test -n "$i_eth0" && $IPTABLES -A INPUT -i eth0   -s $i_eth0   -m conntrack --ctstate NEW  -j In_RULE_0 
     done
-    $IPTABLES -A INPUT -i eth0   -s 172.20.0.1   -m state --state NEW  -j In_RULE_0
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_0
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.254   -m state --state NEW  -j In_RULE_0
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_0
+    $IPTABLES -A INPUT -i eth0   -s 172.20.0.1   -m conntrack --ctstate NEW  -j In_RULE_0
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_0
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.254   -m conntrack --ctstate NEW  -j In_RULE_0
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_0
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A FORWARD -i eth0   -s $i_eth0   -m state --state NEW  -j In_RULE_0 
+    test -n "$i_eth0" && $IPTABLES -A FORWARD -i eth0   -s $i_eth0   -m conntrack --ctstate NEW  -j In_RULE_0 
     done
-    $IPTABLES -A FORWARD -i eth0   -s 172.20.0.1   -m state --state NEW  -j In_RULE_0
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_0
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.254   -m state --state NEW  -j In_RULE_0
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_0
+    $IPTABLES -A FORWARD -i eth0   -s 172.20.0.1   -m conntrack --ctstate NEW  -j In_RULE_0
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_0
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.254   -m conntrack --ctstate NEW  -j In_RULE_0
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_0
     $IPTABLES -A In_RULE_0  -j LOG  --log-level info --log-prefix "RULE 0 -- DENY "
     $IPTABLES -A In_RULE_0  -j DROP
     # 
@@ -462,8 +462,8 @@ script_body() {
     # 
     echo "Rule 1 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (global)
     # 
@@ -471,7 +471,7 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
@@ -480,8 +480,8 @@ script_body() {
     # Firewall uses one of the machines
     # on internal network for DNS
     $IPTABLES -N RULE_3
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_3
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_3
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_3
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_3
     $IPTABLES -A RULE_3  -j LOG  --log-level info --log-prefix "RULE 3 -- ACCEPT "
     $IPTABLES -A RULE_3  -j ACCEPT
     # 
@@ -489,7 +489,7 @@ script_body() {
     # 
     echo "Rule 4 (global)"
     # 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (global)
     # 
@@ -498,7 +498,7 @@ script_body() {
     # fw is part of any and networks
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A OUTPUT -p tcp -m tcp  -s $i_eth0   -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A OUTPUT -p tcp -m tcp  -s $i_eth0   -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 6 (global)
@@ -508,7 +508,7 @@ script_body() {
     # fw is NOT part of any and networks
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A OUTPUT -p tcp -m tcp  -s $i_eth0   -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A OUTPUT -p tcp -m tcp  -s $i_eth0   -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 7 (global)
@@ -519,7 +519,7 @@ script_body() {
 
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A OUTPUT -p tcp -m tcp  -s $i_eth0   -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A OUTPUT -p tcp -m tcp  -s $i_eth0   -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 8 (global)
@@ -528,7 +528,7 @@ script_body() {
     # 
     # fw is part of any
     $IPTABLES -N Cid307958X52019.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j Cid307958X52019.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j Cid307958X52019.0
     $IPTABLES -A Cid307958X52019.0  -s 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid307958X52019.0  -s 192.168.1.254   -j ACCEPT
     # 
@@ -538,7 +538,7 @@ script_body() {
     # 
     # fw is not part of any
     $IPTABLES -N Cid625000X52019.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j Cid625000X52019.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j Cid625000X52019.0
     $IPTABLES -A Cid625000X52019.0  -s 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid625000X52019.0  -s 192.168.1.254   -j ACCEPT
     # 
@@ -547,15 +547,15 @@ script_body() {
     echo "Rule 10 (global)"
     # 
     # fw is not part of any
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.254   -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.254   -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 11 (global)
     # 
     echo "Rule 11 (global)"
     # 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.1   -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.2   -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.2   -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.1   -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.2   -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.2   -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 12 (global)
     # 
@@ -579,120 +579,120 @@ script_body() {
     # 
     echo "Rule 13 (eth0)"
     # 
-    $IPTABLES -A INPUT -i ! eth0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i ! eth0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o ! eth0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o ! eth0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i ! eth0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i ! eth0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o ! eth0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o ! eth0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 14 (eth0,eth1)
     # 
     echo "Rule 14 (eth0,eth1)"
     # 
-    $IPTABLES -A INPUT -i eth2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth2.100   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth2.100   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth2.100   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth2.100   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth2.100   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth2.100   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth2.100   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth2.100   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 15 (eth0)
     # 
     echo "Rule 15 (eth0)"
     # 
     # fw is part of any is OFF
-    $IPTABLES -A FORWARD -i ! eth0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o ! eth0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i ! eth0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o ! eth0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 16 (eth0,eth1)
     # 
     echo "Rule 16 (eth0,eth1)"
     # 
     # fw is part of any is OFF
-    $IPTABLES -A FORWARD -i eth2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth2.100   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth2.100   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth2.100   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth2.100   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 17 (eth0)
     # 
     echo "Rule 17 (eth0)"
     # 
     # fw is part of any is OFF
-    $IPTABLES -A FORWARD -i ! eth0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i ! eth0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 18 (eth0,eth1)
     # 
     echo "Rule 18 (eth0,eth1)"
     # 
     # fw is part of any is OFF
-    $IPTABLES -A FORWARD -i eth2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth2.100   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth2.100   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 19 (eth0)
     # 
     echo "Rule 19 (eth0)"
     # 
     # fw is part of any is OFF
-    $IPTABLES -A FORWARD -o ! eth0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o ! eth0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 20 (eth0,eth1)
     # 
     echo "Rule 20 (eth0,eth1)"
     # 
     # fw is part of any is OFF
-    $IPTABLES -A FORWARD -o eth2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth2.100   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth2.100   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 21 (eth0)
     # 
     echo "Rule 21 (eth0)"
     # 
-    $IPTABLES -A INPUT -i ! eth0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i ! eth0   -m conntrack --ctstate NEW  -j ACCEPT
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A OUTPUT -o ! eth0   -d $i_eth0   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A OUTPUT -o ! eth0   -d $i_eth0   -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A OUTPUT -o ! eth0   -d 172.20.0.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o ! eth0   -d 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o ! eth0   -d 192.168.1.254   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o ! eth0   -d 172.20.0.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o ! eth0   -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o ! eth0   -d 192.168.1.254   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 22 (eth0,eth1)
     # 
     echo "Rule 22 (eth0,eth1)"
     # 
-    $IPTABLES -A INPUT -i eth2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth2.100   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth2.100   -m conntrack --ctstate NEW  -j ACCEPT
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A OUTPUT -o eth2   -d $i_eth0   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A OUTPUT -o eth2   -d $i_eth0   -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A OUTPUT -o eth2   -d 172.20.0.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth2   -d 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth2   -d 192.168.1.254   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth2   -d 172.20.0.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth2   -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth2   -d 192.168.1.254   -m conntrack --ctstate NEW  -j ACCEPT
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A OUTPUT -o eth2.100   -d $i_eth0   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A OUTPUT -o eth2.100   -d $i_eth0   -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A OUTPUT -o eth2.100   -d 172.20.0.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth2.100   -d 192.168.1.1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth2.100   -d 192.168.1.254   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth2.100   -d 172.20.0.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth2.100   -d 192.168.1.1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth2.100   -d 192.168.1.254   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 23 (eth0)
     # 
     echo "Rule 23 (eth0)"
     # 
     # fw is part of any is OFF
-    $IPTABLES -A INPUT -i ! eth0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i ! eth0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 24 (eth0,eth1)
     # 
     echo "Rule 24 (eth0,eth1)"
     # 
     # fw is part of any is OFF
-    $IPTABLES -A INPUT -i eth2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth2.100   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth2.100   -m conntrack --ctstate NEW  -j ACCEPT
 }
 
 ip_forward() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/heartbeat_cluster_1_d_linux-2-d.fw.orig fwbuilder-5.1.0.3599/test/ipt/heartbeat_cluster_1_d_linux-2-d.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/heartbeat_cluster_1_d_linux-2-d.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/heartbeat_cluster_1_d_linux-2-d.fw.orig	2014-07-08 16:51:10.945000252 +0200
@@ -335,9 +335,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -443,20 +443,20 @@ script_body() {
     $IPTABLES -N In_RULE_0
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A INPUT -i eth0   -s $i_eth0   -m state --state NEW  -j In_RULE_0 
+    test -n "$i_eth0" && $IPTABLES -A INPUT -i eth0   -s $i_eth0   -m conntrack --ctstate NEW  -j In_RULE_0 
     done
-    $IPTABLES -A INPUT -i eth0   -s 172.20.0.2   -m state --state NEW  -j In_RULE_0
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.2   -m state --state NEW  -j In_RULE_0
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.254   -m state --state NEW  -j In_RULE_0
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_0
+    $IPTABLES -A INPUT -i eth0   -s 172.20.0.2   -m conntrack --ctstate NEW  -j In_RULE_0
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.2   -m conntrack --ctstate NEW  -j In_RULE_0
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.254   -m conntrack --ctstate NEW  -j In_RULE_0
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_0
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A FORWARD -i eth0   -s $i_eth0   -m state --state NEW  -j In_RULE_0 
+    test -n "$i_eth0" && $IPTABLES -A FORWARD -i eth0   -s $i_eth0   -m conntrack --ctstate NEW  -j In_RULE_0 
     done
-    $IPTABLES -A FORWARD -i eth0   -s 172.20.0.2   -m state --state NEW  -j In_RULE_0
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.2   -m state --state NEW  -j In_RULE_0
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.254   -m state --state NEW  -j In_RULE_0
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_0
+    $IPTABLES -A FORWARD -i eth0   -s 172.20.0.2   -m conntrack --ctstate NEW  -j In_RULE_0
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.2   -m conntrack --ctstate NEW  -j In_RULE_0
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.254   -m conntrack --ctstate NEW  -j In_RULE_0
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_0
     $IPTABLES -A In_RULE_0  -j LOG  --log-level info --log-prefix "RULE 0 -- DENY "
     $IPTABLES -A In_RULE_0  -j DROP
     # 
@@ -464,8 +464,8 @@ script_body() {
     # 
     echo "Rule 1 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (global)
     # 
@@ -473,7 +473,7 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
@@ -482,8 +482,8 @@ script_body() {
     # Firewall uses one of the machines
     # on internal network for DNS
     $IPTABLES -N RULE_3
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_3
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_3
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_3
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_3
     $IPTABLES -A RULE_3  -j LOG  --log-level info --log-prefix "RULE 3 -- ACCEPT "
     $IPTABLES -A RULE_3  -j ACCEPT
     # 
@@ -491,7 +491,7 @@ script_body() {
     # 
     echo "Rule 4 (global)"
     # 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (global)
     # 
@@ -500,7 +500,7 @@ script_body() {
     # fw is part of any and networks
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A OUTPUT -p tcp -m tcp  -s $i_eth0   -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A OUTPUT -p tcp -m tcp  -s $i_eth0   -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 6 (global)
@@ -510,7 +510,7 @@ script_body() {
     # fw is NOT part of any and networks
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A OUTPUT -p tcp -m tcp  -s $i_eth0   -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A OUTPUT -p tcp -m tcp  -s $i_eth0   -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 7 (global)
@@ -521,7 +521,7 @@ script_body() {
 
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A OUTPUT -p tcp -m tcp  -s $i_eth0   -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A OUTPUT -p tcp -m tcp  -s $i_eth0   -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT 
     done
     # 
     # Rule 8 (global)
@@ -530,7 +530,7 @@ script_body() {
     # 
     # fw is part of any
     $IPTABLES -N Cid307958X52019.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j Cid307958X52019.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j Cid307958X52019.0
     $IPTABLES -A Cid307958X52019.0  -s 192.168.1.2   -j ACCEPT
     $IPTABLES -A Cid307958X52019.0  -s 192.168.1.254   -j ACCEPT
     # 
@@ -540,7 +540,7 @@ script_body() {
     # 
     # fw is not part of any
     $IPTABLES -N Cid625000X52019.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j Cid625000X52019.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j Cid625000X52019.0
     $IPTABLES -A Cid625000X52019.0  -s 192.168.1.2   -j ACCEPT
     $IPTABLES -A Cid625000X52019.0  -s 192.168.1.254   -j ACCEPT
     # 
@@ -549,15 +549,15 @@ script_body() {
     echo "Rule 10 (global)"
     # 
     # fw is not part of any
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.254   -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.254   -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 11 (global)
     # 
     echo "Rule 11 (global)"
     # 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.2   -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.1   -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.1   -d 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.2   -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.1   -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.1   -d 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 12 (global)
     # 
@@ -581,120 +581,120 @@ script_body() {
     # 
     echo "Rule 13 (eth0)"
     # 
-    $IPTABLES -A INPUT -i ! eth0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i ! eth0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o ! eth0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o ! eth0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i ! eth0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i ! eth0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o ! eth0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o ! eth0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 14 (eth0,eth1)
     # 
     echo "Rule 14 (eth0,eth1)"
     # 
-    $IPTABLES -A INPUT -i eth2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth2.100   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth2.100   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth2.100   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth2.100   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth2.100   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth2.100   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth2.100   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth2.100   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 15 (eth0)
     # 
     echo "Rule 15 (eth0)"
     # 
     # fw is part of any is OFF
-    $IPTABLES -A FORWARD -i ! eth0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o ! eth0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i ! eth0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o ! eth0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 16 (eth0,eth1)
     # 
     echo "Rule 16 (eth0,eth1)"
     # 
     # fw is part of any is OFF
-    $IPTABLES -A FORWARD -i eth2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth2.100   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth2.100   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth2.100   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth2.100   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 17 (eth0)
     # 
     echo "Rule 17 (eth0)"
     # 
     # fw is part of any is OFF
-    $IPTABLES -A FORWARD -i ! eth0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i ! eth0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 18 (eth0,eth1)
     # 
     echo "Rule 18 (eth0,eth1)"
     # 
     # fw is part of any is OFF
-    $IPTABLES -A FORWARD -i eth2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -i eth2.100   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth2.100   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 19 (eth0)
     # 
     echo "Rule 19 (eth0)"
     # 
     # fw is part of any is OFF
-    $IPTABLES -A FORWARD -o ! eth0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o ! eth0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 20 (eth0,eth1)
     # 
     echo "Rule 20 (eth0,eth1)"
     # 
     # fw is part of any is OFF
-    $IPTABLES -A FORWARD -o eth2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth2.100   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth2.100   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 21 (eth0)
     # 
     echo "Rule 21 (eth0)"
     # 
-    $IPTABLES -A INPUT -i ! eth0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i ! eth0   -m conntrack --ctstate NEW  -j ACCEPT
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A OUTPUT -o ! eth0   -d $i_eth0   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A OUTPUT -o ! eth0   -d $i_eth0   -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A OUTPUT -o ! eth0   -d 172.20.0.2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o ! eth0   -d 192.168.1.2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o ! eth0   -d 192.168.1.254   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o ! eth0   -d 172.20.0.2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o ! eth0   -d 192.168.1.2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o ! eth0   -d 192.168.1.254   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 22 (eth0,eth1)
     # 
     echo "Rule 22 (eth0,eth1)"
     # 
-    $IPTABLES -A INPUT -i eth2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth2.100   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth2.100   -m conntrack --ctstate NEW  -j ACCEPT
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A OUTPUT -o eth2   -d $i_eth0   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A OUTPUT -o eth2   -d $i_eth0   -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A OUTPUT -o eth2   -d 172.20.0.2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth2   -d 192.168.1.2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth2   -d 192.168.1.254   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth2   -d 172.20.0.2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth2   -d 192.168.1.2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth2   -d 192.168.1.254   -m conntrack --ctstate NEW  -j ACCEPT
     for i_eth0 in $i_eth0_list
     do
-    test -n "$i_eth0" && $IPTABLES -A OUTPUT -o eth2.100   -d $i_eth0   -m state --state NEW  -j ACCEPT 
+    test -n "$i_eth0" && $IPTABLES -A OUTPUT -o eth2.100   -d $i_eth0   -m conntrack --ctstate NEW  -j ACCEPT 
     done
-    $IPTABLES -A OUTPUT -o eth2.100   -d 172.20.0.2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth2.100   -d 192.168.1.2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth2.100   -d 192.168.1.254   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth2.100   -d 172.20.0.2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth2.100   -d 192.168.1.2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth2.100   -d 192.168.1.254   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 23 (eth0)
     # 
     echo "Rule 23 (eth0)"
     # 
     # fw is part of any is OFF
-    $IPTABLES -A INPUT -i ! eth0   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i ! eth0   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 24 (eth0,eth1)
     # 
     echo "Rule 24 (eth0,eth1)"
     # 
     # fw is part of any is OFF
-    $IPTABLES -A INPUT -i eth2   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -i eth2.100   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth2   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth2.100   -m conntrack --ctstate NEW  -j ACCEPT
 }
 
 ip_forward() {
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/heartbeat_cluster_1_linux-1.fw.orig fwbuilder-5.1.0.3599/test/ipt/heartbeat_cluster_1_linux-1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/heartbeat_cluster_1_linux-1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/heartbeat_cluster_1_linux-1.fw.orig	2014-07-08 16:51:10.950000189 +0200
@@ -416,9 +416,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -491,8 +491,8 @@ script_body() {
     # 
     echo "Rule 0 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (eth0)
     # 
@@ -500,18 +500,18 @@ script_body() {
     # 
     # anti spoofing rule
     $IPTABLES -N In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.100.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.100.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.100.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.100.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
     $IPTABLES -A In_RULE_1  -j LOG  --log-level info --log-prefix "RULE 1 -- DENY "
     $IPTABLES -A In_RULE_1  -j DROP
     # 
@@ -519,8 +519,8 @@ script_body() {
     # 
     echo "Rule 2 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
@@ -528,7 +528,7 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
@@ -536,9 +536,9 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (global)
     # 
@@ -547,8 +547,8 @@ script_body() {
     # Firewall uses one of the machines
     # on internal network for DNS
     $IPTABLES -N RULE_5
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
     $IPTABLES -A RULE_5  -j LOG  --log-level info --log-prefix "RULE 5 -- ACCEPT "
     $IPTABLES -A RULE_5  -j ACCEPT
     # 
@@ -599,20 +599,20 @@ script_body() {
     # 
     # fw is part of any
     $IPTABLES -N Cid997025X96143.0
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid997025X96143.0
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid997025X96143.0
     $IPTABLES -A Cid997025X96143.0  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid997025X96143.0  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid997025X96143.0  -s 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid997025X96143.0  -s 192.168.1.2   -j ACCEPT
     $IPTABLES -A Cid997025X96143.0  -s 192.168.100.1   -j ACCEPT
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 11 (global)
     # 
     echo "Rule 11 (global)"
     # 
     # fw is NOT part of any
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 12 (global)
     # 
@@ -620,7 +620,7 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid143289X96143.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid143289X96143.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid143289X96143.0
     $IPTABLES -A Cid143289X96143.0  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid143289X96143.0  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid143289X96143.0  -s 192.168.100.1   -j ACCEPT
@@ -631,7 +631,7 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid1946680X96143.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid1946680X96143.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid1946680X96143.0
     $IPTABLES -A Cid1946680X96143.0  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid1946680X96143.0  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid1946680X96143.0  -s 192.168.100.1   -j ACCEPT
@@ -642,12 +642,12 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid378955X96143.0
-    $IPTABLES -A FORWARD -i eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid378955X96143.0
+    $IPTABLES -A FORWARD -i eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid378955X96143.0
     $IPTABLES -A Cid378955X96143.0  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid378955X96143.0  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid378955X96143.0  -s 192.168.100.1   -j ACCEPT
     $IPTABLES -N Cid378955X96143.1
-    $IPTABLES -A OUTPUT -o eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid378955X96143.1
+    $IPTABLES -A OUTPUT -o eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid378955X96143.1
     $IPTABLES -A Cid378955X96143.1  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid378955X96143.1  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid378955X96143.1  -s 192.168.100.1   -j ACCEPT
@@ -658,7 +658,7 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid1801407X96143.0
-    $IPTABLES -A OUTPUT -o eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid1801407X96143.0
+    $IPTABLES -A OUTPUT -o eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid1801407X96143.0
     $IPTABLES -A Cid1801407X96143.0  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid1801407X96143.0  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid1801407X96143.0  -s 192.168.100.1   -j ACCEPT
@@ -669,10 +669,10 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid143343X96143.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid143343X96143.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid143343X96143.0
     $IPTABLES -A Cid143343X96143.0  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid143343X96143.0  -s 192.168.100.1   -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 17 (eth0)
     # 
@@ -680,15 +680,15 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid2241935X96143.0
-    $IPTABLES -A FORWARD -i eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid2241935X96143.0
+    $IPTABLES -A FORWARD -i eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid2241935X96143.0
     $IPTABLES -A Cid2241935X96143.0  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid2241935X96143.0  -s 192.168.100.1   -j ACCEPT
-    $IPTABLES -A FORWARD -i eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     $IPTABLES -N Cid2241935X96143.1
-    $IPTABLES -A OUTPUT -o eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid2241935X96143.1
+    $IPTABLES -A OUTPUT -o eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid2241935X96143.1
     $IPTABLES -A Cid2241935X96143.1  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid2241935X96143.1  -s 192.168.100.1   -j ACCEPT
-    $IPTABLES -A FORWARD -o eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 18 (eth0)
     # 
@@ -696,10 +696,10 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid2241981X96143.0
-    $IPTABLES -A OUTPUT -o eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid2241981X96143.0
+    $IPTABLES -A OUTPUT -o eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid2241981X96143.0
     $IPTABLES -A Cid2241981X96143.0  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid2241981X96143.0  -s 192.168.100.1   -j ACCEPT
-    $IPTABLES -A FORWARD -o eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 19 (global)
     # 
@@ -707,7 +707,7 @@ script_body() {
     # 
     # using interface of another cluster in the rule
     $IPTABLES -N Cid8228X45618.0
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid8228X45618.0
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid8228X45618.0
     $IPTABLES -A Cid8228X45618.0  -s 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid8228X45618.0  -s 192.168.1.2   -j ACCEPT
     $IPTABLES -A Cid8228X45618.0  -s 192.168.1.100   -j ACCEPT
@@ -717,7 +717,7 @@ script_body() {
     echo "Rule 20 (global)"
     # 
     $IPTABLES -N Cid147047X84105.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid147047X84105.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid147047X84105.0
     $IPTABLES -A Cid147047X84105.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid147047X84105.0  -d 192.168.1.2   -j ACCEPT
     $IPTABLES -A Cid147047X84105.0  -d 192.168.1.100   -j ACCEPT
@@ -727,9 +727,9 @@ script_body() {
     echo "Rule 21 (global)"
     # 
     $IPTABLES -N RULE_21
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j RULE_21
-    $IPTABLES -A INPUT  -m state --state NEW  -j RULE_21
-    $IPTABLES -A FORWARD  -m state --state NEW  -j RULE_21
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j RULE_21
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j RULE_21
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j RULE_21
     $IPTABLES -A RULE_21  -j LOG  --log-level info --log-prefix "RULE 21 -- DENY "
     $IPTABLES -A RULE_21  -j DROP
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/heartbeat_cluster_1_linux-2.fw.orig fwbuilder-5.1.0.3599/test/ipt/heartbeat_cluster_1_linux-2.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/heartbeat_cluster_1_linux-2.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/heartbeat_cluster_1_linux-2.fw.orig	2014-07-08 16:51:10.523005527 +0200
@@ -321,9 +321,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -399,8 +399,8 @@ script_body() {
     # 
     echo "Rule 0 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (eth0)
     # 
@@ -408,16 +408,16 @@ script_body() {
     # 
     # anti spoofing rule
     $IPTABLES -N In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
     $IPTABLES -A In_RULE_1  -j LOG  --log-level info --log-prefix "RULE 1 -- DENY "
     $IPTABLES -A In_RULE_1  -j DROP
     # 
@@ -425,8 +425,8 @@ script_body() {
     # 
     echo "Rule 2 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
@@ -434,7 +434,7 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
@@ -442,9 +442,9 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (global)
     # 
@@ -453,8 +453,8 @@ script_body() {
     # Firewall uses one of the machines
     # on internal network for DNS
     $IPTABLES -N RULE_5
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
     $IPTABLES -A RULE_5  -j LOG  --log-level info --log-prefix "RULE 5 -- ACCEPT "
     $IPTABLES -A RULE_5  -j ACCEPT
     # 
@@ -503,19 +503,19 @@ script_body() {
     # 
     # fw is part of any
     $IPTABLES -N Cid997025X96143.0
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid997025X96143.0
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid997025X96143.0
     $IPTABLES -A Cid997025X96143.0  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid997025X96143.0  -s 172.24.0.3   -j ACCEPT
     $IPTABLES -A Cid997025X96143.0  -s 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid997025X96143.0  -s 192.168.1.3   -j ACCEPT
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 11 (global)
     # 
     echo "Rule 11 (global)"
     # 
     # fw is NOT part of any
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 12 (global)
     # 
@@ -523,7 +523,7 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid143289X96143.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid143289X96143.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid143289X96143.0
     $IPTABLES -A Cid143289X96143.0  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid143289X96143.0  -s 172.24.0.3   -j ACCEPT
     # 
@@ -533,7 +533,7 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid1946680X96143.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid1946680X96143.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid1946680X96143.0
     $IPTABLES -A Cid1946680X96143.0  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid1946680X96143.0  -s 172.24.0.3   -j ACCEPT
     # 
@@ -543,11 +543,11 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid378955X96143.0
-    $IPTABLES -A FORWARD -i eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid378955X96143.0
+    $IPTABLES -A FORWARD -i eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid378955X96143.0
     $IPTABLES -A Cid378955X96143.0  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid378955X96143.0  -s 172.24.0.3   -j ACCEPT
     $IPTABLES -N Cid378955X96143.1
-    $IPTABLES -A OUTPUT -o eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid378955X96143.1
+    $IPTABLES -A OUTPUT -o eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid378955X96143.1
     $IPTABLES -A Cid378955X96143.1  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid378955X96143.1  -s 172.24.0.3   -j ACCEPT
     # 
@@ -557,7 +557,7 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid1801407X96143.0
-    $IPTABLES -A OUTPUT -o eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid1801407X96143.0
+    $IPTABLES -A OUTPUT -o eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid1801407X96143.0
     $IPTABLES -A Cid1801407X96143.0  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid1801407X96143.0  -s 172.24.0.3   -j ACCEPT
     # 
@@ -566,9 +566,9 @@ script_body() {
     echo "Rule 16 (global)"
     # 
     # fw is NOT part of any
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     $IPTABLES -N Cid143343X96143.0
-    $IPTABLES -A FORWARD -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid143343X96143.0
+    $IPTABLES -A FORWARD -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid143343X96143.0
     $IPTABLES -A Cid143343X96143.0  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid143343X96143.0  -s 192.168.100.1   -j ACCEPT
     # 
@@ -577,14 +577,14 @@ script_body() {
     echo "Rule 17 (eth0)"
     # 
     # fw is NOT part of any
-    $IPTABLES -A FORWARD -i eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -i eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     $IPTABLES -N Cid2241935X96143.0
-    $IPTABLES -A FORWARD -i eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid2241935X96143.0
+    $IPTABLES -A FORWARD -i eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid2241935X96143.0
     $IPTABLES -A Cid2241935X96143.0  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid2241935X96143.0  -s 192.168.100.1   -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     $IPTABLES -N Cid2241935X96143.1
-    $IPTABLES -A FORWARD -o eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid2241935X96143.1
+    $IPTABLES -A FORWARD -o eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid2241935X96143.1
     $IPTABLES -A Cid2241935X96143.1  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid2241935X96143.1  -s 192.168.100.1   -j ACCEPT
     # 
@@ -593,9 +593,9 @@ script_body() {
     echo "Rule 18 (eth0)"
     # 
     # fw is NOT part of any
-    $IPTABLES -A OUTPUT -o eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     $IPTABLES -N Cid2241981X96143.0
-    $IPTABLES -A FORWARD -o eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid2241981X96143.0
+    $IPTABLES -A FORWARD -o eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid2241981X96143.0
     $IPTABLES -A Cid2241981X96143.0  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid2241981X96143.0  -s 192.168.100.1   -j ACCEPT
     # 
@@ -605,7 +605,7 @@ script_body() {
     # 
     # using interface of another cluster in the rule
     $IPTABLES -N Cid8228X45618.0
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid8228X45618.0
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid8228X45618.0
     $IPTABLES -A Cid8228X45618.0  -s 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid8228X45618.0  -s 192.168.1.2   -j ACCEPT
     $IPTABLES -A Cid8228X45618.0  -s 192.168.1.100   -j ACCEPT
@@ -615,7 +615,7 @@ script_body() {
     echo "Rule 20 (global)"
     # 
     $IPTABLES -N Cid147047X84105.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid147047X84105.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid147047X84105.0
     $IPTABLES -A Cid147047X84105.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid147047X84105.0  -d 192.168.1.2   -j ACCEPT
     $IPTABLES -A Cid147047X84105.0  -d 192.168.1.100   -j ACCEPT
@@ -625,9 +625,9 @@ script_body() {
     echo "Rule 21 (global)"
     # 
     $IPTABLES -N RULE_21
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j RULE_21
-    $IPTABLES -A INPUT  -m state --state NEW  -j RULE_21
-    $IPTABLES -A FORWARD  -m state --state NEW  -j RULE_21
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j RULE_21
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j RULE_21
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j RULE_21
     $IPTABLES -A RULE_21  -j LOG  --log-level info --log-prefix "RULE 21 -- DENY "
     $IPTABLES -A RULE_21  -j DROP
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/heartbeat_cluster_2_linux-1.fw.orig fwbuilder-5.1.0.3599/test/ipt/heartbeat_cluster_2_linux-1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/heartbeat_cluster_2_linux-1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/heartbeat_cluster_2_linux-1.fw.orig	2014-07-08 16:51:10.933000402 +0200
@@ -416,9 +416,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -479,8 +479,8 @@ script_body() {
     # 
     echo "Rule 0 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (eth0)
     # 
@@ -488,18 +488,18 @@ script_body() {
     # 
     # anti spoofing rule
     $IPTABLES -N In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.100.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.100.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.100.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.100.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
     $IPTABLES -A In_RULE_1  -j LOG  --log-level info --log-prefix "RULE 1 -- DENY "
     $IPTABLES -A In_RULE_1  -j DROP
     # 
@@ -507,8 +507,8 @@ script_body() {
     # 
     echo "Rule 2 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
@@ -516,7 +516,7 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
@@ -524,9 +524,9 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (global)
     # 
@@ -535,8 +535,8 @@ script_body() {
     # Firewall uses one of the machines
     # on internal network for DNS
     $IPTABLES -N RULE_5
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
     $IPTABLES -A RULE_5  -j LOG  --log-level info --log-prefix "RULE 5 -- ACCEPT "
     $IPTABLES -A RULE_5  -j ACCEPT
     # 
@@ -582,18 +582,18 @@ script_body() {
     # 
     echo "Rule 9 (global)"
     # 
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 10 (global)
     # 
     echo "Rule 10 (global)"
     # 
     $IPTABLES -N RULE_10
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j RULE_10
-    $IPTABLES -A INPUT  -m state --state NEW  -j RULE_10
-    $IPTABLES -A FORWARD  -m state --state NEW  -j RULE_10
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j RULE_10
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j RULE_10
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j RULE_10
     $IPTABLES -A RULE_10  -j LOG  --log-level info --log-prefix "RULE 10 -- DENY "
     $IPTABLES -A RULE_10  -j DROP
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/heartbeat_cluster_2_linux-2.fw.orig fwbuilder-5.1.0.3599/test/ipt/heartbeat_cluster_2_linux-2.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/heartbeat_cluster_2_linux-2.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/heartbeat_cluster_2_linux-2.fw.orig	2014-07-08 16:51:10.492005915 +0200
@@ -321,9 +321,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -396,8 +396,8 @@ script_body() {
     # 
     echo "Rule 0 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (eth0)
     # 
@@ -405,16 +405,16 @@ script_body() {
     # 
     # anti spoofing rule
     $IPTABLES -N In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
     $IPTABLES -A In_RULE_1  -j LOG  --log-level info --log-prefix "RULE 1 -- DENY "
     $IPTABLES -A In_RULE_1  -j DROP
     # 
@@ -422,8 +422,8 @@ script_body() {
     # 
     echo "Rule 2 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
@@ -431,7 +431,7 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
@@ -439,9 +439,9 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (global)
     # 
@@ -450,8 +450,8 @@ script_body() {
     # Firewall uses one of the machines
     # on internal network for DNS
     $IPTABLES -N RULE_5
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
     $IPTABLES -A RULE_5  -j LOG  --log-level info --log-prefix "RULE 5 -- ACCEPT "
     $IPTABLES -A RULE_5  -j ACCEPT
     # 
@@ -495,18 +495,18 @@ script_body() {
     # 
     echo "Rule 9 (global)"
     # 
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 10 (global)
     # 
     echo "Rule 10 (global)"
     # 
     $IPTABLES -N RULE_10
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j RULE_10
-    $IPTABLES -A INPUT  -m state --state NEW  -j RULE_10
-    $IPTABLES -A FORWARD  -m state --state NEW  -j RULE_10
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j RULE_10
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j RULE_10
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j RULE_10
     $IPTABLES -A RULE_10  -j LOG  --log-level info --log-prefix "RULE 10 -- DENY "
     $IPTABLES -A RULE_10  -j DROP
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/host.fw.orig fwbuilder-5.1.0.3599/test/ipt/host.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/host.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/host.fw.orig	2014-07-08 16:51:10.402007040 +0200
@@ -317,9 +317,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -342,30 +342,30 @@ script_body() {
     echo "Rule 1 (lo)"
     # 
     # allow everything on loopback
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (lo)
     # 
     echo "Rule 2 (lo)"
     # 
     # allow everything on loopback
-    $IPTABLES -A OUTPUT -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (lo)
     # 
     echo "Rule 3 (lo)"
     # 
     $IPTABLES -N Cid3BD8ECC6.0
-    $IPTABLES -A INPUT -i lo   -s 22.22.22.22   -m state --state NEW  -j Cid3BD8ECC6.0
-    $IPTABLES -A INPUT -i lo   -s 127.0.0.1   -m state --state NEW  -j Cid3BD8ECC6.0
+    $IPTABLES -A INPUT -i lo   -s 22.22.22.22   -m conntrack --ctstate NEW  -j Cid3BD8ECC6.0
+    $IPTABLES -A INPUT -i lo   -s 127.0.0.1   -m conntrack --ctstate NEW  -j Cid3BD8ECC6.0
     $IPTABLES -N In_RULE_3
     $IPTABLES -A Cid3BD8ECC6.0  -d 22.22.22.22   -j In_RULE_3
     $IPTABLES -A Cid3BD8ECC6.0  -d 127.0.0.1   -j In_RULE_3
     $IPTABLES -A In_RULE_3  -j LOG  --log-level debug
     $IPTABLES -A In_RULE_3  -j ACCEPT
     $IPTABLES -N Cid3BD8ECC6.1
-    $IPTABLES -A OUTPUT -o lo   -s 22.22.22.22   -m state --state NEW  -j Cid3BD8ECC6.1
-    $IPTABLES -A OUTPUT -o lo   -s 127.0.0.1   -m state --state NEW  -j Cid3BD8ECC6.1
+    $IPTABLES -A OUTPUT -o lo   -s 22.22.22.22   -m conntrack --ctstate NEW  -j Cid3BD8ECC6.1
+    $IPTABLES -A OUTPUT -o lo   -s 127.0.0.1   -m conntrack --ctstate NEW  -j Cid3BD8ECC6.1
     $IPTABLES -N Out_RULE_3
     $IPTABLES -A Cid3BD8ECC6.1  -d 22.22.22.22   -j Out_RULE_3
     $IPTABLES -A Cid3BD8ECC6.1  -d 127.0.0.1   -j Out_RULE_3
@@ -376,8 +376,8 @@ script_body() {
     # 
     echo "Rule 7 (global)"
     # 
-    $IPTABLES -A INPUT  -s 22.22.22.22   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 22.22.22.22   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 8 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/ipcop1.fw.orig fwbuilder-5.1.0.3599/test/ipt/ipcop1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/ipcop1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/ipcop1.fw.orig	2014-07-08 16:51:11.037999089 +0200
@@ -161,8 +161,8 @@ script_body() {
     # 
     echo "Rule 0 (global)"
     # 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 10.3.14.40   --dport 80  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -d 10.3.14.40   --dport 80  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 10.3.14.40   --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -d 10.3.14.40   --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/large_policy_test.fwb fwbuilder-5.1.0.3599/test/ipt/large_policy_test.fwb
--- fwbuilder-5.1.0.3599-orig/test/ipt/large_policy_test.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/large_policy_test.fwb	2014-07-08 16:51:10.581004802 +0200
@@ -104,14 +104,14 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"/>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
         <CustomServiceCommand platform="Undefined"/>
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"/>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
         <ServiceGroup id="sg-DHCP" name="DHCP" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/linux-1.fw.orig fwbuilder-5.1.0.3599/test/ipt/linux-1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/linux-1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/linux-1.fw.orig	2014-07-08 16:51:10.384007265 +0200
@@ -394,9 +394,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -471,8 +471,8 @@ script_body() {
     # 
     echo "Rule 0 (eth0)"
     # 
-    $IPTABLES -A INPUT  -i eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -o eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -i eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -o eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (eth0)
     # 
@@ -480,18 +480,18 @@ script_body() {
     # 
     # anti spoofing rule
     $IPTABLES -N In_RULE_1
-    $IPTABLES -A INPUT  -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT  -i eth0   -s 172.24.0.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT  -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT  -i eth0   -s 192.168.1.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT  -i eth0   -s 192.168.100.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT  -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD  -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD  -i eth0   -s 172.24.0.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD  -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD  -i eth0   -s 192.168.1.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD  -i eth0   -s 192.168.100.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD  -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
+    $IPTABLES -A INPUT  -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT  -i eth0   -s 172.24.0.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT  -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT  -i eth0   -s 192.168.1.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT  -i eth0   -s 192.168.100.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT  -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD  -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD  -i eth0   -s 172.24.0.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD  -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD  -i eth0   -s 192.168.1.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD  -i eth0   -s 192.168.100.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD  -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
     $IPTABLES -A In_RULE_1  -j LOG  --log-level info --log-prefix "RULE 1 -- DENY "
     $IPTABLES -A In_RULE_1  -j DROP
     # 
@@ -499,8 +499,8 @@ script_body() {
     # 
     echo "Rule 2 (lo)"
     # 
-    $IPTABLES -A INPUT  -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
@@ -508,7 +508,7 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
@@ -516,9 +516,9 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (global)
     # 
@@ -527,8 +527,8 @@ script_body() {
     # Firewall uses one of the machines
     # on internal network for DNS
     $IPTABLES -N RULE_5
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
     $IPTABLES -A RULE_5  -j LOG  --log-level info --log-prefix "RULE 5 -- ACCEPT "
     $IPTABLES -A RULE_5  -j ACCEPT
     # 
@@ -579,20 +579,20 @@ script_body() {
     # 
     # fw is part of any
     $IPTABLES -N Cid997025X96143.0
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid997025X96143.0
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid997025X96143.0
     $IPTABLES -A Cid997025X96143.0  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid997025X96143.0  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid997025X96143.0  -s 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid997025X96143.0  -s 192.168.1.2   -j ACCEPT
     $IPTABLES -A Cid997025X96143.0  -s 192.168.100.1   -j ACCEPT
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 11 (global)
     # 
     echo "Rule 11 (global)"
     # 
     # fw is NOT part of any
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 12 (global)
     # 
@@ -600,7 +600,7 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid143289X96143.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid143289X96143.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid143289X96143.0
     $IPTABLES -A Cid143289X96143.0  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid143289X96143.0  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid143289X96143.0  -s 192.168.100.1   -j ACCEPT
@@ -611,7 +611,7 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid1946680X96143.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid1946680X96143.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid1946680X96143.0
     $IPTABLES -A Cid1946680X96143.0   -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid1946680X96143.0   -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid1946680X96143.0   -s 192.168.100.1   -j ACCEPT
@@ -622,12 +622,12 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid378955X96143.0
-    $IPTABLES -A FORWARD  -i eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid378955X96143.0
+    $IPTABLES -A FORWARD  -i eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid378955X96143.0
     $IPTABLES -A Cid378955X96143.0  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid378955X96143.0  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid378955X96143.0  -s 192.168.100.1   -j ACCEPT
     $IPTABLES -N Cid378955X96143.1
-    $IPTABLES -A OUTPUT  -o eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid378955X96143.1
+    $IPTABLES -A OUTPUT  -o eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid378955X96143.1
     $IPTABLES -A Cid378955X96143.1  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid378955X96143.1  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid378955X96143.1  -s 192.168.100.1   -j ACCEPT
@@ -638,7 +638,7 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid1801407X96143.0
-    $IPTABLES -A OUTPUT  -o eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid1801407X96143.0
+    $IPTABLES -A OUTPUT  -o eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid1801407X96143.0
     $IPTABLES -A Cid1801407X96143.0  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid1801407X96143.0  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid1801407X96143.0  -s 192.168.100.1   -j ACCEPT
@@ -649,10 +649,10 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid143343X96143.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid143343X96143.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid143343X96143.0
     $IPTABLES -A Cid143343X96143.0  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid143343X96143.0  -s 192.168.100.1   -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 17 (eth0)
     # 
@@ -660,15 +660,15 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid2241935X96143.0
-    $IPTABLES -A FORWARD  -i eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid2241935X96143.0
+    $IPTABLES -A FORWARD  -i eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid2241935X96143.0
     $IPTABLES -A Cid2241935X96143.0  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid2241935X96143.0  -s 192.168.100.1   -j ACCEPT
-    $IPTABLES -A FORWARD  -i eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -i eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     $IPTABLES -N Cid2241935X96143.1
-    $IPTABLES -A OUTPUT  -o eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid2241935X96143.1
+    $IPTABLES -A OUTPUT  -o eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid2241935X96143.1
     $IPTABLES -A Cid2241935X96143.1  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid2241935X96143.1  -s 192.168.100.1   -j ACCEPT
-    $IPTABLES -A FORWARD  -o eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -o eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 18 (eth0)
     # 
@@ -676,10 +676,10 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid2241981X96143.0
-    $IPTABLES -A OUTPUT  -o eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid2241981X96143.0
+    $IPTABLES -A OUTPUT  -o eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid2241981X96143.0
     $IPTABLES -A Cid2241981X96143.0  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid2241981X96143.0  -s 192.168.100.1   -j ACCEPT
-    $IPTABLES -A FORWARD  -o eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -o eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 19 (global)
     # 
@@ -687,7 +687,7 @@ script_body() {
     # 
     # using interface of another cluster in the rule
     $IPTABLES -N Cid8228X45618.0
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid8228X45618.0
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid8228X45618.0
     $IPTABLES -A Cid8228X45618.0   -s 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid8228X45618.0   -s 192.168.1.2   -j ACCEPT
     $IPTABLES -A Cid8228X45618.0   -s 192.168.1.100   -j ACCEPT
@@ -697,7 +697,7 @@ script_body() {
     echo "Rule 20 (global)"
     # 
     $IPTABLES -N Cid147047X84105.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid147047X84105.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid147047X84105.0
     $IPTABLES -A Cid147047X84105.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid147047X84105.0  -d 192.168.1.2   -j ACCEPT
     $IPTABLES -A Cid147047X84105.0  -d 192.168.1.100   -j ACCEPT
@@ -707,9 +707,9 @@ script_body() {
     echo "Rule 21 (global)"
     # 
     $IPTABLES -N RULE_21
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j RULE_21
-    $IPTABLES -A INPUT  -m state --state NEW  -j RULE_21
-    $IPTABLES -A FORWARD  -m state --state NEW  -j RULE_21
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j RULE_21
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j RULE_21
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j RULE_21
     $IPTABLES -A RULE_21  -j LOG  --log-level info --log-prefix "RULE 21 -- DENY "
     $IPTABLES -A RULE_21  -j DROP
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/linux-2.fw.orig fwbuilder-5.1.0.3599/test/ipt/linux-2.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/linux-2.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/linux-2.fw.orig	2014-07-08 16:51:10.510005690 +0200
@@ -299,9 +299,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -378,8 +378,8 @@ script_body() {
     # 
     echo "Rule 0 (eth0)"
     # 
-    $IPTABLES -A INPUT  -i eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -o eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -i eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -o eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (eth0)
     # 
@@ -387,16 +387,16 @@ script_body() {
     # 
     # anti spoofing rule
     $IPTABLES -N In_RULE_1
-    $IPTABLES -A INPUT  -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT  -i eth0   -s 172.24.0.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT  -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT  -i eth0   -s 192.168.1.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT  -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD  -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD  -i eth0   -s 172.24.0.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD  -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD  -i eth0   -s 192.168.1.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD  -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
+    $IPTABLES -A INPUT  -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT  -i eth0   -s 172.24.0.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT  -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT  -i eth0   -s 192.168.1.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT  -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD  -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD  -i eth0   -s 172.24.0.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD  -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD  -i eth0   -s 192.168.1.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD  -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
     $IPTABLES -A In_RULE_1  -j LOG  --log-level info --log-prefix "RULE 1 -- DENY "
     $IPTABLES -A In_RULE_1  -j DROP
     # 
@@ -404,8 +404,8 @@ script_body() {
     # 
     echo "Rule 2 (lo)"
     # 
-    $IPTABLES -A INPUT  -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
@@ -413,7 +413,7 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
@@ -421,9 +421,9 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (global)
     # 
@@ -432,8 +432,8 @@ script_body() {
     # Firewall uses one of the machines
     # on internal network for DNS
     $IPTABLES -N RULE_5
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
     $IPTABLES -A RULE_5  -j LOG  --log-level info --log-prefix "RULE 5 -- ACCEPT "
     $IPTABLES -A RULE_5  -j ACCEPT
     # 
@@ -482,19 +482,19 @@ script_body() {
     # 
     # fw is part of any
     $IPTABLES -N Cid997025X96143.0
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid997025X96143.0
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid997025X96143.0
     $IPTABLES -A Cid997025X96143.0  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid997025X96143.0  -s 172.24.0.3   -j ACCEPT
     $IPTABLES -A Cid997025X96143.0  -s 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid997025X96143.0  -s 192.168.1.3   -j ACCEPT
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 11 (global)
     # 
     echo "Rule 11 (global)"
     # 
     # fw is NOT part of any
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 12 (global)
     # 
@@ -502,7 +502,7 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid143289X96143.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid143289X96143.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid143289X96143.0
     $IPTABLES -A Cid143289X96143.0  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid143289X96143.0  -s 172.24.0.3   -j ACCEPT
     # 
@@ -512,7 +512,7 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid1946680X96143.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid1946680X96143.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid1946680X96143.0
     $IPTABLES -A Cid1946680X96143.0   -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid1946680X96143.0   -s 172.24.0.3   -j ACCEPT
     # 
@@ -522,11 +522,11 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid378955X96143.0
-    $IPTABLES -A FORWARD  -i eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid378955X96143.0
+    $IPTABLES -A FORWARD  -i eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid378955X96143.0
     $IPTABLES -A Cid378955X96143.0  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid378955X96143.0  -s 172.24.0.3   -j ACCEPT
     $IPTABLES -N Cid378955X96143.1
-    $IPTABLES -A OUTPUT  -o eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid378955X96143.1
+    $IPTABLES -A OUTPUT  -o eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid378955X96143.1
     $IPTABLES -A Cid378955X96143.1  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid378955X96143.1  -s 172.24.0.3   -j ACCEPT
     # 
@@ -536,7 +536,7 @@ script_body() {
     # 
     # fw is NOT part of any
     $IPTABLES -N Cid1801407X96143.0
-    $IPTABLES -A OUTPUT  -o eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid1801407X96143.0
+    $IPTABLES -A OUTPUT  -o eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid1801407X96143.0
     $IPTABLES -A Cid1801407X96143.0  -s 172.24.0.1   -j ACCEPT
     $IPTABLES -A Cid1801407X96143.0  -s 172.24.0.3   -j ACCEPT
     # 
@@ -545,9 +545,9 @@ script_body() {
     echo "Rule 16 (global)"
     # 
     # fw is NOT part of any
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     $IPTABLES -N Cid143343X96143.0
-    $IPTABLES -A FORWARD -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid143343X96143.0
+    $IPTABLES -A FORWARD -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid143343X96143.0
     $IPTABLES -A Cid143343X96143.0  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid143343X96143.0  -s 192.168.100.1   -j ACCEPT
     # 
@@ -556,14 +556,14 @@ script_body() {
     echo "Rule 17 (eth0)"
     # 
     # fw is NOT part of any
-    $IPTABLES -A FORWARD  -i eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -i eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     $IPTABLES -N Cid2241935X96143.0
-    $IPTABLES -A FORWARD  -i eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid2241935X96143.0
+    $IPTABLES -A FORWARD  -i eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid2241935X96143.0
     $IPTABLES -A Cid2241935X96143.0  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid2241935X96143.0  -s 192.168.100.1   -j ACCEPT
-    $IPTABLES -A OUTPUT  -o eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -o eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     $IPTABLES -N Cid2241935X96143.1
-    $IPTABLES -A FORWARD  -o eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid2241935X96143.1
+    $IPTABLES -A FORWARD  -o eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid2241935X96143.1
     $IPTABLES -A Cid2241935X96143.1  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid2241935X96143.1  -s 192.168.100.1   -j ACCEPT
     # 
@@ -572,9 +572,9 @@ script_body() {
     echo "Rule 18 (eth0)"
     # 
     # fw is NOT part of any
-    $IPTABLES -A OUTPUT  -o eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -o eth0  -p tcp -m tcp  -s 172.24.0.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     $IPTABLES -N Cid2241981X96143.0
-    $IPTABLES -A FORWARD  -o eth0  -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid2241981X96143.0
+    $IPTABLES -A FORWARD  -o eth0  -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid2241981X96143.0
     $IPTABLES -A Cid2241981X96143.0  -s 172.24.0.2   -j ACCEPT
     $IPTABLES -A Cid2241981X96143.0  -s 192.168.100.1   -j ACCEPT
     # 
@@ -584,7 +584,7 @@ script_body() {
     # 
     # using interface of another cluster in the rule
     $IPTABLES -N Cid8228X45618.0
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid8228X45618.0
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid8228X45618.0
     $IPTABLES -A Cid8228X45618.0   -s 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid8228X45618.0   -s 192.168.1.2   -j ACCEPT
     $IPTABLES -A Cid8228X45618.0   -s 192.168.1.100   -j ACCEPT
@@ -594,7 +594,7 @@ script_body() {
     echo "Rule 20 (global)"
     # 
     $IPTABLES -N Cid147047X84105.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j Cid147047X84105.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j Cid147047X84105.0
     $IPTABLES -A Cid147047X84105.0  -d 192.168.1.1   -j ACCEPT
     $IPTABLES -A Cid147047X84105.0  -d 192.168.1.2   -j ACCEPT
     $IPTABLES -A Cid147047X84105.0  -d 192.168.1.100   -j ACCEPT
@@ -604,9 +604,9 @@ script_body() {
     echo "Rule 21 (global)"
     # 
     $IPTABLES -N RULE_21
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j RULE_21
-    $IPTABLES -A INPUT  -m state --state NEW  -j RULE_21
-    $IPTABLES -A FORWARD  -m state --state NEW  -j RULE_21
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j RULE_21
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j RULE_21
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j RULE_21
     $IPTABLES -A RULE_21  -j LOG  --log-level info --log-prefix "RULE 21 -- DENY "
     $IPTABLES -A RULE_21  -j DROP
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/objects-for-regression-tests.fwb fwbuilder-5.1.0.3599/test/ipt/objects-for-regression-tests.fwb
--- fwbuilder-5.1.0.3599-orig/test/ipt/objects-for-regression-tests.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/objects-for-regression-tests.fwb	2014-07-08 16:51:10.921000552 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
@@ -6070,7 +6070,7 @@
           <CustomServiceCommand platform="iosacl"></CustomServiceCommand>
           <CustomServiceCommand platform="ipf"></CustomServiceCommand>
           <CustomServiceCommand platform="ipfw"></CustomServiceCommand>
-          <CustomServiceCommand platform="iptables">-p tcp -m state --state ESTABLISHED --tcp-flags SYN,ACK,RST,URG ACK</CustomServiceCommand>
+          <CustomServiceCommand platform="iptables">-p tcp -m conntrack --ctstate ESTABLISHED --tcp-flags SYN,ACK,RST,URG ACK</CustomServiceCommand>
           <CustomServiceCommand platform="pf"></CustomServiceCommand>
           <CustomServiceCommand platform="pix"></CustomServiceCommand>
           <CustomServiceCommand platform="unknown"></CustomServiceCommand>
@@ -6080,7 +6080,7 @@
           <CustomServiceCommand platform="iosacl"></CustomServiceCommand>
           <CustomServiceCommand platform="ipf"></CustomServiceCommand>
           <CustomServiceCommand platform="ipfw"></CustomServiceCommand>
-          <CustomServiceCommand platform="iptables">-p tcp -m state --state ESTABLISHED --tcp-flags SYN,FIN,RST,URG,PSH RST</CustomServiceCommand>
+          <CustomServiceCommand platform="iptables">-p tcp -m conntrack --ctstate ESTABLISHED --tcp-flags SYN,FIN,RST,URG,PSH RST</CustomServiceCommand>
           <CustomServiceCommand platform="pf"></CustomServiceCommand>
           <CustomServiceCommand platform="pix"></CustomServiceCommand>
           <CustomServiceCommand platform="unknown"></CustomServiceCommand>
@@ -6100,7 +6100,7 @@
           <CustomServiceCommand platform="iosacl"></CustomServiceCommand>
           <CustomServiceCommand platform="ipf"></CustomServiceCommand>
           <CustomServiceCommand platform="ipfw"></CustomServiceCommand>
-          <CustomServiceCommand platform="iptables">-p tcp ! --syn -dport 5190 -m state --state NEW</CustomServiceCommand>
+          <CustomServiceCommand platform="iptables">-p tcp ! --syn -dport 5190 -m conntrack --ctstate NEW</CustomServiceCommand>
           <CustomServiceCommand platform="pf"></CustomServiceCommand>
           <CustomServiceCommand platform="pix"></CustomServiceCommand>
           <CustomServiceCommand platform="unknown"></CustomServiceCommand>
@@ -6120,7 +6120,7 @@
           <CustomServiceCommand platform="iosacl"></CustomServiceCommand>
           <CustomServiceCommand platform="ipf"></CustomServiceCommand>
           <CustomServiceCommand platform="ipfw"></CustomServiceCommand>
-          <CustomServiceCommand platform="iptables">-m tcp --tcp-flags SYN,ACK SYN,ACK -m state --state NEW</CustomServiceCommand>
+          <CustomServiceCommand platform="iptables">-m tcp --tcp-flags SYN,ACK SYN,ACK -m conntrack --ctstate NEW</CustomServiceCommand>
           <CustomServiceCommand platform="pf"></CustomServiceCommand>
           <CustomServiceCommand platform="pix"></CustomServiceCommand>
           <CustomServiceCommand platform="unknown"></CustomServiceCommand>
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/openais_cluster_1_linux-1.fw.orig fwbuilder-5.1.0.3599/test/ipt/openais_cluster_1_linux-1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/openais_cluster_1_linux-1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/openais_cluster_1_linux-1.fw.orig	2014-07-08 16:51:10.374007390 +0200
@@ -416,9 +416,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -473,8 +473,8 @@ script_body() {
     # 
     echo "Rule 0 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (eth0)
     # 
@@ -482,18 +482,18 @@ script_body() {
     # 
     # anti spoofing rule
     $IPTABLES -N In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.100.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.100.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.100.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.100.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
     $IPTABLES -A In_RULE_1  -j LOG  --log-level info --log-prefix "RULE 1 -- DENY "
     $IPTABLES -A In_RULE_1  -j DROP
     # 
@@ -501,8 +501,8 @@ script_body() {
     # 
     echo "Rule 2 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
@@ -510,7 +510,7 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
@@ -518,9 +518,9 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (global)
     # 
@@ -529,8 +529,8 @@ script_body() {
     # Firewall uses one of the machines
     # on internal network for DNS
     $IPTABLES -N RULE_5
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
     $IPTABLES -A RULE_5  -j LOG  --log-level info --log-prefix "RULE 5 -- ACCEPT "
     $IPTABLES -A RULE_5  -j ACCEPT
     # 
@@ -563,18 +563,18 @@ script_body() {
     # 
     echo "Rule 8 (global)"
     # 
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 9 (global)
     # 
     echo "Rule 9 (global)"
     # 
     $IPTABLES -N RULE_9
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j RULE_9
-    $IPTABLES -A INPUT  -m state --state NEW  -j RULE_9
-    $IPTABLES -A FORWARD  -m state --state NEW  -j RULE_9
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j RULE_9
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j RULE_9
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j RULE_9
     $IPTABLES -A RULE_9  -j LOG  --log-level info --log-prefix "RULE 9 -- DENY "
     $IPTABLES -A RULE_9  -j DROP
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/openais_cluster_1_linux-2.fw.orig fwbuilder-5.1.0.3599/test/ipt/openais_cluster_1_linux-2.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/openais_cluster_1_linux-2.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/openais_cluster_1_linux-2.fw.orig	2014-07-08 16:51:10.550005190 +0200
@@ -321,9 +321,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -381,8 +381,8 @@ script_body() {
     # 
     echo "Rule 0 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (eth0)
     # 
@@ -390,16 +390,16 @@ script_body() {
     # 
     # anti spoofing rule
     $IPTABLES -N In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
     $IPTABLES -A In_RULE_1  -j LOG  --log-level info --log-prefix "RULE 1 -- DENY "
     $IPTABLES -A In_RULE_1  -j DROP
     # 
@@ -407,8 +407,8 @@ script_body() {
     # 
     echo "Rule 2 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
@@ -416,7 +416,7 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
@@ -424,9 +424,9 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (global)
     # 
@@ -435,8 +435,8 @@ script_body() {
     # Firewall uses one of the machines
     # on internal network for DNS
     $IPTABLES -N RULE_5
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
     $IPTABLES -A RULE_5  -j LOG  --log-level info --log-prefix "RULE 5 -- ACCEPT "
     $IPTABLES -A RULE_5  -j ACCEPT
     # 
@@ -467,18 +467,18 @@ script_body() {
     # 
     echo "Rule 8 (global)"
     # 
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 9 (global)
     # 
     echo "Rule 9 (global)"
     # 
     $IPTABLES -N RULE_9
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j RULE_9
-    $IPTABLES -A INPUT  -m state --state NEW  -j RULE_9
-    $IPTABLES -A FORWARD  -m state --state NEW  -j RULE_9
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j RULE_9
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j RULE_9
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j RULE_9
     $IPTABLES -A RULE_9  -j LOG  --log-level info --log-prefix "RULE 9 -- DENY "
     $IPTABLES -A RULE_9  -j DROP
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/rc.firewall.local fwbuilder-5.1.0.3599/test/ipt/rc.firewall.local
--- fwbuilder-5.1.0.3599-orig/test/ipt/rc.firewall.local	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/rc.firewall.local	2014-07-08 16:51:10.516005615 +0200
@@ -162,8 +162,8 @@ script_body() {
     # 
     echo "Rule 0 (global)"
     # 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 10.3.14.40   --dport 80  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -d 10.3.14.40   --dport 80  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 10.3.14.40   --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -d 10.3.14.40   --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/rh90.fw.orig fwbuilder-5.1.0.3599/test/ipt/rh90.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/rh90.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/rh90.fw.orig	2014-07-08 16:51:10.936000364 +0200
@@ -321,9 +321,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -347,8 +347,8 @@ script_body() {
     # 
     echo "Rule 1 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (global)
     # 
@@ -357,26 +357,26 @@ script_body() {
     # SSH Access to the host; useful ICMP
     # types; ping request
     $IPTABLES -N Cid41528C32.0
-    $IPTABLES -A OUTPUT  -d 10.3.14.58   -m state --state NEW  -j Cid41528C32.0
+    $IPTABLES -A OUTPUT  -d 10.3.14.58   -m conntrack --ctstate NEW  -j Cid41528C32.0
     $IPTABLES -A Cid41528C32.0 -p icmp  -m icmp  --icmp-type 3  -j ACCEPT
     $IPTABLES -A Cid41528C32.0 -p icmp  -m icmp  --icmp-type 0/0   -j ACCEPT
     $IPTABLES -A Cid41528C32.0 -p icmp  -m icmp  --icmp-type 8/0   -j ACCEPT
     $IPTABLES -A Cid41528C32.0 -p icmp  -m icmp  --icmp-type 11/0   -j ACCEPT
     $IPTABLES -A Cid41528C32.0 -p icmp  -m icmp  --icmp-type 11/1   -j ACCEPT
     $IPTABLES -A Cid41528C32.0 -p tcp -m tcp  --dport 22  -j ACCEPT
-    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type 3  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type 0/0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type 8/0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type 11/0   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type 11/1   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type 3  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type 0/0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type 8/0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type 11/0   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p icmp  -m icmp  --icmp-type 11/1   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
     echo "Rule 3 (global)"
     # 
-    $IPTABLES -A INPUT  -s 10.3.14.58   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 10.3.14.58   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/server-cluster-1_server-1.fw.orig fwbuilder-5.1.0.3599/test/ipt/server-cluster-1_server-1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/server-cluster-1_server-1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/server-cluster-1_server-1.fw.orig	2014-07-08 16:51:10.473006152 +0200
@@ -323,9 +323,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/server-cluster-1_server-2.fw.orig fwbuilder-5.1.0.3599/test/ipt/server-cluster-1_server-2.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/server-cluster-1_server-2.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/server-cluster-1_server-2.fw.orig	2014-07-08 16:51:10.422006790 +0200
@@ -322,9 +322,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/test-shadowing-1.fw.orig fwbuilder-5.1.0.3599/test/ipt/test-shadowing-1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/test-shadowing-1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/test-shadowing-1.fw.orig	2014-07-08 16:51:10.408006965 +0200
@@ -330,9 +330,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -348,8 +348,8 @@ script_body() {
     # shades rule below
     # test-shadowing-1:Policy:0: error: Rule '0 (eth0)' shadows rule '1 (eth0)'  below it
 
-    $IPTABLES -A OUTPUT -o eth0   -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -o eth0   -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (eth0)
     # 
@@ -368,9 +368,9 @@ script_body() {
     # of any for this rule
     # test-shadowing-1:Policy:2: error: Rule '2 (global)' shadows rule '3 (global)'  below it
 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 80  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 80  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  --dport 80  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
@@ -389,9 +389,9 @@ script_body() {
     # 
     # test-shadowing-1:Policy:4: error: Rule '4 (global)' shadows rule '5 (global)'  below it
 
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (global)
     # 
@@ -407,9 +407,9 @@ script_body() {
     # 
     # test-shadowing-1:Policy:6: error: Rule '6 (global)' shadows rule '7 (global)'  below it
 
-    $IPTABLES -A INPUT -p udp -m udp  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p udp -m udp  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p udp -m udp  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p udp -m udp  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p udp -m udp  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 7 (global)
     # 
@@ -427,9 +427,9 @@ script_body() {
     # it uses IPService object with protocol 0
     # test-shadowing-1:Policy:8: error: Rule '8 (global)' shadows rule '9 (global)'  below it
 
-    $IPTABLES -A INPUT -p all  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p all  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p all  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p all  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p all  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p all  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 9 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/test-shadowing-2.fw.orig fwbuilder-5.1.0.3599/test/ipt/test-shadowing-2.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/test-shadowing-2.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/test-shadowing-2.fw.orig	2014-07-08 16:51:10.592004665 +0200
@@ -328,9 +328,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -346,7 +346,7 @@ script_body() {
     # shades rule below
     # test-shadowing-2:Policy:0: error: Rule '0 (eth0)' shadows rule '1 (eth0)'  below it
 
-    $IPTABLES -A FORWARD -o eth0   -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -o eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (eth0)
     # 
@@ -362,9 +362,9 @@ script_body() {
     # of any for this rule
     # test-shadowing-2:Policy:2: error: Rule '2 (global)' shadows rule '3 (global)'  below it
 
-    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 80  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p tcp -m tcp  --dport 80  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  --dport 80  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  --dport 80  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
@@ -380,7 +380,7 @@ script_body() {
     # it uses IPService object with protocol 0
     # test-shadowing-2:Policy:4: error: Rule '4 (global)' shadows rule '5 (global)'  below it
 
-    $IPTABLES -A FORWARD -p all  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p all  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (global)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/test-shadowing-3.fw.orig fwbuilder-5.1.0.3599/test/ipt/test-shadowing-3.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/test-shadowing-3.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/test-shadowing-3.fw.orig	2014-07-08 16:51:10.350007690 +0200
@@ -330,9 +330,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
@@ -347,7 +347,7 @@ script_body() {
     # 
     # connlimit
     $IPTABLES -N Policy_1
-    $IPTABLES -A Policy_1 -o eth0   -s 192.168.1.0/24   -m state --state NEW  -m connlimit --connlimit-above 10 -j ACCEPT
+    $IPTABLES -A Policy_1 -o eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -m connlimit --connlimit-above 10 -j ACCEPT
     # 
     # Rule Policy_1 1 (eth0)
     # 
@@ -362,7 +362,7 @@ script_body() {
     # 
     # hashlimit
     $IPTABLES -N Policy_2
-    $IPTABLES -A Policy_2 -o eth0   -s 192.168.1.0/24   -m state --state NEW  -m hashlimit --hashlimit 10/second --hashlimit-name test -j ACCEPT
+    $IPTABLES -A Policy_2 -o eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -m hashlimit --hashlimit 10/second --hashlimit-name test -j ACCEPT
     # 
     # Rule Policy_2 1 (eth0)
     # 
@@ -379,14 +379,14 @@ script_body() {
     # test-shadowing-3:Policy_3:0: error: Rule 'Policy_3 0 (eth0)' shadows rule 'Policy_3 1 (eth0)'  below it
 
     $IPTABLES -N Policy_3
-    $IPTABLES -A Policy_3 -o eth0   -s 192.168.1.0/24   -m state --state NEW  -m hashlimit --hashlimit 50/second --hashlimit-mode srcip --hashlimit-name test -j ACCEPT
+    $IPTABLES -A Policy_3 -o eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -m hashlimit --hashlimit 50/second --hashlimit-mode srcip --hashlimit-name test -j ACCEPT
     # 
     # Rule Policy_3 1 (eth0)
     # 
     echo "Rule Policy_3 1 (eth0)"
     # 
     # 50/sec
-    $IPTABLES -A Policy_3 -o eth0   -s 192.168.1.0/24   -m state --state NEW  -m hashlimit --hashlimit 50/second --hashlimit-mode srcip --hashlimit-name test -j ACCEPT
+    $IPTABLES -A Policy_3 -o eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -m hashlimit --hashlimit 50/second --hashlimit-mode srcip --hashlimit-name test -j ACCEPT
     # ================ Table 'filter', rule set Policy_4
     # 
     # Rule Policy_4 0 (eth0)
@@ -395,28 +395,28 @@ script_body() {
     # 
     # 30/sec
     $IPTABLES -N Policy_4
-    $IPTABLES -A Policy_4 -o eth0   -s 192.168.1.0/24   -m state --state NEW  -m hashlimit --hashlimit 30/second --hashlimit-mode srcip --hashlimit-name test -j ACCEPT
+    $IPTABLES -A Policy_4 -o eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -m hashlimit --hashlimit 30/second --hashlimit-mode srcip --hashlimit-name test -j ACCEPT
     # 
     # Rule Policy_4 1 (eth0)
     # 
     echo "Rule Policy_4 1 (eth0)"
     # 
     # 50/sec
-    $IPTABLES -A Policy_4 -o eth0   -s 192.168.1.0/24   -m state --state NEW  -m hashlimit --hashlimit 50/second --hashlimit-mode srcip --hashlimit-name test -j ACCEPT
+    $IPTABLES -A Policy_4 -o eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -m hashlimit --hashlimit 50/second --hashlimit-mode srcip --hashlimit-name test -j ACCEPT
     # 
     # Rule Policy_4 2 (eth0)
     # 
     echo "Rule Policy_4 2 (eth0)"
     # 
     # htable_rule_4
-    $IPTABLES -A Policy_4 -o eth0   -s 192.168.1.0/24   -m state --state NEW  -m hashlimit --hashlimit 10/second --hashlimit-mode srcip --hashlimit-name htable_rule_4 -j ACCEPT
+    $IPTABLES -A Policy_4 -o eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -m hashlimit --hashlimit 10/second --hashlimit-mode srcip --hashlimit-name htable_rule_4 -j ACCEPT
     # 
     # Rule Policy_4 3 (eth0)
     # 
     echo "Rule Policy_4 3 (eth0)"
     # 
     # htable_rule_5
-    $IPTABLES -A Policy_4 -o eth0   -s 192.168.1.0/24   -m state --state NEW  -m hashlimit --hashlimit 10/second --hashlimit-mode srcip --hashlimit-name htable_rule_5 -j ACCEPT
+    $IPTABLES -A Policy_4 -o eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -m hashlimit --hashlimit 10/second --hashlimit-mode srcip --hashlimit-name htable_rule_5 -j ACCEPT
     # ================ Table 'filter', rule set Policy_5
     # 
     # Rule Policy_5 0 (eth0)
@@ -427,14 +427,14 @@ script_body() {
     # test-shadowing-3:Policy_5:0: error: Rule 'Policy_5 0 (eth0)' shadows rule 'Policy_5 1 (eth0)'  below it
 
     $IPTABLES -N Policy_5
-    $IPTABLES -A Policy_5 -o eth0   -s 192.168.1.0/24   -m state --state NEW  -m hashlimit --hashlimit 50/second --hashlimit-mode srcip --hashlimit-name test -j ACCEPT
+    $IPTABLES -A Policy_5 -o eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -m hashlimit --hashlimit 50/second --hashlimit-mode srcip --hashlimit-name test -j ACCEPT
     # 
     # Rule Policy_5 1 (eth0)
     # 
     echo "Rule Policy_5 1 (eth0)"
     # 
     # 30/sec
-    $IPTABLES -A Policy_5 -o eth0   -s 192.168.1.0/24   -m state --state NEW  -m hashlimit --hashlimit 30/second --hashlimit-mode srcip --hashlimit-name test -j ACCEPT
+    $IPTABLES -A Policy_5 -o eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -m hashlimit --hashlimit 30/second --hashlimit-mode srcip --hashlimit-name test -j ACCEPT
     # ================ Table 'filter', rule set Policy_6
     # 
     # Rule Policy_6 0 (global)
@@ -490,7 +490,7 @@ script_body() {
     echo "Rule 0 (eth0)"
     # 
     # limit 
-    $IPTABLES -A FORWARD -o eth0   -s 192.168.1.0/24   -m state --state NEW  -m limit --limit 10/second -j ACCEPT
+    $IPTABLES -A FORWARD -o eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -m limit --limit 10/second -j ACCEPT
     # 
     # Rule 1 (eth0)
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/test_fw.fw.orig fwbuilder-5.1.0.3599/test/ipt/test_fw.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/test_fw.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/test_fw.fw.orig	2014-07-08 16:51:10.343007778 +0200
@@ -331,9 +331,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -373,16 +373,16 @@ script_body() {
     # 
     # anti spoofing rule
     $IPTABLES -N In_RULE_0
-    $IPTABLES -A INPUT -i eth0   -s 192.0.2.1   -m state --state NEW  -j In_RULE_0
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_0
-    $IPTABLES -A INPUT -i eth0   -s 192.168.2.1   -m state --state NEW  -j In_RULE_0
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_0
-    $IPTABLES -A INPUT -i eth0   -s 192.168.2.0/24   -m state --state NEW  -j In_RULE_0
-    $IPTABLES -A FORWARD -i eth0   -s 192.0.2.1   -m state --state NEW  -j In_RULE_0
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_0
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.2.1   -m state --state NEW  -j In_RULE_0
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_0
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.2.0/24   -m state --state NEW  -j In_RULE_0
+    $IPTABLES -A INPUT -i eth0   -s 192.0.2.1   -m conntrack --ctstate NEW  -j In_RULE_0
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_0
+    $IPTABLES -A INPUT -i eth0   -s 192.168.2.1   -m conntrack --ctstate NEW  -j In_RULE_0
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_0
+    $IPTABLES -A INPUT -i eth0   -s 192.168.2.0/24   -m conntrack --ctstate NEW  -j In_RULE_0
+    $IPTABLES -A FORWARD -i eth0   -s 192.0.2.1   -m conntrack --ctstate NEW  -j In_RULE_0
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_0
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.2.1   -m conntrack --ctstate NEW  -j In_RULE_0
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_0
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.2.0/24   -m conntrack --ctstate NEW  -j In_RULE_0
     $IPTABLES -A In_RULE_0  -j LOG  --log-level info --log-prefix "RULE 0 -- DENY "
     $IPTABLES -A In_RULE_0  -j DROP
     # 
@@ -390,8 +390,8 @@ script_body() {
     # 
     echo "Rule 1 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 2 (global)
     # 
@@ -399,7 +399,7 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
@@ -407,8 +407,8 @@ script_body() {
     # 
     # Firewall uses one of the machines
     # on internal network for DNS
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.10   --dport 53  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.10   --dport 53  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.10   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.10   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
@@ -417,10 +417,10 @@ script_body() {
     # All other attempts to connect to
     # the firewall are denied and logged
     $IPTABLES -N RULE_4
-    $IPTABLES -A OUTPUT  -d 192.0.2.1   -m state --state NEW  -j RULE_4
-    $IPTABLES -A OUTPUT  -d 192.168.1.1   -m state --state NEW  -j RULE_4
-    $IPTABLES -A OUTPUT  -d 192.168.2.1   -m state --state NEW  -j RULE_4
-    $IPTABLES -A INPUT  -m state --state NEW  -j RULE_4
+    $IPTABLES -A OUTPUT  -d 192.0.2.1   -m conntrack --ctstate NEW  -j RULE_4
+    $IPTABLES -A OUTPUT  -d 192.168.1.1   -m conntrack --ctstate NEW  -j RULE_4
+    $IPTABLES -A OUTPUT  -d 192.168.2.1   -m conntrack --ctstate NEW  -j RULE_4
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j RULE_4
     $IPTABLES -A RULE_4  -j LOG  --log-level info --log-prefix "RULE 4 -- DENY "
     $IPTABLES -A RULE_4  -j DROP
     # 
@@ -441,8 +441,8 @@ script_body() {
     # Mail relay on DMZ can accept
     # connections from hosts on the
     # Internet
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.2.10   --dport 25  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -d 192.168.2.10   --dport 25  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.2.10   --dport 25  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -d 192.168.2.10   --dport 25  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 7 (global)
     # 
@@ -451,7 +451,7 @@ script_body() {
     # this rule permits a mail relay
     # located on DMZ to connect
     # to internal mail server
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.2.10   -d 192.168.1.10   --dport 25  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.2.10   -d 192.168.1.10   --dport 25  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 8 (global)
     # 
@@ -460,10 +460,10 @@ script_body() {
     # Mail relay needs DNS and can
     # connect to mail servers on the
     # Internet
-    $IPTABLES -A INPUT -p tcp -m tcp  -m multiport  -s 192.168.2.10   -d ! 192.168.1.0/24   --dports 53,25  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A INPUT -p udp -m udp  -s 192.168.2.10   -d ! 192.168.1.0/24   --dport 53  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  -s 192.168.2.10   -d ! 192.168.1.0/24   --dports 53,25  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p udp -m udp  -s 192.168.2.10   -d ! 192.168.1.0/24   --dport 53  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -m multiport  -s 192.168.2.10   -d ! 192.168.1.0/24   --dports 53,25  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p udp -m udp  -s 192.168.2.10   -d ! 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -m multiport  -s 192.168.2.10   -d ! 192.168.1.0/24   --dports 53,25  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p udp -m udp  -s 192.168.2.10   -d ! 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 9 (global)
     # 
@@ -484,9 +484,9 @@ script_body() {
     # 
     # This permits access from internal net
     # to the Internet and DMZ
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 11 (global)
     # 
@@ -505,9 +505,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IP6TABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IP6TABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IP6TABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IP6TABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/vrrp_cluster_1_linux-1.fw.orig fwbuilder-5.1.0.3599/test/ipt/vrrp_cluster_1_linux-1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/vrrp_cluster_1_linux-1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/vrrp_cluster_1_linux-1.fw.orig	2014-07-08 16:51:10.427006727 +0200
@@ -416,9 +416,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -485,8 +485,8 @@ script_body() {
     # 
     echo "Rule 0 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (eth0)
     # 
@@ -494,18 +494,18 @@ script_body() {
     # 
     # anti spoofing rule
     $IPTABLES -N In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.100.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.100.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.100.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.100.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
     $IPTABLES -A In_RULE_1  -j LOG  --log-level info --log-prefix "RULE 1 -- DENY "
     $IPTABLES -A In_RULE_1  -j DROP
     # 
@@ -513,8 +513,8 @@ script_body() {
     # 
     echo "Rule 2 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
@@ -522,7 +522,7 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
@@ -530,9 +530,9 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (global)
     # 
@@ -541,8 +541,8 @@ script_body() {
     # Firewall uses one of the machines
     # on internal network for DNS
     $IPTABLES -N RULE_5
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
     $IPTABLES -A RULE_5  -j LOG  --log-level info --log-prefix "RULE 5 -- ACCEPT "
     $IPTABLES -A RULE_5  -j ACCEPT
     # 
@@ -566,18 +566,18 @@ script_body() {
     # 
     echo "Rule 7 (global)"
     # 
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 8 (global)
     # 
     echo "Rule 8 (global)"
     # 
     $IPTABLES -N RULE_8
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j RULE_8
-    $IPTABLES -A INPUT  -m state --state NEW  -j RULE_8
-    $IPTABLES -A FORWARD  -m state --state NEW  -j RULE_8
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j RULE_8
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j RULE_8
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j RULE_8
     $IPTABLES -A RULE_8  -j LOG  --log-level info --log-prefix "RULE 8 -- DENY "
     $IPTABLES -A RULE_8  -j DROP
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/vrrp_cluster_1_linux-2.fw.orig fwbuilder-5.1.0.3599/test/ipt/vrrp_cluster_1_linux-2.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/vrrp_cluster_1_linux-2.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/vrrp_cluster_1_linux-2.fw.orig	2014-07-08 16:51:10.535005377 +0200
@@ -321,9 +321,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -393,8 +393,8 @@ script_body() {
     # 
     echo "Rule 0 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (eth0)
     # 
@@ -402,16 +402,16 @@ script_body() {
     # 
     # anti spoofing rule
     $IPTABLES -N In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
     $IPTABLES -A In_RULE_1  -j LOG  --log-level info --log-prefix "RULE 1 -- DENY "
     $IPTABLES -A In_RULE_1  -j DROP
     # 
@@ -419,8 +419,8 @@ script_body() {
     # 
     echo "Rule 2 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
@@ -428,7 +428,7 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
@@ -436,9 +436,9 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 5 (global)
     # 
@@ -447,8 +447,8 @@ script_body() {
     # Firewall uses one of the machines
     # on internal network for DNS
     $IPTABLES -N RULE_5
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
     $IPTABLES -A RULE_5  -j LOG  --log-level info --log-prefix "RULE 5 -- ACCEPT "
     $IPTABLES -A RULE_5  -j ACCEPT
     # 
@@ -471,18 +471,18 @@ script_body() {
     # 
     echo "Rule 7 (global)"
     # 
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 8 (global)
     # 
     echo "Rule 8 (global)"
     # 
     $IPTABLES -N RULE_8
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j RULE_8
-    $IPTABLES -A INPUT  -m state --state NEW  -j RULE_8
-    $IPTABLES -A FORWARD  -m state --state NEW  -j RULE_8
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j RULE_8
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j RULE_8
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j RULE_8
     $IPTABLES -A RULE_8  -j LOG  --log-level info --log-prefix "RULE 8 -- DENY "
     $IPTABLES -A RULE_8  -j DROP
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/vrrp_cluster_2_linux-1.fw.orig fwbuilder-5.1.0.3599/test/ipt/vrrp_cluster_2_linux-1.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/vrrp_cluster_2_linux-1.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/vrrp_cluster_2_linux-1.fw.orig	2014-07-08 16:51:11.080998551 +0200
@@ -416,9 +416,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -497,8 +497,8 @@ script_body() {
     # 
     echo "Rule 0 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (eth0)
     # 
@@ -506,18 +506,18 @@ script_body() {
     # 
     # anti spoofing rule
     $IPTABLES -N In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.100.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.2   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.100.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.100.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.2   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.100.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
     $IPTABLES -A In_RULE_1  -j LOG  --log-level info --log-prefix "RULE 1 -- DENY "
     $IPTABLES -A In_RULE_1  -j DROP
     # 
@@ -525,8 +525,8 @@ script_body() {
     # 
     echo "Rule 2 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
@@ -534,7 +534,7 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
@@ -542,13 +542,13 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.2   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     $IPTABLES -N Cid5188X25627.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j Cid5188X25627.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j Cid5188X25627.0
     $IPTABLES -A Cid5188X25627.0  -d 192.168.1.3   -j ACCEPT
     $IPTABLES -A Cid5188X25627.0  -d 192.168.1.4   -j ACCEPT
     $IPTABLES -N Cid5188X25627.1
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j Cid5188X25627.1
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j Cid5188X25627.1
     $IPTABLES -A Cid5188X25627.1  -d 192.168.1.3   -j ACCEPT
     $IPTABLES -A Cid5188X25627.1  -d 192.168.1.4   -j ACCEPT
     # 
@@ -559,8 +559,8 @@ script_body() {
     # Firewall uses one of the machines
     # on internal network for DNS
     $IPTABLES -N RULE_5
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
     $IPTABLES -A RULE_5  -j LOG  --log-level info --log-prefix "RULE 5 -- ACCEPT "
     $IPTABLES -A RULE_5  -j ACCEPT
     # 
@@ -584,18 +584,18 @@ script_body() {
     # 
     echo "Rule 7 (global)"
     # 
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 8 (global)
     # 
     echo "Rule 8 (global)"
     # 
     $IPTABLES -N RULE_8
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j RULE_8
-    $IPTABLES -A INPUT  -m state --state NEW  -j RULE_8
-    $IPTABLES -A FORWARD  -m state --state NEW  -j RULE_8
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j RULE_8
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j RULE_8
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j RULE_8
     $IPTABLES -A RULE_8  -j LOG  --log-level info --log-prefix "RULE 8 -- DENY "
     $IPTABLES -A RULE_8  -j DROP
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/vrrp_cluster_2_linux-2.fw.orig fwbuilder-5.1.0.3599/test/ipt/vrrp_cluster_2_linux-2.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/vrrp_cluster_2_linux-2.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/vrrp_cluster_2_linux-2.fw.orig	2014-07-08 16:51:10.929000452 +0200
@@ -321,9 +321,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -405,8 +405,8 @@ script_body() {
     # 
     echo "Rule 0 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (eth0)
     # 
@@ -414,16 +414,16 @@ script_body() {
     # 
     # anti spoofing rule
     $IPTABLES -N In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.3   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.3   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
     $IPTABLES -A In_RULE_1  -j LOG  --log-level info --log-prefix "RULE 1 -- DENY "
     $IPTABLES -A In_RULE_1  -j DROP
     # 
@@ -431,8 +431,8 @@ script_body() {
     # 
     echo "Rule 2 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
@@ -440,7 +440,7 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
@@ -448,13 +448,13 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.3   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     $IPTABLES -N Cid5188X25627.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j Cid5188X25627.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j Cid5188X25627.0
     $IPTABLES -A Cid5188X25627.0  -d 192.168.1.2   -j ACCEPT
     $IPTABLES -A Cid5188X25627.0  -d 192.168.1.4   -j ACCEPT
     $IPTABLES -N Cid5188X25627.1
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j Cid5188X25627.1
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j Cid5188X25627.1
     $IPTABLES -A Cid5188X25627.1  -d 192.168.1.2   -j ACCEPT
     $IPTABLES -A Cid5188X25627.1  -d 192.168.1.4   -j ACCEPT
     # 
@@ -465,8 +465,8 @@ script_body() {
     # Firewall uses one of the machines
     # on internal network for DNS
     $IPTABLES -N RULE_5
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
     $IPTABLES -A RULE_5  -j LOG  --log-level info --log-prefix "RULE 5 -- ACCEPT "
     $IPTABLES -A RULE_5  -j ACCEPT
     # 
@@ -489,18 +489,18 @@ script_body() {
     # 
     echo "Rule 7 (global)"
     # 
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 8 (global)
     # 
     echo "Rule 8 (global)"
     # 
     $IPTABLES -N RULE_8
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j RULE_8
-    $IPTABLES -A INPUT  -m state --state NEW  -j RULE_8
-    $IPTABLES -A FORWARD  -m state --state NEW  -j RULE_8
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j RULE_8
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j RULE_8
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j RULE_8
     $IPTABLES -A RULE_8  -j LOG  --log-level info --log-prefix "RULE 8 -- DENY "
     $IPTABLES -A RULE_8  -j DROP
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/ipt/vrrp_cluster_2_linux-3.fw.orig fwbuilder-5.1.0.3599/test/ipt/vrrp_cluster_2_linux-3.fw.orig
--- fwbuilder-5.1.0.3599-orig/test/ipt/vrrp_cluster_2_linux-3.fw.orig	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/ipt/vrrp_cluster_2_linux-3.fw.orig	2014-07-08 16:51:10.614004390 +0200
@@ -321,9 +321,9 @@ script_body() {
 
     # ================ Table 'filter', automatic rules
     # accept established sessions
-    $IPTABLES -A INPUT   -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A OUTPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT 
-    $IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
+    $IPTABLES -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 
+    $IPTABLES -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
 
 
     # ================ Table 'nat',  rule set NAT
@@ -381,8 +381,8 @@ script_body() {
     # 
     echo "Rule 0 (eth0)"
     # 
-    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o eth0  -p vrrp  -d 224.0.0.18   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 1 (eth0)
     # 
@@ -390,16 +390,16 @@ script_body() {
     # 
     # anti spoofing rule
     $IPTABLES -N In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 172.24.0.4   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.4   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.4   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.4   -m state --state NEW  -j In_RULE_1
-    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m state --state NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 172.24.0.4   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.4   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A INPUT -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 172.24.0.4   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.1   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.4   -m conntrack --ctstate NEW  -j In_RULE_1
+    $IPTABLES -A FORWARD -i eth0   -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j In_RULE_1
     $IPTABLES -A In_RULE_1  -j LOG  --log-level info --log-prefix "RULE 1 -- DENY "
     $IPTABLES -A In_RULE_1  -j DROP
     # 
@@ -407,8 +407,8 @@ script_body() {
     # 
     echo "Rule 2 (lo)"
     # 
-    $IPTABLES -A INPUT -i lo   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT -o lo   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -i lo   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT -o lo   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 3 (global)
     # 
@@ -416,7 +416,7 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 4 (global)
     # 
@@ -424,13 +424,13 @@ script_body() {
     # 
     # SSH Access to firewall is permitted
     # only from internal network
-    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.4   --dport 22  -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT -p tcp -m tcp  -s 192.168.1.0/24   -d 192.168.1.4   --dport 22  -m conntrack --ctstate NEW  -j ACCEPT
     $IPTABLES -N Cid5188X25627.0
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j Cid5188X25627.0
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j Cid5188X25627.0
     $IPTABLES -A Cid5188X25627.0  -d 192.168.1.2   -j ACCEPT
     $IPTABLES -A Cid5188X25627.0  -d 192.168.1.3   -j ACCEPT
     $IPTABLES -N Cid5188X25627.1
-    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m state --state NEW  -j Cid5188X25627.1
+    $IPTABLES -A FORWARD -p tcp -m tcp  -s 192.168.1.0/24   --dport 22  -m conntrack --ctstate NEW  -j Cid5188X25627.1
     $IPTABLES -A Cid5188X25627.1  -d 192.168.1.2   -j ACCEPT
     $IPTABLES -A Cid5188X25627.1  -d 192.168.1.3   -j ACCEPT
     # 
@@ -441,8 +441,8 @@ script_body() {
     # Firewall uses one of the machines
     # on internal network for DNS
     $IPTABLES -N RULE_5
-    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
-    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m state --state NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p tcp -m tcp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
+    $IPTABLES -A OUTPUT -p udp -m udp  -d 192.168.1.0/24   --dport 53  -m conntrack --ctstate NEW  -j RULE_5
     $IPTABLES -A RULE_5  -j LOG  --log-level info --log-prefix "RULE 5 -- ACCEPT "
     $IPTABLES -A RULE_5  -j ACCEPT
     # 
@@ -465,18 +465,18 @@ script_body() {
     # 
     echo "Rule 7 (global)"
     # 
-    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
-    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m state --state NEW  -j ACCEPT
+    $IPTABLES -A INPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A OUTPUT  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
+    $IPTABLES -A FORWARD  -s 192.168.1.0/24   -m conntrack --ctstate NEW  -j ACCEPT
     # 
     # Rule 8 (global)
     # 
     echo "Rule 8 (global)"
     # 
     $IPTABLES -N RULE_8
-    $IPTABLES -A OUTPUT  -m state --state NEW  -j RULE_8
-    $IPTABLES -A INPUT  -m state --state NEW  -j RULE_8
-    $IPTABLES -A FORWARD  -m state --state NEW  -j RULE_8
+    $IPTABLES -A OUTPUT  -m conntrack --ctstate NEW  -j RULE_8
+    $IPTABLES -A INPUT  -m conntrack --ctstate NEW  -j RULE_8
+    $IPTABLES -A FORWARD  -m conntrack --ctstate NEW  -j RULE_8
     $IPTABLES -A RULE_8  -j LOG  --log-level info --log-prefix "RULE 8 -- DENY "
     $IPTABLES -A RULE_8  -j DROP
     # 
diff -Naurp fwbuilder-5.1.0.3599-orig/test/pf/cluster-tests.fwb fwbuilder-5.1.0.3599/test/pf/cluster-tests.fwb
--- fwbuilder-5.1.0.3599-orig/test/pf/cluster-tests.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/pf/cluster-tests.fwb	2014-07-08 16:51:10.315008128 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/test/pf/objects-for-regression-tests.fwb fwbuilder-5.1.0.3599/test/pf/objects-for-regression-tests.fwb
--- fwbuilder-5.1.0.3599-orig/test/pf/objects-for-regression-tests.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/pf/objects-for-regression-tests.fwb	2014-07-08 16:51:10.284008515 +0200
@@ -111,7 +111,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -119,7 +119,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/test/pix/cluster-tests.fwb fwbuilder-5.1.0.3599/test/pix/cluster-tests.fwb
--- fwbuilder-5.1.0.3599-orig/test/pix/cluster-tests.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/pix/cluster-tests.fwb	2014-07-08 16:51:11.266996226 +0200
@@ -104,14 +104,14 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
         <CustomServiceCommand platform="Undefined"></CustomServiceCommand>
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
         <ServiceGroup id="sg-DHCP" name="DHCP" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/test/pix/objects-for-regression-tests.fwb fwbuilder-5.1.0.3599/test/pix/objects-for-regression-tests.fwb
--- fwbuilder-5.1.0.3599-orig/test/pix/objects-for-regression-tests.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/pix/objects-for-regression-tests.fwb	2014-07-08 16:51:11.253996389 +0200
@@ -104,7 +104,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -112,7 +112,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
diff -Naurp fwbuilder-5.1.0.3599-orig/test/procurve_acl/objects-for-regression-tests.fwb fwbuilder-5.1.0.3599/test/procurve_acl/objects-for-regression-tests.fwb
--- fwbuilder-5.1.0.3599-orig/test/procurve_acl/objects-for-regression-tests.fwb	2012-03-23 07:10:54.000000000 +0100
+++ fwbuilder-5.1.0.3599/test/procurve_acl/objects-for-regression-tests.fwb	2014-07-08 16:51:11.453993888 +0200
@@ -104,7 +104,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <CustomService id="stdid14_2" name="ESTABLISHED ipv6" comment="This service matches all packets which are part of network connections established through the firewall, or connections 'related' to those established through the firewall. Term 'established' refers to the state tracking mechanism which exists inside iptables and other stateful firewalls and does not mean any particular combination of packet header options. Packet is considered to correspond to the state 'ESTABLISHED' if it belongs to the network session, for which proper initiation has been seen by the firewall, so its stateful inspection module made appropriate record in the state table. Usually stateful firewalls keep track of network connections using not only tcp protocol, but also udp and sometimes even icmp protocols. 'RELATED' describes packet belonging to a separate network connection, related to the session firewall is keeping track of. One example is FTP command and FTP data sessions." ro="False" protocol="any" address_family="ipv6">
@@ -112,7 +112,7 @@
         <CustomServiceCommand platform="iosacl">established</CustomServiceCommand>
         <CustomServiceCommand platform="ipfilter"></CustomServiceCommand>
         <CustomServiceCommand platform="ipfw">established</CustomServiceCommand>
-        <CustomServiceCommand platform="iptables">-m state --state ESTABLISHED,RELATED</CustomServiceCommand>
+        <CustomServiceCommand platform="iptables">-m conntrack --ctstate ESTABLISHED,RELATED</CustomServiceCommand>
         <CustomServiceCommand platform="procurve_acl">established</CustomServiceCommand>
       </CustomService>
       <ServiceGroup id="stdid10" name="Groups" comment="" ro="False">
